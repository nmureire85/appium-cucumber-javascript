"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDevice = require("appium-ios-device");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const DEFAULT_ITEM_PUSH_TIMEOUT = 30 * 1000;
const APPLICATION_NOTIFICATION_TIMEOUT = 30 * 1000;
const IOS_DEPLOY = 'ios-deploy';

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }

  async remove(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      await service.uninstallApplication(bundleid);
    } finally {
      service.close();
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app, timeout) {
    const timer = new _appiumSupport.timing.Timer().start();

    try {
      const bundlePathOnPhone = await this.pushAppBundle(app, timeout);
      await this.installApplication(bundlePathOnPhone);
    } catch (err) {
      _logger.default.warn(`Error installing app: ${err.message}`);

      _logger.default.warn(`Falling back to '${IOS_DEPLOY}' usage`);

      try {
        await _appiumSupport.fs.which(IOS_DEPLOY);
      } catch (err1) {
        throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - '${IOS_DEPLOY}' utility has not been found in PATH. Is it installed?`);
      }

      try {
        await (0, _teen_process.exec)(IOS_DEPLOY, ['--id', this.udid, '--bundle', app]);
      } catch (err1) {
        throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - ${err1.stderr || err1.stdout || err1.message}`);
      }
    }

    _logger.default.info(`App installation succeeded after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
  }

  async installApplication(bundlePathOnPhone) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });

    try {
      await installationService.installApplication(bundlePathOnPhone, {
        PackageType: 'Developer'
      });

      try {
        await appInstalledNotification.timeout(APPLICATION_NOTIFICATION_TIMEOUT, `Could not get the application installed notification within ${APPLICATION_NOTIFICATION_TIMEOUT}ms but we will continue`);
      } catch (e) {
        _logger.default.warn(`Failed to receive the notification. Error: ${e.message}`);
      }
    } finally {
      installationService.close();
      notificationService.close();
    }
  }

  async pushAppBundle(app, timeout = DEFAULT_ITEM_PUSH_TIMEOUT) {
    const timer = new _appiumSupport.timing.Timer().start();
    const afcService = await _appiumIosDevice.services.startAfcService(this.udid);

    try {
      const bundlePathOnPhone = await this.createAppPath(afcService, app);
      await _appiumSupport.fs.walkDir(app, true, async (itemPath, isDir) => {
        const pathOnPhone = _path.default.join(bundlePathOnPhone, _path.default.relative(app, itemPath));

        if (isDir) {
          await afcService.createDirectory(pathOnPhone);
        } else {
          const readStream = _appiumSupport.fs.createReadStream(itemPath, {
            autoClose: true
          });

          const writeStream = await afcService.createWriteStream(pathOnPhone, {
            autoDestroy: true
          });
          writeStream.on('finish', writeStream.destroy);
          let pushError = null;
          const itemPushWait = new _bluebird.default((resolve, reject) => {
            writeStream.on('close', () => {
              if (pushError) {
                reject(pushError);
              } else {
                resolve();
              }
            });

            const onStreamError = e => {
              readStream.unpipe(writeStream);

              _logger.default.debug(e);

              pushError = e;
            };

            writeStream.on('error', onStreamError);
            readStream.on('error', onStreamError);
          });
          readStream.pipe(writeStream);
          await itemPushWait.timeout(timeout, `Could not push '${itemPath}' within the timeout of ${timeout}ms. ` + `Consider increasing the value of 'appPushTimeout' capability.`);
        }
      });

      _logger.default.debug(`Pushed the app files successfully after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

      return bundlePathOnPhone;
    } finally {
      afcService.close();
    }
  }

  async createAppPath(afcService, localAppPath) {
    const basename = _path.default.basename(localAppPath);

    const relativePath = _path.default.join(INSTALLATION_STAGING_DIR, basename);

    try {
      await afcService.deleteDirectory(relativePath);
    } catch (ign) {}

    await afcService.createDirectory(relativePath);
    return relativePath;
  }

  async installApp(app, timeout) {
    await this.install(app, timeout);
  }

  async isAppInstalled(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.lookupApplications({
        bundleIds: bundleid
      });
      return !!applications[bundleid];
    } finally {
      service.close();
    }
  }

  async getUserInstalledBundleIdsByBundleName(bundleName) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.listApplications({
        applicationType: 'User'
      });
      return _lodash.default.reduce(applications, (acc, {
        CFBundleName
      }, key) => {
        if (CFBundleName === bundleName) {
          acc.push(key);
        }

        return acc;
      }, []);
    } finally {
      service.close();
    }
  }

  async getPlatformVersion() {
    return await _appiumIosDevice.utilities.getOSVersion(this.udid);
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbIkFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04iLCJJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIiLCJERUZBVUxUX0lURU1fUFVTSF9USU1FT1VUIiwiQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVQiLCJJT1NfREVQTE9ZIiwiSU9TRGVwbG95IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwicmVtb3ZlIiwiYnVuZGxlaWQiLCJzZXJ2aWNlIiwic2VydmljZXMiLCJzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSIsInVuaW5zdGFsbEFwcGxpY2F0aW9uIiwiY2xvc2UiLCJyZW1vdmVBcHAiLCJidW5kbGVJZCIsImluc3RhbGwiLCJhcHAiLCJ0aW1lb3V0IiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiYnVuZGxlUGF0aE9uUGhvbmUiLCJwdXNoQXBwQnVuZGxlIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwiZXJyIiwibG9nIiwid2FybiIsIm1lc3NhZ2UiLCJmcyIsIndoaWNoIiwiZXJyMSIsIkVycm9yIiwic3RkZXJyIiwic3Rkb3V0IiwiaW5mbyIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIiwibm90aWZpY2F0aW9uU2VydmljZSIsInN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIiwiaW5zdGFsbGF0aW9uU2VydmljZSIsImFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiIsIkIiLCJyZXNvbHZlIiwib2JzZXJ2ZU5vdGlmaWNhdGlvbiIsIm5vdGlmaWNhdGlvbiIsIlBhY2thZ2VUeXBlIiwiZSIsImFmY1NlcnZpY2UiLCJzdGFydEFmY1NlcnZpY2UiLCJjcmVhdGVBcHBQYXRoIiwid2Fsa0RpciIsIml0ZW1QYXRoIiwiaXNEaXIiLCJwYXRoT25QaG9uZSIsInBhdGgiLCJqb2luIiwicmVsYXRpdmUiLCJjcmVhdGVEaXJlY3RvcnkiLCJyZWFkU3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dG9DbG9zZSIsIndyaXRlU3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJhdXRvRGVzdHJveSIsIm9uIiwiZGVzdHJveSIsInB1c2hFcnJvciIsIml0ZW1QdXNoV2FpdCIsInJlamVjdCIsIm9uU3RyZWFtRXJyb3IiLCJ1bnBpcGUiLCJkZWJ1ZyIsInBpcGUiLCJsb2NhbEFwcFBhdGgiLCJiYXNlbmFtZSIsInJlbGF0aXZlUGF0aCIsImRlbGV0ZURpcmVjdG9yeSIsImlnbiIsImluc3RhbGxBcHAiLCJpc0FwcEluc3RhbGxlZCIsImFwcGxpY2F0aW9ucyIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsImdldFVzZXJJbnN0YWxsZWRCdW5kbGVJZHNCeUJ1bmRsZU5hbWUiLCJidW5kbGVOYW1lIiwibGlzdEFwcGxpY2F0aW9ucyIsImFwcGxpY2F0aW9uVHlwZSIsIl8iLCJyZWR1Y2UiLCJhY2MiLCJDRkJ1bmRsZU5hbWUiLCJrZXkiLCJwdXNoIiwiZ2V0UGxhdGZvcm1WZXJzaW9uIiwidXRpbGl0aWVzIiwiZ2V0T1NWZXJzaW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGtDQUFrQyxHQUFHLHdDQUEzQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLGVBQWpDO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsS0FBSyxJQUF2QztBQUNBLE1BQU1DLGdDQUFnQyxHQUFHLEtBQUssSUFBOUM7QUFDQSxNQUFNQyxVQUFVLEdBQUcsWUFBbkI7O0FBRUEsTUFBTUMsU0FBTixDQUFnQjtBQUVkQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUTtBQUNqQixTQUFLQSxJQUFMLEdBQVlBLElBQVo7QUFDRDs7QUFFRCxRQUFNQyxNQUFOLENBQWNDLFFBQWQsRUFBd0I7QUFDdEIsVUFBTUMsT0FBTyxHQUFHLE1BQU1DLDBCQUFTQyw2QkFBVCxDQUF1QyxL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O0FBQ0EsYUFBT0MsZ0JBQUVDLE1BQUYsQ0FBU1IsWUFBVCxFQUF1QixDQUFDUyxHQUFELEVBQU07QUFBQ0MsUUFBQUE7QUFBRCxPQUFOLEVBQXNCQyxHQUF0QixLQUE4QjtBQUMxRCxZQUFJRCxZQUFZLEtBQUtOLFVBQXJCLEVBQWlDO0FBQy9CSyxVQUFBQSxHQUFHLENBQUNHLElBQUosQ0FBU0QsR0FBVDtBQUNEOztBQUNELGVBQU9GLEdBQVA7QUFDRCxPQUxNLEVBS0osRUFMSSxDQUFQO0FBTUQsS0FSRCxTQVFVO0FBQ1JuRixNQUFBQSxPQUFPLENBQUNJLEtBQVI7QUFDRDtBQUNGOztBQUVELFFBQU1tRixrQkFBTixHQUE0QjtBQUMxQixXQUFPLE1BQU1DLDJCQUFVQyxZQUFWLENBQXVCLEtBQUs1RixJQUE1QixDQUFiO0FBQ0Q7O0FBMUthOztlQTZLREYsUyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrcyAqL1xuaW1wb3J0IHsgZnMsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc2VydmljZXMsIHV0aWxpdGllcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5jb25zdCBBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OID0gJ2NvbS5hcHBsZS5tb2JpbGUuYXBwbGljYXRpb25faW5zdGFsbGVkJztcbmNvbnN0IElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiA9ICdQdWJsaWNTdGFnaW5nJztcbmNvbnN0IERFRkFVTFRfSVRFTV9QVVNIX1RJTUVPVVQgPSAzMCAqIDEwMDA7XG5jb25zdCBBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVCA9IDMwICogMTAwMDtcbmNvbnN0IElPU19ERVBMT1kgPSAnaW9zLWRlcGxveSc7XG5cbmNsYXNzIElPU0RlcGxveSB7XG5cbiAgY29uc3RydWN0b3IgKHVkaWQpIHtcbiAgICB0aGlzLnVkaWQgPSB1ZGlkO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlIChidW5kbGVpZCkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnVuaW5zdGFsbEFwcGxpY2F0aW9uKGJ1bmRsZWlkKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgICBhd2FpdCB0aGlzLnJlbW92ZShidW5kbGVJZCk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsIChhcHAsIHRpbWVvdXQpIHtcbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBidW5kbGVQYXRoT25QaG9uZSA9IGF3YWl0IHRoaXMucHVzaEFwcEJ1bmRsZShhcHAsIHRpbWVvdXQpO1xuICAgICAgYXdhaXQgdGhpcy5pbnN0YWxsQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYEVycm9yIGluc3RhbGxpbmcgYXBwOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLndhcm4oYEZhbGxpbmcgYmFjayB0byAnJHtJT1NfREVQTE9ZfScgdXNhZ2VgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLndoaWNoKElPU19ERVBMT1kpO1xuICAgICAgfSBjYXRjaCAoZXJyMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBpbnN0YWxsICcke2FwcH0nOlxcbmAgK1xuICAgICAgICAgIGAgIC0gJHtlcnIubWVzc2FnZX1cXG5gICtcbiAgICAgICAgICBgICAtICcke0lPU19ERVBMT1l9JyB1dGlsaXR5IGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBJcyBpdCBpbnN0YWxsZWQ/YCk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBleGVjKElPU19ERVBMT1ksIFtcbiAgICAgICAgICAnLS1pZCcsIHRoaXMudWRpZCxcbiAgICAgICAgICAnLS1idW5kbGUnLCBhcHAsXG4gICAgICAgIF0pO1xuICAgICAgfSBjYXRjaCAoZXJyMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBpbnN0YWxsICcke2FwcH0nOlxcbmAgK1xuICAgICAgICAgIGAgIC0gJHtlcnIubWVzc2FnZX1cXG5gICtcbiAgICAgICAgICBgICAtICR7ZXJyMS5zdGRlcnIgfHwgZXJyMS5zdGRvdXQgfHwgZXJyMS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2cuaW5mbyhgQXBwIGluc3RhbGxhdGlvbiBzdWNjZWVkZWQgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHBsaWNhdGlvbiAoYnVuZGxlUGF0aE9uUGhvbmUpIHtcbiAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnROb3RpZmljYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICBjb25zdCBpbnN0YWxsYXRpb25TZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICBjb25zdCBhcHBJbnN0YWxsZWROb3RpZmljYXRpb24gPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5vYnNlcnZlTm90aWZpY2F0aW9uKEFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04sIHtub3RpZmljYXRpb246IHJlc29sdmV9KTtcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgaW5zdGFsbGF0aW9uU2VydmljZS5pbnN0YWxsQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUsIHtQYWNrYWdlVHlwZTogJ0RldmVsb3Blcid9KTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbi50aW1lb3V0KEFQUExJQ0FUSU9OX05PVElGSUNBVElPTl9USU1FT1VULCBgQ291bGQgbm90IGdldCB0aGUgYXBwbGljYXRpb24gaW5zdGFsbGVkIG5vdGlmaWNhdGlvbiB3aXRoaW4gJHtBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVH1tcyBidXQgd2Ugd2lsbCBjb250aW51ZWApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIHJlY2VpdmUgdGhlIG5vdGlmaWNhdGlvbi4gRXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICBpbnN0YWxsYXRpb25TZXJ2aWNlLmNsb3NlKCk7XG4gICAgICBub3RpZmljYXRpb25TZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcHVzaEFwcEJ1bmRsZSAoYXBwLCB0aW1lb3V0ID0gREVGQVVMVF9JVEVNX1BVU0hfVElNRU9VVCkge1xuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgY29uc3QgYWZjU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0QWZjU2VydmljZSh0aGlzLnVkaWQpO1xuICAgIC8vIFdlIGFyZSBwdXNoaW5nIHNlcmlhbGx5IGR1ZSB0byB0aGlzIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMzExNS4gVGhlcmUgaXMgbm90aGluZyBlbHNlIHdlIGNhbiBkbyBiZXNpZGVzIHRoaXNcbiAgICB0cnkge1xuICAgICAgY29uc3QgYnVuZGxlUGF0aE9uUGhvbmUgPSBhd2FpdCB0aGlzLmNyZWF0ZUFwcFBhdGgoYWZjU2VydmljZSwgYXBwKTtcbiAgICAgIGF3YWl0IGZzLndhbGtEaXIoYXBwLCB0cnVlLCBhc3luYyAoaXRlbVBhdGgsIGlzRGlyKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhdGhPblBob25lID0gcGF0aC5qb2luKGJ1bmRsZVBhdGhPblBob25lLCBwYXRoLnJlbGF0aXZlKGFwcCwgaXRlbVBhdGgpKTtcbiAgICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgICAgYXdhaXQgYWZjU2VydmljZS5jcmVhdGVEaXJlY3RvcnkocGF0aE9uUGhvbmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGl0ZW1QYXRoLCB7YXV0b0Nsb3NlOiB0cnVlfSk7XG4gICAgICAgICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGhPblBob25lLCB7YXV0b0Rlc3Ryb3k6IHRydWV9KTtcbiAgICAgICAgICB3cml0ZVN0cmVhbS5vbignZmluaXNoJywgd3JpdGVTdHJlYW0uZGVzdHJveSk7XG4gICAgICAgICAgbGV0IHB1c2hFcnJvciA9IG51bGw7XG4gICAgICAgICAgY29uc3QgaXRlbVB1c2hXYWl0ID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgICBpZiAocHVzaEVycm9yKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KHB1c2hFcnJvcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IG9uU3RyZWFtRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgICAgICAgICByZWFkU3RyZWFtLnVucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgICAgICAgICAgIGxvZy5kZWJ1ZyhlKTtcbiAgICAgICAgICAgICAgcHVzaEVycm9yID0gZTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB3cml0ZVN0cmVhbS5vbignZXJyb3InLCBvblN0cmVhbUVycm9yKTtcbiAgICAgICAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgb25TdHJlYW1FcnJvcik7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmVhZFN0cmVhbS5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgICAgICBhd2FpdCBpdGVtUHVzaFdhaXQudGltZW91dCh0aW1lb3V0LFxuICAgICAgICAgICAgYENvdWxkIG5vdCBwdXNoICcke2l0ZW1QYXRofScgd2l0aGluIHRoZSB0aW1lb3V0IG9mICR7dGltZW91dH1tcy4gYCArXG4gICAgICAgICAgICBgQ29uc2lkZXIgaW5jcmVhc2luZyB0aGUgdmFsdWUgb2YgJ2FwcFB1c2hUaW1lb3V0JyBjYXBhYmlsaXR5LmApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGxvZy5kZWJ1ZyhgUHVzaGVkIHRoZSBhcHAgZmlsZXMgc3VjY2Vzc2Z1bGx5IGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgICByZXR1cm4gYnVuZGxlUGF0aE9uUGhvbmU7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGFmY1NlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjcmVhdGVBcHBQYXRoIChhZmNTZXJ2aWNlLCBsb2NhbEFwcFBhdGgpIHtcbiAgICBjb25zdCBiYXNlbmFtZSA9IHBhdGguYmFzZW5hbWUobG9jYWxBcHBQYXRoKTtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBwYXRoLmpvaW4oSU5TVEFMTEFUSU9OX1NUQUdJTkdfRElSLCBiYXNlbmFtZSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGFmY1NlcnZpY2UuZGVsZXRlRGlyZWN0b3J5KHJlbGF0aXZlUGF0aCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlRGlyZWN0b3J5KHJlbGF0aXZlUGF0aCk7XG4gICAgcmV0dXJuIHJlbGF0aXZlUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKGFwcCwgdGltZW91dCkge1xuICAgIGF3YWl0IHRoaXMuaW5zdGFsbChhcHAsIHRpbWVvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhbiBhcHBsaWNhdGlvbiBvYmplY3QgaWYgdGVzdCBhcHAgaGFzICdidW5kbGVpZCcuXG4gICAqIFRoZSB0YXJnZXQgYnVuZGxlaWQgY2FuIGJlIFVzZXIgYW5kIFN5c3RlbSBhcHBzLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlaWQgVGhlIGJ1bmRsZUlkIHRvIGVuc3VyZSBpdCBpcyBpbnN0YWxsZWRcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyBUcnVlIGlmIHRoZSBidW5kbGVpZCBleGlzdHMgaW4gdGhlIHJlc3VsdCBvZiAnbGlzdEFwcGxpY2F0aW9ucycgbGlrZTpcbiAgICogeyBcImNvbS5hcHBsZS5QcmVmZXJlbmNlc1wiOntcbiAgICogICBcIlVJUmVxdWlyZWREZXZpY2VDYXBhYmlsaXRpZXNcIjpbXCJhcm02NFwiXSxcbiAgICogICBcIlVJUmVxdWlyZXNGdWxsU2NyZWVuXCI6dHJ1ZSxcbiAgICogICBcIkNGQnVuZGxlSW5mb0RpY3Rpb25hcnlWZXJzaW9uXCI6XCI2LjBcIixcbiAgICogICBcIkVudGl0bGVtZW50c1wiOlxuICAgKiAgICAge1wiY29tLmFwcGxlLmZyb250Ym9hcmQuZGVsZXRlLWFwcGxpY2F0aW9uLXNuYXBzaG90c1wiOnRydWUsLi5cbiAgICovXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVpZCkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBsaWNhdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmxvb2t1cEFwcGxpY2F0aW9ucyh7IGJ1bmRsZUlkczogYnVuZGxlaWQgfSk7XG4gICAgICByZXR1cm4gISFhcHBsaWNhdGlvbnNbYnVuZGxlaWRdO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVOYW1lIFRoZSBuYW1lIG9mIENGQnVuZGxlTmFtZSBpbiBJbmZvLnBsaXN0XG4gICAqXG4gICAqIEByZXR1cm5zIHtBcnJheTxzdHJpbmc+fSBBIGxpc3Qgb2YgVXNlciBsZXZlbCBhcHBzJyBidW5kbGUgaWRzIHdoaWNoIGhhc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NGQnVuZGxlTmFtZScgYXR0cmlidXRlIGFzICdidW5kbGVOYW1lJy5cbiAgICovXG4gIGFzeW5jIGdldFVzZXJJbnN0YWxsZWRCdW5kbGVJZHNCeUJ1bmRsZU5hbWUgKGJ1bmRsZU5hbWUpIHtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXBwbGljYXRpb25zID0gYXdhaXQgc2VydmljZS5saXN0QXBwbGljYXRpb25zKHthcHBsaWNhdGlvblR5cGU6ICdVc2VyJ30pO1xuICAgICAgcmV0dXJuIF8ucmVkdWNlKGFwcGxpY2F0aW9ucywgKGFjYywge0NGQnVuZGxlTmFtZX0sIGtleSkgPT4ge1xuICAgICAgICBpZiAoQ0ZCdW5kbGVOYW1lID09PSBidW5kbGVOYW1lKSB7XG4gICAgICAgICAgYWNjLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwgW10pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0UGxhdGZvcm1WZXJzaW9uICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdXRpbGl0aWVzLmdldE9TVmVyc2lvbih0aGlzLnVkaWQpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IElPU0RlcGxveTtcbiJdLCJmaWxlIjoibGliL2lvcy1kZXBsb3kuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
