"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

const commands = {};
exports.commands = commands;
const AUDIO_RECORD_FEAT_NAME = 'audio_record';
const MAX_RECORDING_TIME_SEC = 60 * 60 * 12;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const PROCESS_STARTUP_TIMEOUT_MS = 5000;
const DEFAULT_SOURCE = 'avfoundation';
const DEFAULT_BITRATE = '128k';
const DEFAULT_CODEC = 'aac';
const DEFAULT_CHANNELS = 2;
const DEFAULT_RATE = 44100;
const DEFAULT_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

class AudioRecorder {
  constructor(input, audioPath, opts = {}) {
    this.audioPath = audioPath;
    this.opts = opts;
    this.input = input;
    this.mainProcess = null;
  }

  async start(timeoutSeconds) {
    try {
      await _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }

    const {
      audioSource = DEFAULT_SOURCE,
      audioCodec,
      audioBitrate,
      audioChannels,
      audioRate
    } = this.opts;
    const args = ['-t', `${timeoutSeconds}`, '-f', audioSource, '-i', this.input, '-c:a', audioCodec, '-b:a', audioBitrate, '-ac', `${audioChannels}`, '-ar', `${audioRate}`, this.audioPath];
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    let isCaptureStarted = false;
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr) {
        if (stderr.trim().startsWith('size=')) {
          if (!isCaptureStarted) {
            isCaptureStarted = true;
          }
        } else {
          ffmpegLogger.info(`${stderr}`);
        }
      }
    });
    await this.mainProcess.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(() => isCaptureStarted, {
        waitMs: PROCESS_STARTUP_TIMEOUT_MS,
        intervalMs: 300
      });
    } catch (e) {
      _logger.default.warn(`Audio recording process did not start within ${PROCESS_STARTUP_TIMEOUT_MS}ms. Continuing anyway`);
    }

    if (!this.mainProcess.isRunning) {
      this.mainProcess = null;
      throw new Error(`The audio recording process '${FFMPEG_BINARY}' died unexpectedly. ` + `Check server logs for more details`);
    }

    _logger.default.info(`Starting capture on audio input '${this.input}' with command: '${_appiumSupport.util.quote([FFMPEG_BINARY, ...args])}'. ` + `Will timeout in ${timeoutSeconds}s`);

    this.mainProcess.once('exit', (code, signal) => {
      if ([0, 255].includes(code)) {
        _logger.default.info(`The recording session on audio input '${this.input}' has been finished`);
      } else {
        _logger.default.debug(`The recording session on audio input '${this.input}' has exited ` + `with code ${code}, signal ${signal}`);
      }
    });
  }

  isRecording() {
    var _this$mainProcess;

    return !!((_this$mainProcess = this.mainProcess) === null || _this$mainProcess === void 0 ? void 0 : _this$mainProcess.isRunning);
  }

  async interrupt(force = false) {
    if (this.isRecording()) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;

      try {
        await interruptPromise;
      } catch (e) {
        _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

        return false;
      }
    }

    return true;
  }

  async finish() {
    await this.interrupt();
    return this.audioPath;
  }

  async cleanup() {
    if (await _appiumSupport.fs.exists(this.audioPath)) {
      await _appiumSupport.fs.rimraf(this.audioPath);
    }
  }

}

commands.startAudioRecording = async function startAudioRecording(options = {}) {
  var _this$_audioRecorder;

  if (!this.isFeatureEnabled(AUDIO_RECORD_FEAT_NAME)) {
    _logger.default.errorAndThrow(`Audio capture feature must be enabled on the server side. ` + `Please set '--relaxed-security' or '--allow-insecure' with '${AUDIO_RECORD_FEAT_NAME}' option. ` + `Read https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.`);
  }

  const {
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    audioInput,
    audioSource,
    audioCodec = DEFAULT_CODEC,
    audioBitrate = DEFAULT_BITRATE,
    audioChannels = DEFAULT_CHANNELS,
    audioRate = DEFAULT_RATE,
    forceRestart
  } = options;

  if (!audioInput) {
    _logger.default.errorAndThrow(`The mandatory audioInput option is not provided. Please set it ` + `to a correct value (e. g. ':1'). Use 'ffmpeg -f avfoundation -list_devices true -i ""' ` + `command to list available input sources`);
  }

  if ((_this$_audioRecorder = this._audioRecorder) === null || _this$_audioRecorder === void 0 ? void 0 : _this$_audioRecorder.isRecording()) {
    _logger.default.info(`There is an active audio recording process`);

    if (forceRestart) {
      _logger.default.info(`Stopping it because 'forceRestart' option is set to true`);

      await this._audioRecorder.interrupt(true);
    } else {
      _logger.default.info(`Doing nothing. ` + `Set 'forceRestart' option to true if you'd like to start a new audio recording session`);

      return;
    }
  }

  if (this._audioRecorder) {
    await this._audioRecorder.cleanup();
    this._audioRecorder = null;
  }

  const audioPath = await _appiumSupport.tempDir.path({
    prefix: `appium_${_appiumSupport.util.uuidV4().substring(0, 8)}`,
    suffix: DEFAULT_EXT
  });
  const audioRecorder = new AudioRecorder(audioInput, audioPath, {
    audioSource,
    audioCodec,
    audioBitrate,
    audioChannels,
    audioRate
  });
  const timeoutSeconds = parseInt(timeLimit, 10);

  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  try {
    await audioRecorder.start(timeoutSeconds);
  } catch (e) {
    await audioRecorder.interrupt(true);
    await audioRecorder.cleanup();
    throw e;
  }

  this._audioRecorder = audioRecorder;
};

commands.stopAudioRecording = async function stopAudioRecording() {
  if (!this._audioRecorder) {
    _logger.default.info('Audio recording has not been started. There is nothing to stop');

    return '';
  }

  let resultPath;

  try {
    resultPath = await this._audioRecorder.finish();

    if (!(await _appiumSupport.fs.exists(resultPath))) {
      _logger.default.errorAndThrow(`${FFMPEG_BINARY} has failed ` + `to store the actual audio recording at '${resultPath}'`);
    }
  } catch (e) {
    await this._audioRecorder.interrupt(true);
    await this._audioRecorder.cleanup();
    this._audioRecorder = null;
    throw e;
  }

  return await (0, _utils.encodeBase64OrUpload)(resultPath);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmQtYXVkaW8uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJBVURJT19SRUNPUkRfRkVBVF9OQU1FIiwiTUFYX1JFQ09SRElOR19USU1FX1NFQyIsIkRFRkFVTFRfUkVDT1JESU5HX1RJTUVfU0VDIiwiUFJPQ0VTU19TVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1NPVVJDRSIsIkRFRkFVTFRfQklUUkFURSIsIkRFRkFVTFRfQ09ERUMiLCJERUZBVUxUX0NIQU5ORUxTIiwiREVGQVVMVF9SQVRFIiwiREVGQVVMVF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiZmZtcGVnTG9nZ2VyIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiQXVkaW9SZWNvcmRlciIsImNvbnN0cnVjdG9yIiwiaW5wdXQiLCJhdWRpb1BhdGgiLCJvcHRzIiwibWFpblByb2Nlc3MiLCJzdGFydCIsInRpbWVvdXRTZWNvbmRzIiwiZnMiLCJ3aGljaCIsImVyciIsIkVycm9yIiwiYXVkaW9Tb3VyY2UiLCJhdWRpb0NvZGVjIiwiYXVkaW9CaXRyYXRlIiwiYXVkaW9DaGFubmVscyIsImF1ZGlvUmF0ZSIsImFyZ3MiLCJTdWJQcm9jZXNzIiwiaXNDYXB0dXJlU3RhcnRlZCIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwidHJpbSIsInN0YXJ0c1dpdGgiLCJpbmZvIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImUiLCJsb2ciLCJ3YXJuIiwiaXNSdW5uaW5nIiwidXRpbCIsInF1b3RlIiwib25jZSIsImNvZGUiLCJzaWduYWwiLCJpbmNsdWRlcyIsImRlYnVnIiwiaXNSZWNvcmRpbmciLCJpbnRlcnJ1cHQiLCJmb3JjZSIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwibWVzc2FnZSIsImZpbmlzaCIsImNsZWFudXAiLCJleGlzdHMiLCJyaW1yYWYiLCJzdGFydEF1ZGlvUmVjb3JkaW5nIiwib3B0aW9ucyIsImlzRmVhdHVyZUVuYWJsZWQiLCJlcnJvckFuZFRocm93IiwidGltZUxpbWl0IiwiYXVkaW9JbnB1dCIsImZvcmNlUmVzdGFydCIsIl9hdWRpb1JlY29yZGVyIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJ1dWlkVjQiLCJzdWJzdHJpbmciLCJzdWZmaXgiLCJhdWRpb1JlY29yZGVyIiwicGFyc2VJbnQiLCJpc05hTiIsInN0b3BBdWRpb1JlY29yZGluZyIsInJlc3VsdFBhdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBLE1BQU1DLHNCQUFzQixHQUFHLGNBQS9CO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxFQUFMLEdBQVUsRUFBekM7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxLQUFLLENBQXhDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUcsSUFBbkM7QUFDQSxNQUFNQyxjQUFjLEdBQUcsY0FBdkI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsTUFBeEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsS0FBdEI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxDQUF6QjtBQUNBLE1BQU1DLFlBQVksR0FBRyxLQUFyQjtBQUNBLE1BQU1DLFdBQVcsR0FBRyxNQUFwQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxRQUF0Qjs7QUFDQSxNQUFNQyxZQUFZLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCSCxhQUFqQixDQUFyQjs7QUFHQSxNQUFNSSxhQUFOLENBQW9CO0FBQ2xCQyxFQUFBQSxXQUFXLENBQUVDLEtBQUYsRUFBU0MsU0FBVCxFQUFvQkMsSUFBSSxHQUFHLEVBQTNCLEVBQStCO0FBQ3hDLFNBQUtELFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0YsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0csV0FBTCxHQUFtQixJQUFuQjtBQUNEOztBQUVELFFBQU1DLEtBQU4sQ0FBYUMsY0FBYixFQUE2QjtBQUMzQixRQUFJO0FB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QUFqQixHQUNmLDJDQUEwQ3VFLFVBQVcsR0FEeEQ7QUFFRDtBQUNGLEdBTkQsQ0FNRSxPQUFPdkMsQ0FBUCxFQUFVO0FBQ1YsVUFBTSxLQUFLNEIsY0FBTCxDQUFvQmhCLFNBQXBCLENBQThCLElBQTlCLENBQU47QUFDQSxVQUFNLEtBQUtnQixjQUFMLENBQW9CVixPQUFwQixFQUFOO0FBQ0EsU0FBS1UsY0FBTCxHQUFzQixJQUF0QjtBQUNBLFVBQU01QixDQUFOO0FBQ0Q7O0FBQ0QsU0FBTyxNQUFNLGlDQUFxQnVDLFVBQXJCLENBQWI7QUFDRCxDQXBCRDs7ZUF3QmVsRixRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZnMsIHRlbXBEaXIsIGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmNvbnN0IGNvbW1hbmRzID0ge307XG5cbmNvbnN0IEFVRElPX1JFQ09SRF9GRUFUX05BTUUgPSAnYXVkaW9fcmVjb3JkJztcbmNvbnN0IE1BWF9SRUNPUkRJTkdfVElNRV9TRUMgPSA2MCAqIDYwICogMTI7XG5jb25zdCBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMztcbmNvbnN0IFBST0NFU1NfU1RBUlRVUF9USU1FT1VUX01TID0gNTAwMDtcbmNvbnN0IERFRkFVTFRfU09VUkNFID0gJ2F2Zm91bmRhdGlvbic7XG5jb25zdCBERUZBVUxUX0JJVFJBVEUgPSAnMTI4ayc7XG5jb25zdCBERUZBVUxUX0NPREVDID0gJ2FhYyc7XG5jb25zdCBERUZBVUxUX0NIQU5ORUxTID0gMjtcbmNvbnN0IERFRkFVTFRfUkFURSA9IDQ0MTAwO1xuY29uc3QgREVGQVVMVF9FWFQgPSAnLm1wNCc7XG5jb25zdCBGRk1QRUdfQklOQVJZID0gJ2ZmbXBlZyc7XG5jb25zdCBmZm1wZWdMb2dnZXIgPSBsb2dnZXIuZ2V0TG9nZ2VyKEZGTVBFR19CSU5BUlkpO1xuXG5cbmNsYXNzIEF1ZGlvUmVjb3JkZXIge1xuICBjb25zdHJ1Y3RvciAoaW5wdXQsIGF1ZGlvUGF0aCwgb3B0cyA9IHt9KSB7XG4gICAgdGhpcy5hdWRpb1BhdGggPSBhdWRpb1BhdGg7XG4gICAgdGhpcy5vcHRzID0gb3B0cztcbiAgICB0aGlzLmlucHV0ID0gaW5wdXQ7XG4gICAgdGhpcy5tYWluUHJvY2VzcyA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydCAodGltZW91dFNlY29uZHMpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnMud2hpY2goRkZNUEVHX0JJTkFSWSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke0ZGTVBFR19CSU5BUll9JyBiaW5hcnkgaXMgbm90IGZvdW5kIGluIFBBVEguIEluc3RhbGwgaXQgdXNpbmcgJ2JyZXcgaW5zdGFsbCBmZm1wZWcnLiBgICtcbiAgICAgICAgYENoZWNrIGh0dHBzOi8vd3d3LmZmbXBlZy5vcmcvZG93bmxvYWQuaHRtbCBmb3IgbW9yZSBkZXRhaWxzLmApO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIGF1ZGlvU291cmNlID0gREVGQVVMVF9TT1VSQ0UsXG4gICAgICBhdWRpb0NvZGVjLFxuICAgICAgYXVkaW9CaXRyYXRlLFxuICAgICAgYXVkaW9DaGFubmVscyxcbiAgICAgIGF1ZGlvUmF0ZSxcbiAgICB9ID0gdGhpcy5vcHRzO1xuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctdCcsIGAke3RpbWVvdXRTZWNvbmRzfWAsXG4gICAgICAnLWYnLCBhdWRpb1NvdXJjZSxcbiAgICAgICctaScsIHRoaXMuaW5wdXQsXG4gICAgICAnLWM6YScsIGF1ZGlvQ29kZWMsXG4gICAgICAnLWI6YScsIGF1ZGlvQml0cmF0ZSxcbiAgICAgICctYWMnLCBgJHthdWRpb0NoYW5uZWxzfWAsXG4gICAgICAnLWFyJywgYCR7YXVkaW9SYXRlfWAsXG4gICAgICB0aGlzLmF1ZGlvUGF0aCxcbiAgICBdO1xuXG4gICAgdGhpcy5tYWluUHJvY2VzcyA9IG5ldyBTdWJQcm9jZXNzKEZGTVBFR19CSU5BUlksIGFyZ3MpO1xuICAgIGxldCBpc0NhcHR1cmVTdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5tYWluUHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBpZiAoc3RkZXJyKSB7XG4gICAgICAgIGlmIChzdGRlcnIudHJpbSgpLnN0YXJ0c1dpdGgoJ3NpemU9JykpIHtcbiAgICAgICAgICBpZiAoIWlzQ2FwdHVyZVN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIGlzQ2FwdHVyZVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmZm1wZWdMb2dnZXIuaW5mbyhgJHtzdGRlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLm1haW5Qcm9jZXNzLnN0YXJ0KDApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+IGlzQ2FwdHVyZVN0YXJ0ZWQsIHtcbiAgICAgICAgd2FpdE1zOiBQUk9DRVNTX1NUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYEF1ZGlvIHJlY29yZGluZyBwcm9jZXNzIGRpZCBub3Qgc3RhcnQgd2l0aGluICR7UFJPQ0VTU19TVEFSVFVQX1RJTUVPVVRfTVN9bXMuIENvbnRpbnVpbmcgYW55d2F5YCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5tYWluUHJvY2Vzcy5pc1J1bm5pbmcpIHtcbiAgICAgIHRoaXMubWFpblByb2Nlc3MgPSBudWxsO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgYXVkaW8gcmVjb3JkaW5nIHByb2Nlc3MgJyR7RkZNUEVHX0JJTkFSWX0nIGRpZWQgdW5leHBlY3RlZGx5LiBgICtcbiAgICAgICAgYENoZWNrIHNlcnZlciBsb2dzIGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYFN0YXJ0aW5nIGNhcHR1cmUgb24gYXVkaW8gaW5wdXQgJyR7dGhpcy5pbnB1dH0nIHdpdGggY29tbWFuZDogJyR7dXRpbC5xdW90ZShbRkZNUEVHX0JJTkFSWSwgLi4uYXJnc10pfScuIGAgK1xuICAgICAgYFdpbGwgdGltZW91dCBpbiAke3RpbWVvdXRTZWNvbmRzfXNgKTtcbiAgICB0aGlzLm1haW5Qcm9jZXNzLm9uY2UoJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAvLyBmZm1wZWcgcmV0dXJucyBjb2RlIDI1NSBpZiBTSUdJTlQgYXJyaXZlc1xuICAgICAgaWYgKFswLCAyNTVdLmluY2x1ZGVzKGNvZGUpKSB7XG4gICAgICAgIGxvZy5pbmZvKGBUaGUgcmVjb3JkaW5nIHNlc3Npb24gb24gYXVkaW8gaW5wdXQgJyR7dGhpcy5pbnB1dH0nIGhhcyBiZWVuIGZpbmlzaGVkYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYFRoZSByZWNvcmRpbmcgc2Vzc2lvbiBvbiBhdWRpbyBpbnB1dCAnJHt0aGlzLmlucHV0fScgaGFzIGV4aXRlZCBgICtcbiAgICAgICAgICBgd2l0aCBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGlzUmVjb3JkaW5nICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5tYWluUHJvY2Vzcz8uaXNSdW5uaW5nKTtcbiAgfVxuXG4gIGFzeW5jIGludGVycnVwdCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGlmICh0aGlzLmlzUmVjb3JkaW5nKCkpIHtcbiAgICAgIGNvbnN0IGludGVycnVwdFByb21pc2UgPSB0aGlzLm1haW5Qcm9jZXNzLnN0b3AoZm9yY2UgPyAnU0lHVEVSTScgOiAnU0lHSU5UJyk7XG4gICAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGludGVycnVwdFByb21pc2U7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgJHtmb3JjZSA/ICd0ZXJtaW5hdGUnIDogJ2ludGVycnVwdCd9ICR7RkZNUEVHX0JJTkFSWX0uIGAgK1xuICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGZpbmlzaCAoKSB7XG4gICAgYXdhaXQgdGhpcy5pbnRlcnJ1cHQoKTtcbiAgICByZXR1cm4gdGhpcy5hdWRpb1BhdGg7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwICgpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMuYXVkaW9QYXRoKSkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHRoaXMuYXVkaW9QYXRoKTtcbiAgICB9XG4gIH1cbn1cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0UmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ30gYXVkaW9JbnB1dCAtIFRoZSBuYW1lIG9mIHRoZSBjb3JyZXNwb25kaW5nIGF1ZGlvIGlucHV0IGRldmljZSB0byB1c2UgZm9yIHRoZVxuICogY2FwdHVyZS4gVGhlIGZ1bGwgbGlzdCBvZiBjYXB0dXJlIGRldmljZXMgY291bGQgYmUgc2hvd24gdXNpbmcgYGZmbXBlZyAtZiBhdmZvdW5kYXRpb24gLWxpc3RfZGV2aWNlcyB0cnVlIC1pIFwiXCJgXG4gKiBUZXJtaW5hbCBjb21tYW5kLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBhdWRpb0NvZGVjIFthYWNdIC0gVGhlIG5hbWUgb2YgdGhlIGF1ZGlvIGNvZGVjLiBUaGUgQWR2YW5jZWQgQXVkaW8gQ29kZWMgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBhdWRpb0JpdHJhdGUgWzEyOGtdIC0gVGhlIGJpdHJhdGUgb2YgdGhlIHJlc3VsdGluZyBhdWRpbyBzdHJlYW0uIDEyOGsgYnkgZGVmYXVsdC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IGF1ZGlvQ2hhbm5lbHMgWzJdIC0gVGhlIGNvdW50IG9mIGF1ZGlvIGNoYW5uZWxzIGluIHRoZSByZXN1bHRpbmcgc3RyZWFtLiBTZXR0aW5nIGl0IHRvIGAxYFxuICogd2lsbCBjcmVhdGUgYSBzaW5nbGUgY2hhbm5lbCAobW9ubykgYXVkaW8gc3RyZWFtLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gYXVkaW9SYXRlIFs0NDEwMF0gLSBUaGUgc2FtcGxpbmcgcmF0ZSBvZiB0aGUgcmVzdWx0aW5nIGF1ZGlvIHN0cmVhbS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IHRpbWVMaW1pdCBbMTgwXSAtIFRoZSBtYXhpbXVtIHJlY29yZGluZyB0aW1lLCBpbiBzZWNvbmRzLlxuICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgMTgwLCB0aGUgbWF4aW11bSB2YWx1ZSBpcyA0MzIwMCAoMTIgaG91cnMpLlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gZm9yY2VSZXN0YXJ0IFtmYWxzZV0gLSBXaGV0aGVyIHRvIHJlc3RhcnQgYXVkaW8gY2FwdHVyZSBwcm9jZXNzIGZvcmNlZnVsbHkgd2hlblxuICogc3RhcnRSZWNvcmRpbmdBdWRpbyBpcyBjYWxsZWQgKGB0cnVlYCkgb3IgaWdub3JlIHRoZSBjYWxsIHVudGlsIHRoZSBjdXJyZW50IGF1ZGlvIHJlY29yZGluZyBpcyBjb21wbGV0ZWQuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmRzIHRoZSBnaXZlbiBoYXJkd2FyZSBhdWRpbyBpbnB1dCBpbnRvIGFuIC5tcDQgZmlsZS5cbiAqXG4gKiBAcGFyYW0gez9TdGFydFJlY29yZGluZ09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgYXZhaWxhYmxlIG9wdGlvbnMuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYXVkaW8gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0QXVkaW9SZWNvcmRpbmcgPSBhc3luYyBmdW5jdGlvbiBzdGFydEF1ZGlvUmVjb3JkaW5nIChvcHRpb25zID0ge30pIHtcbiAgaWYgKCF0aGlzLmlzRmVhdHVyZUVuYWJsZWQoQVVESU9fUkVDT1JEX0ZFQVRfTkFNRSkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQXVkaW8gY2FwdHVyZSBmZWF0dXJlIG11c3QgYmUgZW5hYmxlZCBvbiB0aGUgc2VydmVyIHNpZGUuIGAgK1xuICAgICAgYFBsZWFzZSBzZXQgJy0tcmVsYXhlZC1zZWN1cml0eScgb3IgJy0tYWxsb3ctaW5zZWN1cmUnIHdpdGggJyR7QVVESU9fUkVDT1JEX0ZFQVRfTkFNRX0nIG9wdGlvbi4gYCArXG4gICAgICBgUmVhZCBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9ibG9iL21hc3Rlci9kb2NzL2VuL3dyaXRpbmctcnVubmluZy1hcHBpdW0vc2VjdXJpdHkubWQgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICB0aW1lTGltaXQgPSBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyxcbiAgICBhdWRpb0lucHV0LFxuICAgIC8vIFVuZG9jdW1lbnRlZCBmZWF0dXJlXG4gICAgYXVkaW9Tb3VyY2UsXG4gICAgYXVkaW9Db2RlYyA9IERFRkFVTFRfQ09ERUMsXG4gICAgYXVkaW9CaXRyYXRlID0gREVGQVVMVF9CSVRSQVRFLFxuICAgIGF1ZGlvQ2hhbm5lbHMgPSBERUZBVUxUX0NIQU5ORUxTLFxuICAgIGF1ZGlvUmF0ZSA9IERFRkFVTFRfUkFURSxcbiAgICBmb3JjZVJlc3RhcnQsXG4gIH0gPSBvcHRpb25zO1xuXG4gIGlmICghYXVkaW9JbnB1dCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgbWFuZGF0b3J5IGF1ZGlvSW5wdXQgb3B0aW9uIGlzIG5vdCBwcm92aWRlZC4gUGxlYXNlIHNldCBpdCBgICtcbiAgICAgIGB0byBhIGNvcnJlY3QgdmFsdWUgKGUuIGcuICc6MScpLiBVc2UgJ2ZmbXBlZyAtZiBhdmZvdW5kYXRpb24gLWxpc3RfZGV2aWNlcyB0cnVlIC1pIFwiXCInIGAgK1xuICAgICAgYGNvbW1hbmQgdG8gbGlzdCBhdmFpbGFibGUgaW5wdXQgc291cmNlc2ApO1xuICB9XG5cbiAgaWYgKHRoaXMuX2F1ZGlvUmVjb3JkZXI/LmlzUmVjb3JkaW5nKCkpIHtcbiAgICBsb2cuaW5mbyhgVGhlcmUgaXMgYW4gYWN0aXZlIGF1ZGlvIHJlY29yZGluZyBwcm9jZXNzYCk7XG4gICAgaWYgKGZvcmNlUmVzdGFydCkge1xuICAgICAgbG9nLmluZm8oYFN0b3BwaW5nIGl0IGJlY2F1c2UgJ2ZvcmNlUmVzdGFydCcgb3B0aW9uIGlzIHNldCB0byB0cnVlYCk7XG4gICAgICBhd2FpdCB0aGlzLl9hdWRpb1JlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmluZm8oYERvaW5nIG5vdGhpbmcuIGAgK1xuICAgICAgICBgU2V0ICdmb3JjZVJlc3RhcnQnIG9wdGlvbiB0byB0cnVlIGlmIHlvdSdkIGxpa2UgdG8gc3RhcnQgYSBuZXcgYXVkaW8gcmVjb3JkaW5nIHNlc3Npb25gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cbiAgaWYgKHRoaXMuX2F1ZGlvUmVjb3JkZXIpIHtcbiAgICBhd2FpdCB0aGlzLl9hdWRpb1JlY29yZGVyLmNsZWFudXAoKTtcbiAgICB0aGlzLl9hdWRpb1JlY29yZGVyID0gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGF1ZGlvUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiBgYXBwaXVtXyR7dXRpbC51dWlkVjQoKS5zdWJzdHJpbmcoMCwgOCl9YCxcbiAgICBzdWZmaXg6IERFRkFVTFRfRVhULFxuICB9KTtcblxuICBjb25zdCBhdWRpb1JlY29yZGVyID0gbmV3IEF1ZGlvUmVjb3JkZXIoYXVkaW9JbnB1dCwgYXVkaW9QYXRoLCB7XG4gICAgYXVkaW9Tb3VyY2UsXG4gICAgYXVkaW9Db2RlYyxcbiAgICBhdWRpb0JpdHJhdGUsXG4gICAgYXVkaW9DaGFubmVscyxcbiAgICBhdWRpb1JhdGUsXG4gIH0pO1xuXG4gIGNvbnN0IHRpbWVvdXRTZWNvbmRzID0gcGFyc2VJbnQodGltZUxpbWl0LCAxMCk7XG4gIGlmIChpc05hTih0aW1lb3V0U2Vjb25kcykgfHwgdGltZW91dFNlY29uZHMgPiBNQVhfUkVDT1JESU5HX1RJTUVfU0VDIHx8IHRpbWVvdXRTZWNvbmRzIDw9IDApIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHRpbWVMaW1pdCB2YWx1ZSBtdXN0IGJlIGluIHJhbmdlIFsxLCAke01BWF9SRUNPUkRJTkdfVElNRV9TRUN9XSBzZWNvbmRzLiBgICtcbiAgICAgIGBUaGUgdmFsdWUgb2YgJyR7dGltZUxpbWl0fScgaGFzIGJlZW4gcGFzc2VkIGluc3RlYWQuYCk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IGF1ZGlvUmVjb3JkZXIuc3RhcnQodGltZW91dFNlY29uZHMpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgYXdhaXQgYXVkaW9SZWNvcmRlci5pbnRlcnJ1cHQodHJ1ZSk7XG4gICAgYXdhaXQgYXVkaW9SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhyb3cgZTtcbiAgfVxuICB0aGlzLl9hdWRpb1JlY29yZGVyID0gYXVkaW9SZWNvcmRlcjtcbn07XG5cbi8qKlxuICogU3RvcCByZWNvcmRpbmcgb2YgdGhlIGF1ZGlvIGlucHV0LiBJZiBubyBhdWRpbyByZWNvcmRpbmcgcHJvY2VzcyBpcyBydW5uaW5nIHRoZW5cbiAqIHRoZSBlbmRwb2ludCB3aWxsIHRyeSB0byBnZXQgdGhlIHJlY2VudGx5IHJlY29yZGVkIGZpbGUuXG4gKiBJZiBubyBwcmV2aW91c2x5IHJlY29yZGVkIGZpbGUgaXMgZm91bmQgYW5kIG5vIGFjdGl2ZSBhdWRpbyByZWNvcmRpbmdcbiAqIHByb2Nlc3NlcyBhcmUgcnVubmluZyB0aGVuIHRoZSBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcuXG4gKlxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcmVjb3JkZWQgbWVkaWEgZmlsZSBvciBhblxuICogZW1wdHkgc3RyaW5nIGlmIG5vIGF1ZGlvIHJlY29yZGluZyBoYXMgYmVlbiBzdGFydGVkIGJlZm9yZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgcmVjb3JkZWQgZmlsZS5cbiAqL1xuY29tbWFuZHMuc3RvcEF1ZGlvUmVjb3JkaW5nID0gYXN5bmMgZnVuY3Rpb24gc3RvcEF1ZGlvUmVjb3JkaW5nICgpIHtcbiAgaWYgKCF0aGlzLl9hdWRpb1JlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ0F1ZGlvIHJlY29yZGluZyBoYXMgbm90IGJlZW4gc3RhcnRlZC4gVGhlcmUgaXMgbm90aGluZyB0byBzdG9wJyk7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgbGV0IHJlc3VsdFBhdGg7XG4gIHRyeSB7XG4gICAgcmVzdWx0UGF0aCA9IGF3YWl0IHRoaXMuX2F1ZGlvUmVjb3JkZXIuZmluaXNoKCk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGAke0ZGTVBFR19CSU5BUll9IGhhcyBmYWlsZWQgYCArXG4gICAgICAgIGB0byBzdG9yZSB0aGUgYWN0dWFsIGF1ZGlvIHJlY29yZGluZyBhdCAnJHtyZXN1bHRQYXRofSdgKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBhd2FpdCB0aGlzLl9hdWRpb1JlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCB0aGlzLl9hdWRpb1JlY29yZGVyLmNsZWFudXAoKTtcbiAgICB0aGlzLl9hdWRpb1JlY29yZGVyID0gbnVsbDtcbiAgICB0aHJvdyBlO1xuICB9XG4gIHJldHVybiBhd2FpdCBlbmNvZGVCYXNlNjRPclVwbG9hZChyZXN1bHRQYXRoKTtcbn07XG5cblxuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvcmVjb3JkLWF1ZGlvLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
