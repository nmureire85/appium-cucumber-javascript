"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumRemoteDebugger = require("appium-remote-debugger");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

const WEBVIEW_BASE = `${_appiumIosDriver.WEBVIEW_WIN}_`;
let commands = {},
    helpers = {},
    extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.context);

extensions.closeAlertBeforeTest = async function closeAlertBeforeTest() {
  return true;
};

extensions.navToInitialWebview = async function navToInitialWebview() {
  if (this.useNewSafari()) {
    await this.typeAndNavToUrl();
  } else if (!this.isRealDevice() && this.opts.safari) {
    await this.navToViewThroughFavorites();
  } else {
    await this.navToViewWithTitle(/.*/);
  }
};

extensions.getLatestWebviewContextForTitle = async function getLatestWebviewContextForTitle(regExp) {
  const currentUrl = this.getCurrentUrl();

  const contexts = _lodash.default.filter(await this.getContextsAndViews(), 'view');

  if (currentUrl) {
    for (const ctx of contexts) {
      if ((ctx.view.url || '') === this.getCurrentUrl()) {
        return ctx.id;
      }
    }
  }

  for (const ctx of contexts) {
    if (ctx.view.title && regExp.test(ctx.view.title) || ctx.view.url && regExp.test(ctx.view.url)) {
      return ctx.id;
    }
  }
};

extensions.isWebContext = function isWebContext() {
  return !!this.curContext && this.curContext !== _appiumIosDriver.iosCommands.context.NATIVE_WIN;
};

extensions.isWebview = function isWebview() {
  return this.isWebContext();
};

extensions.getNewRemoteDebugger = async function getNewRemoteDebugger() {
  let socketPath;

  if (!this.isRealDevice()) {
    socketPath = await this.opts.device.getWebInspectorSocket();
  }

  return (0, _appiumRemoteDebugger.createRemoteDebugger)({
    bundleId: this.opts.bundleId,
    additionalBundleIds: this.opts.additionalWebviewBundleIds,
    isSafari: this.isSafari(),
    includeSafari: this.opts.includeSafariInWebviews,
    useNewSafari: this.useNewSafari(),
    pageLoadMs: this.pageLoadMs,
    platformVersion: this.opts.platformVersion,
    socketPath,
    remoteDebugProxy: this.opts.remoteDebugProxy,
    garbageCollectOnExecute: _appiumSupport.util.hasValue(this.opts.safariGarbageCollect) ? !!this.opts.safariGarbageCollect : false,
    udid: this.opts.udid,
    logAllCommunication: this.opts.safariLogAllCommunication,
    logAllCommunicationHexDump: this.opts.safariLogAllCommunicationHexDump,
    socketChunkSize: this.opts.safariSocketChunkSize,
    webInspectorMaxFrameLength: this.opts.safariWebInspectorMaxFrameLength
  }, this.isRealDevice());
};

commands.setContext = async function setContext(name, callback, skipReadyCheck) {
  function alreadyInContext(desired, current) {
    return desired === current || desired === null && current === _appiumIosDriver.NATIVE_WIN || desired === _appiumIosDriver.NATIVE_WIN && current === null;
  }

  function isNativeContext(context) {
    return context === _appiumIosDriver.NATIVE_WIN || context === null;
  }

  if (name && name.id) {
    name = name.id;
  }

  _logger.default.debug(`Attempting to set context to '${name || _appiumIosDriver.NATIVE_WIN}' from '${this.curContext ? this.curContext : _appiumIosDriver.NATIVE_WIN}'`);

  if (alreadyInContext(name, this.curContext) || alreadyInContext(_lodash.default.replace(name, WEBVIEW_BASE, ''), this.curContext)) {
    _logger.default.debug(`Already in '${name || _appiumIosDriver.NATIVE_WIN}' context. Doing nothing.`);

    return;
  }

  if (isNativeContext(name)) {
    this.curContext = null;
    return;
  }

  if (_lodash.default.isUndefined(this.contexts)) {
    await this.getContexts();
  }

  let contextId = _lodash.default.replace(name, WEBVIEW_BASE, '');

  if (contextId === '') {
    contextId = this.contexts[1];
  }

  if (!_lodash.default.includes(this.contexts, contextId)) {
    throw new _appiumBaseDriver.errors.NoSuchContextError();
  }

  const oldContext = this.curContext;
  this.curContext = this.curWindowHandle = contextId;

  const [appIdKey, pageIdKey] = _lodash.default.map(contextId.split('.'), id => parseInt(id, 10));

  try {
    this.selectingNewPage = true;
    await this.remote.selectPage(appIdKey, pageIdKey, skipReadyCheck);
  } catch (err) {
    this.curContext = this.curWindowHandle = oldContext;
    throw err;
  } finally {
    this.selectingNewPage = false;
  }

  if (this.opts.enablePerformanceLogging && this.remote) {
    _logger.default.debug(`Starting performance log on '${this.curContext}'`);

    this.logs.performance = new _appiumIosDriver.IOSPerformanceLog(this.remote);
    await this.logs.performance.startCapture();
  }

  if (name && name !== _appiumIosDriver.NATIVE_WIN && this.logs) {
    if (this.logs.safariConsole) {
      await this.remote.startConsole(this.logs.safariConsole.addLogLine.bind(this.logs.safariConsole));
    }

    if (this.logs.safariNetwork) {
      await this.remote.startNetwork(this.logs.safariNetwork.addLogLine.bind(this.logs.safariNetwork));
    }
  }
};

extensions.connectToRemoteDebugger = async function connectToRemoteDebugger() {
  this.remote = await this.getNewRemoteDebugger();
  this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));
  this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_FRAMES_DETACHED, () => {
    if (!_lodash.default.isEmpty(this.curWebFrames)) {
      _logger.default.debug(`Clearing ${_appiumSupport.util.pluralize('frame', this.curWebFrames.length, true)}: ${this.curWebFrames.join(', ')}`);
    }

    this.curWebFrames = [];
  });
  await this.remote.connect(this.opts.webviewConnectTimeout);
};

extensions.listWebFrames = async function listWebFrames(useUrl = true) {
  if (!this.opts.bundleId) {
    _logger.default.errorAndThrow('Cannot enter web frame without a bundle ID');
  }

  useUrl = useUrl && !this.isRealDevice() && !!this.getCurrentUrl();

  _logger.default.debug(`Selecting by url: ${useUrl} ${useUrl ? `(expected url: '${this.getCurrentUrl()}')` : ''}`);

  const currentUrl = useUrl ? this.getCurrentUrl() : undefined;
  let pageArray = [];

  const getWebviewPages = async () => {
    try {
      return await this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries, this.opts.ignoreAboutBlankUrl);
    } catch (err) {
      _logger.default.debug(`No available web pages: ${err.message}`);

      return [];
    }
  };

  if (this.remote && this.remote.appIdKey) {
    pageArray = await getWebviewPages();
  } else {
    if (!this.remote) {
      await this.connectToRemoteDebugger();
    }

    await this.remote.setConnectionKey();
    pageArray = await getWebviewPages();
    const alertErrorMsg = 'Close alert failed. Retry.';

    try {
      await (0, _asyncbox.retryInterval)(6, 1000, async () => {
        if (!(await this.closeAlertBeforeTest())) {
          throw new Error(alertErrorMsg);
        }
      });
    } catch (err) {
      if (err.message !== alertErrorMsg) {
        _logger.default.errorAndThrow(err);
      }
    }
  }

  if (pageArray.length === 0) {
    _logger.default.debug('No web frames found.');
  }

  return pageArray;
};

commands.getContexts = async function getContexts() {
  _logger.default.debug('Getting list of available contexts');

  const contexts = await this.getContextsAndViews(false);
  const mapFn = this.opts.fullContextList ? function (context) {
    return {
      id: context.id.toString(),
      title: context.view.title,
      url: context.view.url,
      bundleId: context.view.bundleId
    };
  } : context => context.id.toString();
  return contexts.map(mapFn);
};

extensions.mobileGetContexts = async function mobileGetContexts(opts = {}) {
  let {
    waitForWebviewMs = 0
  } = opts;

  if (!_lodash.default.isNumber(waitForWebviewMs)) {
    waitForWebviewMs = parseInt(waitForWebviewMs, 10);

    if (isNaN(waitForWebviewMs)) {
      waitForWebviewMs = 0;
    }
  }

  const curOpt = this.opts.fullContextList;
  this.opts.fullContextList = true;
  const timer = new _appiumSupport.timing.Timer().start();

  try {
    let contexts;

    do {
      contexts = await this.getContexts();

      if (contexts.length >= 2) {
        _logger.default.debug(`Found webview context after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

        return contexts;
      }

      _logger.default.debug(`No webviews found in ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    } while (timer.getDuration().asMilliSeconds < waitForWebviewMs);

    return contexts;
  } finally {
    this.opts.fullContextList = curOpt;
  }
};

commands.setWindow = async function setWindow(name, skipReadyCheck) {
  try {
    await this.setContext(name, _lodash.default.noop, skipReadyCheck);
  } catch (err) {
    throw (0, _appiumBaseDriver.isErrorType)(err, _appiumBaseDriver.errors.NoSuchContextError) ? new _appiumBaseDriver.errors.NoSuchWindowError() : err;
  }
};

commands.getWindowHandle = async function getWindowHandle() {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotImplementedError();
  }

  _logger.default.debug(`Getting current window handle`);

  return this.curContext;
};

commands.getWindowHandles = async function getWindowHandles() {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotImplementedError();
  }

  _logger.default.debug('Getting list of available window handles');

  const contexts = await this.getContextsAndViews(false);
  return contexts.filter(context => context.id !== _appiumIosDriver.NATIVE_WIN).map(context => context.view.id.toString());
};

extensions.onPageChange = async function onPageChange(pageChangeNotification) {
  _logger.default.debug(`Remote debugger notified us of a new page listing: ${JSON.stringify(pageChangeNotification)}`);

  if (this.selectingNewPage) {
    _logger.default.debug('We are in the middle of selecting a page, ignoring');

    return;
  }

  if (!this.remote || !this.remote.isConnected) {
    _logger.default.debug('We have not yet connected, ignoring');

    return;
  }

  const {
    appIdKey,
    pageArray
  } = pageChangeNotification;
  let newIds = [];
  let newPages = [];
  let keyId = null;

  for (const page of pageArray) {
    const id = page.id.toString();
    newIds.push(id);

    if (page.isKey) {
      keyId = id;
    }

    const contextId = `${appIdKey}.${id}`;

    if (!_lodash.default.includes(this.contexts, contextId)) {
      newPages.push(id);
      this.contexts.push(contextId);
    }
  }

  if (!keyId) {
    _logger.default.debug('No key id found. Choosing first id from page array');

    keyId = newIds[0] || null;
  }

  if (!_appiumSupport.util.hasValue(this.curContext)) {
    _logger.default.debug('We do not appear to have window set yet, ignoring');

    return;
  }

  const [curAppIdKey, curPageIdKey] = this.curContext.split('.');

  if (curAppIdKey !== appIdKey) {
    _logger.default.debug('Page change not referring to currently selected app, ignoring.');

    return;
  }

  let newPage = null;

  if (newPages.length) {
    newPage = _lodash.default.last(newPages);

    _logger.default.debug(`We have new pages, selecting page '${newPage}'`);
  } else if (!_lodash.default.includes(newIds, curPageIdKey)) {
    _logger.default.debug('New page listing from remote debugger does not contain ' + 'current window; assuming it is closed');

    if (!_appiumSupport.util.hasValue(keyId)) {
      _logger.default.error('Do not have our current window anymore, and there ' + 'are not any more to load! Doing nothing...');

      this.setCurrentUrl(undefined);
      return;
    }

    _logger.default.debug(`Debugger already selected page '${keyId}', ` + `confirming that choice.`);

    this.curContext = `${appIdKey}.${keyId}`;
    newPage = keyId;
  } else {
    _logger.default.debug('Checking if page needs to load');

    const needsPageLoad = (() => {
      const contextArray = _lodash.default.map(pageArray, page => `${appIdKey}.${page.id}`);

      return !_lodash.default.isEqual(_lodash.default.find(this.contexts, this.curContext), _lodash.default.find(contextArray, this.curContext));
    })();

    if (needsPageLoad) {
      _logger.default.debug('Page load needed. Loading...');

      await this.remote.pageLoad();
    }

    _logger.default.debug('New page listing is same as old, doing nothing');
  }

  if (_appiumSupport.util.hasValue(this.curContext)) {
    let currentPageId = parseInt(_lodash.default.last(this.curContext.split('.')), 10);

    let page = _lodash.default.find(pageArray, p => parseInt(p.id, 10) === currentPageId);

    if (page && page.url !== this.getCurrentUrl()) {
      _logger.default.debug(`Redirected from '${this.getCurrentUrl()}' to '${page.url}'`);

      this.setCurrentUrl(page.url);
    }
  }

  if (_appiumSupport.util.hasValue(newPage)) {
    this.selectingNewPage = true;
    const oldContext = this.curContext;
    this.curContext = `${appIdKey}.${newPage}`;
    this.remote.selectPage(appIdKey, parseInt(newPage, 10)).catch(err => {
      _logger.default.warn(`Failed to select page: ${err.message}`);

      this.curContext = oldContext;
    });
    this.selectingNewPage = false;
  }

  this.windowHandleCache = pageArray;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbIldFQlZJRVdfQkFTRSIsIldFQlZJRVdfV0lOIiwiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImlvc0NvbW1hbmRzIiwiY29udGV4dCIsImNsb3NlQWxlcnRCZWZvcmVUZXN0IiwibmF2VG9Jbml0aWFsV2VidmlldyIsInVzZU5ld1NhZmFyaSIsInR5cGVBbmROYXZUb1VybCIsImlzUmVhbERldmljZSIsIm9wdHMiLCJzYWZhcmkiLCJuYXZUb1ZpZXdUaHJvdWdoRmF2b3JpdGVzIiwibmF2VG9WaWV3V2l0aFRpdGxlIiwiZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSIsInJlZ0V4cCIsImN1cnJlbnRVcmwiLCJnZXRDdXJyZW50VXJsIiwiY29udGV4dHMiLCJfIiwiZmlsdGVyIiwiZ2V0Q29udGV4dHNBbmRWaWV3cyIsImN0eCIsInZpZXciLCJ1cmwiLCJpZCIsInRpdGxlIiwidGVzdCIsImlzV2ViQ29udGV4dCIsImN1ckNvbnRleHQiLCJOQVRJVkVfV0lOIiwiaXNXZWJ2aWV3IiwiZ2V0TmV3UmVtb3RlRGVidWdnZXIiLCJzb2NrZXRQYXRoIiwiZGV2aWNlIiwiZ2V0V2ViSW5zcGVjdG9yU29ja2V0IiwiYnVuZGxlSWQiLCJhZGRpdGlvbmFsQnVuZGxlSWRzIiwiYWRkaXRpb25hbFdlYnZpZXdCdW5kbGVJZHMiLCJpc1NhZmFyaSIsImluY2x1ZGVTYWZhcmkiLCJpbmNsdWRlU2FmYXJpSW5XZWJ2aWV3cyIsInBhZ2VMb2FkTXMiLCJwbGF0Zm9ybVZlcnNpb24iLCJyZW1vdGVEZWJ1Z1Byb3h5IiwiZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUiLCJ1dGlsIiwiaGFzVmFsdWUiLCJzYWZhcmlHYXJiYWdlQ29sbGVjdCIsInVkaWQiLCJsb2dBbGxDb21tdW5pY2F0aW9uIiwic2FmYXJpTG9nQWxsQ29tbXVuaWNhdGlvbiIsImxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wIiwic2FmYXJpTG9nQWxsQ29tbXVuaWNhdGlvbkhleER1bXAiLCJzb2NrZXRDaHVua1NpemUiLCJzYWZhcmlTb2NrZXRDaHVua1NpemUiLCJ3ZWJJbnNwZWN0b3JNYXhGcmFtZUxlbmd0aCIsInNhZmFyaVdlYkluc3BlY3Rvck1heEZyYW1lTGVuZ3RoIiwic2V0Q29udGV4dCIsIm5hbWUiLCJjYWxsYmFjayIsInNraXBSZWFkeUNoZWNrIiwiYWxyZWFkeUluQ29udGV4dCIsImRlc2lyZWQiLCJjdXJyZW50IiwiaXNOYXRpdmVDb250ZXh0IiwibG9nIiwiZGVidWciLCJyZXBsYWNlIiwiaXNVbmRlZmluZWQiLCJnZXRDb250ZXh0cyIsImNvbnRleHRJZCIsImluY2x1ZGVzIiwiZXJyb3JzIiwiTm9TdWNoQ29udGV4dEVycm9yIiwib2xkQ29udGV4dCIsImN1cldpbmRvd0hhbmRsZSIsImFwcElkS2V5IiwicGFnZUlkS2V5IiwibWFwIiwic3BsaXQiLCJwYXJzZUludCIsInNlbGVjdGluZ05ld1BhZ2UiLCJyZW1vdGUiLCJzZWxlY3RQYWdlIiwiZXJyIiwiZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nIiwibG9ncyIsInBlcmZvcm1hbmNlIiwiSU9TUGVyZm9ybWFuY2VMb2ciLCJzdGFydENhcHR1cmUiLCJzYWZhcmlDb25zb2xlIiwic3RhcnRDb25zb2xlIiwiYWRkTG9nTGluZSIsImJpbmQiLCJzYWZhcmlOZXR3b3JrIiwic3RhcnROZXR3b3JrIiwiY29ubmVjdFRvUmVtb3RlRGVidWdnZXIiLCJvbiIsIlJlbW90ZURlYnVnZ2VyIiwiRVZFTlRfUEFHRV9DSEFOR0UiLCJvblBhZ2VDaGFuZ2UiLCJFVkVOVF9GUkFNRVNfREVUQUNIRUQiLCJpc0VtcHR5IiwiY3VyV2ViRnJhbWVzIiwicGx1cmFsaXplIiwibGVuZ3RoIiwiam9pbiIsImNvbm5lY3QiLCJ3ZWJ2aWV3Q29ubmVjdFRpbWVvdXQiLCJsaXN0V2ViRnJhbWVzIiwidXNlVXJsIiwiZXJyb3JBbmRUaHJvdyIsInVuZGVmaW5lZCIsInBhZ2VBcnJheSIsImdldFdlYnZpZXdQYWdlcyIsInNlbGVjdEFwcCIsIndlYnZpZXdDb25uZWN0UmV0cmllcyIsImlnbm9yZUFib3V0QmxhbmtVcmwiLCJtZXNzYWdlIiwic2V0Q29ubmVjdGlvbktleSIsImFsZXJ0RXJyb3JNc2ciLCJFcnJvciIsIm1hcEZuIiwiZnVsbENvbnRleHRMaXN0IiwidG9TdHJpbmciLCJtb2JpbGVHZXRDb250ZXh0cyIsIndhaXRGb3JXZWJ2aWV3TXMiLCJpc051bWJlciIsImlzTmFOIiwiY3VyT3B0IiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJzZXRXaW5kb3ciLCJub29wIiwiTm9TdWNoV2luZG93RXJyb3IiLCJnZXRXaW5kb3dIYW5kbGUiLCJOb3RJbXBsZW1lbnRlZEVycm9yIiwiZ2V0V2luZG93SGFuZGxlcyIsInBhZ2VDaGFuZ2VOb3RpZmljYXRpb24iLCJKU09OIiwic3RyaW5naWZ5IiwiaXNDb25uZWN0ZWQiLCJuZXdJZHMiLCJuZXdQYWdlcyIsImtleUlkIiwicGFnZSIsInB1c2giLCJpc0tleSIsImN1ckFwcElkS2V5IiwiY3VyUGFnZUlkS2V5IiwibmV3UGFnZSIsImxhc3QiLCJlcnJvciIsInNldEN1cnJlbnRVcmwiLCJuZWVkc1BhZ2VMb2FkIiwiY29udGV4dEFycmF5IiwiaXNFcXVhbCIsImZpbmQiLCJwYWdlTG9hZCIsImN1cnJlbnRQYWdlSWQiLCJwIiwiY2F0Y2giLCJ3YXJuIiwid2luZG93SGFuZGxlQ2FjaGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsWUFBWSxHQUFJLEdBQUVDLDRCQUFZLEdBQXBDO0FBRUEsSUFBSUMsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxF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LEVBQVAsQ0FBUixLQUF1QjRJLGFBQWhELENBQVg7O0FBQ0EsUUFBSWQsSUFBSSxJQUFJQSxJQUFJLENBQUMvSCxHQUFMLEtBQWEsS0FBS1AsYUFBTCxFQUF6QixFQUErQztBQUM3Q2lELHNCQUFJQyxLQUFKLENBQVcsb0JBQW1CLEtBQUtsRCxhQUFMLEVBQXFCLFNBQVFzSSxJQUFJLENBQUMvSCxHQUFJLEdBQXBFOztBQUNBLFdBQUt1SSxhQUFMLENBQW1CUixJQUFJLENBQUMvSCxHQUF4QjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSXNCLG9CQUFLQyxRQUFMLENBQWM2RyxPQUFkLENBQUosRUFBNEI7QUFDMUIsU0FBSzFFLGdCQUFMLEdBQXdCLElBQXhCO0FBQ0EsVUFBTVAsVUFBVSxHQUFHLEtBQUs5QyxVQUF4QjtBQUNBLFNBQUtBLFVBQUwsR0FBbUIsR0FBRWdELFFBQVMsSUFBRytFLE9BQVEsRUFBekM7QUFFQSxTQUFLekUsTUFBTCxDQUFZQyxVQUFaLENBQXVCUCxRQUF2QixFQUFpQ0ksUUFBUSxDQUFDMkUsT0FBRCxFQUFVLEVBQVYsQ0FBekMsRUFDR1csS0FESCxDQUNVbEYsR0FBRCxJQUFTO0FBQ2RuQixzQkFBSXNHLElBQUosQ0FBVSwwQkFBeUJuRixHQUFHLENBQUNrQyxPQUFRLEVBQS9DOztBQUNBLFdBQUsxRixVQUFMLEdBQWtCOEMsVUFBbEI7QUFDRCxLQUpIO0FBS0EsU0FBS08sZ0JBQUwsR0FBd0IsS0FBeEI7QUFDRDs7QUFDRCxPQUFLdUYsaUJBQUwsR0FBeUJ2RCxTQUF6QjtBQUNELENBaEhEOztBQW1IQWpILE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFDZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlvc0NvbW1hbmRzLCBJT1NQZXJmb3JtYW5jZUxvZywgTkFUSVZFX1dJTiwgV0VCVklFV19XSU4gfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBjcmVhdGVSZW1vdGVEZWJ1Z2dlciwgUmVtb3RlRGVidWdnZXIgfSBmcm9tICdhcHBpdW0tcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCB7IGVycm9ycywgaXNFcnJvclR5cGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgdXRpbCwgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuY29uc3QgV0VCVklFV19CQVNFID0gYCR7V0VCVklFV19XSU59X2A7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBpb3NDb21tYW5kcy5jb250ZXh0KTtcblxuLy8gb3ZlcnJpZGUsIGFzIGFwcGl1bS1pb3MtZHJpdmVyJ3MgdmVyc2lvbiB1c2VzIFVJIEF1dG9tYXRpb24gdG8gY2xvc2VcbmV4dGVuc2lvbnMuY2xvc2VBbGVydEJlZm9yZVRlc3QgPSBhc3luYyBmdW5jdGlvbiBjbG9zZUFsZXJ0QmVmb3JlVGVzdCAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbi8vIHRoZSBhcHBpdW0taW9zLWRyaXZlciB2ZXJzaW9uIGhhcyBhIHdhaXQgb24gcmVhbCBkZXZpY2VzLCB3aGljaCBpcyBubyBsb25nZXJcbi8vIG5lY2Vzc2FyeVxuZXh0ZW5zaW9ucy5uYXZUb0luaXRpYWxXZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gbmF2VG9Jbml0aWFsV2VidmlldyAoKSB7XG4gIGlmICh0aGlzLnVzZU5ld1NhZmFyaSgpKSB7XG4gICAgYXdhaXQgdGhpcy50eXBlQW5kTmF2VG9VcmwoKTtcbiAgfSBlbHNlIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSAmJiB0aGlzLm9wdHMuc2FmYXJpKSB7XG4gICAgYXdhaXQgdGhpcy5uYXZUb1ZpZXdUaHJvdWdoRmF2b3JpdGVzKCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5uYXZUb1ZpZXdXaXRoVGl0bGUoLy4qLyk7XG4gIH1cbn07XG5cbi8vIHRoZSBhcHBpdW0taW9zLWRyaXZlciB2ZXJzaW9uIG9mIHRoaXMgZnVuY3Rpb24gZmFpbHMgaW4gQ0ksXG4vLyBhbmQgdGhlIHdyb25nIHdlYnZpZXcgaXMgYWxtb3N0IGFsd2F5cyByZXRyaWV2ZWRcbi8vIGFsc28gb3ZlcnJpZGUgc28gdGhhdCB0aGUgY2FzZSB3aGVyZSB0aGUgU0RLIHZlcnNpb24gaXMgbm90IHNldCBkb2VzIG5vdCBmYWlsXG5leHRlbnNpb25zLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUgPSBhc3luYyBmdW5jdGlvbiBnZXRMYXRlc3RXZWJ2aWV3Q29udGV4dEZvclRpdGxlIChyZWdFeHApIHtcbiAgY29uc3QgY3VycmVudFVybCA9IHRoaXMuZ2V0Q3VycmVudFVybCgpO1xuXG4gIGNvbnN0IGNvbnRleHRzID0gXy5maWx0ZXIoYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKCksICd2aWV3Jyk7XG5cbiAgaWYgKGN1cnJlbnRVcmwpIHtcbiAgICAvLyBmaXJzdCB0cnkgdG8gbWF0Y2ggYnkgY3VycmVudCB1cmxcbiAgICBmb3IgKGNvbnN0IGN0eCBvZiBjb250ZXh0cykge1xuICAgICAgaWYgKChjdHgudmlldy51cmwgfHwgJycpID09PSB0aGlzLmdldEN1cnJlbnRVcmwoKSkge1xuICAgICAgICByZXR1cm4gY3R4LmlkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGlmIG5vdCwgdHJ5IHRvIG1hdGNoIGJ5IHJlZ3VsYXIgZXhwcmVzc2lvblxuICBmb3IgKGNvbnN0IGN0eCBvZiBjb250ZXh0cykge1xuICAgIGlmICgoY3R4LnZpZXcudGl0bGUgJiYgcmVnRXhwLnRlc3QoY3R4LnZpZXcudGl0bGUpKSB8fCAoY3R4LnZpZXcudXJsICYmIHJlZ0V4cC50ZXN0KGN0eC52aWV3LnVybCkpKSB7XG4gICAgICByZXR1cm4gY3R4LmlkO1xuICAgIH1cbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5pc1dlYkNvbnRleHQgPSBmdW5jdGlvbiBpc1dlYkNvbnRleHQgKCkge1xuICByZXR1cm4gISF0aGlzLmN1ckNvbnRleHQgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBpb3NDb21tYW5kcy5jb250ZXh0Lk5BVElWRV9XSU47XG59O1xuXG5leHRlbnNpb25zLmlzV2VidmlldyA9IGZ1bmN0aW9uIGlzV2VidmlldyAoKSB7XG4gIHJldHVybiB0aGlzLmlzV2ViQ29udGV4dCgpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXROZXdSZW1vdGVEZWJ1Z2dlciA9IGFzeW5jIGZ1bmN0aW9uIGdldE5ld1JlbW90ZURlYnVnZ2VyICgpIHtcbiAgbGV0IHNvY2tldFBhdGg7XG4gIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHNvY2tldFBhdGggPSBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmdldFdlYkluc3BlY3RvclNvY2tldCgpO1xuICB9XG4gIHJldHVybiBjcmVhdGVSZW1vdGVEZWJ1Z2dlcih7XG4gICAgYnVuZGxlSWQ6IHRoaXMub3B0cy5idW5kbGVJZCxcbiAgICBhZGRpdGlvbmFsQnVuZGxlSWRzOiB0aGlzLm9wdHMuYWRkaXRpb25hbFdlYnZpZXdCdW5kbGVJZHMsXG4gICAgaXNTYWZhcmk6IHRoaXMuaXNTYWZhcmkoKSxcbiAgICBpbmNsdWRlU2FmYXJpOiB0aGlzLm9wdHMuaW5jbHVkZVNhZmFyaUluV2Vidmlld3MsXG4gICAgdXNlTmV3U2FmYXJpOiB0aGlzLnVzZU5ld1NhZmFyaSgpLFxuICAgIHBhZ2VMb2FkTXM6IHRoaXMucGFnZUxvYWRNcyxcbiAgICBwbGF0Zm9ybVZlcnNpb246IHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgc29ja2V0UGF0aCxcbiAgICByZW1vdGVEZWJ1Z1Byb3h5OiB0aGlzLm9wdHMucmVtb3RlRGVidWdQcm94eSxcbiAgICBnYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZTogdXRpbC5oYXNWYWx1ZSh0aGlzLm9wdHMuc2FmYXJpR2FyYmFnZUNvbGxlY3QpXG4gICAgICA/ICEhdGhpcy5vcHRzLnNhZmFyaUdhcmJhZ2VDb2xsZWN0XG4gICAgICA6IGZhbHNlLFxuICAgIHVkaWQ6IHRoaXMub3B0cy51ZGlkLFxuICAgIGxvZ0FsbENvbW11bmljYXRpb246IHRoaXMub3B0cy5zYWZhcmlMb2dBbGxDb21tdW5pY2F0aW9uLFxuICAgIGxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wOiB0aGlzLm9wdHMuc2FmYXJpTG9nQWxsQ29tbXVuaWNhdGlvbkhleER1bXAsXG4gICAgc29ja2V0Q2h1bmtTaXplOiB0aGlzLm9wdHMuc2FmYXJpU29ja2V0Q2h1bmtTaXplLFxuICAgIHdlYkluc3BlY3Rvck1heEZyYW1lTGVuZ3RoOiB0aGlzLm9wdHMuc2FmYXJpV2ViSW5zcGVjdG9yTWF4RnJhbWVMZW5ndGhcbiAgfSwgdGhpcy5pc1JlYWxEZXZpY2UoKSk7XG59O1xuXG4vKipcbiAqIFNldCBjb250ZXh0XG4gKlxuICogQHBhcmFtIHs/c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgY29udGV4dCB0byBzZXQuIEl0IGNvdWxkIGJlICdudWxsJyBhcyBOQVRJVkVfV0lOLlxuICogQHBhcmFtIHtjYWxsYmFja30gY2FsbGJhY2sgVGhlIGNhbGxiYWNrLiAoSXQgaXMgbm90IGNhbGxlZCBpbiB0aGlzIG1ldGhvZClcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gc2tpcFJlYWR5Q2hlY2sgLSBXaGV0aGVyIGl0IHdhaXRzIGZvciB0aGUgbmV3IGNvbnRleHQgaXMgcmVhZHlcbiAqL1xuY29tbWFuZHMuc2V0Q29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uIHNldENvbnRleHQgKG5hbWUsIGNhbGxiYWNrLCBza2lwUmVhZHlDaGVjaykge1xuICBmdW5jdGlvbiBhbHJlYWR5SW5Db250ZXh0IChkZXNpcmVkLCBjdXJyZW50KSB7XG4gICAgcmV0dXJuIChkZXNpcmVkID09PSBjdXJyZW50IHx8XG4gICAgICAgICAgIChkZXNpcmVkID09PSBudWxsICYmIGN1cnJlbnQgPT09IE5BVElWRV9XSU4pIHx8XG4gICAgICAgICAgIChkZXNpcmVkID09PSBOQVRJVkVfV0lOICYmIGN1cnJlbnQgPT09IG51bGwpKTtcbiAgfVxuICBmdW5jdGlvbiBpc05hdGl2ZUNvbnRleHQgKGNvbnRleHQpIHtcbiAgICByZXR1cm4gY29udGV4dCA9PT0gTkFUSVZFX1dJTiB8fCBjb250ZXh0ID09PSBudWxsO1xuICB9XG5cbiAgLy8gYWxsb3cgdGhlIGZ1bGwgY29udGV4dCBsaXN0IHRvIGJlIHBhc3NlZCBpblxuICBpZiAobmFtZSAmJiBuYW1lLmlkKSB7XG4gICAgbmFtZSA9IG5hbWUuaWQ7XG4gIH1cblxuICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gc2V0IGNvbnRleHQgdG8gJyR7bmFtZSB8fCBOQVRJVkVfV0lOfScgZnJvbSAnJHt0aGlzLmN1ckNvbnRleHQgPyB0aGlzLmN1ckNvbnRleHQgOiBOQVRJVkVfV0lOfSdgKTtcblxuICBpZiAoYWxyZWFkeUluQ29udGV4dChuYW1lLCB0aGlzLmN1ckNvbnRleHQpIHx8IGFscmVhZHlJbkNvbnRleHQoXy5yZXBsYWNlKG5hbWUsIFdFQlZJRVdfQkFTRSwgJycpLCB0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgLy8gYWxyZWFkeSBpbiB0aGUgbmFtZWQgY29udGV4dCwgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGxvZy5kZWJ1ZyhgQWxyZWFkeSBpbiAnJHtuYW1lIHx8IE5BVElWRV9XSU59JyBjb250ZXh0LiBEb2luZyBub3RoaW5nLmApO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoaXNOYXRpdmVDb250ZXh0KG5hbWUpKSB7XG4gICAgLy8gc3dpdGNoaW5nIGludG8gdGhlIG5hdGl2ZSBjb250ZXh0XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gbnVsbDtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBzd2l0Y2hpbmcgaW50byBhIHdlYnZpZXcgY29udGV4dFxuXG4gIC8vIGlmIGNvbnRleHRzIGhhdmUgbm90IGFscmVhZHkgYmVlbiByZXRyaWV2ZWQsIGdldCB0aGVtXG4gIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMuY29udGV4dHMpKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRDb250ZXh0cygpO1xuICB9XG5cbiAgbGV0IGNvbnRleHRJZCA9IF8ucmVwbGFjZShuYW1lLCBXRUJWSUVXX0JBU0UsICcnKTtcbiAgaWYgKGNvbnRleHRJZCA9PT0gJycpIHtcbiAgICAvLyBhbGxvdyB1c2VyIHRvIHBhc3MgaW4gXCJXRUJWSUVXXCIgd2l0aG91dCBhbiBpbmRleFxuICAgIC8vIHRoZSBzZWNvbmQgY29udGV4dCB3aWxsIGJlIHRoZSBmaXJzdCB3ZWJ2aWV3IGFzXG4gICAgLy8gdGhlIGZpcnN0IGlzIGFsd2F5cyBOQVRJVkVfQVBQXG4gICAgY29udGV4dElkID0gdGhpcy5jb250ZXh0c1sxXTtcbiAgfVxuICBpZiAoIV8uaW5jbHVkZXModGhpcy5jb250ZXh0cywgY29udGV4dElkKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoQ29udGV4dEVycm9yKCk7XG4gIH1cblxuICBjb25zdCBvbGRDb250ZXh0ID0gdGhpcy5jdXJDb250ZXh0O1xuICB0aGlzLmN1ckNvbnRleHQgPSB0aGlzLmN1cldpbmRvd0hhbmRsZSA9IGNvbnRleHRJZDtcblxuICAvLyBgY29udGV4dElkYCB3aWxsIGJlIGluIHRoZSBmb3JtIG9mIGBhcHBJZC5wYWdlSWRgIGluIHRoaXMgY2FzZVxuICBjb25zdCBbYXBwSWRLZXksIHBhZ2VJZEtleV0gPSBfLm1hcChjb250ZXh0SWQuc3BsaXQoJy4nKSwgKGlkKSA9PiBwYXJzZUludChpZCwgMTApKTtcbiAgdHJ5IHtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UoYXBwSWRLZXksIHBhZ2VJZEtleSwgc2tpcFJlYWR5Q2hlY2spO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSB0aGlzLmN1cldpbmRvd0hhbmRsZSA9IG9sZENvbnRleHQ7XG4gICAgdGhyb3cgZXJyO1xuICB9IGZpbmFsbHkge1xuICAgIHRoaXMuc2VsZWN0aW5nTmV3UGFnZSA9IGZhbHNlO1xuICB9XG5cbiAgLy8gYXR0ZW1wdCB0byBzdGFydCBwZXJmb3JtYW5jZSBsb2dnaW5nLCBpZiByZXF1ZXN0ZWRcbiAgaWYgKHRoaXMub3B0cy5lbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmcgJiYgdGhpcy5yZW1vdGUpIHtcbiAgICBsb2cuZGVidWcoYFN0YXJ0aW5nIHBlcmZvcm1hbmNlIGxvZyBvbiAnJHt0aGlzLmN1ckNvbnRleHR9J2ApO1xuICAgIHRoaXMubG9ncy5wZXJmb3JtYW5jZSA9IG5ldyBJT1NQZXJmb3JtYW5jZUxvZyh0aGlzLnJlbW90ZSk7XG4gICAgYXdhaXQgdGhpcy5sb2dzLnBlcmZvcm1hbmNlLnN0YXJ0Q2FwdHVyZSgpO1xuICB9XG5cbiAgLy8gc3RhcnQgc2FmYXJpIGxvZ2dpbmcgaWYgdGhlIGxvZ3MgaGFuZGxlcnMgYXJlIGFjdGl2ZVxuICBpZiAobmFtZSAmJiBuYW1lICE9PSBOQVRJVkVfV0lOICYmIHRoaXMubG9ncykge1xuICAgIGlmICh0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSkge1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuc3RhcnRDb25zb2xlKHRoaXMubG9ncy5zYWZhcmlDb25zb2xlLmFkZExvZ0xpbmUuYmluZCh0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSkpO1xuICAgIH1cbiAgICBpZiAodGhpcy5sb2dzLnNhZmFyaU5ldHdvcmspIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLnN0YXJ0TmV0d29yayh0aGlzLmxvZ3Muc2FmYXJpTmV0d29yay5hZGRMb2dMaW5lLmJpbmQodGhpcy5sb2dzLnNhZmFyaU5ldHdvcmspKTtcbiAgICB9XG4gIH1cbn07XG5cbmV4dGVuc2lvbnMuY29ubmVjdFRvUmVtb3RlRGVidWdnZXIgPSBhc3luYyBmdW5jdGlvbiBjb25uZWN0VG9SZW1vdGVEZWJ1Z2dlciAoKSB7XG4gIHRoaXMucmVtb3RlID0gYXdhaXQgdGhpcy5nZXROZXdSZW1vdGVEZWJ1Z2dlcigpO1xuXG4gIHRoaXMucmVtb3RlLm9uKFJlbW90ZURlYnVnZ2VyLkVWRU5UX1BBR0VfQ0hBTkdFLCB0aGlzLm9uUGFnZUNoYW5nZS5iaW5kKHRoaXMpKTtcbiAgdGhpcy5yZW1vdGUub24oUmVtb3RlRGVidWdnZXIuRVZFTlRfRlJBTUVTX0RFVEFDSEVELCAoKSA9PiB7XG4gICAgaWYgKCFfLmlzRW1wdHkodGhpcy5jdXJXZWJGcmFtZXMpKSB7XG4gICAgICBsb2cuZGVidWcoYENsZWFyaW5nICR7dXRpbC5wbHVyYWxpemUoJ2ZyYW1lJywgdGhpcy5jdXJXZWJGcmFtZXMubGVuZ3RoLCB0cnVlKX06ICR7dGhpcy5jdXJXZWJGcmFtZXMuam9pbignLCAnKX1gKTtcbiAgICB9XG4gICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgfSk7XG5cbiAgYXdhaXQgdGhpcy5yZW1vdGUuY29ubmVjdCh0aGlzLm9wdHMud2Vidmlld0Nvbm5lY3RUaW1lb3V0KTtcbn07XG5cbmV4dGVuc2lvbnMubGlzdFdlYkZyYW1lcyA9IGFzeW5jIGZ1bmN0aW9uIGxpc3RXZWJGcmFtZXMgKHVzZVVybCA9IHRydWUpIHtcbiAgaWYgKCF0aGlzLm9wdHMuYnVuZGxlSWQpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ2Fubm90IGVudGVyIHdlYiBmcmFtZSB3aXRob3V0IGEgYnVuZGxlIElEJyk7XG4gIH1cblxuICB1c2VVcmwgPSB1c2VVcmwgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkgJiYgISF0aGlzLmdldEN1cnJlbnRVcmwoKTtcbiAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgYnkgdXJsOiAke3VzZVVybH0gJHt1c2VVcmwgPyBgKGV4cGVjdGVkIHVybDogJyR7dGhpcy5nZXRDdXJyZW50VXJsKCl9JylgIDogJyd9YCk7XG5cbiAgY29uc3QgY3VycmVudFVybCA9IHVzZVVybCA/IHRoaXMuZ2V0Q3VycmVudFVybCgpIDogdW5kZWZpbmVkO1xuICBsZXQgcGFnZUFycmF5ID0gW107XG4gIGNvbnN0IGdldFdlYnZpZXdQYWdlcyA9IGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdEFwcChjdXJyZW50VXJsLCB0aGlzLm9wdHMud2Vidmlld0Nvbm5lY3RSZXRyaWVzLCB0aGlzLm9wdHMuaWdub3JlQWJvdXRCbGFua1VybCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoYE5vIGF2YWlsYWJsZSB3ZWIgcGFnZXM6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9O1xuXG4gIGlmICh0aGlzLnJlbW90ZSAmJiB0aGlzLnJlbW90ZS5hcHBJZEtleSkge1xuICAgIC8vIGFscmVhZHkgY29ubmVjdGVkXG4gICAgcGFnZUFycmF5ID0gYXdhaXQgZ2V0V2Vidmlld1BhZ2VzKCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCF0aGlzLnJlbW90ZSkge1xuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0VG9SZW1vdGVEZWJ1Z2dlcigpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLnJlbW90ZS5zZXRDb25uZWN0aW9uS2V5KCk7XG5cbiAgICBwYWdlQXJyYXkgPSBhd2FpdCBnZXRXZWJ2aWV3UGFnZXMoKTtcblxuICAgIGNvbnN0IGFsZXJ0RXJyb3JNc2cgPSAnQ2xvc2UgYWxlcnQgZmFpbGVkLiBSZXRyeS4nO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDYsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKCFhd2FpdCB0aGlzLmNsb3NlQWxlcnRCZWZvcmVUZXN0KCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYWxlcnRFcnJvck1zZyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaWYgdGhlIGxvb3AgdG8gY2xvc2UgYWxlcnRzIGZhaWxlZCB0byBkaXNtaXNzLCBpZ25vcmUsXG4gICAgICAvLyBvdGhlcndpc2UgbG9nIGFuZCB0aHJvdyB0aGUgZXJyb3JcbiAgICAgIGlmIChlcnIubWVzc2FnZSAhPT0gYWxlcnRFcnJvck1zZykge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlcnIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChwYWdlQXJyYXkubGVuZ3RoID09PSAwKSB7XG4gICAgLy8gd2UgaGF2ZSBubyB3ZWIgZnJhbWVzLCBidXQgY29udGludWUgYW55d2F5XG4gICAgbG9nLmRlYnVnKCdObyB3ZWIgZnJhbWVzIGZvdW5kLicpO1xuICB9XG4gIHJldHVybiBwYWdlQXJyYXk7XG59O1xuXG5jb21tYW5kcy5nZXRDb250ZXh0cyA9IGFzeW5jIGZ1bmN0aW9uIGdldENvbnRleHRzICgpIHtcbiAgbG9nLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgYXZhaWxhYmxlIGNvbnRleHRzJyk7XG4gIGNvbnN0IGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKGZhbHNlKTtcblxuICBjb25zdCBtYXBGbiA9IHRoaXMub3B0cy5mdWxsQ29udGV4dExpc3RcbiAgICA/IGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogY29udGV4dC5pZC50b1N0cmluZygpLFxuICAgICAgICB0aXRsZTogY29udGV4dC52aWV3LnRpdGxlLFxuICAgICAgICB1cmw6IGNvbnRleHQudmlldy51cmwsXG4gICAgICAgIGJ1bmRsZUlkOiBjb250ZXh0LnZpZXcuYnVuZGxlSWQsXG4gICAgICB9O1xuICAgIH1cbiAgICA6IChjb250ZXh0KSA9PiBjb250ZXh0LmlkLnRvU3RyaW5nKCk7XG4gIHJldHVybiBjb250ZXh0cy5tYXAobWFwRm4pO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDb250ZXh0XG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGlkIC0gVGhlIGlkZW50aWZpZXIgb2YgdGhlIGNvbnRleHQuIFRoZSBuYXRpdmUgY29udGV4dFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgJ05BVElWRV9BUFAnIGFuZCB0aGUgd2Vidmlld3Mgd2lsbCBiZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICdXRUJWSUVXX3h4eCdcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdGl0bGUgLSBUaGUgdGl0bGUgYXNzb2NpYXRlZCB3aXRoIHRoZSB3ZWJ2aWV3IGNvbnRlbnRcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXJsIC0gVGhlIHVybCBhc3NvY2lhdGVkIHdpdGggdGhlIHdlYnZpZXcgY29udGVudFxuICovXG5cbi8qKlxuICogR2V0IHRoZSBjb250ZXh0cyBhdmFpbGFibGUsIHdpdGggaW5mb3JtYXRpb24gYWJvdXQgdGhlIHVybCBhbmQgdGl0bGUgb2YgZWFjaFxuICogd2Vidmlld1xuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIC0gT3B0aW9ucyBzZXQsIHdoaWNoIGNhbiBpbmNsdWRlIGB3YWl0Rm9yV2Vidmlld01zYCB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZ5IHRoZSBwZXJpb2QgdG8gcG9sbCBmb3IgYXZhaWxhYmxlIHdlYnZpZXdzXG4gKiBAcmV0dXJucyB7QXJyYXl9IExpc3Qgb2YgQ29udGV4dCBvYmplY3RzXG4gKi9cbmV4dGVuc2lvbnMubW9iaWxlR2V0Q29udGV4dHMgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVHZXRDb250ZXh0cyAob3B0cyA9IHt9KSB7XG4gIGxldCB7XG4gICAgd2FpdEZvcldlYnZpZXdNcyA9IDAsXG4gIH0gPSBvcHRzO1xuXG4gIC8vIG1ha2Ugc3VyZSBpdCBpcyBhIG51bWJlciwgc28gdGhlIGR1cmF0aW9uIGNoZWNrIHdvcmtzIHByb3Blcmx5XG4gIGlmICghXy5pc051bWJlcih3YWl0Rm9yV2Vidmlld01zKSkge1xuICAgIHdhaXRGb3JXZWJ2aWV3TXMgPSBwYXJzZUludCh3YWl0Rm9yV2Vidmlld01zLCAxMCk7XG4gICAgaWYgKGlzTmFOKHdhaXRGb3JXZWJ2aWV3TXMpKSB7XG4gICAgICB3YWl0Rm9yV2Vidmlld01zID0gMDtcbiAgICB9XG4gIH1cblxuICBjb25zdCBjdXJPcHQgPSB0aGlzLm9wdHMuZnVsbENvbnRleHRMaXN0O1xuICAvLyBgYXBwaXVtLWlvcy1kcml2ZXIjZ2V0Q29udGV4dHNgIHJldHVybnMgdGhlIGZ1bGwgbGlzdCBvZiBjb250ZXh0c1xuICAvLyBpZiB0aGlzIG9wdGlvbiBpcyBvblxuICB0aGlzLm9wdHMuZnVsbENvbnRleHRMaXN0ID0gdHJ1ZTtcblxuICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICB0cnkge1xuICAgIGxldCBjb250ZXh0cztcbiAgICBkbyB7XG4gICAgICBjb250ZXh0cyA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dHMoKTtcblxuICAgICAgaWYgKGNvbnRleHRzLmxlbmd0aCA+PSAyKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgd2VidmlldyBjb250ZXh0IGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgICAgIHJldHVybiBjb250ZXh0cztcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgTm8gd2Vidmlld3MgZm91bmQgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICB9IHdoaWxlICh0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzIDwgd2FpdEZvcldlYnZpZXdNcyk7XG4gICAgcmV0dXJuIGNvbnRleHRzO1xuICB9IGZpbmFsbHkge1xuICAgIC8vIHJlc2V0IHRoZSBvcHRpb24gc28gdGhlcmUgYXJlIG5vIHNpZGUgZWZmZWN0c1xuICAgIHRoaXMub3B0cy5mdWxsQ29udGV4dExpc3QgPSBjdXJPcHQ7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldFdpbmRvdyA9IGFzeW5jIGZ1bmN0aW9uIHNldFdpbmRvdyAobmFtZSwgc2tpcFJlYWR5Q2hlY2spIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnNldENvbnRleHQobmFtZSwgXy5ub29wLCBza2lwUmVhZHlDaGVjayk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIHRyYW5zbGF0ZSB0aGUgZXJyb3IgaW4gdGVybXMgb2Ygd2luZG93c1xuICAgIHRocm93IGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLk5vU3VjaENvbnRleHRFcnJvcilcbiAgICAgID8gbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcigpXG4gICAgICA6IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlID0gYXN5bmMgZnVuY3Rpb24gZ2V0V2luZG93SGFuZGxlICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgR2V0dGluZyBjdXJyZW50IHdpbmRvdyBoYW5kbGVgKTtcbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dDtcbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd0hhbmRsZXMgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dIYW5kbGVzICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgbG9nLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgYXZhaWxhYmxlIHdpbmRvdyBoYW5kbGVzJyk7XG4gIGNvbnN0IGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKGZhbHNlKTtcbiAgcmV0dXJuIGNvbnRleHRzXG4gICAgLy8gZ2V0IHJpZCBvZiB0aGUgbmF0aXZlIGFwcCBjb250ZXh0XG4gICAgLmZpbHRlcigoY29udGV4dCkgPT4gY29udGV4dC5pZCAhPT0gTkFUSVZFX1dJTilcbiAgICAvLyBnZXQgdGhlIGBhcHAuaWRgIGZvcm1hdCBleHBlY3RlZFxuICAgIC5tYXAoKGNvbnRleHQpID0+IGNvbnRleHQudmlldy5pZC50b1N0cmluZygpKTtcbn07XG5cbmV4dGVuc2lvbnMub25QYWdlQ2hhbmdlID0gYXN5bmMgZnVuY3Rpb24gb25QYWdlQ2hhbmdlIChwYWdlQ2hhbmdlTm90aWZpY2F0aW9uKSB7XG4gIGxvZy5kZWJ1ZyhgUmVtb3RlIGRlYnVnZ2VyIG5vdGlmaWVkIHVzIG9mIGEgbmV3IHBhZ2UgbGlzdGluZzogJHtKU09OLnN0cmluZ2lmeShwYWdlQ2hhbmdlTm90aWZpY2F0aW9uKX1gKTtcbiAgaWYgKHRoaXMuc2VsZWN0aW5nTmV3UGFnZSkge1xuICAgIGxvZy5kZWJ1ZygnV2UgYXJlIGluIHRoZSBtaWRkbGUgb2Ygc2VsZWN0aW5nIGEgcGFnZSwgaWdub3JpbmcnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKCF0aGlzLnJlbW90ZSB8fCAhdGhpcy5yZW1vdGUuaXNDb25uZWN0ZWQpIHtcbiAgICBsb2cuZGVidWcoJ1dlIGhhdmUgbm90IHlldCBjb25uZWN0ZWQsIGlnbm9yaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qge2FwcElkS2V5LCBwYWdlQXJyYXl9ID0gcGFnZUNoYW5nZU5vdGlmaWNhdGlvbjtcblxuICBsZXQgbmV3SWRzID0gW107XG4gIGxldCBuZXdQYWdlcyA9IFtdO1xuICBsZXQga2V5SWQgPSBudWxsO1xuICBmb3IgKGNvbnN0IHBhZ2Ugb2YgcGFnZUFycmF5KSB7XG4gICAgY29uc3QgaWQgPSBwYWdlLmlkLnRvU3RyaW5nKCk7XG4gICAgbmV3SWRzLnB1c2goaWQpO1xuICAgIGlmIChwYWdlLmlzS2V5KSB7XG4gICAgICBrZXlJZCA9IGlkO1xuICAgIH1cbiAgICBjb25zdCBjb250ZXh0SWQgPSBgJHthcHBJZEtleX0uJHtpZH1gO1xuXG4gICAgLy8gYWRkIGlmIHRoaXMgaXMgYSBuZXcgcGFnZVxuICAgIGlmICghXy5pbmNsdWRlcyh0aGlzLmNvbnRleHRzLCBjb250ZXh0SWQpKSB7XG4gICAgICBuZXdQYWdlcy5wdXNoKGlkKTtcbiAgICAgIHRoaXMuY29udGV4dHMucHVzaChjb250ZXh0SWQpO1xuICAgIH1cbiAgfVxuXG4gIGlmICgha2V5SWQpIHtcbiAgICAvLyBpZiB0aGVyZSBpcyBubyBrZXkgaWQsIHB1bGwgdGhlIGZpcnN0IGlkIGZyb20gdGhlIHBhZ2UgYXJyYXkgYW5kIHVzZSB0aGF0XG4gICAgLy8gYXMgYSBzdGFuZCBpblxuICAgIGxvZy5kZWJ1ZygnTm8ga2V5IGlkIGZvdW5kLiBDaG9vc2luZyBmaXJzdCBpZCBmcm9tIHBhZ2UgYXJyYXknKTtcbiAgICBrZXlJZCA9IG5ld0lkc1swXSB8fCBudWxsO1xuICB9XG5cbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKHRoaXMuY3VyQ29udGV4dCkpIHtcbiAgICBsb2cuZGVidWcoJ1dlIGRvIG5vdCBhcHBlYXIgdG8gaGF2ZSB3aW5kb3cgc2V0IHlldCwgaWdub3JpbmcnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBbY3VyQXBwSWRLZXksIGN1clBhZ2VJZEtleV0gPSB0aGlzLmN1ckNvbnRleHQuc3BsaXQoJy4nKTtcblxuICBpZiAoY3VyQXBwSWRLZXkgIT09IGFwcElkS2V5KSB7XG4gICAgbG9nLmRlYnVnKCdQYWdlIGNoYW5nZSBub3QgcmVmZXJyaW5nIHRvIGN1cnJlbnRseSBzZWxlY3RlZCBhcHAsIGlnbm9yaW5nLicpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCBuZXdQYWdlID0gbnVsbDtcbiAgaWYgKG5ld1BhZ2VzLmxlbmd0aCkge1xuICAgIG5ld1BhZ2UgPSBfLmxhc3QobmV3UGFnZXMpO1xuICAgIGxvZy5kZWJ1ZyhgV2UgaGF2ZSBuZXcgcGFnZXMsIHNlbGVjdGluZyBwYWdlICcke25ld1BhZ2V9J2ApO1xuICB9IGVsc2UgaWYgKCFfLmluY2x1ZGVzKG5ld0lkcywgY3VyUGFnZUlkS2V5KSkge1xuICAgIGxvZy5kZWJ1ZygnTmV3IHBhZ2UgbGlzdGluZyBmcm9tIHJlbW90ZSBkZWJ1Z2dlciBkb2VzIG5vdCBjb250YWluICcgK1xuICAgICAgICAgICAgICAgICAnY3VycmVudCB3aW5kb3c7IGFzc3VtaW5nIGl0IGlzIGNsb3NlZCcpO1xuICAgIGlmICghdXRpbC5oYXNWYWx1ZShrZXlJZCkpIHtcbiAgICAgIGxvZy5lcnJvcignRG8gbm90IGhhdmUgb3VyIGN1cnJlbnQgd2luZG93IGFueW1vcmUsIGFuZCB0aGVyZSAnICtcbiAgICAgICAgICAgICAgICAgICAnYXJlIG5vdCBhbnkgbW9yZSB0byBsb2FkISBEb2luZyBub3RoaW5nLi4uJyk7XG4gICAgICB0aGlzLnNldEN1cnJlbnRVcmwodW5kZWZpbmVkKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYERlYnVnZ2VyIGFscmVhZHkgc2VsZWN0ZWQgcGFnZSAnJHtrZXlJZH0nLCBgICtcbiAgICAgICAgICAgICAgICAgYGNvbmZpcm1pbmcgdGhhdCBjaG9pY2UuYCk7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gYCR7YXBwSWRLZXl9LiR7a2V5SWR9YDtcbiAgICBuZXdQYWdlID0ga2V5SWQ7XG4gIH0gZWxzZSB7XG4gICAgLy8gYXQgdGhpcyBwb2ludCwgdGhlcmUgYXJlIG5vIG5ldyBwYWdlcywgYW5kIHRoZSBjdXJyZW50IHBhZ2Ugc3RpbGwgZXhpc3RzXG4gICAgbG9nLmRlYnVnKCdDaGVja2luZyBpZiBwYWdlIG5lZWRzIHRvIGxvYWQnKTtcbiAgICAvLyBJZiBhIHdpbmRvdyBuYXZpZ2F0ZXMgdG8gYW4gYW5jaG9yIGl0IGRvZXNuJ3QgYWx3YXlzIGZpcmUgYSBwYWdlXG4gICAgLy8gY2FsbGJhY2sgZXZlbnQuIExldCdzIGNoZWNrIGlmIHdlIHdvdW5kIHVwIGluIHN1Y2ggYSBzaXR1YXRpb24uXG4gICAgY29uc3QgbmVlZHNQYWdlTG9hZCA9ICgoKSA9PiB7XG4gICAgICAvLyBuZWVkIHRvIG1hcCB0aGUgcGFnZSBpZHMgdG8gY29udGV4dCBpZHNcbiAgICAgIGNvbnN0IGNvbnRleHRBcnJheSA9IF8ubWFwKHBhZ2VBcnJheSwgKHBhZ2UpID0+IGAke2FwcElkS2V5fS4ke3BhZ2UuaWR9YCk7XG4gICAgICAvLyBjaGVjayBpZiB0aGUgY3VycmVudCBjb250ZXh0IGV4aXN0cyBpbiBib3RoIG91ciByZWNvcmRlZCBjb250ZXh0cyxcbiAgICAgIC8vIGFuZCB0aGUgcGFnZSBhcnJheVxuICAgICAgcmV0dXJuICFfLmlzRXF1YWwoXy5maW5kKHRoaXMuY29udGV4dHMsIHRoaXMuY3VyQ29udGV4dCksIF8uZmluZChjb250ZXh0QXJyYXksIHRoaXMuY3VyQ29udGV4dCkpO1xuICAgIH0pKCk7XG5cbiAgICBpZiAobmVlZHNQYWdlTG9hZCkge1xuICAgICAgbG9nLmRlYnVnKCdQYWdlIGxvYWQgbmVlZGVkLiBMb2FkaW5nLi4uJyk7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5wYWdlTG9hZCgpO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZygnTmV3IHBhZ2UgbGlzdGluZyBpcyBzYW1lIGFzIG9sZCwgZG9pbmcgbm90aGluZycpO1xuICB9XG5cbiAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIHBhZ2UgbGlzdGluZyBpc24ndCBpbmRpY2F0aW5nIGEgcmVkaXJlY3RcbiAgaWYgKHV0aWwuaGFzVmFsdWUodGhpcy5jdXJDb250ZXh0KSkge1xuICAgIGxldCBjdXJyZW50UGFnZUlkID0gcGFyc2VJbnQoXy5sYXN0KHRoaXMuY3VyQ29udGV4dC5zcGxpdCgnLicpKSwgMTApO1xuICAgIGxldCBwYWdlID0gXy5maW5kKHBhZ2VBcnJheSwgKHApID0+IHBhcnNlSW50KHAuaWQsIDEwKSA9PT0gY3VycmVudFBhZ2VJZCk7XG4gICAgaWYgKHBhZ2UgJiYgcGFnZS51cmwgIT09IHRoaXMuZ2V0Q3VycmVudFVybCgpKSB7XG4gICAgICBsb2cuZGVidWcoYFJlZGlyZWN0ZWQgZnJvbSAnJHt0aGlzLmdldEN1cnJlbnRVcmwoKX0nIHRvICcke3BhZ2UudXJsfSdgKTtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFVybChwYWdlLnVybCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHV0aWwuaGFzVmFsdWUobmV3UGFnZSkpIHtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSB0cnVlO1xuICAgIGNvbnN0IG9sZENvbnRleHQgPSB0aGlzLmN1ckNvbnRleHQ7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gYCR7YXBwSWRLZXl9LiR7bmV3UGFnZX1gO1xuICAgIC8vIGRvIG5vdCB3YWl0LCBhcyB0aGlzIGNhbiB0YWtlIGEgbG9uZyB0aW1lLCBhbmQgdGhlIHJlc3BvbnNlIGlzIG5vdCBuZWNlc3NhcnlcbiAgICB0aGlzLnJlbW90ZS5zZWxlY3RQYWdlKGFwcElkS2V5LCBwYXJzZUludChuZXdQYWdlLCAxMCkpXG4gICAgICAuY2F0Y2goKGVycikgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrc1xuICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIHNlbGVjdCBwYWdlOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICB0aGlzLmN1ckNvbnRleHQgPSBvbGRDb250ZXh0O1xuICAgICAgfSk7XG4gICAgdGhpcy5zZWxlY3RpbmdOZXdQYWdlID0gZmFsc2U7XG4gIH1cbiAgdGhpcy53aW5kb3dIYW5kbGVDYWNoZSA9IHBhZ2VBcnJheTtcbn07XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
