"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {};

function extractMandatoryOptions(opts = {}, keys) {
  const result = {};

  for (const key of keys) {
    const value = opts[key];

    if (!_lodash.default.isString(value) || _lodash.default.isEmpty(value)) {
      _logger.default.errorAndThrow(`'${key}' is expected to be a valid string. '${value}' is given instead`);
    }

    result[key] = value;
  }

  return result;
}

commands.mobileInstallApp = async function mobileInstallApp(opts = {}) {
  const {
    app
  } = extractMandatoryOptions(opts, ['app']);
  const dstPath = await this.helpers.configureApp(app, '.app');

  _logger.default.info(`Installing '${dstPath}' to the ${this.isRealDevice() ? 'real device' : 'Simulator'} ` + `with UDID '${this.opts.device.udid}'`);

  if (!(await _appiumSupport.fs.exists(dstPath))) {
    _logger.default.errorAndThrow(`The application at '${dstPath}' does not exist or is not accessible`);
  }

  await this.opts.device.installApp(dstPath, this.opts.appPushTimeout);

  _logger.default.info(`Installation of '${dstPath}' succeeded`);
};

commands.mobileIsAppInstalled = async function mobileIsAppInstalled(opts = {}) {
  const {
    bundleId
  } = extractMandatoryOptions(opts, ['bundleId']);
  const installed = await this.opts.device.isAppInstalled(bundleId);

  _logger.default.info(`App '${bundleId}' is${installed ? '' : ' not'} installed`);

  return installed;
};

commands.mobileRemoveApp = async function mobileRemoveApp(opts = {}) {
  const {
    bundleId
  } = extractMandatoryOptions(opts, ['bundleId']);

  _logger.default.info(`Uninstalling the application with bundle identifier '${bundleId}' ` + `from the ${this.isRealDevice() ? 'real device' : 'Simulator'} with UDID '${this.opts.device.udid}'`);

  try {
    await this.opts.device.removeApp(bundleId);

    _logger.default.info(`Removal of '${bundleId}' succeeded`);

    return true;
  } catch (err) {
    _logger.default.warn(`Cannot remove '${bundleId}'. Original error: ${err.message}`);

    return false;
  }
};

commands.mobileLaunchApp = async function mobileLaunchApp(opts = {}) {
  const wdaOpts = extractMandatoryOptions(opts, ['bundleId']);

  if (opts.arguments) {
    wdaOpts.arguments = _lodash.default.isArray(opts.arguments) ? opts.arguments : [opts.arguments];
  }

  if (opts.environment) {
    wdaOpts.environment = opts.environment;
  }

  return await this.proxyCommand('/wda/apps/launch', 'POST', wdaOpts);
};

commands.mobileTerminateApp = async function mobileTerminateApp(opts = {}) {
  return await this.proxyCommand('/wda/apps/terminate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.mobileActivateApp = async function mobileActivateApp(opts = {}) {
  return await this.proxyCommand('/wda/apps/activate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.mobileQueryAppState = async function mobileQueryAppState(opts = {}) {
  return await this.proxyCommand('/wda/apps/state', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.installApp = async function installApp(appPath) {
  await this.mobileInstallApp({
    app: appPath
  });
};

commands.activateApp = async function activateApp(bundleId, opts = {}) {
  return await this.mobileLaunchApp(Object.assign({}, opts, {
    bundleId
  }));
};

commands.isAppInstalled = async function isAppInstalled(bundleId) {
  return await this.mobileIsAppInstalled({
    bundleId
  });
};

commands.terminateApp = async function terminateApp(bundleId) {
  return await this.mobileTerminateApp({
    bundleId
  });
};

commands.queryAppState = async function queryAppState(bundleId) {
  return await this.mobileQueryAppState({
    bundleId
  });
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImV4dHJhY3RNYW5kYXRvcnlPcHRpb25zIiwib3B0cyIsImtleXMiLCJyZXN1bHQiLCJrZXkiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsImlzRW1wdHkiLCJsb2ciLCJlcnJvckFuZFRocm93IiwibW9iaWxlSW5zdGFsbEFwcCIsImFwcCIsImRzdFBhdGgiLCJoZWxwZXJzIiwiY29uZmlndXJlQXBwIiwiaW5mbyIsImlzUmVhbERldmljZSIsImRldmljZSIsInVkaWQiLCJmcyIsImV4aXN0cyIsImluc3RhbGxBcHAiLCJhcHBQdXNoVGltZW91dCIsIm1vYmlsZUlzQXBwSW5zdGFsbGVkIiwiYnVuZGxlSWQiLCJpbnN0YWxsZWQiLCJpc0FwcEluc3RhbGxlZCIsIm1vYmlsZVJlbW92ZUFwcCIsInJlbW92ZUFwcCIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwibW9iaWxlTGF1bmNoQXBwIiwid2RhT3B0cyIsImFyZ3VtZW50cyIsImlzQXJyYXkiLCJlbnZpcm9ubWVudCIsInByb3h5Q29tbWFuZCIsIm1vYmlsZVRlcm1pbmF0ZUFwcCIsIm1vYmlsZUFjdGl2YXRlQXBwIiwibW9iaWxlUXVlcnlBcHBTdGF0ZSIsImFwcFBhdGgiLCJhY3RpdmF0ZUFwcCIsIk9iamVjdCIsImFzc2lnbiIsInRlcm1pbmF0ZUFwcCIsInF1ZXJ5QXBwU3RhdGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUEsU0FBU0MsdUJBQVQsQ0FBa0NDLElBQUksR0FBRyxFQUF6QyxFQUE2Q0MsSUFBN0MsRUFBbUQ7QUFDakQsUUFBTUMsTUFBTSxHQUFHLEVBQWY7O0FBQ0EsT0FBSyxNQUFNQyxHQUFYLElBQWtCRixJQUFsQixFQUF3QjtBQUN0QixVQUFNRyxLQUFLLEdBQUdKLElBQUksQ0FBQ0csR0FBRCxDQUFs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J2xvZGFzaCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmZ1bmN0aW9uIGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zIChvcHRzID0ge30sIGtleXMpIHtcbiAgY29uc3QgcmVzdWx0ID0ge307XG4gIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICBjb25zdCB2YWx1ZSA9IG9wdHNba2V5XTtcbiAgICBpZiAoIV8uaXNTdHJpbmcodmFsdWUpIHx8IF8uaXNFbXB0eSh2YWx1ZSkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGAnJHtrZXl9JyBpcyBleHBlY3RlZCB0byBiZSBhIHZhbGlkIHN0cmluZy4gJyR7dmFsdWV9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gICAgfVxuICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuY29tbWFuZHMubW9iaWxlSW5zdGFsbEFwcCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUluc3RhbGxBcHAgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7YXBwfSA9IGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYXBwJ10pO1xuICBjb25zdCBkc3RQYXRoID0gYXdhaXQgdGhpcy5oZWxwZXJzLmNvbmZpZ3VyZUFwcChhcHAsICcuYXBwJyk7XG4gIGxvZy5pbmZvKGBJbnN0YWxsaW5nICcke2RzdFBhdGh9JyB0byB0aGUgJHt0aGlzLmlzUmVhbERldmljZSgpID8gJ3JlYWwgZGV2aWNlJyA6ICdTaW11bGF0b3InfSBgICtcbiAgICBgd2l0aCBVRElEICcke3RoaXMub3B0cy5kZXZpY2UudWRpZH0nYCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGRzdFBhdGgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBhcHBsaWNhdGlvbiBhdCAnJHtkc3RQYXRofScgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmluc3RhbGxBcHAoZHN0UGF0aCwgdGhpcy5vcHRzLmFwcFB1c2hUaW1lb3V0KTtcbiAgbG9nLmluZm8oYEluc3RhbGxhdGlvbiBvZiAnJHtkc3RQYXRofScgc3VjY2VlZGVkYCk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVJc0FwcEluc3RhbGxlZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUlzQXBwSW5zdGFsbGVkIChvcHRzID0ge30pIHtcbiAgY29uc3Qge2J1bmRsZUlkfSA9IGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSk7XG4gIGNvbnN0IGluc3RhbGxlZCA9IGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuaXNBcHBJbnN0YWxsZWQoYnVuZGxlSWQpO1xuICBsb2cuaW5mbyhgQXBwICcke2J1bmRsZUlkfScgaXMke2luc3RhbGxlZCA/ICcnIDogJyBub3QnfSBpbnN0YWxsZWRgKTtcbiAgcmV0dXJuIGluc3RhbGxlZDtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZVJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVJlbW92ZUFwcCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtidW5kbGVJZH0gPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pO1xuICBsb2cuaW5mbyhgVW5pbnN0YWxsaW5nIHRoZSBhcHBsaWNhdGlvbiB3aXRoIGJ1bmRsZSBpZGVudGlmaWVyICcke2J1bmRsZUlkfScgYCArXG4gICAgYGZyb20gdGhlICR7dGhpcy5pc1JlYWxEZXZpY2UoKSA/ICdyZWFsIGRldmljZScgOiAnU2ltdWxhdG9yJ30gd2l0aCBVRElEICcke3RoaXMub3B0cy5kZXZpY2UudWRpZH0nYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICAgIGxvZy5pbmZvKGBSZW1vdmFsIG9mICcke2J1bmRsZUlkfScgc3VjY2VlZGVkYCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgcmVtb3ZlICcke2J1bmRsZUlkfScuIE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcblxuY29tbWFuZHMubW9iaWxlTGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlTGF1bmNoQXBwIChvcHRzID0ge30pIHtcbiAgY29uc3Qgd2RhT3B0cyA9IGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSk7XG4gIGlmIChvcHRzLmFyZ3VtZW50cykge1xuICAgIHdkYU9wdHMuYXJndW1lbnRzID0gXy5pc0FycmF5KG9wdHMuYXJndW1lbnRzKSA/IG9wdHMuYXJndW1lbnRzIDogW29wdHMuYXJndW1lbnRzXTtcbiAgfVxuICBpZiAob3B0cy5lbnZpcm9ubWVudCkge1xuICAgIHdkYU9wdHMuZW52aXJvbm1lbnQgPSBvcHRzLmVudmlyb25tZW50O1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hcHBzL2xhdW5jaCcsICdQT1NUJywgd2RhT3B0cyk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVUZXJtaW5hdGVBcHAgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVUZXJtaW5hdGVBcHAgKG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYXBwcy90ZXJtaW5hdGUnLCAnUE9TVCcsIGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSkpO1xufTtcblxuY29tbWFuZHMubW9iaWxlQWN0aXZhdGVBcHAgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVBY3RpdmF0ZUFwcCAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hcHBzL2FjdGl2YXRlJywgJ1BPU1QnLCBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pKTtcbn07XG5cbi8qKlxuICogUmV0dXJucyB0aGUgY3VycmVudCBhcHBsaWNhdGlvbiBzdGF0ZVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIC0gT3B0aW9ucyBzZXQsIHdoaWNoIG11c3QgY29udGFpbiBgYnVuZGxlSWRgIHByb3BlcnR5XG4gKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgYWN0dWFsIGFwcGxpY2F0aW9uIHN0YXRlIGNvZGUuIFNlZVxuICogaHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2RvY3VtZW50YXRpb24veGN0ZXN0L3hjdWlhcHBsaWNhdGlvbnN0YXRlP2xhbmd1YWdlPW9iamNcbiAqIHRvIGdldCB0aGUgbGlzdCBvZiBwb3NzaWJsZSB2YWx1ZXMuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVF1ZXJ5QXBwU3RhdGUgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVRdWVyeUFwcFN0YXRlIChvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FwcHMvc3RhdGUnLCAnUE9TVCcsIGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSkpO1xufTtcblxuY29tbWFuZHMuaW5zdGFsbEFwcCA9IGFzeW5jIGZ1bmN0aW9uIGluc3RhbGxBcHAgKGFwcFBhdGgpIHtcbiAgYXdhaXQgdGhpcy5tb2JpbGVJbnN0YWxsQXBwKHthcHA6IGFwcFBhdGh9KTtcbn07XG5cbmNvbW1hbmRzLmFjdGl2YXRlQXBwID0gYXN5bmMgZnVuY3Rpb24gYWN0aXZhdGVBcHAgKGJ1bmRsZUlkLCBvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlTGF1bmNoQXBwKE9iamVjdC5hc3NpZ24oe30sIG9wdHMsIHtidW5kbGVJZH0pKTtcbn07XG5cbmNvbW1hbmRzLmlzQXBwSW5zdGFsbGVkID0gYXN5bmMgZnVuY3Rpb24gaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZUlzQXBwSW5zdGFsbGVkKHtidW5kbGVJZH0pO1xufTtcblxuY29tbWFuZHMudGVybWluYXRlQXBwID0gYXN5bmMgZnVuY3Rpb24gdGVybWluYXRlQXBwIChidW5kbGVJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVUZXJtaW5hdGVBcHAoe2J1bmRsZUlkfSk7XG59O1xuXG5jb21tYW5kcy5xdWVyeUFwcFN0YXRlID0gYXN5bmMgZnVuY3Rpb24gcXVlcnlBcHBTdGF0ZSAoYnVuZGxlSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlUXVlcnlBcHBTdGF0ZSh7YnVuZGxlSWR9KTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvYXBwLW1hbmFnZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
