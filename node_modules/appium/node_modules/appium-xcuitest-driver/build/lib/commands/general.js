"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.extensions = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _momentTimezone = _interopRequireDefault(require("moment-timezone"));

var _appiumIosDevice = require("appium-ios-device");

let commands = {},
    helpers = {},
    extensions = {};
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function active() {
  if (this.isWebContext()) {
    return await this.executeAtom('active_element', []);
  }

  return await this.proxyCommand(`/element/active`, 'GET');
};

commands.background = async function background(seconds) {
  const homescreen = '/wda/homescreen';
  const deactivateApp = '/wda/deactivateApp';
  let endpoint;
  let params = {};

  const selectEndpoint = timeoutSeconds => {
    if (!_appiumSupport.util.hasValue(timeoutSeconds)) {
      endpoint = homescreen;
    } else if (!isNaN(timeoutSeconds)) {
      const duration = parseFloat(timeoutSeconds);

      if (duration >= 0) {
        params = {
          duration
        };
        endpoint = deactivateApp;
      } else {
        endpoint = homescreen;
      }
    }
  };

  if (_lodash.default.has(seconds, 'timeout')) {
    const {
      timeout
    } = seconds;
    selectEndpoint(isNaN(timeout) ? timeout : parseFloat(timeout) / 1000.0);
  } else {
    selectEndpoint(seconds);
  }

  if (!endpoint) {
    _logger.default.errorAndThrow(`Argument value is expected to be a valid number. ` + `${JSON.stringify(seconds)} has been provided instead`);
  }

  return await this.proxyCommand(endpoint, 'POST', params, endpoint !== homescreen);
};

commands.touchId = async function touchId(match = true) {
  await this.mobileSendBiometricMatch({
    match
  });
};

commands.toggleEnrollTouchId = async function toggleEnrollTouchId(isEnabled = true) {
  await this.mobileEnrollBiometric({
    isEnabled
  });
};

helpers.getWindowSizeWeb = async function getWindowSizeWeb() {
  return await this.executeAtom('get_window_size', []);
};

helpers.getWindowSizeNative = async function getWindowSizeNative() {
  return await this.proxyCommand(`/window/size`, 'GET');
};

commands.getWindowSize = async function getWindowSize(windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (!this.isWebContext()) {
    return await this.getWindowSizeNative();
  } else {
    return await this.getWindowSizeWeb();
  }
};

commands.getDeviceTime = async function getDeviceTime(format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  if (!this.isRealDevice()) {
    return await _appiumIosDriver.iosCommands.general.getDeviceTime.call(this, format);
  }

  const {
    timestamp,
    utcOffset,
    timeZone
  } = await _appiumIosDevice.utilities.getDeviceTime(this.opts.udid);

  _logger.default.debug(`timestamp: ${timestamp}, utcOffset: ${utcOffset}, timeZone: ${timeZone}`);

  const utc = _momentTimezone.default.unix(timestamp).utc();

  if (Math.abs(utcOffset) <= 12 * 60) {
    return utc.utcOffset(utcOffset).format(format);
  }

  if (_lodash.default.includes(timeZone, '/')) {
    return utc.tz(timeZone).format(format);
  }

  if (Math.abs(timeZone) <= 12 * 60 * 60) {
    return utc.utcOffset(timeZone / 60).format(format);
  }

  _logger.default.warn('Did not know how to apply the UTC offset. Returning the timestamp without it');

  return utc.format(format);
};

commands.mobileGetDeviceTime = async function mobileGetDeviceTime(opts = {}) {
  return await this.getDeviceTime(opts.format);
};

commands.getWindowRect = async function getWindowRect() {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.hideKeyboard = async function hideKeyboard(strategy, ...possibleKeys) {
  if (!(this.opts.deviceName || '').includes('iPhone')) {
    try {
      await this.proxyCommand('/wda/keyboard/dismiss', 'POST');
      return;
    } catch (ign) {}
  }

  _logger.default.debug('Cannot dismiss the keyboard using the native call. Trying to apply a workaround...');

  let keyboard;

  try {
    keyboard = await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
  } catch (err) {
    _logger.default.debug('No keyboard found. Unable to hide.');

    return;
  }

  possibleKeys.pop();
  possibleKeys = possibleKeys.filter(element => !!element);

  if (possibleKeys.length) {
    for (const key of possibleKeys) {
      let el = _lodash.default.last(await this.findNativeElementOrElements('accessibility id', key, true, keyboard));

      if (el) {
        _logger.default.debug(`Attempting to hide keyboard by pressing '${key}' key.`);

        await this.nativeClick(el);
        return;
      }
    }
  } else {
    _logger.default.debug('Finding keyboard and clicking final button to close');

    if ((await this.getNativeAttribute('visible', keyboard)) === 'false') {
      _logger.default.debug('No visible keyboard found. Returning');

      return;
    }

    let buttons = await this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, keyboard);

    if (_lodash.default.isEmpty(buttons)) {
      _logger.default.warn(`No button elements found. Unable to hide.`);

      return;
    }

    await this.nativeClick(_lodash.default.last(buttons));
  }
};

commands.getStrings = _appiumIosDriver.iosCommands.general.getStrings;

commands.removeApp = async function removeApp(bundleId) {
  return await this.mobileRemoveApp({
    bundleId
  });
};

commands.launchApp = _appiumIosDriver.iosCommands.general.launchApp;
commands.closeApp = _appiumIosDriver.iosCommands.general.closeApp;

commands.keys = async function keys(keys) {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');
  }

  let el = _appiumSupport.util.unwrapElement(await this.active());

  if (_lodash.default.isEmpty(el)) {
    throw new _appiumBaseDriver.errors.NoSuchElementError();
  }

  await this.setValue(keys, el);
};

commands.setUrl = async function setUrl(url) {
  if (this.isWebContext()) {
    return await _appiumIosDriver.iosCommands.general.setUrl.call(this, url);
  }

  if (this.isRealDevice()) {
    await this.proxyCommand('/url', 'POST', {
      url
    });
  } else {
    await this.opts.device.simctl.openUrl(url);
  }
};

commands.getViewportRect = _appiumIosDriver.iosCommands.device.getViewportRect;

commands.getScreenInfo = async function getScreenInfo() {
  return await this.proxyCommand('/wda/screen', 'GET');
};

commands.getStatusBarHeight = async function getStatusBarHeight() {
  const {
    statusBarSize
  } = await this.getScreenInfo();
  return statusBarSize.height;
};

commands.getDevicePixelRatio = async function getDevicePixelRatio() {
  const {
    scale
  } = await this.getScreenInfo();
  return scale;
};

commands.mobilePressButton = async function mobilePressButton(opts = {}) {
  const {
    name
  } = opts;

  if (!name) {
    _logger.default.errorAndThrow('Button name is mandatory');
  }

  return await this.proxyCommand('/wda/pressButton', 'POST', {
    name
  });
};

commands.mobileSiriCommand = async function mobileSiriCommand(opts = {}) {
  const {
    text
  } = opts;

  if (!_appiumSupport.util.hasValue(text)) {
    _logger.default.errorAndThrow('"text" argument is mandatory');
  }

  return await this.proxyCommand('/wda/siri/activate', 'POST', {
    text
  });
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInByb3h5Q29tbWFuZCIsImJhY2tncm91bmQiLCJzZWNvbmRzIiwiaG9tZXNjcmVlbiIsImRlYWN0aXZhdGVBcHAiLCJlbmRwb2ludCIsInBhcmFtcyIsInNlbGVjdEVuZHBvaW50IiwidGltZW91dFNlY29uZHMiLCJ1dGlsIiwiaGFzVmFsdWUiLCJpc05hTiIsImR1cmF0aW9uIiwicGFyc2VGbG9hdCIsIl8iLCJoYXMiLCJ0aW1lb3V0IiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0b3VjaElkIiwibWF0Y2giLCJtb2JpbGVTZW5kQmlvbWV0cmljTWF0Y2giLCJ0b2dnbGVFbnJvbGxUb3VjaElkIiwiaXNFbmFibGVkIiwibW9iaWxlRW5yb2xsQmlvbWV0cmljIiwiZ2V0V2luZG93U2l6ZVdlYiIsImdldFdpbmRvd1NpemVOYXRpdmUiLCJnZXRXaW5kb3dTaXplIiwid2luZG93SGFuZGxlIiwiZXJyb3JzIiwiTm90WWV0SW1wbGVtZW50ZWRFcnJvciIsImdldERldmljZVRpbWUiLCJmb3JtYXQiLCJpbmZvIiwiaXNSZWFsRGV2aWNlIiwiaW9zQ29tbWFuZHMiLCJnZW5lcmFsIiwiY2FsbCIsInRpbWVzdGFtcCIsInV0Y09mZnNldCIsInRpbWVab25lIiwidXRpbGl0aWVzIiwib3B0cyIsInVkaWQiLCJkZWJ1ZyIsInV0YyIsIm1vbWVudCIsInVuaXgiLCJNYXRoIiwiYWJzIiwiaW5jbHVkZXMiLCJ0eiIsIndhcm4iLCJtb2JpbGVHZXREZXZpY2VUaW1lIiwiZ2V0V2luZG93UmVjdCIsIndpZHRoIiwiaGVpZ2h0IiwieCIsInkiLCJoaWRlS2V5Ym9hcmQiLCJzdHJhdGVneSIsInBvc3NpYmxlS2V5cyIsImRldmljZU5hbWUiLCJpZ24iLCJrZXlib2FyZCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImVyciIsInBvcCIsImZpbHRlciIsImVsZW1lbnQiLCJsZW5ndGgiLCJrZXkiLCJlbCIsImxhc3QiLCJuYXRpdmVDbGljayIsImdldE5hdGl2ZUF0dHJpYnV0ZSIsImJ1dHRvbnMiLCJpc0VtcHR5IiwiZ2V0U3RyaW5ncyIsInJlbW92ZUFwcCIsImJ1bmRsZUlkIiwibW9iaWxlUmVtb3ZlQXBwIiwibGF1bmNoQXBwIiwiY2xvc2VBcHAiLCJrZXlzIiwiVW5rbm93bkVycm9yIiwidW53cmFwRWxlbWVudCIsIk5vU3VjaEVsZW1lbnRFcnJvciIsInNldFZhbHVlIiwic2V0VXJsIiwidXJsIiwiZGV2aWNlIiwic2ltY3RsIiwib3BlblVybCIsImdldFZpZXdwb3J0UmVjdCIsImdldFNjcmVlbkluZm8iLCJnZXRTdGF0dXNCYXJIZWlnaHQiLCJzdGF0dXNCYXJTaXplIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsInNjYWxlIiwibW9iaWxlUHJlc3NCdXR0b24iLCJuYW1lIiwibW9iaWxlU2lyaUNvbW1hbmQiLCJ0ZXh0IiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFFQSxNQUFNQyxxQkFBcUIsR0FBRyxzQkFBOUI7O0FBR0FILFFBQVEsQ0FBQ0ksTUFBVCxHQUFrQixlQUFlQSxNQUFmLEdBQXlCO0FBQ3pDLE1BQUksS0FBS0MsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLFdBQU8sTUFBTSxLQUFLQyxXQUFMLENBQWlCLGdCQUFqQixFQUFtQyxFQUFuQyxDQUFiO0FBQ0Q7O0FBQ0QsU0FBTyxNQUFNLEtBQUtDLFlBQUwsQ0FBbUIsaUJB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QkFBbEI7QUFDRDs7QUFDRCxTQUFPLE1BQU0sS0FBS2xCLFlBQUwsQ0FBa0Isa0JBQWxCLEVBQXNDLE1BQXRDLEVBQThDO0FBQUN1RyxJQUFBQTtBQUFELEdBQTlDLENBQWI7QUFDRCxDQU5EOztBQVFBOUcsUUFBUSxDQUFDK0csaUJBQVQsR0FBNkIsZUFBZUEsaUJBQWYsQ0FBa0M1RCxJQUFJLEdBQUcsRUFBekMsRUFBNkM7QUFDeEUsUUFBTTtBQUFDNkQsSUFBQUE7QUFBRCxNQUFTN0QsSUFBZjs7QUFDQSxNQUFJLENBQUNuQyxvQkFBS0MsUUFBTCxDQUFjK0YsSUFBZCxDQUFMLEVBQTBCO0FBQ3hCeEYsb0JBQUlDLGFBQUosQ0FBa0IsOEJBQWxCO0FBQ0Q7O0FBQ0QsU0FBTyxNQUFNLEtBQUtsQixZQUFMLENBQWtCLG9CQUFsQixFQUF3QyxNQUF4QyxFQUFnRDtBQUFDeUcsSUFBQUE7QUFBRCxHQUFoRCxDQUFiO0FBQ0QsQ0FORDs7QUFRQUMsTUFBTSxDQUFDQyxNQUFQLENBQWNoSCxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFHZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnO1xuaW1wb3J0IHsgdXRpbGl0aWVzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IE1PTUVOVF9GT1JNQVRfSVNPODYwMSA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWic7XG5cblxuY29tbWFuZHMuYWN0aXZlID0gYXN5bmMgZnVuY3Rpb24gYWN0aXZlICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC9hY3RpdmVgLCAnR0VUJyk7XG59O1xuXG4vKipcbiAqIENsb3NlIGFwcCAoc2ltdWxhdGUgZGV2aWNlIGhvbWUgYnV0dG9uKS4gSXQgaXMgcG9zc2libGUgdG8gcmVzdG9yZVxuICogdGhlIGFwcCBhZnRlciB0aGUgdGltZW91dCBvciBrZWVwIGl0IG1pbmltaXplZCBiYXNlZCBvbiB0aGUgcGFyYW1ldGVyIHZhbHVlLlxuICpcbiAqIEBwYXJhbSB7P251bWJlcnxPYmplY3R9IHNlY29uZHNcbiAqIC0gYW55IHBvc2l0aXZlIG51bWJlciBvZiBzZWNvbmRzOiBjb21lIGJhY2sgYWZ0ZXIgWCBzZWNvbmRzXG4gKiAtIGFueSBuZWdhdGl2ZSBudW1iZXIgb2Ygc2Vjb25kcyBvciB6ZXJvOiBuZXZlciBjb21lIGJhY2tcbiAqIC0gdW5kZWZpbmVkL251bGw6IG5ldmVyIGNvbWUgYmFja1xuICogLSB7dGltZW91dDogNTAwMH06IGNvbWUgYmFjayBhZnRlciA1IHNlY29uZHNcbiAqIC0ge3RpbWVvdXQ6IG51bGx9LCB7dGltZW91dDogLTJ9OiBuZXZlciBjb21lIGJhY2tcbiAqL1xuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIGJhY2tncm91bmQgKHNlY29uZHMpIHtcbiAgY29uc3QgaG9tZXNjcmVlbiA9ICcvd2RhL2hvbWVzY3JlZW4nO1xuICBjb25zdCBkZWFjdGl2YXRlQXBwID0gJy93ZGEvZGVhY3RpdmF0ZUFwcCc7XG5cbiAgbGV0IGVuZHBvaW50O1xuICBsZXQgcGFyYW1zID0ge307XG4gIGNvbnN0IHNlbGVjdEVuZHBvaW50ID0gKHRpbWVvdXRTZWNvbmRzKSA9PiB7XG4gICAgaWYgKCF1dGlsLmhhc1ZhbHVlKHRpbWVvdXRTZWNvbmRzKSkge1xuICAgICAgZW5kcG9pbnQgPSBob21lc2NyZWVuO1xuICAgIH0gZWxzZSBpZiAoIWlzTmFOKHRpbWVvdXRTZWNvbmRzKSkge1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBwYXJzZUZsb2F0KHRpbWVvdXRTZWNvbmRzKTtcbiAgICAgIGlmIChkdXJhdGlvbiA+PSAwKSB7XG4gICAgICAgIHBhcmFtcyA9IHtkdXJhdGlvbn07XG4gICAgICAgIGVuZHBvaW50ID0gZGVhY3RpdmF0ZUFwcDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbjtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIGlmIChfLmhhcyhzZWNvbmRzLCAndGltZW91dCcpKSB7XG4gICAgY29uc3Qge3RpbWVvdXR9ID0gc2Vjb25kcztcbiAgICBzZWxlY3RFbmRwb2ludChpc05hTih0aW1lb3V0KSA/IHRpbWVvdXQgOiBwYXJzZUZsb2F0KHRpbWVvdXQpIC8gMTAwMC4wKTtcbiAgfSBlbHNlIHtcbiAgICBzZWxlY3RFbmRwb2ludChzZWNvbmRzKTtcbiAgfVxuICBpZiAoIWVuZHBvaW50KSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEFyZ3VtZW50IHZhbHVlIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgbnVtYmVyLiBgICtcbiAgICAgIGAke0pTT04uc3RyaW5naWZ5KHNlY29uZHMpfSBoYXMgYmVlbiBwcm92aWRlZCBpbnN0ZWFkYCk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCAnUE9TVCcsIHBhcmFtcywgZW5kcG9pbnQgIT09IGhvbWVzY3JlZW4pO1xufTtcblxuY29tbWFuZHMudG91Y2hJZCA9IGFzeW5jIGZ1bmN0aW9uIHRvdWNoSWQgKG1hdGNoID0gdHJ1ZSkge1xuICBhd2FpdCB0aGlzLm1vYmlsZVNlbmRCaW9tZXRyaWNNYXRjaCh7bWF0Y2h9KTtcbn07XG5cbmNvbW1hbmRzLnRvZ2dsZUVucm9sbFRvdWNoSWQgPSBhc3luYyBmdW5jdGlvbiB0b2dnbGVFbnJvbGxUb3VjaElkIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gIGF3YWl0IHRoaXMubW9iaWxlRW5yb2xsQmlvbWV0cmljKHtpc0VuYWJsZWR9KTtcbn07XG5cbmhlbHBlcnMuZ2V0V2luZG93U2l6ZVdlYiA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemVXZWIgKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xufTtcblxuaGVscGVycy5nZXRXaW5kb3dTaXplTmF0aXZlID0gYXN5bmMgZnVuY3Rpb24gZ2V0V2luZG93U2l6ZU5hdGl2ZSAoKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL3dpbmRvdy9zaXplYCwgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemUgKHdpbmRvd0hhbmRsZSA9ICdjdXJyZW50Jykge1xuICBpZiAod2luZG93SGFuZGxlICE9PSAnY3VycmVudCcpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoJ0N1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuJyk7XG4gIH1cblxuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplTmF0aXZlKCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZVdlYigpO1xuICB9XG59O1xuXG4vKipcbiAqIFJldHJpZXZlcyB0aGUgY3VycmVudCBkZXZpY2UncyB0aW1lc3RhbXAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZvcm1hdCAtIFRoZSBzZXQgb2YgZm9ybWF0IHNwZWNpZmllcnMuIFJlYWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwczovL21vbWVudGpzLmNvbS9kb2NzLyB0byBnZXQgdGhlIGZ1bGwgbGlzdCBvZiBzdXBwb3J0ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRldGltZSBmb3JtYXQgc3BlY2lmaWVycy4gVGhlIGRlZmF1bHQgZm9ybWF0IGlzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgYFlZWVktTU0tRERUSEg6bW06c3NaYCwgd2hpY2ggY29tcGxpZXMgdG8gSVNPLTg2MDFcbiAqIEByZXR1cm5zIEZvcm1hdHRlZCBkYXRldGltZSBzdHJpbmcgb3IgdGhlIHJhdyBjb21tYW5kIG91dHB1dCBpZiBmb3JtYXR0aW5nIGZhaWxzXG4gKi9cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiBnZXREZXZpY2VUaW1lIChmb3JtYXQgPSBNT01FTlRfRk9STUFUX0lTTzg2MDEpIHtcbiAgbG9nLmluZm8oJ0F0dGVtcHRpbmcgdG8gY2FwdHVyZSBpT1MgZGV2aWNlIGRhdGUgYW5kIHRpbWUnKTtcbiAgaWYgKCF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IGlvc0NvbW1hbmRzLmdlbmVyYWwuZ2V0RGV2aWNlVGltZS5jYWxsKHRoaXMsIGZvcm1hdCk7XG4gIH1cblxuICBjb25zdCB7XG4gICAgdGltZXN0YW1wLFxuICAgIHV0Y09mZnNldCxcbiAgICB0aW1lWm9uZSxcbiAgfSA9IGF3YWl0IHV0aWxpdGllcy5nZXREZXZpY2VUaW1lKHRoaXMub3B0cy51ZGlkKTtcbiAgbG9nLmRlYnVnKGB0aW1lc3RhbXA6ICR7dGltZXN0YW1wfSwgdXRjT2Zmc2V0OiAke3V0Y09mZnNldH0sIHRpbWVab25lOiAke3RpbWVab25lfWApO1xuICBjb25zdCB1dGMgPSBtb21lbnQudW5peCh0aW1lc3RhbXApLnV0YygpO1xuICAvLyBhdCBzb21lIHBvaW50IG9mIHRpbWUgQXBwbGUgc3RhcnRlZCB0byByZXR1cm4gdGltZXN0YW1wc1xuICAvLyBpbiB1dGNPZmZzZXQgaW5zdGVhZCBvZiBhY3R1YWwgVVRDIG9mZnNldHNcbiAgaWYgKE1hdGguYWJzKHV0Y09mZnNldCkgPD0gMTIgKiA2MCkge1xuICAgIHJldHVybiB1dGMudXRjT2Zmc2V0KHV0Y09mZnNldCkuZm9ybWF0KGZvcm1hdCk7XG4gIH1cbiAgLy8gdGltZVpvbmUgY291bGQgZWl0aGVyIGJlIGEgdGltZSB6b25lIG5hbWUgb3JcbiAgLy8gYW4gVVRDIG9mZnNldCBpbiBzZWNvbmRzXG4gIGlmIChfLmluY2x1ZGVzKHRpbWVab25lLCAnLycpKSB7XG4gICAgcmV0dXJuIHV0Yy50eih0aW1lWm9uZSkuZm9ybWF0KGZvcm1hdCk7XG4gIH1cbiAgaWYgKE1hdGguYWJzKHRpbWVab25lKSA8PSAxMiAqIDYwICogNjApIHtcbiAgICByZXR1cm4gdXRjLnV0Y09mZnNldCh0aW1lWm9uZSAvIDYwKS5mb3JtYXQoZm9ybWF0KTtcbiAgfVxuICBsb2cud2FybignRGlkIG5vdCBrbm93IGhvdyB0byBhcHBseSB0aGUgVVRDIG9mZnNldC4gUmV0dXJuaW5nIHRoZSB0aW1lc3RhbXAgd2l0aG91dCBpdCcpO1xuICByZXR1cm4gdXRjLmZvcm1hdChmb3JtYXQpO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBEZXZpY2VUaW1lT3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IGZvcm1hdCBbWVlZWS1NTS1ERFRISDptbTpzc1pdIC0gU2VlIGdldERldmljZVRpbWUjZm9ybWF0XG4gKi9cblxuLyoqXG4gKiBSZXRyaWV2ZXMgdGhlIGN1cnJlbnQgZGV2aWNlIHRpbWVcbiAqXG4gKiBAcGFyYW0ge0RldmljZVRpbWVPcHRpb25zfSBvcHRzXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEZvcm1hdHRlZCBkYXRldGltZSBzdHJpbmcgb3IgdGhlIHJhdyBjb21tYW5kIG91dHB1dCBpZiBmb3JtYXR0aW5nIGZhaWxzXG4gKi9cbmNvbW1hbmRzLm1vYmlsZUdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVHZXREZXZpY2VUaW1lIChvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0RGV2aWNlVGltZShvcHRzLmZvcm1hdCk7XG59O1xuXG4vLyBGb3IgVzNDXG5jb21tYW5kcy5nZXRXaW5kb3dSZWN0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0V2luZG93UmVjdCAoKSB7XG4gIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICByZXR1cm4ge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICB4OiAwLFxuICAgIHk6IDBcbiAgfTtcbn07XG5cbmNvbW1hbmRzLmhpZGVLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIGhpZGVLZXlib2FyZCAoc3RyYXRlZ3ksIC4uLnBvc3NpYmxlS2V5cykge1xuICBpZiAoISh0aGlzLm9wdHMuZGV2aWNlTmFtZSB8fCAnJykuaW5jbHVkZXMoJ2lQaG9uZScpKSB7XG4gICAgLy8gVE9ETzogb25jZSBXREEgY2FuIGhhbmRsZSBkaXNtaXNzaW5nIGtleWJvYXJkIGZvciBpcGhvbmUsIHRha2UgYXdheSBjb25kaXRpb25hbFxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9rZXlib2FyZC9kaXNtaXNzJywgJ1BPU1QnKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gIH1cblxuICBsb2cuZGVidWcoJ0Nhbm5vdCBkaXNtaXNzIHRoZSBrZXlib2FyZCB1c2luZyB0aGUgbmF0aXZlIGNhbGwuIFRyeWluZyB0byBhcHBseSBhIHdvcmthcm91bmQuLi4nKTtcblxuICBsZXQga2V5Ym9hcmQ7XG4gIHRyeSB7XG4gICAga2V5Ym9hcmQgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVLZXlib2FyZCcsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gbm8ga2V5Ym9hcmQgZm91bmRcbiAgICBsb2cuZGVidWcoJ05vIGtleWJvYXJkIGZvdW5kLiBVbmFibGUgdG8gaGlkZS4nKTtcbiAgICByZXR1cm47XG4gIH1cbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBwb3NzaWJsZUtleXMgPSBwb3NzaWJsZUtleXMuZmlsdGVyKChlbGVtZW50KSA9PiAhIWVsZW1lbnQpOyAvLyBnZXQgcmlkIG9mIHVuZGVmaW5lZCBlbGVtZW50c1xuICBpZiAocG9zc2libGVLZXlzLmxlbmd0aCkge1xuICAgIGZvciAoY29uc3Qga2V5IG9mIHBvc3NpYmxlS2V5cykge1xuICAgICAgbGV0IGVsID0gXy5sYXN0KGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywga2V5LCB0cnVlLCBrZXlib2FyZCkpO1xuICAgICAgaWYgKGVsKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBoaWRlIGtleWJvYXJkIGJ5IHByZXNzaW5nICcke2tleX0nIGtleS5gKTtcbiAgICAgICAgYXdhaXQgdGhpcy5uYXRpdmVDbGljayhlbCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gZmluZCB0aGUga2V5Ym9hcmQsIGFuZCBoaXQgdGhlIGxhc3QgQnV0dG9uXG4gICAgbG9nLmRlYnVnKCdGaW5kaW5nIGtleWJvYXJkIGFuZCBjbGlja2luZyBmaW5hbCBidXR0b24gdG8gY2xvc2UnKTtcbiAgICBpZiAoYXdhaXQgdGhpcy5nZXROYXRpdmVBdHRyaWJ1dGUoJ3Zpc2libGUnLCBrZXlib2FyZCkgPT09ICdmYWxzZScpIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm8gdmlzaWJsZSBrZXlib2FyZCBmb3VuZC4gUmV0dXJuaW5nJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBidXR0b25zID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlQnV0dG9uJywgdHJ1ZSwga2V5Ym9hcmQpO1xuICAgIGlmIChfLmlzRW1wdHkoYnV0dG9ucykpIHtcbiAgICAgIGxvZy53YXJuKGBObyBidXR0b24gZWxlbWVudHMgZm91bmQuIFVuYWJsZSB0byBoaWRlLmApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLm5hdGl2ZUNsaWNrKF8ubGFzdChidXR0b25zKSk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldFN0cmluZ3MgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmdldFN0cmluZ3M7XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlUmVtb3ZlQXBwKHtidW5kbGVJZH0pO1xufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gaW9zQ29tbWFuZHMuZ2VuZXJhbC5sYXVuY2hBcHA7XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gaW9zQ29tbWFuZHMuZ2VuZXJhbC5jbG9zZUFwcDtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIGtleXMgKGtleXMpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgbGV0IGVsID0gdXRpbC51bndyYXBFbGVtZW50KGF3YWl0IHRoaXMuYWN0aXZlKCkpO1xuICBpZiAoXy5pc0VtcHR5KGVsKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gIH1cbiAgYXdhaXQgdGhpcy5zZXRWYWx1ZShrZXlzLCBlbCk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiBzZXRVcmwgKHVybCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCBpb3NDb21tYW5kcy5nZW5lcmFsLnNldFVybC5jYWxsKHRoaXMsIHVybCk7XG4gIH1cblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvdXJsJywgJ1BPU1QnLCB7dXJsfSk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5zaW1jdGwub3BlblVybCh1cmwpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFJlY3QgPSBpb3NDb21tYW5kcy5kZXZpY2UuZ2V0Vmlld3BvcnRSZWN0O1xuXG4vLyBtZW1vaXplZCBpbiBjb25zdHJ1Y3RvclxuY29tbWFuZHMuZ2V0U2NyZWVuSW5mbyA9IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbkluZm8gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvc2NyZWVuJywgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0U3RhdHVzQmFySGVpZ2h0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3RhdHVzQmFySGVpZ2h0ICgpIHtcbiAgY29uc3Qge3N0YXR1c0JhclNpemV9ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5JbmZvKCk7XG4gIHJldHVybiBzdGF0dXNCYXJTaXplLmhlaWdodDtcbn07XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5jb21tYW5kcy5nZXREZXZpY2VQaXhlbFJhdGlvID0gYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlUGl4ZWxSYXRpbyAoKSB7XG4gIGNvbnN0IHtzY2FsZX0gPSBhd2FpdCB0aGlzLmdldFNjcmVlbkluZm8oKTtcbiAgcmV0dXJuIHNjYWxlO1xufTtcblxuY29tbWFuZHMubW9iaWxlUHJlc3NCdXR0b24gPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVQcmVzc0J1dHRvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtuYW1lfSA9IG9wdHM7XG4gIGlmICghbmFtZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdCdXR0b24gbmFtZSBpcyBtYW5kYXRvcnknKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvcHJlc3NCdXR0b24nLCAnUE9TVCcsIHtuYW1lfSk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVTaXJpQ29tbWFuZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVNpcmlDb21tYW5kIChvcHRzID0ge30pIHtcbiAgY29uc3Qge3RleHR9ID0gb3B0cztcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKHRleHQpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ1widGV4dFwiIGFyZ3VtZW50IGlzIG1hbmRhdG9yeScpO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9zaXJpL2FjdGl2YXRlJywgJ1BPU1QnLCB7dGV4dH0pO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5cbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBleHRlbnNpb25zIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
