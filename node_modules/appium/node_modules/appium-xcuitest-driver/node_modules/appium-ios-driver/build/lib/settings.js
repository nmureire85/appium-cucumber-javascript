"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocale = setLocale;
exports.setPreferences = setPreferences;
exports.setLocaleAndPreferences = setLocaleAndPreferences;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function launchAndQuitSimulator(sim, safari) {
  _logger.default.debug('No simulator directories found.');

  return await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');

    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, safari);
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');

    return false;
  }

  _logger.default.debug('Setting iOS and app preferences');

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, safari);
  }

  let updated = false;

  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');

    _logger.default.error(e);
  }

  return updated;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => !_lodash.default.isUndefined(c));

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJTRVRUSU5HU19DQVBTIiwiU0FGQVJJX1NFVFRJTkdTX0NBUFMiLCJsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIiwic2ltIiwic2FmYXJpIiwibG9nZ2VyIiwiZGVidWciLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwib3B0cyIsInNldHRpbmciLCJfIiwiaGFzIiwic2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMiLCJzaHV0ZG93bkZuIiwibm9vcCIsImxvY2FsQ29uZmlnIiwic2V0TG9jYWxlIiwicHJlZnNVcGRhdGVkIiwic2V0UHJlZmVyZW5jZXMiLCJfdXBkYXRlZCIsImxvY2FsZUNvbmZpZyIsImxhbmd1YWdlIiwibG9jYWxlIiwiY2FsZW5kYXJGb3JtYXQiLCJpc0ZyZXNoIiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImUiLCJlcnJvckFuZFRocm93IiwibmVlZFRvU2V0UHJlZnMiLCJuZWVkVG9TZXRTYWZhcmlQcmVmcyIsInNldExvY1NlcnZpY2VzUHJlZnMiLCJlcnJvciIsInNldFNhZmFyaVByZWZzIiwibG9jU2VydiIsImZpbmQiLCJsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkIiwiYyIsImlzVW5kZWZpbmVkIiwidXBkYXRlU2V0dGluZ3MiLCJMb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImJ1bmRsZUlkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUcsQ0FDcEIseUJBRG9CLEVBRXBCLDRCQUZvQixDQUF0QjtBQUlBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCLG1CQUQyQixFQUUzQiwwQkFGMkIsRUFHM0IsNkJBSDJCLENBQTdCOztBQU1BLGVBQWVDLHNCQUFmLENBQXVDQyxHQUF2QyxFQUE0Q0MsTUFBNUMsRUFBb0Q7QUFDbERDLGtCQUFPQyxLQUFQLENBQWEsaUNBQWI7O0FBQ0EsU0FBTyxNQUFNSCxHQUFHLENBQUNJLGFBQUosQ0FBa0JILE1BQWxCLENBQWI7QUFDRDs7QUFFRCxTQUFTSSxnQkFBVCxDQUEyQkMsUUFBM0IsRUFBcUNDLElBQUksR0FBRyxFQUE1QyxFQUFnRDtBQUM5QyxPQUFLLElBQUlDLE9BQVQsSUFBb0JGLFFBQXBCLEVBQThCO0FBQzVCLFFBQUlHLGdCQUFFQyxHQUFGLENBQU1ILElBQU4sRUFBWUMsT0FBWixDQUFKLEVBQTBCO0FBQ3hCLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsU0FBTyxLQUFQO0FBQ0Q7O0FBRUQsZUFBZUcsdUJBQWYsQ0FBd0NYLEdBQXhDLEVBQTZDTyxJQUE3QyxFQUFtRE4sTUFBTSxHQUFHLEtBQTVELEVBQW1FVyxVQUFVLEdBQUdILGdCQUFFSSxJQUFsRixFQUF3RjtBQUN0RixRQUFNQyxXQUFXLEdBQUcsTUFBTUMsU0FBUyxDQUFDZixHQUFELEVBQU1PLElBQU4sRUFBWSxFQUFaLEVBQWdCTixNQUFoQixDQUFuQztBQUNBLFFBQU1lLFlBQVksR0FBRyxNQUFNQyxjQUFjLENBQUNqQixHQUFELEVBQU1PLElBQU4sRUFBWU4sTUFBWixDQUF6Qzs7QUFDQSxNQUFJYSxXQUFXLENBQUNJLFFBQVosSUFBd0JGLFlBQTVCLEVBQTBDO0FBQ3hDZCxv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QWMsMkNBQTBDLENBQUMsQ0FBQzJDLEdBQUksR0FBOUQ7O0FBQ0FELElBQUFBLGNBQWMsQ0FBQ1EscUJBQWYsR0FBdUNQLEdBQXZDO0FBQ0Q7O0FBQ0QsU0FBUXJDLGdCQUFFNkMsSUFBRixDQUFPVCxjQUFQLElBQXlCLENBQTFCLEdBQ0gsTUFBTTdDLEdBQUcsQ0FBQ3VELG9CQUFKLENBQXlCVixjQUF6QixDQURILEdBRUgsS0FGSjtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IFNFVFRJTkdTX0NBUFMgPSBbXG4gICdsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCcsXG4gICdsb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCcsXG5dO1xuY29uc3QgU0FGQVJJX1NFVFRJTkdTX0NBUFMgPSBbXG4gICdzYWZhcmlBbGxvd1BvcHVwcycsXG4gICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnLFxuICAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJyxcbl07XG5cbmFzeW5jIGZ1bmN0aW9uIGxhdW5jaEFuZFF1aXRTaW11bGF0b3IgKHNpbSwgc2FmYXJpKSB7XG4gIGxvZ2dlci5kZWJ1ZygnTm8gc2ltdWxhdG9yIGRpcmVjdG9yaWVzIGZvdW5kLicpO1xuICByZXR1cm4gYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoc2FmYXJpKTtcbn1cblxuZnVuY3Rpb24gY2hlY2tQcmVmZXJlbmNlcyAoc2V0dGluZ3MsIG9wdHMgPSB7fSkge1xuICBmb3IgKGxldCBzZXR0aW5nIG9mIHNldHRpbmdzKSB7XG4gICAgaWYgKF8uaGFzKG9wdHMsIHNldHRpbmcpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGVBbmRQcmVmZXJlbmNlcyAoc2ltLCBvcHRzLCBzYWZhcmkgPSBmYWxzZSwgc2h1dGRvd25GbiA9IF8ubm9vcCkge1xuICBjb25zdCBsb2NhbENvbmZpZyA9IGF3YWl0IHNldExvY2FsZShzaW0sIG9wdHMsIHt9LCBzYWZhcmkpO1xuICBjb25zdCBwcmVmc1VwZGF0ZWQgPSBhd2FpdCBzZXRQcmVmZXJlbmNlcyhzaW0sIG9wdHMsIHNhZmFyaSk7XG4gIGlmIChsb2NhbENvbmZpZy5fdXBkYXRlZCB8fCBwcmVmc1VwZGF0ZWQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1VwZGF0ZWQgc2V0dGluZ3MuIFJlYm9vdGluZyB0aGUgc2ltdWxhdG9yIGlmIGl0IGlzIGFscmVhZHkgb3BlbicpO1xuICAgIGF3YWl0IHNodXRkb3duRm4oc2ltKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIuZGVidWcoJ1NldHRpbmcgZGlkIG5vdCBuZWVkIHRvIGJlIHVwZGF0ZWQnKTtcbiAgfVxuICBkZWxldGUgbG9jYWxDb25maWcuX3VwZGF0ZWQ7XG4gIHJldHVybiBsb2NhbENvbmZpZztcbn1cblxuLy8gcGFzcyBpbiB0aGUgc2ltdWxhdG9yIHNvIHRoYXQgb3RoZXIgc3lzdGVtcyB0aGF0IHVzZSB0aGUgZnVuY3Rpb24gY2FuIHN1cHBseVxuLy8gd2hhdGV2ZXIgdGhleSBoYXZlXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGUgKHNpbSwgb3B0cywgbG9jYWxlQ29uZmlnID0ge30sIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGlmICghb3B0cy5sYW5ndWFnZSAmJiAhb3B0cy5sb2NhbGUgJiYgIW9wdHMuY2FsZW5kYXJGb3JtYXQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ05vIHJlYXNvbiB0byBzZXQgbG9jYWxlJyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgLy8gd2UgbmVlZCB0aGUgc2ltdWxhdG9yIHRvIGhhdmUgaXRzIGRpcmVjdG9yaWVzIGluIHBsYWNlXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHNhZmFyaSk7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1NldHRpbmcgbG9jYWxlIGluZm9ybWF0aW9uJyk7XG4gIGxvY2FsZUNvbmZpZyA9IHtcbiAgICBsYW5ndWFnZTogb3B0cy5sYW5ndWFnZSB8fCBsb2NhbGVDb25maWcubGFuZ3VhZ2UsXG4gICAgbG9jYWxlOiBvcHRzLmxvY2FsZSB8fCBsb2NhbGVDb25maWcubG9jYWxlLFxuICAgIGNhbGVuZGFyRm9ybWF0OiBvcHRzLmNhbGVuZGFyRm9ybWF0IHx8IGxvY2FsZUNvbmZpZy5jYWxlbmRhckZvcm1hdCxcbiAgICBfdXBkYXRlZDogZmFsc2UsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBsZXQgdXBkYXRlZCA9IGF3YWl0IHNpbS51cGRhdGVMb2NhbGUob3B0cy5sYW5ndWFnZSwgb3B0cy5sb2NhbGUsIG9wdHMuY2FsZW5kYXJGb3JtYXQpO1xuICAgIGlmICh1cGRhdGVkKSB7XG4gICAgICBsb2NhbGVDb25maWcuX3VwZGF0ZWQgPSB0cnVlO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBBcHBpdW0gd2FzIHVuYWJsZSB0byBzZXQgbG9jYWxlIGluZm86ICR7ZX1gKTtcbiAgfVxuXG4gIHJldHVybiBsb2NhbGVDb25maWc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGxldCBuZWVkVG9TZXRQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGxldCBuZWVkVG9TZXRTYWZhcmlQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0FGQVJJX1NFVFRJTkdTX0NBUFMsIG9wdHMpO1xuICBpZiAoIW5lZWRUb1NldFByZWZzICYmICFuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgIGxvZ2dlci5kZWJ1ZygnTm8gaU9TIC8gYXBwIHByZWZlcmVuY2VzIHRvIHNldCcpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnU2V0dGluZyBpT1MgYW5kIGFwcCBwcmVmZXJlbmNlcycpO1xuXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHNhZmFyaSk7XG4gIH1cblxuICBsZXQgdXBkYXRlZCA9IGZhbHNlO1xuICB0cnkge1xuICAgIGlmIChuZWVkVG9TZXRQcmVmcykge1xuICAgICAgdXBkYXRlZCA9IGF3YWl0IHNldExvY1NlcnZpY2VzUHJlZnMoc2ltLCBvcHRzKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmsnKTtcbiAgICBsb2dnZXIuZXJyb3IoZSk7XG4gIH1cblxuICB0cnkge1xuICAgIGlmIChuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgICAgdXBkYXRlZCA9IGF3YWl0IHNldFNhZmFyaVByZWZzKHNpbSwgb3B0cykgfHwgdXBkYXRlZDtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHNldHRpbmcgc2FmYXJpIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrJyk7XG4gICAgbG9nZ2VyLmVycm9yKGUpO1xuICB9XG5cbiAgcmV0dXJuIHVwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY1NlcnZpY2VzUHJlZnMgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxldCBsb2NTZXJ2ID0gXy5maW5kKFtvcHRzLmxvY2F0aW9uU2VydmljZXNFbmFibGVkLCBvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkXSwgKGMpID0+ICFfLmlzVW5kZWZpbmVkKGMpKTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKGxvY1NlcnYpKSB7XG4gICAgbG9jU2VydiA9IGxvY1NlcnYgPyAxIDogMDtcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgdG8gJHtsb2NTZXJ2fWApO1xuICAgIGF3YWl0IHNpbS51cGRhdGVTZXR0aW5ncygnbG9jYXRpb25TZXJ2aWNlcycsIHtcbiAgICAgIExvY2F0aW9uU2VydmljZXNFbmFibGVkOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW43LjAnOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW44LjAnOiBsb2NTZXJ2XG4gICAgfSk7XG4gIH1cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQpKSB7XG4gICAgaWYgKCFvcHRzLmJ1bmRsZUlkKSB7XG4gICAgICBsZXQgbXNnID0gXCJDYW4ndCBzZXQgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCB3aXRob3V0IGJ1bmRsZSBJRFwiO1xuICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICB9XG4gICAgbGV0IGxvY0F1dGggPSAhIW9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQ7XG4gICAgaWYgKGxvY0F1dGgpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnQXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0RlLWF1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAnKTtcbiAgICB9XG4gICAgYXdhaXQgc2ltLnVwZGF0ZUxvY2F0aW9uU2V0dGluZ3Mob3B0cy5idW5kbGVJZCwgbG9jQXV0aCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0U2FmYXJpUHJlZnMgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxldCBzYWZhcmlTZXR0aW5ncyA9IHt9O1xuXG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpQWxsb3dQb3B1cHMnKSkge1xuICAgIGNvbnN0IHZhbCA9ICEhb3B0cy5zYWZhcmlBbGxvd1BvcHVwcztcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgamF2YXNjcmlwdCB3aW5kb3cgb3BlbmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldlYktpdEphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkgPSB2YWw7XG4gICAgc2FmYXJpU2V0dGluZ3MuSmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycpKSB7XG4gICAgY29uc3QgdmFsID0gIW9wdHMuc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBmcmF1ZHVsZW50IHdlYnNpdGUgd2FybmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldhcm5BYm91dEZyYXVkdWxlbnRXZWJzaXRlcyA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCcpKSB7XG4gICAgY29uc3QgdmFsID0gb3B0cy5zYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQgPyAxIDogMDtcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgb3BlbmluZyBsaW5rcyBpbiBiYWNrZ3JvdW5kIHRvICckeyEhdmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5PcGVuTGlua3NJbkJhY2tncm91bmQgPSB2YWw7XG4gIH1cbiAgcmV0dXJuIChfLnNpemUoc2FmYXJpU2V0dGluZ3MpID4gMClcbiAgICA/IGF3YWl0IHNpbS51cGRhdGVTYWZhcmlTZXR0aW5ncyhzYWZhcmlTZXR0aW5ncylcbiAgICA6IGZhbHNlO1xufVxuXG5leHBvcnQgeyBzZXRMb2NhbGUsIHNldFByZWZlcmVuY2VzLCBzZXRMb2NhbGVBbmRQcmVmZXJlbmNlcyB9O1xuIl0sImZpbGUiOiJsaWIvc2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
