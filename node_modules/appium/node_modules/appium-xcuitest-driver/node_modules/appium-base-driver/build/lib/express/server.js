"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.server = server;
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _constants = require("../constants");

var _events = require("events");

const KEEP_ALIVE_TIMEOUT_MS = 60 * 10 * 1000;

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _constants.DEFAULT_BASE_PATH,
    plugins = []
  } = opts;
  const app = (0, _express.default)();

  const httpServer = _http.default.createServer(app);

  return await new _bluebird.default(async (resolve, reject) => {
    try {
      configureHttp({
        httpServer,
        reject
      });
      configureServer({
        app,
        addRoutes: routeConfiguringFunction,
        allowCors,
        basePath,
        plugins
      });
      await configureServerPlugins({
        app,
        httpServer,
        plugins
      });
      await startServer({
        httpServer,
        hostname,
        port
      });
      resolve(httpServer);
    } catch (err) {
      reject(err);
    }
  });
}

function configureServer({
  app,
  addRoutes,
  allowCors = true,
  basePath = _constants.DEFAULT_BASE_PATH,
  plugins = []
}) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use(_middleware.handleIdempotency);
  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  const extraMethods = plugins.filter(p => {
    if (!_lodash.default.isPlainObject(p.newMethodMap)) {
      _logger.default.warn(`Tried to apply newMethodMap from plugin '${p.name}' but it was invalid. Will ` + `skip adding these methods to the method map.`);

      return false;
    }

    return true;
  }).map(p => p.newMethodMap);
  addRoutes(app, {
    basePath,
    extraMethods
  });
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
  app.all('*', _middleware.catch404Handler);
}

function configureHttp({
  httpServer,
  reject
}) {
  const serverState = {
    notifier: new _events.EventEmitter(),
    closed: false
  };
  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => await new _bluebird.default((resolve, reject) => {
    serverState.closed = true;
    serverState.notifier.emit('shutdown');

    _logger.default.info('Waiting until the server is closed');

    httpServer.on('close', () => {
      _logger.default.info('Received server close event');

      resolve();
    });
    close(err => {
      if (err) reject(err);
    });
  });

  httpServer.on('error', err => {
    if (err.code === 'EADDRNOTAVAIL') {
      _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
    } else {
      _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
    }

    reject(err);
  });
  httpServer.on('connection', socket => {
    socket.setTimeout(KEEP_ALIVE_TIMEOUT_MS);
    socket.on('error', reject);

    function destroy() {
      socket.destroy();
    }

    socket._openReqCount = 0;
    socket.once('close', () => serverState.notifier.removeListener('shutdown', destroy));
    serverState.notifier.once('shutdown', destroy);
  });
  httpServer.on('request', function (req, res) {
    const socket = req.connection || req.socket;
    socket._openReqCount++;
    res.on('finish', function () {
      socket._openReqCount--;

      if (serverState.closed && socket._openReqCount === 0) {
        socket.destroy();
      }
    });
  });
}

async function configureServerPlugins({
  plugins,
  app,
  httpServer
}) {
  for (const plugin of plugins.filter(p => p.updatesServer)) {
    _logger.default.info(`Allowing plugin ${plugin.name} to modify the Appium server`);

    try {
      await plugin.updateServer(app, httpServer);
    } catch (err) {
      _logger.default.error(`Plugin '${plugin.name}' tried to update the server but the updateServer ` + `method was not implemented, did not return a promise, or threw an ` + `error. Original message: ${err}.`);

      throw err;
    }
  }
}

async function startServer({
  httpServer,
  port,
  hostname
}) {
  const serverArgs = [port];

  if (hostname) {
    serverArgs.push(hostname);
  }

  const startPromise = _bluebird.default.promisify(httpServer.listen, {
    context: httpServer
  })(...serverArgs);

  httpServer.keepAliveTimeout = KEEP_ALIVE_TIMEOUT_MS;
  httpServer.headersTimeout = KEEP_ALIVE_TIMEOUT_MS + 5 * 1000;
  await startPromise;
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3NlcnZlci5qcyJdLCJuYW1lcyI6WyJLRUVQX0FMSVZFX1RJTUVPVVRfTVMiLCJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsInBsdWdpbnMiLCJhcHAiLCJodHRwU2VydmVyIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwiY29uZmlndXJlSHR0cCIsImNvbmZpZ3VyZVNlcnZlciIsImFkZFJvdXRlcyIsImNvbmZpZ3VyZVNlcnZlclBsdWdpbnMiLCJzdGFydFNlcnZlciIsImVyciIsIm5vcm1hbGl6ZUJhc2VQYXRoIiwidXNlIiwiZW5kTG9nRm9ybWF0dGVyIiwicGF0aCIsIlNUQVRJQ19ESVIiLCJleHByZXNzIiwic3RhdGljIiwicHJvZHVjZUVycm9yIiwicHJvZHVjZUNyYXNoIiwiYWxsb3dDcm9zc0RvbWFpbiIsImhhbmRsZUlkZW1wb3RlbmN5IiwiZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlIiwiYm9keVBhcnNlciIsInVybGVuY29kZWQiLCJleHRlbmRlZCIsImNhdGNoQWxsSGFuZGxlciIsImpzb24iLCJsaW1pdCIsInN0YXJ0TG9nRm9ybWF0dGVyIiwiZXh0cmFNZXRob2RzIiwiZmlsdGVyIiwicCIsIl8iLCJpc1BsYWluT2JqZWN0IiwibmV3TWV0aG9kTWFwIiwibG9nIiwid2FybiIsIm5hbWUiLCJtYXAiLCJhbGwiLCJ3ZWxjb21lIiwiZ3VpbmVhUGlnIiwiZ3VpbmVhUGlnU2Nyb2xsYWJsZSIsImd1aW5lYVBpZ0FwcEJhbm5lciIsImNhdGNoNDA0SGFuZGxlciIsInNlcnZlclN0YXRlIiwibm90aWZpZXIiLCJFdmVudEVtaXR0ZXIiLCJjbG9zZWQiLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsInJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJjbG9zZSIsImJpbmQiLCJlbWl0IiwiaW5mbyIsIm9uIiwiY29kZSIsImVycm9yIiwic29ja2V0Iiwic2V0VGltZW91dCIsImRlc3Ryb3kiLCJfb3BlblJlcUNvdW50Iiwib25jZSIsInJlbW92ZUxpc3RlbmVyIiwicmVxIiwicmVzIiwiY29ubmVjdGlvbiIsInBsdWdpbiIsInVwZGF0ZXNTZXJ2ZXIiLCJ1cGRhdGVTZXJ2ZXIiLCJzZXJ2ZXJBcmdzIiwicHVzaCIsInN0YXJ0UHJvbWlzZSIsInByb21pc2lmeSIsImxpc3RlbiIsImNvbnRleHQiLCJrZWVwQWxpdmVUaW1lb3V0IiwiaGVhZGVyc1RpbWVvdXQiLCJpc1N0cmluZyIsIkVycm9yIiwicmVwbGFjZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUtBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLHFCQUFxQixHQUFHLEtBQUssRUFBTCxHQUFVLElBQXhDOztBQUdBLGVBQWVDLE1BQWYsQ0FBdUJDLElBQUksR0FBRyxFQUE5QixFQUFrQztBQUNoQyxRQUFNO0FBQ0pDLElBQUFBLHdCQURJO0FBRUpDLElBQUFBLElBRkk7QUFHSkMsSUFBQUEsUUFBUSxHQUFHLElBSFA7QUFJSkMsSUFBQUEsU0FBUyxHQUFHLElBSlI7QUFLSkMsSUFBQUEsUUFBUSxHQUFHQyw0QkFMUDtBQU1KQyxJQUFBQSxPQUFPLEdBQUc7QUFOTixNQU9GUCxJQVBKO0FBVUEsUUFBTVEsR0FBRyxHQUFHLHVCQUFaOztBQUNBLFFBQU1DLFVBQVUsR0FBR0MsY0FBS0MsWUFBTCxDQUFrQkgsR0FBbEIsQ0FBbkI7O0FBQ0EsU0FBTyxNQUFNLElBQUlJLGlCQUFKLENBQU0sT0FBT0MsT0FBUCxFQUFnQkMsTUFBaEIsS0FBMkI7QUFNNUMsUUFBSTtBQUNG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QUFBLFFBQVEsR0FBSSxJQUFHQSxRQUFTLEVBQXhCO0FBQ0Q7O0FBRUQsU0FBT0EsUUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBmYXZpY29uIGZyb20gJ3NlcnZlLWZhdmljb24nO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0IG1ldGhvZE92ZXJyaWRlIGZyb20gJ21ldGhvZC1vdmVycmlkZSc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHN0YXJ0TG9nRm9ybWF0dGVyLCBlbmRMb2dGb3JtYXR0ZXIgfSBmcm9tICcuL2V4cHJlc3MtbG9nZ2luZyc7XG5pbXBvcnQge1xuICBhbGxvd0Nyb3NzRG9tYWluLCBmaXhQeXRob25Db250ZW50VHlwZSwgZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlLFxuICBjYXRjaEFsbEhhbmRsZXIsIGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUsIGhhbmRsZUlkZW1wb3RlbmN5LFxuICBjYXRjaDQwNEhhbmRsZXIsXG59IGZyb20gJy4vbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBndWluZWFQaWcsIGd1aW5lYVBpZ1Njcm9sbGFibGUsIGd1aW5lYVBpZ0FwcEJhbm5lciwgd2VsY29tZSwgU1RBVElDX0RJUiB9IGZyb20gJy4vc3RhdGljJztcbmltcG9ydCB7IHByb2R1Y2VFcnJvciwgcHJvZHVjZUNyYXNoIH0gZnJvbSAnLi9jcmFzaCc7XG5pbXBvcnQge1xuICBhZGRXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyxcbiAgZ2V0V2ViU29ja2V0SGFuZGxlcnNcbn0gZnJvbSAnLi93ZWJzb2NrZXQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgREVGQVVMVF9CQVNFX1BBVEggfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuXG5jb25zdCBLRUVQX0FMSVZFX1RJTUVPVVRfTVMgPSA2MCAqIDEwICogMTAwMDsgLy8gMTAgbWludXRlc1xuXG5cbmFzeW5jIGZ1bmN0aW9uIHNlcnZlciAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sXG4gICAgcG9ydCxcbiAgICBob3N0bmFtZSA9IG51bGwsXG4gICAgYWxsb3dDb3JzID0gdHJ1ZSxcbiAgICBiYXNlUGF0aCA9IERFRkFVTFRfQkFTRV9QQVRILFxuICAgIHBsdWdpbnMgPSBbXVxuICB9ID0gb3B0cztcblxuICAvLyBjcmVhdGUgdGhlIGFjdHVhbCBodHRwIHNlcnZlclxuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGNvbnN0IGh0dHBTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIHdlIHB1dCBhbiBhc3luYyBmdW5jdGlvbiBhcyB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvciBiZWNhdXNlIHdlIHdhbnQgc29tZSB0aGluZ3MgdG8gaGFwcGVuIGluXG4gICAgLy8gc2VyaWFsIChhcHBsaWNhdGlvbiBvZiBwbHVnaW4gdXBkYXRlcywgZm9yIGV4YW1wbGUpLiBCdXQgd2Ugc3RpbGwgbmVlZCB0byB1c2UgYSBwcm9taXNlIGhlcmVcbiAgICAvLyBiZWNhdXNlIHNvbWUgZWxlbWVudHMgb2Ygc2VydmVyIHN0YXJ0IGZhaWx1cmUgb25seSBoYXBwZW4gaW4gaHR0cFNlcnZlciBsaXN0ZW5lcnMuIFNvIHRoZVxuICAgIC8vIHdheSB3ZSByZXNvbHZlIGl0IGlzIHRvIHVzZSBhbiBhc3luYyBmdW5jdGlvbiBoZXJlIGJ1dCB0byB3cmFwIGFsbCB0aGUgaW5uZXIgbG9naWMgaW5cbiAgICAvLyB0cnkvY2F0Y2ggc28gYW55IGVycm9ycyBjYW4gYmUgcGFzc2VkIHRvIHJlamVjdC5cbiAgICB0cnkge1xuICAgICAgY29uZmlndXJlSHR0cCh7aHR0cFNlcnZlciwgcmVqZWN0fSk7XG4gICAgICBjb25maWd1cmVTZXJ2ZXIoe2FwcCwgYWRkUm91dGVzOiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIGFsbG93Q29ycywgYmFzZVBhdGgsIHBsdWdpbnN9KTtcbiAgICAgIGF3YWl0IGNvbmZpZ3VyZVNlcnZlclBsdWdpbnMoe2FwcCwgaHR0cFNlcnZlciwgcGx1Z2luc30pO1xuXG4gICAgICBhd2FpdCBzdGFydFNlcnZlcih7aHR0cFNlcnZlciwgaG9zdG5hbWUsIHBvcnR9KTtcbiAgICAgIHJlc29sdmUoaHR0cFNlcnZlcik7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZWplY3QoZXJyKTtcbiAgICB9XG4gIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGNvbmZpZ3VyZVNlcnZlciAoe1xuICBhcHAsXG4gIGFkZFJvdXRlcyxcbiAgYWxsb3dDb3JzID0gdHJ1ZSxcbiAgYmFzZVBhdGggPSBERUZBVUxUX0JBU0VfUEFUSCxcbiAgcGx1Z2lucyA9IFtdLFxufSkge1xuICBiYXNlUGF0aCA9IG5vcm1hbGl6ZUJhc2VQYXRoKGJhc2VQYXRoKTtcblxuICBhcHAudXNlKGVuZExvZ0Zvcm1hdHRlcik7XG5cbiAgLy8gc2V0IHVwIHN0YXRpYyBhc3NldHNcbiAgYXBwLnVzZShmYXZpY29uKHBhdGgucmVzb2x2ZShTVEFUSUNfRElSLCAnZmF2aWNvbi5pY28nKSkpO1xuICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKFNUQVRJQ19ESVIpKTtcblxuICAvLyBjcmFzaCByb3V0ZXMsIGZvciB0ZXN0aW5nXG4gIGFwcC51c2UoYCR7YmFzZVBhdGh9L3Byb2R1Y2VfZXJyb3JgLCBwcm9kdWNlRXJyb3IpO1xuICBhcHAudXNlKGAke2Jhc2VQYXRofS9jcmFzaGAsIHByb2R1Y2VDcmFzaCk7XG5cbiAgLy8gYWRkIG1pZGRsZXdhcmVzXG4gIGlmIChhbGxvd0NvcnMpIHtcbiAgICBhcHAudXNlKGFsbG93Q3Jvc3NEb21haW4pO1xuICB9IGVsc2Uge1xuICAgIGFwcC51c2UoYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZShiYXNlUGF0aCkpO1xuICB9XG4gIGFwcC51c2UoaGFuZGxlSWRlbXBvdGVuY3kpO1xuICBhcHAudXNlKGZpeFB5dGhvbkNvbnRlbnRUeXBlKGJhc2VQYXRoKSk7XG4gIGFwcC51c2UoZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlKTtcbiAgYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoe2V4dGVuZGVkOiB0cnVlfSkpO1xuICBhcHAudXNlKG1ldGhvZE92ZXJyaWRlKCkpO1xuICBhcHAudXNlKGNhdGNoQWxsSGFuZGxlcik7XG5cbiAgLy8gbWFrZSBzdXJlIGFwcGl1bSBuZXZlciBmYWlscyBiZWNhdXNlIG9mIGEgZmlsZSBzaXplIHVwbG9hZCBsaW1pdFxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7bGltaXQ6ICcxZ2InfSkpO1xuXG4gIC8vIHNldCB1cCBzdGFydCBsb2dnaW5nICh3aGljaCBkZXBlbmRzIG9uIGJvZHlQYXJzZXIgZG9pbmcgaXRzIHRoaW5nKVxuICBhcHAudXNlKHN0YXJ0TG9nRm9ybWF0dGVyKTtcblxuICBjb25zdCBleHRyYU1ldGhvZHMgPSBwbHVnaW5zLmZpbHRlcigocCkgPT4ge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHAubmV3TWV0aG9kTWFwKSkge1xuICAgICAgbG9nLndhcm4oYFRyaWVkIHRvIGFwcGx5IG5ld01ldGhvZE1hcCBmcm9tIHBsdWdpbiAnJHtwLm5hbWV9JyBidXQgaXQgd2FzIGludmFsaWQuIFdpbGwgYCArXG4gICAgICAgICAgICAgICBgc2tpcCBhZGRpbmcgdGhlc2UgbWV0aG9kcyB0byB0aGUgbWV0aG9kIG1hcC5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0pLm1hcCgocCkgPT4gcC5uZXdNZXRob2RNYXApO1xuICBhZGRSb3V0ZXMoYXBwLCB7YmFzZVBhdGgsIGV4dHJhTWV0aG9kc30pO1xuXG4gIC8vIGR5bmFtaWMgcm91dGVzIGZvciB0ZXN0aW5nLCBldGMuXG4gIGFwcC5hbGwoJy93ZWxjb21lJywgd2VsY29tZSk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWcnLCBndWluZWFQaWcpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnLXNjcm9sbGFibGUnLCBndWluZWFQaWdTY3JvbGxhYmxlKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZy1hcHAtYmFubmVyJywgZ3VpbmVhUGlnQXBwQmFubmVyKTtcbiAgYXBwLmFsbCgnKicsIGNhdGNoNDA0SGFuZGxlcik7XG59XG5cbmZ1bmN0aW9uIGNvbmZpZ3VyZUh0dHAgKHtodHRwU2VydmVyLCByZWplY3R9KSB7XG4gIGNvbnN0IHNlcnZlclN0YXRlID0ge1xuICAgIG5vdGlmaWVyOiBuZXcgRXZlbnRFbWl0dGVyKCksXG4gICAgY2xvc2VkOiBmYWxzZSxcbiAgfTtcbiAgaHR0cFNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyID0gYWRkV2ViU29ja2V0SGFuZGxlcjtcbiAgaHR0cFNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyID0gcmVtb3ZlV2ViU29ja2V0SGFuZGxlcjtcbiAgaHR0cFNlcnZlci5yZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyA9IHJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzO1xuICBodHRwU2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzID0gZ2V0V2ViU29ja2V0SGFuZGxlcnM7XG5cbiAgLy8gaHR0cC5TZXJ2ZXIuY2xvc2UoKSBvbmx5IHN0b3BzIG5ldyBjb25uZWN0aW9ucywgYnV0IHdlIG5lZWQgdG8gd2FpdCB1bnRpbFxuICAvLyBhbGwgY29ubmVjdGlvbnMgYXJlIGNsb3NlZCBhbmQgdGhlIGBjbG9zZWAgZXZlbnQgaXMgZW1pdHRlZFxuICBjb25zdCBjbG9zZSA9IGh0dHBTZXJ2ZXIuY2xvc2UuYmluZChodHRwU2VydmVyKTtcbiAgaHR0cFNlcnZlci5jbG9zZSA9IGFzeW5jICgpID0+IGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUtdjAueC1hcmNoaXZlL2lzc3Vlcy85MDY2I2lzc3VlY29tbWVudC0xMjQyMTA1NzZcbiAgICBzZXJ2ZXJTdGF0ZS5jbG9zZWQgPSB0cnVlO1xuICAgIHNlcnZlclN0YXRlLm5vdGlmaWVyLmVtaXQoJ3NodXRkb3duJyk7XG4gICAgbG9nLmluZm8oJ1dhaXRpbmcgdW50aWwgdGhlIHNlcnZlciBpcyBjbG9zZWQnKTtcbiAgICBodHRwU2VydmVyLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgIGxvZy5pbmZvKCdSZWNlaXZlZCBzZXJ2ZXIgY2xvc2UgZXZlbnQnKTtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9KTtcbiAgICBjbG9zZSgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIH0pO1xuICB9KTtcblxuICBodHRwU2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUREUk5PVEFWQUlMJykge1xuICAgICAgbG9nLmVycm9yKCdDb3VsZCBub3Qgc3RhcnQgUkVTVCBodHRwIGludGVyZmFjZSBsaXN0ZW5lci4gJyArXG4gICAgICAgICAgICAgICAgJ1JlcXVlc3RlZCBhZGRyZXNzIGlzIG5vdCBhdmFpbGFibGUuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5lcnJvcignQ291bGQgbm90IHN0YXJ0IFJFU1QgaHR0cCBpbnRlcmZhY2UgbGlzdGVuZXIuIFRoZSByZXF1ZXN0ZWQgJyArXG4gICAgICAgICAgICAgICAgJ3BvcnQgbWF5IGFscmVhZHkgYmUgaW4gdXNlLiBQbGVhc2UgbWFrZSBzdXJlIHRoZXJlIGlzIG5vICcgK1xuICAgICAgICAgICAgICAgICdvdGhlciBpbnN0YW5jZSBvZiB0aGlzIHNlcnZlciBydW5uaW5nIGFscmVhZHkuJyk7XG4gICAgfVxuICAgIHJlamVjdChlcnIpO1xuICB9KTtcblxuICBodHRwU2VydmVyLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4ge1xuICAgIHNvY2tldC5zZXRUaW1lb3V0KEtFRVBfQUxJVkVfVElNRU9VVF9NUyk7XG4gICAgc29ja2V0Lm9uKCdlcnJvcicsIHJlamVjdCk7XG5cbiAgICBmdW5jdGlvbiBkZXN0cm95ICgpIHtcbiAgICAgIHNvY2tldC5kZXN0cm95KCk7XG4gICAgfVxuICAgIHNvY2tldC5fb3BlblJlcUNvdW50ID0gMDtcbiAgICBzb2NrZXQub25jZSgnY2xvc2UnLCAoKSA9PiBzZXJ2ZXJTdGF0ZS5ub3RpZmllci5yZW1vdmVMaXN0ZW5lcignc2h1dGRvd24nLCBkZXN0cm95KSk7XG4gICAgc2VydmVyU3RhdGUubm90aWZpZXIub25jZSgnc2h1dGRvd24nLCBkZXN0cm95KTtcbiAgfSk7XG5cbiAgaHR0cFNlcnZlci5vbigncmVxdWVzdCcsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGNvbnN0IHNvY2tldCA9IHJlcS5jb25uZWN0aW9uIHx8IHJlcS5zb2NrZXQ7XG4gICAgc29ja2V0Ll9vcGVuUmVxQ291bnQrKztcbiAgICByZXMub24oJ2ZpbmlzaCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHNvY2tldC5fb3BlblJlcUNvdW50LS07XG4gICAgICBpZiAoc2VydmVyU3RhdGUuY2xvc2VkICYmIHNvY2tldC5fb3BlblJlcUNvdW50ID09PSAwKSB7XG4gICAgICAgIHNvY2tldC5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb25maWd1cmVTZXJ2ZXJQbHVnaW5zICh7cGx1Z2lucywgYXBwLCBodHRwU2VydmVyfSkge1xuICAvLyBhbGxvdyBwbHVnaW5zIHRvIHVwZGF0ZSB0aGUgYXBwIGFuZCBodHRwIHNlcnZlciBvYmplY3RzXG4gIGZvciAoY29uc3QgcGx1Z2luIG9mIHBsdWdpbnMuZmlsdGVyKChwKSA9PiBwLnVwZGF0ZXNTZXJ2ZXIpKSB7XG4gICAgbG9nLmluZm8oYEFsbG93aW5nIHBsdWdpbiAke3BsdWdpbi5uYW1lfSB0byBtb2RpZnkgdGhlIEFwcGl1bSBzZXJ2ZXJgKTtcbiAgICB0cnkge1xuICAgICAgLy8gd3JhcCB0aGlzIGluIGVycm9yIGhhbmRsaW5nIGluIGNhc2UgdGhlIHBsdWdpbiBmb3Jnb3QgdG8gbWFyayB0aGUgZnVuY3Rpb24gYXN5bmMgb3JcbiAgICAgIC8vIGZvcmdvdCB0byBpbXBsZW1lbnQgaXRcbiAgICAgIGF3YWl0IHBsdWdpbi51cGRhdGVTZXJ2ZXIoYXBwLCBodHRwU2VydmVyKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihgUGx1Z2luICcke3BsdWdpbi5uYW1lfScgdHJpZWQgdG8gdXBkYXRlIHRoZSBzZXJ2ZXIgYnV0IHRoZSB1cGRhdGVTZXJ2ZXIgYCArXG4gICAgICAgICAgICAgICAgYG1ldGhvZCB3YXMgbm90IGltcGxlbWVudGVkLCBkaWQgbm90IHJldHVybiBhIHByb21pc2UsIG9yIHRocmV3IGFuIGAgK1xuICAgICAgICAgICAgICAgIGBlcnJvci4gT3JpZ2luYWwgbWVzc2FnZTogJHtlcnJ9LmApO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFNlcnZlciAoe2h0dHBTZXJ2ZXIsIHBvcnQsIGhvc3RuYW1lfSkge1xuICBjb25zdCBzZXJ2ZXJBcmdzID0gW3BvcnRdO1xuICBpZiAoaG9zdG5hbWUpIHtcbiAgICAvLyBJZiB0aGUgaG9zdG5hbWUgaXMgb21pdHRlZCwgdGhlIHNlcnZlciB3aWxsIGFjY2VwdFxuICAgIC8vIGNvbm5lY3Rpb25zIG9uIGFueSBJUCBhZGRyZXNzXG4gICAgc2VydmVyQXJncy5wdXNoKGhvc3RuYW1lKTtcbiAgfVxuICBjb25zdCBzdGFydFByb21pc2UgPSBCLnByb21pc2lmeShodHRwU2VydmVyLmxpc3Rlbiwge2NvbnRleHQ6IGh0dHBTZXJ2ZXJ9KSguLi5zZXJ2ZXJBcmdzKTtcbiAgaHR0cFNlcnZlci5rZWVwQWxpdmVUaW1lb3V0ID0gS0VFUF9BTElWRV9USU1FT1VUX01TO1xuICAvLyBoZWFkZXJzIHRpbWVvdXQgbXVzdCBiZSBncmVhdGVyIHRoYW4ga2VlcEFsaXZlVGltZW91dFxuICBodHRwU2VydmVyLmhlYWRlcnNUaW1lb3V0ID0gS0VFUF9BTElWRV9USU1FT1VUX01TICsgNSAqIDEwMDA7XG4gIGF3YWl0IHN0YXJ0UHJvbWlzZTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQmFzZVBhdGggKGJhc2VQYXRoKSB7XG4gIGlmICghXy5pc1N0cmluZyhiYXNlUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBwcmVmaXggJHtiYXNlUGF0aH1gKTtcbiAgfVxuXG4gIC8vIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBub3QgZW5kIGluICcvJywgc2luY2Ugb3VyIG1ldGhvZCBtYXBcbiAgLy8gc3RhcnRzIGFsbCBwYXRocyB3aXRoICcvJ1xuICBiYXNlUGF0aCA9IGJhc2VQYXRoLnJlcGxhY2UoL1xcLyQvLCAnJyk7XG5cbiAgLy8gbGlrZXdpc2UsIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBhbHdheXMgU1RBUlQgd2l0aCAvLCB1bmxlc3MgdGhlIHBhdGhcbiAgLy8gaXMgZW1wdHkgbWVhbmluZyBubyBiYXNlIHBhdGggYXQgYWxsXG4gIGlmIChiYXNlUGF0aCAhPT0gJycgJiYgYmFzZVBhdGhbMF0gIT09ICcvJykge1xuICAgIGJhc2VQYXRoID0gYC8ke2Jhc2VQYXRofWA7XG4gIH1cblxuICByZXR1cm4gYmFzZVBhdGg7XG59XG5cbmV4cG9ydCB7IHNlcnZlciwgY29uZmlndXJlU2VydmVyLCBub3JtYWxpemVCYXNlUGF0aCB9O1xuIl0sImZpbGUiOiJsaWIvZXhwcmVzcy9zZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
