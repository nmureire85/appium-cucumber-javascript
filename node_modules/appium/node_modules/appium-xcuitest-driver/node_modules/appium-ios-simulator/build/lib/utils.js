"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllSimulators = killAllSimulators;
exports.endAllSimulatorDaemons = endAllSimulatorDaemons;
exports.safeRimRaf = safeRimRaf;
exports.simExists = simExists;
exports.getSimulatorInfo = getSimulatorInfo;
exports.installSSLCert = installSSLCert;
exports.uninstallSSLCert = uninstallSSLCert;
exports.hasSSLCert = hasSSLCert;
exports.execSQLiteQuery = execSQLiteQuery;
exports.toBiometricDomainComponent = toBiometricDomainComponent;
exports.getDeveloperRoot = getDeveloperRoot;
exports.activateApp = activateApp;
exports.MOBILE_SAFARI_BUNDLE_ID = exports.SAFARI_STARTUP_TIMEOUT = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _asyncbox = require("asyncbox");

var _appiumXcode = require("appium-xcode");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumSupport = require("appium-support");

var _certificate = require("./certificate");

var _path = _interopRequireDefault(require("path"));

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-6"));

const DEFAULT_SIM_SHUTDOWN_TIMEOUT = 30000;
const SAFARI_STARTUP_TIMEOUT = 25 * 1000;
exports.SAFARI_STARTUP_TIMEOUT = SAFARI_STARTUP_TIMEOUT;
const MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
exports.MOBILE_SAFARI_BUNDLE_ID = MOBILE_SAFARI_BUNDLE_ID;

const APP_ACTIVATION_SCRIPT = pid => `#!/usr/bin/python

from AppKit import NSApplicationActivateIgnoringOtherApps, NSApplicationActivateAllWindows
from Cocoa import NSRunningApplication

app = NSRunningApplication.runningApplicationWithProcessIdentifier_(${pid})
if not app:
    raise ValueError('App with PID ${pid} is not running')
if not app.activateWithOptions_(NSApplicationActivateAllWindows | NSApplicationActivateIgnoringOtherApps):
    raise ValueError('App with PID ${pid} cannot be activated')
`;

const BIOMETRICS = {
  touchId: 'fingerTouch',
  faceId: 'pearl'
};

function toBiometricDomainComponent(name) {
  if (!BIOMETRICS[name]) {
    throw new Error(`'${name}' is not a valid biometric. Use one of: ${JSON.stringify(_lodash.default.keys(BIOMETRICS))}`);
  }

  return BIOMETRICS[name];
}

async function pkill(appName, forceKill = false) {
  let args = forceKill ? ['-9'] : [];
  args.push('-x', appName);

  try {
    await (0, _teen_process.exec)('pkill', args);
    return 0;
  } catch (err) {
    if (!_lodash.default.isUndefined(err.code)) {
      throw new Error(`Cannot forcefully terminate ${appName}. pkill error code: ${err.code}`);
    }

    _logger.default.error(`Received unexpected error while trying to kill ${appName}: ${err.message}`);

    throw err;
  }
}

async function killAllSimulators(timeout = DEFAULT_SIM_SHUTDOWN_TIMEOUT) {
  _logger.default.debug('Killing all iOS Simulators');

  const xcodeVersion = await (0, _appiumXcode.getVersion)(true);
  const appName = xcodeVersion.major >= 7 ? 'Simulator' : 'iOS Simulator';
  timeout = timeout * (xcodeVersion.major >= 8 ? 2 : 1);

  try {
    await (0, _teen_process.exec)('xcrun', ['simctl', 'shutdown', xcodeVersion.major > 8 ? 'all' : 'booted'], {
      timeout
    });
  } catch (ign) {}

  const pids = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('pgrep', ['-f', `${appName}.app/Contents/MacOS/`]);

    if (stdout.trim()) {
      pids.push(...stdout.trim().split(/\s+/));
    }
  } catch (e) {
    if (e.code === 1) {
      _logger.default.debug(`${appName} is not running. Continuing...`);

      return;
    }

    if (_lodash.default.isEmpty(pids)) {
      _logger.default.warn(`pgrep error ${e.code} while detecting whether ${appName} is running. Trying to kill anyway.`);
    }
  }

  if (!_lodash.default.isEmpty(pids)) {
    _logger.default.debug(`Killing processes: ${pids.join(', ')}`);

    try {
      await (0, _teen_process.exec)('kill', ['-9', ...pids.map(pid => `${pid}`)]);
    } catch (ign) {}
  }

  _logger.default.debug(`Using pkill to kill application: ${appName}`);

  try {
    await pkill(appName, true);
  } catch (ign) {}

  let remainingDevices = [];

  async function allSimsAreDown() {
    remainingDevices = [];
    let devices = await new _nodeSimctl.default().getDevices();
    devices = _lodash.default.flatten(_lodash.default.values(devices));
    return _lodash.default.every(devices, sim => {
      let state = sim.state.toLowerCase();
      let done = state === 'shutdown' || state === 'unavailable' || state === 'disconnected';

      if (!done) {
        remainingDevices.push(`${sim.name} (${sim.sdk}, udid: ${sim.udid}) is still in state '${state}'`);
      }

      return done;
    });
  }

  try {
    await (0, _asyncbox.waitForCondition)(allSimsAreDown, {
      waitMs: timeout,
      intervalMs: 200
    });
  } catch (err) {
    if (remainingDevices.length > 0) {
      _logger.default.warn(`The following devices are still not in the correct state after ${timeout} ms:`);

      for (let device of remainingDevices) {
        _logger.default.warn(`    ${device}`);
      }
    }

    throw err;
  }
}

async function endAllSimulatorDaemons() {
  _logger.default.debug('Ending all simulator daemons');

  for (let servicePattern of ['com.apple.iphonesimulator', 'com.apple.CoreSimulator']) {
    _logger.default.debug(`Killing any other ${servicePattern} daemons`);

    let launchCtlCommand = `launchctl list | grep ${servicePattern} | cut -f 3 | xargs -n 1 launchctl`;

    try {
      let stopCmd = `${launchCtlCommand} stop`;
      await (0, _teen_process.exec)('bash', ['-c', stopCmd]);
    } catch (err) {
      _logger.default.warn(`Could not stop ${servicePattern} daemons, carrying on anyway!`);
    }

    try {
      let removeCmd = `${launchCtlCommand} remove`;
      await (0, _teen_process.exec)('bash', ['-c', removeCmd]);
    } catch (err) {
      _logger.default.warn(`Could not remove ${servicePattern} daemons, carrying on anyway!`);
    }
  }

  try {
    await (0, _asyncbox.waitForCondition)(async () => {
      let {
        stdout
      } = await (0, _teen_process.exec)('bash', ['-c', `ps -e  | grep launchd_sim | grep -v bash | grep -v grep | awk {'print$1'}`]);
      return stdout.trim().length === 0;
    }, {
      waitMs: 5000,
      intervalMs: 500
    });
  } catch (err) {
    _logger.default.warn(`Could not end all simulator daemons, carrying on!`);
  }

  _logger.default.debug('Finishing ending all simulator daemons');
}

async function getSimulatorInfo(udid) {
  let devices = await new _nodeSimctl.default().getDevices();
  devices = _lodash.default.toPairs(devices).map(pair => pair[1]).reduce((a, b) => a.concat(b), []);
  return _lodash.default.find(devices, sim => sim.udid === udid);
}

async function simExists(udid) {
  return !!(await getSimulatorInfo(udid));
}

async function safeRimRaf(delPath, tryNum = 0) {
  try {
    await _appiumSupport.fs.rimraf(delPath);
  } catch (err) {
    if (tryNum < 20) {
      if (err.message.indexOf('ENOTEMPTY') !== -1) {
        _logger.default.debug(`Path '${delPath}' was not empty during delete; retrying`);

        return await safeRimRaf(delPath, tryNum + 1);
      } else if (err.message.indexOf('ENOENT') !== -1) {
        _logger.default.debug(`Path '${delPath}' did not exist when we tried to delete, ignoring`);

        return await safeRimRaf(delPath, tryNum + 1);
      }
    }
  }
}

async function installSSLCert(pemText, udid) {
  try {
    await _appiumSupport.fs.which('openssl');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires openssl to be available on path`);

    _logger.default.errorAndThrow(`Command 'openssl' not found`);
  }

  try {
    await _appiumSupport.fs.which('sqlite3');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires sqlite3 to be available on path`);

    _logger.default.errorAndThrow(`Command 'sqlite3' not found`);
  }

  let tempFileName = _path.default.resolve(await _appiumSupport.tempDir.openDir(), 'temp-ssl-cert.pem');

  let pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);

  try {
    await _appiumSupport.fs.stat(pathToKeychain);
  } catch (e) {
    _logger.default.debug(`Could not install SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }

  let certificate = new _certificate.Certificate(tempFileName);

  _logger.default.debug(`Installing certificate to ${pathToKeychain}`);

  await certificate.add(pathToKeychain);
  await _appiumSupport.fs.unlink(tempFileName);
  return certificate;
}

async function uninstallSSLCert(pemText, udid) {
  try {
    let tempFileName = _path.default.resolve(__dirname, 'temp-ssl-cert.pem');

    let pathToKeychain = _path.default.resolve(new _simulatorXcode.default(udid).getDir());

    await _appiumSupport.fs.writeFile(tempFileName, pemText);
    let certificate = new _certificate.Certificate(tempFileName);
    await certificate.remove(pathToKeychain);
    await _appiumSupport.fs.unlink(tempFileName);
    return certificate;
  } catch (e) {
    _logger.default.debug(`Could not uninstall SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }
}

async function hasSSLCert(pemText, udid) {
  const tempFileName = _path.default.resolve(await _appiumSupport.tempDir.openDir(), 'temp-ssl-cert.pem');

  const pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);
  const certificate = new _certificate.Certificate(tempFileName);
  return certificate.has(pathToKeychain);
}

async function execSQLiteQuery(db, query, ...queryParams) {
  query = query.replace(/\n+/g, ' ');
  let queryTokens = query.split('?');
  let formattedQuery = [];
  queryParams.map(param => `${param}`).forEach((param, i) => {
    formattedQuery.push(queryTokens[i]);
    formattedQuery.push(param.replace(/'/g, "''"));
  });
  formattedQuery.push(queryTokens[queryTokens.length - 1]);

  _logger.default.debug(`Executing SQL query "${formattedQuery.join('')}" on '${db}'`);

  try {
    return (await (0, _teen_process.exec)('sqlite3', ['-line', db, formattedQuery.join('')])).stdout;
  } catch (err) {
    throw new Error(`Cannot execute SQLite query "${formattedQuery.join('')}" to '${db}'. ` + `Original error: ${err.stderr}`);
  }
}

async function getDeveloperRoot() {
  const {
    stdout
  } = await (0, _teen_process.exec)('xcode-select', ['-p']);
  return stdout.trim();
}

async function activateApp(pid) {
  const tmpScript = await _appiumSupport.tempDir.path({
    prefix: `activate_sim_${_appiumSupport.util.uuidV4().substring(0, 8)}`,
    suffix: '.py'
  });
  await _appiumSupport.fs.writeFile(tmpScript, APP_ACTIVATION_SCRIPT(pid), 'utf8');

  try {
    await (0, _teen_process.exec)('/usr/bin/python', [tmpScript]);
  } finally {
    await _appiumSupport.fs.rimraf(tmpScript);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUIiwiU0FGQVJJX1NUQVJUVVBfVElNRU9VVCIsIk1PQklMRV9TQUZBUklfQlVORExFX0lEIiwiQVBQX0FDVElWQVRJT05fU0NSSVBUIiwicGlkIiwiQklPTUVUUklDUyIsInRvdWNoSWQiLCJmYWNlSWQiLCJ0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCIsIm5hbWUiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJfIiwia2V5cyIsInBraWxsIiwiYXBwTmFtZSIsImZvcmNlS2lsbCIsImFyZ3MiLCJwdXNoIiwiZXJyIiwiaXNVbmRlZmluZWQiLCJjb2RlIiwibG9nIiwiZXJyb3IiLCJtZXNzYWdlIiwia2lsbEFsbFNpbXVsYXRvcnMiLCJ0aW1lb3V0IiwiZGVidWciLCJ4Y29kZVZlcnNpb24iLCJtYWpvciIsImlnbiIsInBpZHMiLCJzdGRvdXQiLCJ0cmltIiwic3BsaXQiLCJlIiwiaXNFbXB0eSIsIndhcm4iLCJqb2luIiwibWFwIiwicmVtYWluaW5nRGV2aWNlcyIsImFsbFNpbXNBcmVEb3duIiwiZGV2aWNlcyIsIlNpbWN0bCIsImdldERldmljZXMiLCJmbGF0dGVuIiwidmFsdWVzIiwiZXZlcnkiLCJzaW0iLCJzdGF0ZSIsInRvTG93ZXJDYXNlIiwiZG9uZSIsInNkayIsInVkaWQiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwibGVuZ3RoIiwiZGV2aWNlIiwiZW5kQWxsU2ltdWxhdG9yRGFlbW9ucyIsInNlcnZpY2VQYXR0ZXJuIiwibGF1bmNoQ3RsQ29tbWFuZCIsInN0b3BDbWQiLCJyZW1vdmVDbWQiLCJnZXRTaW11bGF0b3JJbmZvIiwidG9QYWlycyIsInBhaXIiLCJyZWR1Y2UiLCJhIiwiYiIsImNvbmNhdCIsImZpbmQiLCJzaW1FeGlzdHMiLCJzYWZlUmltUmFmIiwiZGVsUGF0aCIsInRyeU51bSIsImZzIiwicmltcmFmIiwiaW5kZXhPZiIsImluc3RhbGxTU0xDZXJ0IiwicGVtVGV4dCIsIndoaWNoIiwiZXJyb3JBbmRUaHJvdyIsInRlbXBGaWxlTmFtZSIsInBhdGgiLCJyZXNvbHZlIiwidGVtcERpciIsIm9wZW5EaXIiLCJwYXRoVG9LZXljaGFpbiIsIlNpbXVsYXRvciIsImdldERpciIsIndyaXRlRmlsZSIsInN0YXQiLCJjZXJ0aWZpY2F0ZSIsIkNlcnRpZmljYXRlIiwiYWRkIiwidW5saW5rIiwidW5pbnN0YWxsU1NMQ2VydCIsIl9fZGlybmFtZSIsInJlbW92ZSIsImhhc1NTTENlcnQiLCJoYXMiLCJleGVjU1FMaXRlUXVlcnkiLCJkYiIsInF1ZXJ5IiwicXVlcnlQYXJhbXMiLCJyZXBsYWNlIiwicXVlcnlUb2tlbnMiLCJmb3JtYXR0ZWRRdWVyeSIsInBhcmFtIiwiZm9yRWFjaCIsImkiLCJzdGRlcnIiLCJnZXREZXZlbG9wZXJSb290IiwiYWN0aXZhdGVBcHAiLCJ0bXBTY3JpcHQiLCJwcmVmaXgiLCJ1dGlsIiwidXVpZFY0Iiwic3Vic3RyaW5nIiwic3VmZml4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLDRCQUE0QixHQUFHLEtBQXJDO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxJQUFwQzs7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyx3QkFBaEM7OztBQUNBLE1BQU1DLHFCQUFxQixHQUFJQyxHQUFELElBQVU7Ozs7O3NFQUs4QkEsR0FBSTs7cUNBRXJDQSxHQUFJOztxQ0FFSkEsR0FBSTtDQVR6Qzs7QUFhQSxNQUFNQyxVQUFVLEdBQUc7QUFDakJDLEVBQUFBLE9BQU8sRUFBRSxhQURRO0FBRWpCQyxFQUFBQSxNQUFNLEVBQUU7QUFGUyxDQUFuQjs7QUFLQSxTQUFTQywwQkFBVCxDQUFxQ0MsSUFBckMsRUFBMkM7QUFDekMsTUFBSSxDQUFDSixVQUFVLENBQUNJLElBQUQsQ0FB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Q0FBOEIsRUFEbkI7QUFFbkNDLElBQUFBLE1BQU0sRUFBRTtBQUYyQixHQUFiLENBQXhCO0FBSUEsUUFBTTVDLGtCQUFHZSxTQUFILENBQWF3QixTQUFiLEVBQXdCaEgscUJBQXFCLENBQUNDLEdBQUQsQ0FBN0MsRUFBb0QsTUFBcEQsQ0FBTjs7QUFDQSxNQUFJO0FBQ0YsVUFBTSx3QkFBSyxpQkFBTCxFQUF3QixDQUFDK0csU0FBRCxDQUF4QixDQUFOO0FBQ0QsR0FGRCxTQUVVO0FBQ1IsVUFBTXZDLGtCQUFHQyxNQUFILENBQVVzQyxTQUFWLENBQU47QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZ2V0VmVyc2lvbiB9IGZyb20gJ2FwcGl1bS14Y29kZSc7XG5pbXBvcnQgU2ltY3RsIGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgQ2VydGlmaWNhdGUgfSBmcm9tICcuL2NlcnRpZmljYXRlJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFNpbXVsYXRvciBmcm9tICcuL3NpbXVsYXRvci14Y29kZS02JztcblxuXG5jb25zdCBERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUID0gMzAwMDA7XG5jb25zdCBTQUZBUklfU1RBUlRVUF9USU1FT1VUID0gMjUgKiAxMDAwO1xuY29uc3QgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLm1vYmlsZXNhZmFyaSc7XG5jb25zdCBBUFBfQUNUSVZBVElPTl9TQ1JJUFQgPSAocGlkKSA9PiBgIyEvdXNyL2Jpbi9weXRob25cblxuZnJvbSBBcHBLaXQgaW1wb3J0IE5TQXBwbGljYXRpb25BY3RpdmF0ZUlnbm9yaW5nT3RoZXJBcHBzLCBOU0FwcGxpY2F0aW9uQWN0aXZhdGVBbGxXaW5kb3dzXG5mcm9tIENvY29hIGltcG9ydCBOU1J1bm5pbmdBcHBsaWNhdGlvblxuXG5hcHAgPSBOU1J1bm5pbmdBcHBsaWNhdGlvbi5ydW5uaW5nQXBwbGljYXRpb25XaXRoUHJvY2Vzc0lkZW50aWZpZXJfKCR7cGlkfSlcbmlmIG5vdCBhcHA6XG4gICAgcmFpc2UgVmFsdWVFcnJvcignQXBwIHdpdGggUElEICR7cGlkfSBpcyBub3QgcnVubmluZycpXG5pZiBub3QgYXBwLmFjdGl2YXRlV2l0aE9wdGlvbnNfKE5TQXBwbGljYXRpb25BY3RpdmF0ZUFsbFdpbmRvd3MgfCBOU0FwcGxpY2F0aW9uQWN0aXZhdGVJZ25vcmluZ090aGVyQXBwcyk6XG4gICAgcmFpc2UgVmFsdWVFcnJvcignQXBwIHdpdGggUElEICR7cGlkfSBjYW5ub3QgYmUgYWN0aXZhdGVkJylcbmA7XG5cblxuY29uc3QgQklPTUVUUklDUyA9IHtcbiAgdG91Y2hJZDogJ2ZpbmdlclRvdWNoJyxcbiAgZmFjZUlkOiAncGVhcmwnLFxufTtcblxuZnVuY3Rpb24gdG9CaW9tZXRyaWNEb21haW5Db21wb25lbnQgKG5hbWUpIHtcbiAgaWYgKCFCSU9NRVRSSUNTW25hbWVdKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHtuYW1lfScgaXMgbm90IGEgdmFsaWQgYmlvbWV0cmljLiBVc2Ugb25lIG9mOiAke0pTT04uc3RyaW5naWZ5KF8ua2V5cyhCSU9NRVRSSUNTKSl9YCk7XG4gIH1cbiAgcmV0dXJuIEJJT01FVFJJQ1NbbmFtZV07XG59XG5cbi8vIHBncmVwL3BraWxsIGV4aXQgY29kZXM6XG4vLyAwICAgICAgIE9uZSBvciBtb3JlIHByb2Nlc3NlcyB3ZXJlIG1hdGNoZWQuXG4vLyAxICAgICAgIE5vIHByb2Nlc3NlcyB3ZXJlIG1hdGNoZWQuXG4vLyAyICAgICAgIEludmFsaWQgb3B0aW9ucyB3ZXJlIHNwZWNpZmllZCBvbiB0aGUgY29tbWFuZCBsaW5lLlxuLy8gMyAgICAgICBBbiBpbnRlcm5hbCBlcnJvciBvY2N1cnJlZC5cblxuYXN5bmMgZnVuY3Rpb24gcGtpbGwgKGFwcE5hbWUsIGZvcmNlS2lsbCA9IGZhbHNlKSB7XG4gIGxldCBhcmdzID0gZm9yY2VLaWxsID8gWyctOSddIDogW107XG4gIGFyZ3MucHVzaCgnLXgnLCBhcHBOYW1lKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKCdwa2lsbCcsIGFyZ3MpO1xuICAgIHJldHVybiAwO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQoZXJyLmNvZGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmb3JjZWZ1bGx5IHRlcm1pbmF0ZSAke2FwcE5hbWV9LiBwa2lsbCBlcnJvciBjb2RlOiAke2Vyci5jb2RlfWApO1xuICAgIH1cbiAgICBsb2cuZXJyb3IoYFJlY2VpdmVkIHVuZXhwZWN0ZWQgZXJyb3Igd2hpbGUgdHJ5aW5nIHRvIGtpbGwgJHthcHBOYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24ga2lsbEFsbFNpbXVsYXRvcnMgKHRpbWVvdXQgPSBERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUKSB7XG4gIGxvZy5kZWJ1ZygnS2lsbGluZyBhbGwgaU9TIFNpbXVsYXRvcnMnKTtcbiAgY29uc3QgeGNvZGVWZXJzaW9uID0gYXdhaXQgZ2V0VmVyc2lvbih0cnVlKTtcbiAgY29uc3QgYXBwTmFtZSA9IHhjb2RlVmVyc2lvbi5tYWpvciA+PSA3ID8gJ1NpbXVsYXRvcicgOiAnaU9TIFNpbXVsYXRvcic7XG5cbiAgLy8gbGF0ZXIgdmVyc2lvbnMgYXJlIHNsb3dlciB0byBjbG9zZVxuICB0aW1lb3V0ID0gdGltZW91dCAqICh4Y29kZVZlcnNpb24ubWFqb3IgPj0gOCA/IDIgOiAxKTtcblxuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ3hjcnVuJywgWydzaW1jdGwnLCAnc2h1dGRvd24nLCB4Y29kZVZlcnNpb24ubWFqb3IgPiA4ID8gJ2FsbCcgOiAnYm9vdGVkJ10sIHt0aW1lb3V0fSk7XG4gIH0gY2F0Y2ggKGlnbikge31cblxuICBjb25zdCBwaWRzID0gW107XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdwZ3JlcCcsIFsnLWYnLCBgJHthcHBOYW1lfS5hcHAvQ29udGVudHMvTWFjT1MvYF0pO1xuICAgIGlmIChzdGRvdXQudHJpbSgpKSB7XG4gICAgICBwaWRzLnB1c2goLi4uKHN0ZG91dC50cmltKCkuc3BsaXQoL1xccysvKSkpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUgPT09IDEpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJHthcHBOYW1lfSBpcyBub3QgcnVubmluZy4gQ29udGludWluZy4uLmApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoXy5pc0VtcHR5KHBpZHMpKSB7XG4gICAgICBsb2cud2FybihgcGdyZXAgZXJyb3IgJHtlLmNvZGV9IHdoaWxlIGRldGVjdGluZyB3aGV0aGVyICR7YXBwTmFtZX0gaXMgcnVubmluZy4gVHJ5aW5nIHRvIGtpbGwgYW55d2F5LmApO1xuICAgIH1cbiAgfVxuICBpZiAoIV8uaXNFbXB0eShwaWRzKSkge1xuICAgIGxvZy5kZWJ1ZyhgS2lsbGluZyBwcm9jZXNzZXM6ICR7cGlkcy5qb2luKCcsICcpfWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdraWxsJywgWyctOScsIC4uLihwaWRzLm1hcCgocGlkKSA9PiBgJHtwaWR9YCkpXSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG5cbiAgbG9nLmRlYnVnKGBVc2luZyBwa2lsbCB0byBraWxsIGFwcGxpY2F0aW9uOiAke2FwcE5hbWV9YCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgcGtpbGwoYXBwTmFtZSwgdHJ1ZSk7XG4gIH0gY2F0Y2ggKGlnbikge31cblxuICAvLyB3YWl0IGZvciBhbGwgdGhlIGRldmljZXMgdG8gYmUgc2h1dGRvd24gYmVmb3JlIENvbnRpbnVpbmdcbiAgLy8gYnV0IG9ubHkgcHJpbnQgb3V0IHRoZSBmYWlsZWQgb25lcyB3aGVuIHRoZXkgYXJlIGFjdHVhbGx5IGZ1bGx5IGZhaWxlZFxuICBsZXQgcmVtYWluaW5nRGV2aWNlcyA9IFtdO1xuICBhc3luYyBmdW5jdGlvbiBhbGxTaW1zQXJlRG93biAoKSB7XG4gICAgcmVtYWluaW5nRGV2aWNlcyA9IFtdO1xuICAgIGxldCBkZXZpY2VzID0gYXdhaXQgbmV3IFNpbWN0bCgpLmdldERldmljZXMoKTtcbiAgICBkZXZpY2VzID0gXy5mbGF0dGVuKF8udmFsdWVzKGRldmljZXMpKTtcbiAgICByZXR1cm4gXy5ldmVyeShkZXZpY2VzLCAoc2ltKSA9PiB7XG4gICAgICBsZXQgc3RhdGUgPSBzaW0uc3RhdGUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGxldCBkb25lID0gc3RhdGUgPT09ICdzaHV0ZG93bicgfHxcbiAgICAgICAgICAgICAgICAgc3RhdGUgPT09ICd1bmF2YWlsYWJsZScgfHxcbiAgICAgICAgICAgICAgICAgc3RhdGUgPT09ICdkaXNjb25uZWN0ZWQnO1xuICAgICAgaWYgKCFkb25lKSB7XG4gICAgICAgIHJlbWFpbmluZ0RldmljZXMucHVzaChgJHtzaW0ubmFtZX0gKCR7c2ltLnNka30sIHVkaWQ6ICR7c2ltLnVkaWR9KSBpcyBzdGlsbCBpbiBzdGF0ZSAnJHtzdGF0ZX0nYCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZG9uZTtcbiAgICB9KTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYWxsU2ltc0FyZURvd24sIHtcbiAgICAgIHdhaXRNczogdGltZW91dCxcbiAgICAgIGludGVydmFsTXM6IDIwMFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAocmVtYWluaW5nRGV2aWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICBsb2cud2FybihgVGhlIGZvbGxvd2luZyBkZXZpY2VzIGFyZSBzdGlsbCBub3QgaW4gdGhlIGNvcnJlY3Qgc3RhdGUgYWZ0ZXIgJHt0aW1lb3V0fSBtczpgKTtcbiAgICAgIGZvciAobGV0IGRldmljZSBvZiByZW1haW5pbmdEZXZpY2VzKSB7XG4gICAgICAgIGxvZy53YXJuKGAgICAgJHtkZXZpY2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBlbmRBbGxTaW11bGF0b3JEYWVtb25zICgpIHtcbiAgbG9nLmRlYnVnKCdFbmRpbmcgYWxsIHNpbXVsYXRvciBkYWVtb25zJyk7XG4gIGZvciAobGV0IHNlcnZpY2VQYXR0ZXJuIG9mIFsnY29tLmFwcGxlLmlwaG9uZXNpbXVsYXRvcicsICdjb20uYXBwbGUuQ29yZVNpbXVsYXRvciddKSB7XG4gICAgbG9nLmRlYnVnKGBLaWxsaW5nIGFueSBvdGhlciAke3NlcnZpY2VQYXR0ZXJufSBkYWVtb25zYCk7XG4gICAgbGV0IGxhdW5jaEN0bENvbW1hbmQgPSBgbGF1bmNoY3RsIGxpc3QgfCBncmVwICR7c2VydmljZVBhdHRlcm59IHwgY3V0IC1mIDMgfCB4YXJncyAtbiAxIGxhdW5jaGN0bGA7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBzdG9wQ21kID0gYCR7bGF1bmNoQ3RsQ29tbWFuZH0gc3RvcGA7XG4gICAgICBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsIHN0b3BDbWRdKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDb3VsZCBub3Qgc3RvcCAke3NlcnZpY2VQYXR0ZXJufSBkYWVtb25zLCBjYXJyeWluZyBvbiBhbnl3YXkhYCk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVtb3ZlQ21kID0gYCR7bGF1bmNoQ3RsQ29tbWFuZH0gcmVtb3ZlYDtcbiAgICAgIGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJywgcmVtb3ZlQ21kXSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IHJlbW92ZSAke3NlcnZpY2VQYXR0ZXJufSBkYWVtb25zLCBjYXJyeWluZyBvbiBhbnl3YXkhYCk7XG4gICAgfVxuICB9XG4gIC8vIHdhaXRpbmcgdW50aWwgdGhlIHNpbXVsYXRvciBzZXJ2aWNlIGhhcyBkaWVkLlxuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLFxuICAgICAgICBgcHMgLWUgIHwgZ3JlcCBsYXVuY2hkX3NpbSB8IGdyZXAgLXYgYmFzaCB8IGdyZXAgLXYgZ3JlcCB8IGF3ayB7J3ByaW50JDEnfWBdKTtcbiAgICAgIHJldHVybiBzdGRvdXQudHJpbSgpLmxlbmd0aCA9PT0gMDtcbiAgICB9LCB7d2FpdE1zOiA1MDAwLCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENvdWxkIG5vdCBlbmQgYWxsIHNpbXVsYXRvciBkYWVtb25zLCBjYXJyeWluZyBvbiFgKTtcbiAgfVxuICBsb2cuZGVidWcoJ0ZpbmlzaGluZyBlbmRpbmcgYWxsIHNpbXVsYXRvciBkYWVtb25zJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNpbXVsYXRvckluZm8gKHVkaWQpIHtcbiAgLy8gc2VlIHRoZSBSRUFETUUgZm9yIGdpdGh1Yi5jb20vYXBwaXVtL25vZGUtc2ltY3RsIGZvciBleGFtcGxlIG91dHB1dCBvZiBnZXREZXZpY2VzKClcbiAgbGV0IGRldmljZXMgPSBhd2FpdCBuZXcgU2ltY3RsKCkuZ2V0RGV2aWNlcygpO1xuXG4gIGRldmljZXMgPSBfLnRvUGFpcnMoZGV2aWNlcylcbiAgICAubWFwKChwYWlyKSA9PiBwYWlyWzFdKVxuICAgIC5yZWR1Y2UoKGEsIGIpID0+IGEuY29uY2F0KGIpLCBbXSk7XG4gIHJldHVybiBfLmZpbmQoZGV2aWNlcywgKHNpbSkgPT4gc2ltLnVkaWQgPT09IHVkaWQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaW1FeGlzdHMgKHVkaWQpIHtcbiAgcmV0dXJuICEhKGF3YWl0IGdldFNpbXVsYXRvckluZm8odWRpZCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzYWZlUmltUmFmIChkZWxQYXRoLCB0cnlOdW0gPSAwKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGRlbFBhdGgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodHJ5TnVtIDwgMjApIHtcbiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9URU1QVFknKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQYXRoICcke2RlbFBhdGh9JyB3YXMgbm90IGVtcHR5IGR1cmluZyBkZWxldGU7IHJldHJ5aW5nYCk7XG4gICAgICAgIHJldHVybiBhd2FpdCBzYWZlUmltUmFmKGRlbFBhdGgsIHRyeU51bSArIDEpO1xuICAgICAgfSBlbHNlIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9FTlQnKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQYXRoICcke2RlbFBhdGh9JyBkaWQgbm90IGV4aXN0IHdoZW4gd2UgdHJpZWQgdG8gZGVsZXRlLCBpZ25vcmluZ2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgc2FmZVJpbVJhZihkZWxQYXRoLCB0cnlOdW0gKyAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBJbnN0YWxsIGFuIFNTTCBjZXJ0aWZpY2F0ZSB0byBhIGRldmljZSB3aXRoIGdpdmVuIHVkaWRcbiAqIEBwYXJhbSB7c3RyaW5nfSBwZW1UZXh0IFNTTCBwZW0gdGV4dFxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgSWRlbnRpZmllciBvZiB0aGUgU2ltdWxhdG9yXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxTU0xDZXJ0IChwZW1UZXh0LCB1ZGlkKSB7XG4gIC8vIENoZWNrIHRoYXQgb3BlbnNzbCBpcyBpbnN0YWxsZWQgb24gdGhlIHBhdGhcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaCgnb3BlbnNzbCcpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBjdXN0b21TU0xDZXJ0IHJlcXVpcmVzIG9wZW5zc2wgdG8gYmUgYXZhaWxhYmxlIG9uIHBhdGhgKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ29tbWFuZCAnb3BlbnNzbCcgbm90IGZvdW5kYCk7XG4gIH1cblxuICAvLyBDaGVjayB0aGF0IHNxbGl0ZTMgaXMgaW5zdGFsbGVkIG9uIHRoZSBwYXRoXG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ3NxbGl0ZTMnKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZyhgY3VzdG9tU1NMQ2VydCByZXF1aXJlcyBzcWxpdGUzIHRvIGJlIGF2YWlsYWJsZSBvbiBwYXRoYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvbW1hbmQgJ3NxbGl0ZTMnIG5vdCBmb3VuZGApO1xuICB9XG5cbiAgLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IGZpbGUgdG8gc3RvcmUgUEVNIHRleHRcbiAgLy8gKGEgdGVtcCBmaWxlIGlzIG5lY2Vzc2FyeSB0byBydW4gYG9wZW5zc2xgIHNoZWxsIGNvbW1hbmRzLCBjYW4ndCBiZSBkb25lIGluIG1lbW9yeSlcbiAgbGV0IHRlbXBGaWxlTmFtZSA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gIGxldCBwYXRoVG9LZXljaGFpbiA9IG5ldyBTaW11bGF0b3IodWRpZCkuZ2V0RGlyKCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZU5hbWUsIHBlbVRleHQpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnN0YXQocGF0aFRvS2V5Y2hhaW4pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBDb3VsZCBub3QgaW5zdGFsbCBTU0wgY2VydGlmaWNhdGUuIE5vIHNpbXVsYXRvciB3aXRoIHVkaWQgJyR7dWRpZH0nYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coZSk7XG4gIH1cblxuICAvLyBEbyB0aGUgY2VydGlmaWNhdGUgaW5zdGFsbGF0aW9uXG4gIGxldCBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZSh0ZW1wRmlsZU5hbWUpO1xuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgY2VydGlmaWNhdGUgdG8gJHtwYXRoVG9LZXljaGFpbn1gKTtcbiAgYXdhaXQgY2VydGlmaWNhdGUuYWRkKHBhdGhUb0tleWNoYWluKTtcblxuICAvLyBSZW1vdmUgdGhlIHRlbXBvcmFyeSBmaWxlXG4gIGF3YWl0IGZzLnVubGluayh0ZW1wRmlsZU5hbWUpO1xuXG4gIHJldHVybiBjZXJ0aWZpY2F0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdW5pbnN0YWxsU1NMQ2VydCAocGVtVGV4dCwgdWRpZCkge1xuICB0cnkge1xuICAgIGxldCB0ZW1wRmlsZU5hbWUgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAndGVtcC1zc2wtY2VydC5wZW0nKTtcbiAgICBsZXQgcGF0aFRvS2V5Y2hhaW4gPSBwYXRoLnJlc29sdmUobmV3IFNpbXVsYXRvcih1ZGlkKS5nZXREaXIoKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlTmFtZSwgcGVtVGV4dCk7XG4gICAgbGV0IGNlcnRpZmljYXRlID0gbmV3IENlcnRpZmljYXRlKHRlbXBGaWxlTmFtZSk7XG4gICAgYXdhaXQgY2VydGlmaWNhdGUucmVtb3ZlKHBhdGhUb0tleWNoYWluKTtcbiAgICBhd2FpdCBmcy51bmxpbmsodGVtcEZpbGVOYW1lKTtcbiAgICByZXR1cm4gY2VydGlmaWNhdGU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYENvdWxkIG5vdCB1bmluc3RhbGwgU1NMIGNlcnRpZmljYXRlLiBObyBzaW11bGF0b3Igd2l0aCB1ZGlkICcke3VkaWR9J2ApO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICB9XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhlIFNpbXVsYXRvciBhbHJlYWR5IGhhcyB0aGlzIFNTTCBjZXJ0aWZpY2F0ZVxuICogQHBhcmFtIHtzdHJpbmd9IHBlbVRleHQgUEVNIHRleHQgb2YgU1NMIGNlcnRcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIElkZW50aWZpZXIgb2YgdGhlIFNpbXVsYXRvclxuICovXG5hc3luYyBmdW5jdGlvbiBoYXNTU0xDZXJ0IChwZW1UZXh0LCB1ZGlkKSB7XG4gIGNvbnN0IHRlbXBGaWxlTmFtZSA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gIGNvbnN0IHBhdGhUb0tleWNoYWluID0gbmV3IFNpbXVsYXRvcih1ZGlkKS5nZXREaXIoKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlTmFtZSwgcGVtVGV4dCk7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gbmV3IENlcnRpZmljYXRlKHRlbXBGaWxlTmFtZSk7XG4gIHJldHVybiBjZXJ0aWZpY2F0ZS5oYXMocGF0aFRvS2V5Y2hhaW4pO1xufVxuXG4vKipcbiAqIFJ1bnMgYSBjb21tYW5kIGxpbmUgc3FsaXRlMyBxdWVyeVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBkYiAtIEZ1bGwgcGF0aCB0byBzcWxpdGUgZGF0YWJhc2VcbiAqIEBwYXJhbSB7c3RyaW5nfSBxdWVyeSAtIFRoZSBhY3R1YWwgcXVlcnkgc3RyaW5nXG4gKiBAcGFyYW0gey4uLnN0cmluZ30gcXVlcnlQYXJhbXMgLSBUaGUgbGlzdCBvZiBxdWVyeSBwYXJhbWV0ZXJzXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBzcWxpdGUgY29tbWFuZCBzdGRvdXRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXhlY1NRTGl0ZVF1ZXJ5IChkYiwgcXVlcnksIC4uLnF1ZXJ5UGFyYW1zKSB7XG4gIHF1ZXJ5ID0gcXVlcnkucmVwbGFjZSgvXFxuKy9nLCAnICcpO1xuICBsZXQgcXVlcnlUb2tlbnMgPSBxdWVyeS5zcGxpdCgnPycpO1xuICBsZXQgZm9ybWF0dGVkUXVlcnkgPSBbXTtcbiAgcXVlcnlQYXJhbXNcbiAgICAubWFwKChwYXJhbSkgPT4gYCR7cGFyYW19YClcbiAgICAuZm9yRWFjaCgocGFyYW0sIGkpID0+IHtcbiAgICAgIGZvcm1hdHRlZFF1ZXJ5LnB1c2gocXVlcnlUb2tlbnNbaV0pO1xuICAgICAgZm9ybWF0dGVkUXVlcnkucHVzaChwYXJhbS5yZXBsYWNlKC8nL2csIFwiJydcIikpO1xuICAgIH0pO1xuICBmb3JtYXR0ZWRRdWVyeS5wdXNoKHF1ZXJ5VG9rZW5zW3F1ZXJ5VG9rZW5zLmxlbmd0aCAtIDFdKTtcblxuICBsb2cuZGVidWcoYEV4ZWN1dGluZyBTUUwgcXVlcnkgXCIke2Zvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpfVwiIG9uICcke2RifSdgKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IGV4ZWMoJ3NxbGl0ZTMnLCBbJy1saW5lJywgZGIsIGZvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpXSkpLnN0ZG91dDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZXhlY3V0ZSBTUUxpdGUgcXVlcnkgXCIke2Zvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpfVwiIHRvICcke2RifScuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5zdGRlcnJ9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2ZWxvcGVyUm9vdCAoKSB7XG4gIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNvZGUtc2VsZWN0JywgWyctcCddKTtcbiAgcmV0dXJuIHN0ZG91dC50cmltKCk7XG59XG5cbi8qKlxuICogQWN0aXZhdGVzIHRoZSBhcHAgaGF2aW5nIHRoZSBnaXZlbiBwcm9jZXNzIGlkZW50aWZpZXIuXG4gKiBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2RvY3VtZW50YXRpb24vYXBwa2l0L25zcnVubmluZ2FwcGxpY2F0aW9uLzE1Mjg3MjUtYWN0aXZhdGV3aXRob3B0aW9ucz9sYW5ndWFnZT1vYmpjXG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gcGlkIEFwcCBwcm9jZXNzIGlkZW50aWZpZXJcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgZ2l2ZW4gUElEIGlzIG5vdCBydW5uaW5nIG9yIHRoZXJlIHdhcyBhIGZhaWx1cmVcbiAqIHdoaWxlIGFjdGl2YXRpbmcgdGhlIGFwcFxuICovXG5hc3luYyBmdW5jdGlvbiBhY3RpdmF0ZUFwcCAocGlkKSB7XG4gIGNvbnN0IHRtcFNjcmlwdCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiBgYWN0aXZhdGVfc2ltXyR7dXRpbC51dWlkVjQoKS5zdWJzdHJpbmcoMCwgOCl9YCxcbiAgICBzdWZmaXg6ICcucHknLFxuICB9KTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRtcFNjcmlwdCwgQVBQX0FDVElWQVRJT05fU0NSSVBUKHBpZCksICd1dGY4Jyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnL3Vzci9iaW4vcHl0aG9uJywgW3RtcFNjcmlwdF0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBTY3JpcHQpO1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIGtpbGxBbGxTaW11bGF0b3JzLFxuICBlbmRBbGxTaW11bGF0b3JEYWVtb25zLFxuICBzYWZlUmltUmFmLFxuICBzaW1FeGlzdHMsXG4gIGdldFNpbXVsYXRvckluZm8sXG4gIGluc3RhbGxTU0xDZXJ0LFxuICB1bmluc3RhbGxTU0xDZXJ0LFxuICBoYXNTU0xDZXJ0LFxuICBleGVjU1FMaXRlUXVlcnksXG4gIHRvQmlvbWV0cmljRG9tYWluQ29tcG9uZW50LFxuICBnZXREZXZlbG9wZXJSb290LFxuICBhY3RpdmF0ZUFwcCxcbiAgU0FGQVJJX1NUQVJUVVBfVElNRU9VVCxcbiAgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsXG59O1xuIl0sImZpbGUiOiJsaWIvdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
