"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.YouiEngineDriver = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _desiredCaps = require("./desired-caps");

var _logger = _interopRequireDefault(require("./logger"));

var _commands = _interopRequireDefault(require("./commands"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncbox = require("asyncbox");

var _appiumAndroidDriver = _interopRequireDefault(require("appium-android-driver"));

var _appiumIosDriver = _interopRequireDefault(require("appium-ios-driver"));

var _appiumXcuitestDriver = _interopRequireDefault(require("appium-xcuitest-driver"));

var _appiumMacDriver = _interopRequireDefault(require("appium-mac-driver"));

var _bluesky = _interopRequireDefault(require("./bluesky"));

var _tvos = _interopRequireDefault(require("./tvos"));

var _tvossimulator = _interopRequireDefault(require("./tvossimulator"));

var _yimac = _interopRequireDefault(require("./yimac"));

const TO_PROXY_COMMON = ['background', 'closeApp', 'getLog', 'getLogTypes', 'getOrientation', 'getStrings', 'installApp', 'launchApp', 'lock', 'removeApp', 'setOrientation'];
const TO_PROXY_IOS_ONLY = ['mobileShake'];
const TO_PROXY_ANDROID_ONLY = ['getNetworkConnection', 'isAppInstalled', 'isLocked', 'longPressKeyCode', 'pressKeyCode', 'setNetworkConnection', 'toggleLocationServices', 'unlock'];
const TO_PROXY_IOS = TO_PROXY_IOS_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_ANDROID = TO_PROXY_ANDROID_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_MAC = TO_PROXY_COMMON;
const MAX_RETRY_COUNT = 3;
const SOCKET_TIMEOUT = 10000;

class YouiEngineDriver extends _appiumBaseDriver.BaseDriver {
  resetYouiEngine() {
    this.ready = false;
    this.socket = null;
    this.locatorStrategies = ['id', 'name', 'class name', 'accessibility id'];
    this.proxydriver = null;
    this.proxyAllowList = '';
    this.device = null;
  }

  constructor(opts, shouldValidateCaps) {
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.settings = new _appiumBaseDriver.DeviceSettings({
      'TimeDilation': 1,
      'SourceTreeFilter': ''
    }, this.onSettingsUpdate.bind(this));
    this.resetYouiEngine();
  }

  validateLocatorStrategy(strategy) {
    super.validateLocatorStrategy(strategy, false);
  }

  async createSession(caps) {
    try {
      let [sessionId] = await super.createSession(caps);

      if (caps.platformName !== null) {
        let appPlatform = caps.platformName.toLowerCase();

        switch (appPlatform) {
          case 'ios':
          case 'tvos':
            await this.startXCUITestSession(caps);
            break;

          case 'android':
            await this.startAndroidSession(caps);
            break;

          case 'mac':
            await this.startMacSession(caps);
            break;

          case 'yimac':
            this.device = new _yimac.default();
            await this.device.startSession(caps);
            break;

          case 'bluesky':
            this.device = new _bluesky.default();
            await this.device.startSession(caps);
            break;

          case 'yitvos':
            {
              let shell = require('shelljs');

              if (shell.exec(`instruments -s devices | grep '${caps.udid}'`).includes('(Simulator)')) {
                this.device = new _tvossimulator.default();
              } else {
                this.device = new _tvos.default();
              }

              await this.device.startSession(caps, this);
              break;
            }

          case 'noproxy':
          case 'connecttoapp':
            break;

          default:
            _logger.default.errorAndThrow(`Unsupported platformName: ${caps.platformName}`);

        }
      }

      await this.connectSocket();

      if (caps.fullSourceTree === true) {} else {
        _logger.default.debug('Setting SourceTreeFilter to displayed elements only');

        await this.updateSettings({
          SourceTreeFilter: "[@isDisplayed='true']"
        });
      }

      return [sessionId, this.opts];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  async onSettingsUpdate(key, value) {
    if (key === 'TimeDilation') {
      await this.setTimeDilation(value);
    } else if (key === 'SourceTreeFilter') {
      await this.setSourceTreeFilter(value);
    }
  }

  async stop() {
    this.ready = false;
  }

  async deleteSession() {
    _logger.default.debug('Deleting YouiEngine session');

    if (this.caps.platformName !== null) {
      let appPlatform = this.caps.platformName.toLowerCase();

      if (['yimac', 'yitvos', 'bluesky'].includes(appPlatform)) {
        if (this.device) {
          this.device.endSession();
        }
      }
    }

    if (this.proxydriver !== null) {
      await this.proxydriver.deleteSession();
    }

    this.socket.end();
    this.socket.destroy();
    await super.deleteSession();
    await this.stop();
  }

  driverShouldDoProxyCmd(command) {
    if (!this.proxydriver) {
      return false;
    }

    for (let allowedCommand of this.proxyAllowList) {
      if (allowedCommand === command) {
        return true;
      }
    }

    return false;
  }

  async executeCommand(cmd, ...args) {
    if (cmd === 'receiveAsyncResponse') {
      _logger.default.debug(`Executing YouiEngineDriver response '${cmd}'`);

      return await this.receiveAsyncResponse(...args);
    } else if (this.ready) {
      if (this.driverShouldDoProxyCmd(cmd)) {
        _logger.default.debug(`Executing proxied WebDriver command '${cmd}'`);

        this.clearNewCommandTimeout();
        let result = this.proxydriver.executeCommand(cmd, ...args);
        this.startNewCommandTimeout(cmd);
        return result;
      } else {
        _logger.default.debug(`Executing YouiEngine WebDriver command '${cmd}'`);

        return await super.executeCommand(cmd, ...args);
      }
    } else {
      _logger.default.debug(`Command Error '${cmd}'`);

      throw new _appiumBaseDriver.errors.NoSuchDriverError(`Driver is not ready, cannot execute ${cmd}.`);
    }
  }

  validateDesiredCaps(caps) {
    let res = super.validateDesiredCaps(caps);

    if (!res) {
      return res;
    }

    if (!caps.youiEngineAppAddress) {
      let msg = 'The desired capabilities must include youiEngineAppAddress';

      _logger.default.errorAndThrow(msg);
    }

    if (caps.platformName.toLowerCase() !== 'connecttoapp' && caps.platformName.toLowerCase() !== 'noproxy') {
      if (!caps.app) {
        let msg = 'The desired capabilities must include app';

        _logger.default.errorAndThrow(msg);
      }

      const fs = require('fs');

      const path = require('path');

      if (!fs.existsSync(caps.app)) {
        let absolutepath = path.resolve(caps.app);
        let msg = 'The app could not be found in following location: ' + absolutepath;

        _logger.default.errorAndThrow(msg);
      }

      if (caps.deviceName.toLowerCase() === 'android') {
        if (!caps.avd) {
          let msg = 'The desired capabilities must include avd';

          _logger.default.errorAndThrow(msg);
        }
      }
    }

    return true;
  }

  async setupNewXCUITestDriver(caps) {
    let args = {
      javascriptEnabled: true
    };
    let driver = new _appiumXcuitestDriver.default(args);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await driver.createSession(capsCopy);
    return driver;
  }

  async startXCUITestSession(caps) {
    _logger.default.info('Starting an IOS proxy session');

    this.proxyAllowList = TO_PROXY_IOS;
    this.proxydriver = await this.setupNewXCUITestDriver(caps);
  }

  async setupNewAndroidDriver(caps) {
    let androidArgs = {
      javascriptEnabled: true
    };
    let androiddriver = new _appiumAndroidDriver.default(androidArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await androiddriver.createSession(capsCopy);
    return androiddriver;
  }

  async startAndroidSession(caps) {
    _logger.default.info('Starting an Android proxy session');

    this.proxyAllowList = TO_PROXY_ANDROID;
    this.proxydriver = await this.setupNewAndroidDriver(caps);
  }

  async setupNewMacDriver(caps) {
    let macArgs = {
      javascriptEnabled: true
    };
    let macdriver = new _appiumMacDriver.default(macArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await macdriver.createSession(capsCopy);
    return macdriver;
  }

  async startMacSession(caps) {
    _logger.default.info('Starting a Mac proxy session');

    this.proxyAllowList = TO_PROXY_MAC;
    this.proxydriver = await this.setupNewMacDriver(caps);
  }

  async connectSocket() {
    let retryCount = 0;
    let connected = false;
    let errno = 'EOK';

    while (retryCount < MAX_RETRY_COUNT && !connected) {
      _logger.default.info('Attempt #' + (retryCount + 1));

      let connectedPromise = new _bluebird.default(resolve => {
        let net = require('net');

        let HOST = this.opts.youiEngineAppAddress;
        let PORT;

        if (this.caps.youiEngineAppPort) {
          PORT = this.caps.youiEngineAppPort;
        } else if (this.caps.platformName.toLowerCase() === 'yips4') {
          PORT = 40123;
        } else {
          PORT = 12345;
        }

        {
          _logger.default.info('Connecting to WebDriver: ' + HOST + ':' + PORT);
        }
        this.socket = new net.Socket();
        this.socket.setTimeout(SOCKET_TIMEOUT);
        this.socket.setKeepAlive(true, 1000);
        let socketClient = this.socket;

        let removeListenerHandler = function () {
          socketClient.removeListener('timeout', timeoutHandler);
          socketClient.removeListener('close', closeHandler);
          socketClient.removeListener('end', endHandler);
          socketClient.removeListener('error', errorHandler);
        };

        let errorHandler = function (ex) {
          _logger.default.error(ex);

          _logger.default.error('Check that WebDriver is enabled in application, if a device ensure the proper IP address is used.');

          removeListenerHandler();
          socketClient.destroy();
          errno = ex.errno;
          resolve(false);
        };

        this.socket.on('error', errorHandler);

        let closeHandler = function () {
          _logger.default.info('Connection closed');

          removeListenerHandler();
          socketClient.destroy();
          resolve(false);
        };

        this.socket.on('close', closeHandler);

        let timeoutHandler = function () {
          _logger.default.error('Connection timed out');

          removeListenerHandler();
          socketClient.destroy();
          resolve(false);
        };

        this.socket.on('timeout', timeoutHandler);
        this.socket.connect(PORT, HOST, function () {
          _logger.default.error('Connection established');

          removeListenerHandler();
          resolve(true);
        });

        let endHandler = function () {
          _logger.default.info('Connection ended');

          removeListenerHandler();
          socketClient.destroy();
          resolve(false);
        };

        this.socket.on('end', endHandler);
      });
      retryCount++;
      connected = await connectedPromise;

      if (!connected && errno === 'ECONNREFUSED') {
        _logger.default.debug('Connection refused, sleeping...');

        await (0, _asyncbox.sleep)(2000);
        errno = 'EOK';
      }

      if (!connected && retryCount === MAX_RETRY_COUNT - 1) {
        _logger.default.errorAndThrow('Failed to connect ' + MAX_RETRY_COUNT + ' times. Aborting.');
      }
    }

    retryCount = 0;
    this.ready = connected;
  }

  async executeSocketCommand(cmd) {
    if (!this.socket.writable) {
      _logger.default.info('Socket is not writable. Trying to reconnect.');

      await this.connectSocket();
    }

    let retryCount = 0;

    while (retryCount < MAX_RETRY_COUNT) {
      this.socket.setTimeout(SOCKET_TIMEOUT);
      let cmdPromise = new _bluebird.default(resolve => {
        _logger.default.debug('COMMAND: ' + cmd);

        let totaldata = [];
        let endMarker = new Buffer.from('youiend');
        let socketClient = this.socket;

        let removeListenerHandler = function () {
          socketClient.removeListener('data', dataHandler);
          socketClient.removeListener('timeout', timeoutHandler);
          socketClient.removeListener('error', errorHandler);
        };

        let timeoutHandler = function () {
          _logger.default.info('Timeout in execute command.');

          removeListenerHandler();
          resolve(false);
        };

        let errorHandler = function () {
          _logger.default.info('On error');

          removeListenerHandler();
          resolve(false);
        };

        let dataHandler = function (data) {
          if (data.length >= endMarker.length) {
            let dataend = new Buffer.alloc(endMarker.length);
            let startIndex = data.length - endMarker.length;
            data.copy(dataend, 0, startIndex, startIndex + endMarker.length);

            if (dataend.equals(endMarker)) {
              let lastData = data.slice(0, startIndex);
              totaldata.push(lastData);
              removeListenerHandler();
              resolve(Buffer.concat(totaldata));
            } else {
              totaldata.push(data);
            }
          }
        };

        socketClient.write(cmd + '\n', 'UTF8', () => {
          socketClient.on('data', dataHandler);
          socketClient.on('timeout', timeoutHandler);
          socketClient.on('error', errorHandler);
        });
      });
      let res = await cmdPromise;

      if (res === false) {
        retryCount++;

        _logger.default.info('Socket failed. Retrying: ' + retryCount);

        continue;
      } else {
        return res;
      }
    }

    throw new Error('ExecuteSocketCommand failed.');
  }

}

exports.YouiEngineDriver = YouiEngineDriver;

for (let [cmd, fn] of _lodash.default.toPairs(_commands.default)) {
  YouiEngineDriver.prototype[cmd] = fn;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiVE9fUFJPWFlfQ09NTU9OIiwiVE9fUFJPWFlfSU9TX09OTFkiLCJUT19QUk9YWV9BTkRST0lEX09OTFkiLCJUT19QUk9YWV9JT1MiLCJjb25jYXQiLCJUT19QUk9YWV9BTkRST0lEIiwiVE9fUFJPWFlfTUFDIiwiTUFYX1JFVFJZX0NPVU5UIiwiU09DS0VUX1RJTUVPVVQiLCJZb3VpRW5naW5lRHJpdmVyIiwiQmFzZURyaXZlciIsInJlc2V0WW91aUVuZ2luZSIsInJlYWR5Iiwic29ja2V0IiwibG9jYXRvclN0cmF0ZWdpZXMiLCJwcm94eWRyaXZlciIsInByb3h5QWxsb3dMaXN0IiwiZGV2aWNlIiwiY29uc3RydWN0b3IiLCJvcHRzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwic2V0dGluZ3MiLCJEZXZpY2VTZXR0aW5ncyIsIm9uU2V0dGluZ3NVcGRhdGUiLCJiaW5kIiwidmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3kiLCJzdHJhdGVneSIsImNyZWF0ZVNlc3Npb24iLCJjYXBzIiwic2Vzc2lvbklkIiwicGxhdGZvcm1OYW1lIiwiYXBwUGxhdGZvcm0iLCJ0b0xvd2VyQ2FzZSIsInN0YXJ0WENVSVRlc3RTZXNzaW9uIiwic3RhcnRBbmRyb2lkU2Vzc2lvbiIsInN0YXJ0TWFjU2Vzc2lvbiIsIllpTWFjIiwic3RhcnRTZXNzaW9uIiwiQmx1ZVNreSIsInNoZWxsIiwicmVxdWlyZSIsImV4ZWMiLCJ1ZGlkIiwiaW5jbHVkZXMiLCJUdk9zU2ltdWxhdG9yIiwiVHZPcyIsImxvZ2dlciIsImVycm9yQW5kVGhyb3ciLCJjb25uZWN0U29ja2V0IiwiZnVsbFNvdXJjZVRyZWUiLCJkZWJ1ZyIsInVwZGF0ZVNldHRpbmdzIiwiU291cmNlVHJlZUZpbHRlciIsImUiLCJkZWxldGVTZXNzaW9uIiwia2V5IiwidmFsdWUiLCJzZXRUaW1lRGlsYXRpb24iLCJzZXRTb3VyY2VUcmVlRmlsdGVyIiwic3RvcCIsImVuZFNlc3Npb24iLCJlbmQiLCJkZXN0cm95IiwiZHJpdmVyU2hvdWxkRG9Qcm94eUNtZCIsImNvbW1hbmQiLCJhbGxvd2VkQ29tbWFuZCIsImV4ZWN1dGVDb21tYW5kIiwiY21kIiwiYXJncyIsInJlY2VpdmVBc3luY1Jlc3BvbnNlIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsInJlc3VsdCIsInN0YXJ0TmV3Q29tbWFuZFRpbWVvdXQiLCJlcnJvcnMiLCJOb1N1Y2hEcml2ZXJFcnJvciIsInZhbGlkYXRlRGVzaXJlZENhcHMiLCJyZXMiLCJ5b3VpRW5naW5lQXBwQWRkcmVzcyIsIm1zZyIsImFwcCIsImZzIiwicGF0aCIsImV4aXN0c1N5bmMiLCJhYnNvbHV0ZXBhdGgiLCJyZXNvbHZlIiwiZGV2aWNlTmFtZSIsImF2ZCIsInNldHVwTmV3WENVSVRlc3REcml2ZXIiLCJqYXZhc2NyaXB0RW5hYmxlZCIsImRyaXZlciIsIlhDVUlUZXN0RHJpdmVyIiwiY2Fwc0NvcHkiLCJfIiwiY2xvbmVEZWVwIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJpbmZvIiwic2V0dXBOZXdBbmRyb2lkRHJpdmVyIiwiYW5kcm9pZEFyZ3MiLCJhbmRyb2lkZHJpdmVyIiwiQW5kcm9pZERyaXZlciIsInNldHVwTmV3TWFjRHJpdmVyIiwibWFjQXJncyIsIm1hY2RyaXZlciIsIk1hY0RyaXZlciIsInJldHJ5Q291bnQiLCJjb25uZWN0ZWQiLCJlcnJubyIsImNvbm5lY3RlZFByb21pc2UiLCJCIiwibmV0IiwiSE9TVCIsIlBPUlQiLCJ5b3VpRW5naW5lQXBwUG9ydCIsIlNvY2tldCIsInNldFRpbWVvdXQiLCJzZXRLZWVwQWxpdmUiLCJzb2NrZXRDbGllbnQiLCJyZW1vdmVMaXN0ZW5lckhhbmRsZXIiLCJyZW1vdmVMaXN0ZW5lciIsInRpbWVvdXRIYW5kbGVyIiwiY2xvc2VIYW5kbGVyIiwiZW5kSGFuZGxlciIsImVycm9ySGFuZGxlciIsImV4IiwiZXJyb3IiLCJvbiIsImNvbm5lY3QiLCJleGVjdXRlU29ja2V0Q29tbWFuZCIsIndyaXRhYmxlIiwiY21kUHJvbWlzZSIsInRvdGFsZGF0YSIsImVuZE1hcmtlciIsIkJ1ZmZlciIsImZyb20iLCJkYXRhSGFuZGxlciIsImRhdGEiLCJsZW5ndGgiLCJkYXRhZW5kIiwiYWxsb2MiLCJzdGFydEluZGV4IiwiY29weSIsImVxdWFscyIsImxhc3REYXRhIiwic2xpY2UiLCJwdXNoIiwid3JpdGUiLCJFcnJvciIsImZuIiwidG9QYWlycyIsImNvbW1hbmRzIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQU1BLE1BQU1BLGVBQWUsR0FBRyxDQUN0QixZQURzQixFQUV0QixVQUZzQixFQUd0QixRQUhzQixFQUl0QixhQUpzQixFQUt0QixnQkFMc0IsRUFNdEIsWUFOc0IsRUFPdEIsWUFQc0IsRUFRdEIsV0FSc0IsRUFTdEIsTUFUc0IsRUFVdEIsV0FWc0IsRUFXdEIsZ0JBWHNCLENBQXhCO0FBY0EsTUFBTUMsaUJBQWlCLEdBQUcsQ0FDeEIsYUFEd0IsQ0FBMUI7QUFJQSxNQUFNQyxxQkFBcUIsR0FBRyxDQUM1QixzQkFENEIsRUFFNUIsZ0JBRjRCLEVBRzVCLFVBSDRCLEVBSTVCLGtCQUo0QixFQUs1QixjQUw0QixFQU01QixzQkFONEIsRUFPNUIsd0JBUDRCLEVBUTVCLFFBUjRCLENBQTlCO0FBV0EsTUFBTUMsWUFBWSxHQUFHRixpQkFBaUIsQ0FBQ0csTUFBbEIsQ0FBeUJKLGVBQXpCLENBQXJCO0FBQ0EsTUFBTUssZ0JBQWdCLEdBQUdILHFCQUFxQixDQUFDRSxNQUF0QixDQUE2QkosZUFBN0IsQ0FBekI7QUFDQSxNQUFNTSxZQUFZLEdBQUdOLGVBQXJCO0FBRUEsTUFBTU8sZUFBZSxHQUFHLENBQXhCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLEtBQXZCOztBQUVBLE1BQU1DLGdC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Rjs7QUFDRCxVQUFNLElBQUlzRSxLQUFKLENBQVUsOEJBQVYsQ0FBTjtBQUNEOztBQWpidUM7Ozs7QUFvYjFDLEtBQUssSUFBSSxDQUFDL0UsR0FBRCxFQUFNZ0YsRUFBTixDQUFULElBQXNCdkQsZ0JBQUV3RCxPQUFGLENBQVVDLGlCQUFWLENBQXRCLEVBQTJDO0FBQ3pDN0ksRUFBQUEsZ0JBQWdCLENBQUM4SSxTQUFqQixDQUEyQm5GLEdBQTNCLElBQWtDZ0YsRUFBbEM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEcml2ZXIsIERldmljZVNldHRpbmdzLCBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZGVzaXJlZENhcENvbnN0cmFpbnRzIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICdhc3luY2JveCc7XG5cbi8vIGZvciBwcm94aWVzXG5pbXBvcnQgQW5kcm9pZERyaXZlciBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuaW1wb3J0IElPU0RyaXZlciBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgWENVSVRlc3REcml2ZXIgZnJvbSAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcic7XG5pbXBvcnQgTWFjRHJpdmVyIGZyb20gJ2FwcGl1bS1tYWMtZHJpdmVyJztcbmltcG9ydCBCbHVlU2t5IGZyb20gJy4vYmx1ZXNreSc7XG5pbXBvcnQgVHZPcyBmcm9tICcuL3R2b3MnO1xuaW1wb3J0IFR2T3NTaW11bGF0b3IgZnJvbSAnLi90dm9zc2ltdWxhdG9yJztcbmltcG9ydCBZaU1hYyBmcm9tICcuL3lpbWFjJztcblxuXG4vLyBBZGQgY29tbWFuZHMgZnJvbSB0aGUgZm9sbG93aW5nIGxvY2F0aW9uIHRoYXQgc2hvdWxkIGJlIG1hcHBlZCB0byBleGlzdGluZyBkcml2ZXJzOlxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tYmFzZS1kcml2ZXIvYmxvYi9tYXN0ZXIvbGliL21qc29ud3Avcm91dGVzLmpzXG5cbmNvbnN0IFRPX1BST1hZX0NPTU1PTiA9IFtcbiAgJ2JhY2tncm91bmQnLFxuICAnY2xvc2VBcHAnLFxuICAnZ2V0TG9nJyxcbiAgJ2dldExvZ1R5cGVzJyxcbiAgJ2dldE9yaWVudGF0aW9uJyxcbiAgJ2dldFN0cmluZ3MnLFxuICAnaW5zdGFsbEFwcCcsXG4gICdsYXVuY2hBcHAnLFxuICAnbG9jaycsXG4gICdyZW1vdmVBcHAnLFxuICAnc2V0T3JpZW50YXRpb24nLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfSU9TX09OTFkgPSBbXG4gICdtb2JpbGVTaGFrZScsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9BTkRST0lEX09OTFkgPSBbXG4gICdnZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICdpc0FwcEluc3RhbGxlZCcsXG4gICdpc0xvY2tlZCcsXG4gICdsb25nUHJlc3NLZXlDb2RlJyxcbiAgJ3ByZXNzS2V5Q29kZScsXG4gICdzZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICd0b2dnbGVMb2NhdGlvblNlcnZpY2VzJyxcbiAgJ3VubG9jaycsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9JT1MgPSBUT19QUk9YWV9JT1NfT05MWS5jb25jYXQoVE9fUFJPWFlfQ09NTU9OKTtcbmNvbnN0IFRPX1BST1hZX0FORFJPSUQgPSBUT19QUk9YWV9BTkRST0lEX09OTFkuY29uY2F0KFRPX1BST1hZX0NPTU1PTik7XG5jb25zdCBUT19QUk9YWV9NQUMgPSBUT19QUk9YWV9DT01NT047XG5cbmNvbnN0IE1BWF9SRVRSWV9DT1VOVCA9IDM7XG5jb25zdCBTT0NLRVRfVElNRU9VVCA9IDEwMDAwO1xuXG5jbGFzcyBZb3VpRW5naW5lRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gIHJlc2V0WW91aUVuZ2luZSAoKSB7XG5cbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMubG9jYXRvclN0cmF0ZWdpZXMgPSBbJ2lkJywgJ25hbWUnLCAnY2xhc3MgbmFtZScsICdhY2Nlc3NpYmlsaXR5IGlkJ107XG4gICAgdGhpcy5wcm94eWRyaXZlciA9IG51bGw7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9ICcnO1xuICAgIHRoaXMuZGV2aWNlID0gbnVsbDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yIChvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpIHtcbiAgICBzdXBlcihvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ2FwQ29uc3RyYWludHM7XG4gICAgdGhpcy5zZXR0aW5ncyA9IG5ldyBEZXZpY2VTZXR0aW5ncyh7J1RpbWVEaWxhdGlvbic6IDEsICdTb3VyY2VUcmVlRmlsdGVyJzogJyd9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU2V0dGluZ3NVcGRhdGUuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yZXNldFlvdWlFbmdpbmUoKTtcblxuICB9XG5cbiAgdmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3kgKHN0cmF0ZWd5KSB7XG4gICAgc3VwZXIudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3ksIGZhbHNlKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKGNhcHMpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IFtzZXNzaW9uSWRdID0gYXdhaXQgc3VwZXIuY3JlYXRlU2Vzc2lvbihjYXBzKTtcblxuICAgICAgLy8gc2V0dXAgcHJveGllcyAtIGlmIHBsYXRmb3JtTmFtZSBpcyBub3QgZW1wdHksIG1ha2UgaXQgbGVzcyBjYXNlIHNlbnNpdGl2ZVxuICAgICAgaWYgKGNhcHMucGxhdGZvcm1OYW1lICE9PSBudWxsKSB7XG4gICAgICAgIGxldCBhcHBQbGF0Zm9ybSA9IGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIHN3aXRjaCAoYXBwUGxhdGZvcm0pIHtcbiAgICAgICAgICBjYXNlICdpb3MnOlxuICAgICAgICAgIGNhc2UgJ3R2b3MnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydFhDVUlUZXN0U2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2FuZHJvaWQnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydEFuZHJvaWRTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnbWFjJzpcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRNYWNTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAneWltYWMnOlxuICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgWWlNYWMoKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGV2aWNlLnN0YXJ0U2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2JsdWVza3knOlxuICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgQmx1ZVNreSgpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXZpY2Uuc3RhcnRTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAneWl0dm9zJzoge1xuICAgICAgICAgICAgbGV0IHNoZWxsID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuICAgICAgICAgICAgaWYgKHNoZWxsLmV4ZWMoYGluc3RydW1lbnRzIC1zIGRldmljZXMgfCBncmVwICcke2NhcHMudWRpZH0nYCkuaW5jbHVkZXMoJyhTaW11bGF0b3IpJykpIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgVHZPc1NpbXVsYXRvcigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgVHZPcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXZpY2Uuc3RhcnRTZXNzaW9uKGNhcHMsIHRoaXMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhc2UgJ25vcHJveHknOlxuICAgICAgICAgIGNhc2UgJ2Nvbm5lY3R0b2FwcCc6XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYFVuc3VwcG9ydGVkIHBsYXRmb3JtTmFtZTogJHtjYXBzLnBsYXRmb3JtTmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG5cbiAgICAgIGlmIChjYXBzLmZ1bGxTb3VyY2VUcmVlID09PSB0cnVlKSB7XG4gICAgICAgIC8vRG8gbm90IHNldCBmaWx0ZXJcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnU2V0dGluZyBTb3VyY2VUcmVlRmlsdGVyIHRvIGRpc3BsYXllZCBlbGVtZW50cyBvbmx5Jyk7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU2V0dGluZ3Moe1NvdXJjZVRyZWVGaWx0ZXI6IFwiW0Bpc0Rpc3BsYXllZD0ndHJ1ZSddXCJ9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFtzZXNzaW9uSWQsIHRoaXMub3B0c107XG5cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24oKTtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgb25TZXR0aW5nc1VwZGF0ZSAoa2V5LCB2YWx1ZSkge1xuICAgIGlmIChrZXkgPT09ICdUaW1lRGlsYXRpb24nKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRpbWVEaWxhdGlvbih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdTb3VyY2VUcmVlRmlsdGVyJykge1xuICAgICAgYXdhaXQgdGhpcy5zZXRTb3VyY2VUcmVlRmlsdGVyKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdG9wICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBZb3VpRW5naW5lIHNlc3Npb24nKTtcblxuICAgIGlmICh0aGlzLmNhcHMucGxhdGZvcm1OYW1lICE9PSBudWxsKSB7XG4gICAgICBsZXQgYXBwUGxhdGZvcm0gPSB0aGlzLmNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgIGlmIChbJ3lpbWFjJywgJ3lpdHZvcycsICdibHVlc2t5J10uaW5jbHVkZXMoYXBwUGxhdGZvcm0pKSB7XG4gICAgICAgIGlmICh0aGlzLmRldmljZSkge1xuICAgICAgICAgIHRoaXMuZGV2aWNlLmVuZFNlc3Npb24oKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLnByb3h5ZHJpdmVyICE9PSBudWxsKSB7XG4gICAgICBhd2FpdCB0aGlzLnByb3h5ZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICB9XG4gICAgdGhpcy5zb2NrZXQuZW5kKCk7XG4gICAgdGhpcy5zb2NrZXQuZGVzdHJveSgpO1xuICAgIGF3YWl0IHN1cGVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcbiAgfVxuXG4gIGRyaXZlclNob3VsZERvUHJveHlDbWQgKGNvbW1hbmQpIHtcbiAgICBpZiAoIXRoaXMucHJveHlkcml2ZXIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBvbmx5IGFsbG93IHdoaXRlIGxpc3RlZCBjb21tYW5kc1xuICAgIGZvciAobGV0IGFsbG93ZWRDb21tYW5kIG9mIHRoaXMucHJveHlBbGxvd0xpc3QpIHtcbiAgICAgIGlmIChhbGxvd2VkQ29tbWFuZCA9PT0gY29tbWFuZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUNvbW1hbmQgKGNtZCwgLi4uYXJncykge1xuICAgIGlmIChjbWQgPT09ICdyZWNlaXZlQXN5bmNSZXNwb25zZScpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFlvdWlFbmdpbmVEcml2ZXIgcmVzcG9uc2UgJyR7Y21kfSdgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlY2VpdmVBc3luY1Jlc3BvbnNlKC4uLmFyZ3MpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5yZWFkeSkge1xuXG4gICAgICBpZiAodGhpcy5kcml2ZXJTaG91bGREb1Byb3h5Q21kKGNtZCkpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBFeGVjdXRpbmcgcHJveGllZCBXZWJEcml2ZXIgY29tbWFuZCAnJHtjbWR9J2ApO1xuXG4gICAgICAgIC8vIFRoZXJlIGFyZSAyIENvbW1hbmRUaW1lb3V0IChZb3VpRW5naW5lRHJpdmVyIGFuZCBwcm94eSlcbiAgICAgICAgLy8gT25seSBZb3VpRW5naW5lRHJpdmVyIENvbW1hbmRUaW1lb3V0IGlzIHVzZWQ7IFByb3h5IGlzIGRpc2FibGVkXG4gICAgICAgIC8vIEFsbCBwcm94eSBjb21tYW5kcyBuZWVkcyB0byByZXNldCB0aGUgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dFxuICAgICAgICAvLyBIZXJlIHdlIG1hbnVhbGx5IHJlc2V0IHRoZSBZb3VpRW5naW5lRHJpdmVyIENvbW1hbmRUaW1lb3V0IGZvciBjb21tYW5kcyB0aGF0IGdvZSB0byBwcm94eS5cbiAgICAgICAgdGhpcy5jbGVhck5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gICAgICAgIGxldCByZXN1bHQgPSB0aGlzLnByb3h5ZHJpdmVyLmV4ZWN1dGVDb21tYW5kKGNtZCwgLi4uYXJncyk7XG4gICAgICAgIHRoaXMuc3RhcnROZXdDb21tYW5kVGltZW91dChjbWQpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBFeGVjdXRpbmcgWW91aUVuZ2luZSBXZWJEcml2ZXIgY29tbWFuZCAnJHtjbWR9J2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgc3VwZXIuZXhlY3V0ZUNvbW1hbmQoY21kLCAuLi5hcmdzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBDb21tYW5kIEVycm9yICcke2NtZH0nYCk7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaERyaXZlckVycm9yKGBEcml2ZXIgaXMgbm90IHJlYWR5LCBjYW5ub3QgZXhlY3V0ZSAke2NtZH0uYCk7XG4gICAgfVxuICB9XG5cbiAgdmFsaWRhdGVEZXNpcmVkQ2FwcyAoY2Fwcykge1xuICAgIC8vIGNoZWNrIHdpdGggdGhlIGJhc2UgY2xhc3MsIGFuZCByZXR1cm4gaWYgaXQgZmFpbHNcbiAgICBsZXQgcmVzID0gc3VwZXIudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcbiAgICBpZiAoIXJlcykge1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0aWVzIGhhcyB5b3VpRW5naW5lQXBwQWRkcmVzc1xuICAgIGlmICghY2Fwcy55b3VpRW5naW5lQXBwQWRkcmVzcykge1xuICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIHlvdWlFbmdpbmVBcHBBZGRyZXNzJztcbiAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuXG4gICAgLy8gQXBwIGlzIGJlaW5nIGxhdW5jaGVkXG4gICAgaWYgKGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdjb25uZWN0dG9hcHAnICYmIGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdub3Byb3h5Jykge1xuXG4gICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0aWVzIGhhcyBhcHBcbiAgICAgIGlmICghY2Fwcy5hcHApIHtcbiAgICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGFwcCc7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgICB9XG4gICAgICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gICAgICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGNhcHMuYXBwKSkge1xuICAgICAgICBsZXQgYWJzb2x1dGVwYXRoID0gcGF0aC5yZXNvbHZlKGNhcHMuYXBwKTtcbiAgICAgICAgbGV0IG1zZyA9ICdUaGUgYXBwIGNvdWxkIG5vdCBiZSBmb3VuZCBpbiBmb2xsb3dpbmcgbG9jYXRpb246ICcgKyBhYnNvbHV0ZXBhdGg7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgICB9XG5cbiAgICAgIC8vQW5kcm9pZCBlbXVsYXRvciB3aXRoIHByb3h5XG4gICAgICBpZiAoY2Fwcy5kZXZpY2VOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdhbmRyb2lkJykge1xuICAgICAgICBpZiAoIWNhcHMuYXZkKSB7XG4gICAgICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGF2ZCc7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGZpbmFsbHksIHJldHVybiB0cnVlIHNpbmNlIHRoZSBzdXBlcmNsYXNzIGNoZWNrIHBhc3NlZCwgYXMgZGlkIHRoaXNcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIHNldHVwTmV3WENVSVRlc3REcml2ZXIgKGNhcHMpIHtcbiAgICBsZXQgYXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlLFxuICAgIH07XG5cbiAgICBsZXQgZHJpdmVyID0gbmV3IFhDVUlUZXN0RHJpdmVyKGFyZ3MpO1xuXG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgaU9TIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gMDtcbiAgICBhd2FpdCBkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRYQ1VJVGVzdFNlc3Npb24gKGNhcHMpIHtcbiAgICBsb2dnZXIuaW5mbygnU3RhcnRpbmcgYW4gSU9TIHByb3h5IHNlc3Npb24nKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfSU9TO1xuXG4gICAgdGhpcy5wcm94eWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdYQ1VJVGVzdERyaXZlcihjYXBzKTtcbiAgfVxuXG4gIGFzeW5jIHNldHVwTmV3QW5kcm9pZERyaXZlciAoY2Fwcykge1xuICAgIGxldCBhbmRyb2lkQXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgYW5kcm9pZGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKGFuZHJvaWRBcmdzKTtcbiAgICBsZXQgY2Fwc0NvcHkgPSBfLmNsb25lRGVlcChjYXBzKTtcbiAgICAvLyBEaXNhYmxpbmcgdGhlIHByb3h5IENvbW1hbmRUaW1lb3V0IGluIHRoZSBBbmRyb2lkIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gMDtcblxuICAgIGF3YWl0IGFuZHJvaWRkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gYW5kcm9pZGRyaXZlcjtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0QW5kcm9pZFNlc3Npb24gKGNhcHMpIHtcbiAgICBsb2dnZXIuaW5mbygnU3RhcnRpbmcgYW4gQW5kcm9pZCBwcm94eSBzZXNzaW9uJyk7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX0FORFJPSUQ7XG5cbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0FuZHJvaWREcml2ZXIoY2Fwcyk7XG4gIH1cblxuICBhc3luYyBzZXR1cE5ld01hY0RyaXZlciAoY2Fwcykge1xuICAgIGxldCBtYWNBcmdzID0ge1xuICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWVcbiAgICB9O1xuICAgIGxldCBtYWNkcml2ZXIgPSBuZXcgTWFjRHJpdmVyKG1hY0FyZ3MpO1xuICAgIGxldCBjYXBzQ29weSA9IF8uY2xvbmVEZWVwKGNhcHMpO1xuICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIHByb3hpZWQgZHJpdmVyIHNpbmNlIHdlIGFyZSBub3cgaGFuZGxpbmcgaXQgaW4gdGhlIFlvdWlFbmdpbmUgRHJpdmVyXG4gICAgY2Fwc0NvcHkubmV3Q29tbWFuZFRpbWVvdXQgPSAwO1xuXG4gICAgYXdhaXQgbWFjZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2Fwc0NvcHkpO1xuXG4gICAgcmV0dXJuIG1hY2RyaXZlcjtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0TWFjU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKCdTdGFydGluZyBhIE1hYyBwcm94eSBzZXNzaW9uJyk7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX01BQztcblxuICAgIHRoaXMucHJveHlkcml2ZXIgPSBhd2FpdCB0aGlzLnNldHVwTmV3TWFjRHJpdmVyKGNhcHMpO1xuICB9XG5cbiAgLy8gU09DS0VUU1xuICBhc3luYyBjb25uZWN0U29ja2V0ICgpIHtcbiAgICBsZXQgcmV0cnlDb3VudCA9IDA7XG4gICAgbGV0IGNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIGxldCBlcnJubyA9ICdFT0snO1xuICAgIHdoaWxlIChyZXRyeUNvdW50IDwgTUFYX1JFVFJZX0NPVU5UICYmICFjb25uZWN0ZWQpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdBdHRlbXB0ICMnICsgKHJldHJ5Q291bnQgKyAxKSk7XG5cbiAgICAgIGxldCBjb25uZWN0ZWRQcm9taXNlID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgICAgbGV0IG5ldCA9IHJlcXVpcmUoJ25ldCcpO1xuXG4gICAgICAgIGxldCBIT1NUID0gdGhpcy5vcHRzLnlvdWlFbmdpbmVBcHBBZGRyZXNzO1xuICAgICAgICBsZXQgUE9SVDtcblxuICAgICAgICBpZiAodGhpcy5jYXBzLnlvdWlFbmdpbmVBcHBQb3J0KSB7XG4gICAgICAgICAgUE9SVCA9IHRoaXMuY2Fwcy55b3VpRW5naW5lQXBwUG9ydDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCkgPT09ICd5aXBzNCcpIHtcbiAgICAgICAgICBQT1JUID0gNDAxMjM7IC8vZGVmYXVsdCBwb3J0IGZvciBQUzRcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBQT1JUID0gMTIzNDU7IC8vZGVmYXVsdCBwb3J0XG4gICAgICAgIH1cbiAgICAgICAge2xvZ2dlci5pbmZvKCdDb25uZWN0aW5nIHRvIFdlYkRyaXZlcjogJyArIEhPU1QgKyAnOicgKyBQT1JUKTt9XG5cbiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgbmV0LlNvY2tldCgpO1xuICAgICAgICB0aGlzLnNvY2tldC5zZXRUaW1lb3V0KFNPQ0tFVF9USU1FT1VUKTtcbiAgICAgICAgdGhpcy5zb2NrZXQuc2V0S2VlcEFsaXZlKHRydWUsIDEwMDApO1xuXG4gICAgICAgIGxldCBzb2NrZXRDbGllbnQgPSB0aGlzLnNvY2tldDtcblxuICAgICAgICBsZXQgcmVtb3ZlTGlzdGVuZXJIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHNvY2tldENsaWVudC5yZW1vdmVMaXN0ZW5lcigndGltZW91dCcsIHRpbWVvdXRIYW5kbGVyKTtcbiAgICAgICAgICBzb2NrZXRDbGllbnQucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgY2xvc2VIYW5kbGVyKTtcbiAgICAgICAgICBzb2NrZXRDbGllbnQucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIGVuZEhhbmRsZXIpO1xuICAgICAgICAgIHNvY2tldENsaWVudC5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBlcnJvckhhbmRsZXIpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vIEFkZCBhbiAnZXJyb3InIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBjbGllbnQgc29ja2V0XG4gICAgICAgIGxldCBlcnJvckhhbmRsZXIgPSBmdW5jdGlvbiAoZXgpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoZXgpO1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignQ2hlY2sgdGhhdCBXZWJEcml2ZXIgaXMgZW5hYmxlZCBpbiBhcHBsaWNhdGlvbiwgaWYgYSBkZXZpY2UgZW5zdXJlIHRoZSBwcm9wZXIgSVAgYWRkcmVzcyBpcyB1c2VkLicpO1xuICAgICAgICAgIHJlbW92ZUxpc3RlbmVySGFuZGxlcigpO1xuICAgICAgICAgIHNvY2tldENsaWVudC5kZXN0cm95KCk7XG4gICAgICAgICAgZXJybm8gPSBleC5lcnJubztcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCdlcnJvcicsIGVycm9ySGFuZGxlcik7XG4gICAgICAgIC8vIEFkZCBhICdjbG9zZScgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgbGV0IGNsb3NlSGFuZGxlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGlvbiBjbG9zZWQnKTtcbiAgICAgICAgICByZW1vdmVMaXN0ZW5lckhhbmRsZXIoKTtcbiAgICAgICAgICBzb2NrZXRDbGllbnQuZGVzdHJveSgpO1xuICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNvY2tldC5vbiAoJ2Nsb3NlJywgY2xvc2VIYW5kbGVyKTtcbiAgICAgICAgLy8gQWRkIGEgJ3RpbWVvdXQnIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBjbGllbnQgc29ja2V0XG4gICAgICAgIGxldCB0aW1lb3V0SGFuZGxlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Nvbm5lY3Rpb24gdGltZWQgb3V0Jyk7XG4gICAgICAgICAgcmVtb3ZlTGlzdGVuZXJIYW5kbGVyKCk7XG4gICAgICAgICAgc29ja2V0Q2xpZW50LmRlc3Ryb3koKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCd0aW1lb3V0JywgdGltZW91dEhhbmRsZXIpO1xuICAgICAgICB0aGlzLnNvY2tldC5jb25uZWN0IChQT1JULCBIT1NULCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdDb25uZWN0aW9uIGVzdGFibGlzaGVkJyk7XG4gICAgICAgICAgcmVtb3ZlTGlzdGVuZXJIYW5kbGVyKCk7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGxldCBlbmRIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxvZ2dlci5pbmZvKCdDb25uZWN0aW9uIGVuZGVkJyk7XG4gICAgICAgICAgcmVtb3ZlTGlzdGVuZXJIYW5kbGVyKCk7XG4gICAgICAgICAgc29ja2V0Q2xpZW50LmRlc3Ryb3koKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ2VuZCcsIGVuZEhhbmRsZXIpO1xuICAgICAgfSk7XG4gICAgICByZXRyeUNvdW50Kys7XG4gICAgICBjb25uZWN0ZWQgPSBhd2FpdCBjb25uZWN0ZWRQcm9taXNlO1xuXG4gICAgICBpZiAoIWNvbm5lY3RlZCAmJiBlcnJubyA9PT0gJ0VDT05OUkVGVVNFRCcpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdDb25uZWN0aW9uIHJlZnVzZWQsIHNsZWVwaW5nLi4uJyk7XG4gICAgICAgIGF3YWl0IHNsZWVwKDIwMDApO1xuICAgICAgICBlcnJubyA9ICdFT0snO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNvbm5lY3RlZCAmJiByZXRyeUNvdW50ID09PSAoTUFYX1JFVFJZX0NPVU5UIC0gMSkpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coJ0ZhaWxlZCB0byBjb25uZWN0ICcgKyBNQVhfUkVUUllfQ09VTlQgKyAnIHRpbWVzLiBBYm9ydGluZy4nKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0cnlDb3VudCA9IDA7XG4gICAgdGhpcy5yZWFkeSA9IGNvbm5lY3RlZDtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVTb2NrZXRDb21tYW5kIChjbWQpIHtcblxuICAgIGlmICghdGhpcy5zb2NrZXQud3JpdGFibGUpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdTb2NrZXQgaXMgbm90IHdyaXRhYmxlLiBUcnlpbmcgdG8gcmVjb25uZWN0LicpO1xuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuXG4gICAgbGV0IHJldHJ5Q291bnQgPSAwO1xuICAgIHdoaWxlIChyZXRyeUNvdW50IDwgTUFYX1JFVFJZX0NPVU5UKSB7XG4gICAgICB0aGlzLnNvY2tldC5zZXRUaW1lb3V0KFNPQ0tFVF9USU1FT1VUKTtcblxuICAgICAgbGV0IGNtZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ0NPTU1BTkQ6ICcgKyBjbWQpO1xuXG4gICAgICAgIGxldCB0b3RhbGRhdGEgPSBbXTtcbiAgICAgICAgbGV0IGVuZE1hcmtlciA9IG5ldyBCdWZmZXIuZnJvbSgneW91aWVuZCcpO1xuICAgICAgICBsZXQgc29ja2V0Q2xpZW50ID0gdGhpcy5zb2NrZXQ7XG5cbiAgICAgICAgbGV0IHJlbW92ZUxpc3RlbmVySGFuZGxlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBzb2NrZXRDbGllbnQucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG4gICAgICAgICAgc29ja2V0Q2xpZW50LnJlbW92ZUxpc3RlbmVyKCd0aW1lb3V0JywgdGltZW91dEhhbmRsZXIpO1xuICAgICAgICAgIHNvY2tldENsaWVudC5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBlcnJvckhhbmRsZXIpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCB0aW1lb3V0SGFuZGxlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnVGltZW91dCBpbiBleGVjdXRlIGNvbW1hbmQuJyk7XG4gICAgICAgICAgcmVtb3ZlTGlzdGVuZXJIYW5kbGVyKCk7XG4gICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnT24gZXJyb3InKTtcbiAgICAgICAgICByZW1vdmVMaXN0ZW5lckhhbmRsZXIoKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgZGF0YUhhbmRsZXIgPSBmdW5jdGlvbiAoZGF0YSkge1xuXG4gICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHRoaXMgaW5jbHVkZXMgYW4gZW5kIG1hcmtlclxuICAgICAgICAgIC8vIGdldCBsYXN0IGZldyB2YWx1ZXMgb2YgYnVmZmVyXG4gICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID49IGVuZE1hcmtlci5sZW5ndGgpIHtcbiAgICAgICAgICAgIGxldCBkYXRhZW5kID0gbmV3IEJ1ZmZlci5hbGxvYyhlbmRNYXJrZXIubGVuZ3RoKTtcbiAgICAgICAgICAgIGxldCBzdGFydEluZGV4ID0gZGF0YS5sZW5ndGggLSBlbmRNYXJrZXIubGVuZ3RoO1xuICAgICAgICAgICAgZGF0YS5jb3B5KGRhdGFlbmQsIDAsIHN0YXJ0SW5kZXgsIHN0YXJ0SW5kZXggKyBlbmRNYXJrZXIubGVuZ3RoKTtcbiAgICAgICAgICAgIGlmIChkYXRhZW5kLmVxdWFscyhlbmRNYXJrZXIpKSB7XG4gICAgICAgICAgICAgIC8vIHJlbW92ZSBkYXRhIGVuZFxuICAgICAgICAgICAgICBsZXQgbGFzdERhdGEgPSBkYXRhLnNsaWNlKDAsIHN0YXJ0SW5kZXgpO1xuICAgICAgICAgICAgICB0b3RhbGRhdGEucHVzaChsYXN0RGF0YSk7XG5cbiAgICAgICAgICAgICAgcmVtb3ZlTGlzdGVuZXJIYW5kbGVyKCk7XG5cbiAgICAgICAgICAgICAgLy8gcmVzb2x2ZVxuICAgICAgICAgICAgICByZXNvbHZlKEJ1ZmZlci5jb25jYXQodG90YWxkYXRhKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0b3RhbGRhdGEucHVzaChkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgc29ja2V0Q2xpZW50LndyaXRlKGNtZCArICdcXG4nLCAnVVRGOCcsICgpID0+IHtcbiAgICAgICAgICBzb2NrZXRDbGllbnQub24oJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG4gICAgICAgICAgc29ja2V0Q2xpZW50Lm9uKCd0aW1lb3V0JywgdGltZW91dEhhbmRsZXIpO1xuICAgICAgICAgIHNvY2tldENsaWVudC5vbignZXJyb3InLCBlcnJvckhhbmRsZXIpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgbGV0IHJlcyA9IGF3YWl0IGNtZFByb21pc2U7XG4gICAgICBpZiAocmVzID09PSBmYWxzZSkge1xuICAgICAgICByZXRyeUNvdW50Kys7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdTb2NrZXQgZmFpbGVkLiBSZXRyeWluZzogJyArIHJldHJ5Q291bnQpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignRXhlY3V0ZVNvY2tldENvbW1hbmQgZmFpbGVkLicpO1xuICB9XG59XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gIFlvdWlFbmdpbmVEcml2ZXIucHJvdG90eXBlW2NtZF0gPSBmbjtcbn1cbmV4cG9ydCB7IFlvdWlFbmdpbmVEcml2ZXIgfTtcbiJdLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
