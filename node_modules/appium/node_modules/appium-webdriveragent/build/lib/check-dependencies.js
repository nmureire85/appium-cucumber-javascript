"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.checkForDependencies = checkForDependencies;
exports.bundleWDASim = bundleWDASim;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _os = require("os");

var _utils = require("./utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _constants = require("./constants");

var _logger = _interopRequireDefault(require("./logger"));

const execLogger = {
  logNonEmptyLines(data, fn) {
    data = Buffer.isBuffer(data) ? data.toString() : data;

    for (const line of data.split(_os.EOL)) {
      if (line) {
        fn(line);
      }
    }
  },

  debug(data) {
    this.logNonEmptyLines(data, _logger.default.debug.bind(_logger.default));
  },

  error(data) {
    this.logNonEmptyLines(data, _logger.default.error.bind(_logger.default));
  }

};
const CARTHAGE_CMD = 'carthage';
const CARTFILE = 'Cartfile.resolved';

const CARTHAGE_WRAPPER_SCRIPT = _path.default.resolve(_constants.WDA_SCRIPTS_ROOT, 'carthage-wrapper.sh');

async function hasTvOSSims() {
  const devices = _lodash.default.flatten(Object.values(await new _nodeSimctl.default().getDevices(null, _constants.PLATFORM_NAME_TVOS)));

  return !_lodash.default.isEmpty(devices);
}

function getCartfileLocations() {
  const cartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, CARTFILE);

  const installedCartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT, CARTFILE);

  return {
    cartfile,
    installedCartfile
  };
}

async function needsUpdate(cartfile, installedCartfile) {
  return !(await (0, _utils.areFilesEqual)(cartfile, installedCartfile));
}

async function fetchDependencies(useSsl = false) {
  _logger.default.info('Fetching dependencies');

  if (!(await _appiumSupport.fs.which(CARTHAGE_CMD))) {
    _logger.default.errorAndThrow('Please make sure that you have Carthage installed ' + '(https://github.com/Carthage/Carthage), and that it is ' + 'available in the PATH for the environment running Appium');
  }

  const {
    cartfile,
    installedCartfile
  } = getCartfileLocations();

  if (!(await needsUpdate(cartfile, installedCartfile))) {
    _logger.default.info('Dependencies up-to-date');

    return false;
  }

  const platforms = [_constants.PLATFORM_NAME_IOS];

  if (await hasTvOSSims()) {
    platforms.push(_constants.PLATFORM_NAME_TVOS);
  } else {
    _logger.default.debug('tvOS platform will not be included into Carthage bootstrap, because no Simulator devices have been created for it');
  }

  _logger.default.info(`Installing/updating dependencies for platforms ${platforms.map(p => `'${p}'`).join(', ')}`);

  const args = [CARTHAGE_WRAPPER_SCRIPT, 'bootstrap'];

  if (useSsl) {
    args.push('--use-ssh');
  }

  args.push('--platform', platforms.join(','));

  try {
    await (0, _teen_process.exec)('/bin/bash', args, {
      logger: execLogger,
      cwd: _constants.BOOTSTRAP_PATH
    });
  } catch (err) {
    await _appiumSupport.fs.rimraf(_path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT));
    throw err;
  }

  await _appiumSupport.fs.copyFile(cartfile, installedCartfile);

  _logger.default.debug(`Finished fetching dependencies`);

  return true;
}

async function buildWDASim() {
  const args = ['-project', _constants.WDA_PROJECT, '-scheme', _constants.WDA_SCHEME, '-sdk', _constants.SDK_SIMULATOR, 'CODE_SIGN_IDENTITY=""', 'CODE_SIGNING_REQUIRED="NO"', 'GCC_TREAT_WARNINGS_AS_ERRORS=0'];
  await (0, _teen_process.exec)('xcodebuild', args);
}

async function checkForDependencies(opts = {}) {
  return await fetchDependencies(opts.useSsl);
}

async function bundleWDASim(xcodebuild, opts = {}) {
  if (xcodebuild && !_lodash.default.isFunction(xcodebuild.retrieveDerivedDataPath)) {
    xcodebuild = new _xcodebuild.default();
    opts = xcodebuild;
  }

  const derivedDataPath = await xcodebuild.retrieveDerivedDataPath();

  const wdaBundlePath = _path.default.join(derivedDataPath, 'Build', 'Products', 'Debug-iphonesimulator', _constants.WDA_RUNNER_APP);

  if (await _appiumSupport.fs.exists(wdaBundlePath)) {
    return wdaBundlePath;
  }

  await checkForDependencies(opts);
  await buildWDASim(xcodebuild, opts);
  return wdaBundlePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jaGVjay1kZXBlbmRlbmNpZXMuanMiXSwibmFtZXMiOlsiZXhlY0xvZ2dlciIsImxvZ05vbkVtcHR5TGluZXMiLCJkYXRhIiwiZm4iLCJCdWZmZXIiLCJpc0J1ZmZlciIsInRvU3RyaW5nIiwibGluZSIsInNwbGl0IiwiRU9MIiwiZGVidWciLCJsb2ciLCJiaW5kIiwiZXJyb3IiLCJDQVJUSEFHRV9DTUQiLCJDQVJURklMRSIsIkNBUlRIQUdFX1dSQVBQRVJfU0NSSVBUIiwicGF0aCIsInJlc29sdmUiLCJXREFfU0NSSVBUU19ST09UIiwiaGFzVHZPU1NpbXMiLCJkZXZpY2VzIiwiXyIsImZsYXR0ZW4iLCJPYmplY3QiLCJ2YWx1ZXMiLCJTaW1jdGwiLCJnZXREZXZpY2VzIiwiUExBVEZPUk1fTkFNRV9UVk9TIiwiaXNFbXB0eSIsImdldENhcnRmaWxlTG9jYXRpb25zIiwiY2FydGZpbGUiLCJCT09UU1RSQVBfUEFUSCIsImluc3RhbGxlZENhcnRmaWxlIiwiQ0FSVEhBR0VfUk9PVCIsIm5lZWRzVXBkYXRlIiwiZmV0Y2hEZXBlbmRlbmNpZXMiLCJ1c2VTc2wiLCJpbmZvIiwiZnMiLCJ3aGljaCIsImVycm9yQW5kVGhyb3ciLCJwbGF0Zm9ybXMiLCJQTEFURk9STV9OQU1FX0lPUyIsInB1c2giLCJtYXAiLCJwIiwiam9pbiIsImFyZ3MiLCJsb2dnZXIiLCJjd2QiLCJlcnIiLCJyaW1yYWYiLCJjb3B5RmlsZSIsImJ1aWxkV0RBU2ltIiwiV0RBX1BST0pFQ1QiLCJXREFfU0NIRU1FIiwiU0RLX1NJTVVMQVRPUiIsImNoZWNrRm9yRGVwZW5kZW5jaWVzIiwib3B0cyIsImJ1bmRsZVdEQVNpbSIsInhjb2RlYnVpbGQiLCJpc0Z1bmN0aW9uIiwicmV0cmlldmVEZXJpdmVkRGF0YVBhdGgiLCJYY29kZUJ1aWxkIiwiZGVyaXZlZERhdGFQYXRoIiwid2RhQnVuZGxlUGF0aCIsIldEQV9SVU5ORVJfQVBQIiwiZXhpc3RzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7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LElBQW5CLENBQU47QUFDRDs7QUFFRCxlQUFlVSxvQkFBZixDQUFxQ0MsSUFBSSxHQUFHLEVBQTVDLEVBQWdEO0FBQzlDLFNBQU8sTUFBTXZCLGlCQUFpQixDQUFDdUIsSUFBSSxDQUFDdEIsTUFBTixDQUE5QjtBQUNEOztBQUVELGVBQWV1QixZQUFmLENBQTZCQyxVQUE3QixFQUF5Q0YsSUFBSSxHQUFHLEVBQWhELEVBQW9EO0FBQ2xELE1BQUlFLFVBQVUsSUFBSSxDQUFDdkMsZ0JBQUV3QyxVQUFGLENBQWFELFVBQVUsQ0FBQ0UsdUJBQXhCLENBQW5CLEVBQXFFO0FBQ25FRixJQUFBQSxVQUFVLEdBQUcsSUFBSUcsbUJBQUosRUFBYjtBQUNBTCxJQUFBQSxJQUFJLEdBQUdFLFVBQVA7QUFDRDs7QUFFRCxRQUFNSSxlQUFlLEdBQUcsTUFBTUosVUFBVSxDQUFDRSx1QkFBWCxFQUE5Qjs7QUFDQSxRQUFNRyxhQUFhLEdBQUdqRCxjQUFLOEIsSUFBTCxDQUFVa0IsZUFBVixFQUEyQixPQUEzQixFQUFvQyxVQUFwQyxFQUFnRCx1QkFBaEQsRUFBeUVFLHlCQUF6RSxDQUF0Qjs7QUFDQSxNQUFJLE1BQU01QixrQkFBRzZCLE1BQUgsQ0FBVUYsYUFBVixDQUFWLEVBQW9DO0FBQ2xDLFdBQU9BLGFBQVA7QUFDRDs7QUFDRCxRQUFNUixvQkFBb0IsQ0FBQ0MsSUFBRCxDQUExQjtBQUNBLFFBQU1MLFdBQVcsQ0FBQ08sVUFBRCxFQUFhRixJQUFiLENBQWpCO0FBQ0EsU0FBT08sYUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgU2ltY3RsIGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnO1xuaW1wb3J0IHsgYXJlRmlsZXNFcXVhbCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFhjb2RlQnVpbGQgZnJvbSAnLi94Y29kZWJ1aWxkJztcbmltcG9ydCB7XG4gIEJPT1RTVFJBUF9QQVRILCBXREFfUFJPSkVDVCwgV0RBX1NDSEVNRSwgQ0FSVEhBR0VfUk9PVCwgU0RLX1NJTVVMQVRPUixcbiAgV0RBX1JVTk5FUl9BUFAsIFdEQV9TQ1JJUFRTX1JPT1QsIFBMQVRGT1JNX05BTUVfSU9TLCBQTEFURk9STV9OQU1FX1RWT1Ncbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5cblxuY29uc3QgZXhlY0xvZ2dlciA9IHtcbiAgLy8gbG9nZ2VyIHRoYXQgZ2V0cyByaWQgb2YgZW1wdHkgbGluZXNcbiAgbG9nTm9uRW1wdHlMaW5lcyAoZGF0YSwgZm4pIHtcbiAgICBkYXRhID0gQnVmZmVyLmlzQnVmZmVyKGRhdGEpID8gZGF0YS50b1N0cmluZygpIDogZGF0YTtcbiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgZGF0YS5zcGxpdChFT0wpKSB7XG4gICAgICBpZiAobGluZSkge1xuICAgICAgICBmbihsaW5lKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG4gIGRlYnVnIChkYXRhKSB7XG4gICAgdGhpcy5sb2dOb25FbXB0eUxpbmVzKGRhdGEsIGxvZy5kZWJ1Zy5iaW5kKGxvZykpO1xuICB9LFxuICBlcnJvciAoZGF0YSkge1xuICAgIHRoaXMubG9nTm9uRW1wdHlMaW5lcyhkYXRhLCBsb2cuZXJyb3IuYmluZChsb2cpKTtcbiAgfSxcbn07XG5cbmNvbnN0IENBUlRIQUdFX0NNRCA9ICdjYXJ0aGFnZSc7XG5jb25zdCBDQVJURklMRSA9ICdDYXJ0ZmlsZS5yZXNvbHZlZCc7XG5jb25zdCBDQVJUSEFHRV9XUkFQUEVSX1NDUklQVCA9IHBhdGgucmVzb2x2ZShXREFfU0NSSVBUU19ST09ULCAnY2FydGhhZ2Utd3JhcHBlci5zaCcpO1xuXG5hc3luYyBmdW5jdGlvbiBoYXNUdk9TU2ltcyAoKSB7XG4gIGNvbnN0IGRldmljZXMgPSBfLmZsYXR0ZW4oT2JqZWN0LnZhbHVlcyhhd2FpdCBuZXcgU2ltY3RsKCkuZ2V0RGV2aWNlcyhudWxsLCBQTEFURk9STV9OQU1FX1RWT1MpKSk7XG4gIHJldHVybiAhXy5pc0VtcHR5KGRldmljZXMpO1xufVxuXG5mdW5jdGlvbiBnZXRDYXJ0ZmlsZUxvY2F0aW9ucyAoKSB7XG4gIGNvbnN0IGNhcnRmaWxlID0gcGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJURklMRSk7XG4gIGNvbnN0IGluc3RhbGxlZENhcnRmaWxlID0gcGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJUSEFHRV9ST09ULCBDQVJURklMRSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjYXJ0ZmlsZSxcbiAgICBpbnN0YWxsZWRDYXJ0ZmlsZSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbmVlZHNVcGRhdGUgKGNhcnRmaWxlLCBpbnN0YWxsZWRDYXJ0ZmlsZSkge1xuICByZXR1cm4gIWF3YWl0IGFyZUZpbGVzRXF1YWwoY2FydGZpbGUsIGluc3RhbGxlZENhcnRmaWxlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hEZXBlbmRlbmNpZXMgKHVzZVNzbCA9IGZhbHNlKSB7XG4gIGxvZy5pbmZvKCdGZXRjaGluZyBkZXBlbmRlbmNpZXMnKTtcbiAgaWYgKCFhd2FpdCBmcy53aGljaChDQVJUSEFHRV9DTUQpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ1BsZWFzZSBtYWtlIHN1cmUgdGhhdCB5b3UgaGF2ZSBDYXJ0aGFnZSBpbnN0YWxsZWQgJyArXG4gICAgICAgICAgICAgICAgICAgICAgJyhodHRwczovL2dpdGh1Yi5jb20vQ2FydGhhZ2UvQ2FydGhhZ2UpLCBhbmQgdGhhdCBpdCBpcyAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnYXZhaWxhYmxlIGluIHRoZSBQQVRIIGZvciB0aGUgZW52aXJvbm1lbnQgcnVubmluZyBBcHBpdW0nKTtcbiAgfVxuXG4gIC8vIGNoZWNrIHRoYXQgdGhlIGRlcGVuZGVuY2llcyBkbyBub3QgbmVlZCB0byBiZSB1cGRhdGVkXG4gIGNvbnN0IHtcbiAgICBjYXJ0ZmlsZSxcbiAgICBpbnN0YWxsZWRDYXJ0ZmlsZSxcbiAgfSA9IGdldENhcnRmaWxlTG9jYXRpb25zKCk7XG5cbiAgaWYgKCFhd2FpdCBuZWVkc1VwZGF0ZShjYXJ0ZmlsZSwgaW5zdGFsbGVkQ2FydGZpbGUpKSB7XG4gICAgLy8gZmlsZXMgYXJlIGlkZW50aWNhbFxuICAgIGxvZy5pbmZvKCdEZXBlbmRlbmNpZXMgdXAtdG8tZGF0ZScpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IHBsYXRmb3JtcyA9IFtQTEFURk9STV9OQU1FX0lPU107XG4gIGlmIChhd2FpdCBoYXNUdk9TU2ltcygpKSB7XG4gICAgcGxhdGZvcm1zLnB1c2goUExBVEZPUk1fTkFNRV9UVk9TKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cuZGVidWcoJ3R2T1MgcGxhdGZvcm0gd2lsbCBub3QgYmUgaW5jbHVkZWQgaW50byBDYXJ0aGFnZSBib290c3RyYXAsIGJlY2F1c2Ugbm8gU2ltdWxhdG9yIGRldmljZXMgaGF2ZSBiZWVuIGNyZWF0ZWQgZm9yIGl0Jyk7XG4gIH1cblxuICBsb2cuaW5mbyhgSW5zdGFsbGluZy91cGRhdGluZyBkZXBlbmRlbmNpZXMgZm9yIHBsYXRmb3JtcyAke3BsYXRmb3Jtcy5tYXAoKHApID0+IGAnJHtwfSdgKS5qb2luKCcsICcpfWApO1xuXG4gIGNvbnN0IGFyZ3MgPSBbQ0FSVEhBR0VfV1JBUFBFUl9TQ1JJUFQsICdib290c3RyYXAnXTtcbiAgaWYgKHVzZVNzbCkge1xuICAgIGFyZ3MucHVzaCgnLS11c2Utc3NoJyk7XG4gIH1cbiAgYXJncy5wdXNoKCctLXBsYXRmb3JtJywgcGxhdGZvcm1zLmpvaW4oJywnKSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnL2Jpbi9iYXNoJywgYXJncywge1xuICAgICAgbG9nZ2VyOiBleGVjTG9nZ2VyLFxuICAgICAgY3dkOiBCT09UU1RSQVBfUEFUSCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gcmVtb3ZlIHRoZSBjYXJ0aGFnZSBkaXJlY3RvcnksIG9yIGVsc2Ugc3Vic2VxdWVudCBydW5zIHdpbGwgc2VlIGl0IGFuZFxuICAgIC8vIGFzc3VtZSB0aGUgZGVwZW5kZW5jaWVzIGFyZSBhbHJlYWR5IGRvd25sb2FkZWRcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJUSEFHRV9ST09UKSk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgLy8gcHV0IHRoZSByZXNvbHZlZCBjYXJ0ZmlsZSBpbnRvIHRoZSBDYXJ0aGFnZSBkaXJlY3RvcnlcbiAgYXdhaXQgZnMuY29weUZpbGUoY2FydGZpbGUsIGluc3RhbGxlZENhcnRmaWxlKTtcblxuICBsb2cuZGVidWcoYEZpbmlzaGVkIGZldGNoaW5nIGRlcGVuZGVuY2llc2ApO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gYnVpbGRXREFTaW0gKCkge1xuICBjb25zdCBhcmdzID0gW1xuICAgICctcHJvamVjdCcsIFdEQV9QUk9KRUNULFxuICAgICctc2NoZW1lJywgV0RBX1NDSEVNRSxcbiAgICAnLXNkaycsIFNES19TSU1VTEFUT1IsXG4gICAgJ0NPREVfU0lHTl9JREVOVElUWT1cIlwiJyxcbiAgICAnQ09ERV9TSUdOSU5HX1JFUVVJUkVEPVwiTk9cIicsXG4gICAgJ0dDQ19UUkVBVF9XQVJOSU5HU19BU19FUlJPUlM9MCcsXG4gIF07XG4gIGF3YWl0IGV4ZWMoJ3hjb2RlYnVpbGQnLCBhcmdzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JEZXBlbmRlbmNpZXMgKG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgZmV0Y2hEZXBlbmRlbmNpZXMob3B0cy51c2VTc2wpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBidW5kbGVXREFTaW0gKHhjb2RlYnVpbGQsIG9wdHMgPSB7fSkge1xuICBpZiAoeGNvZGVidWlsZCAmJiAhXy5pc0Z1bmN0aW9uKHhjb2RlYnVpbGQucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgpKSB7XG4gICAgeGNvZGVidWlsZCA9IG5ldyBYY29kZUJ1aWxkKCk7XG4gICAgb3B0cyA9IHhjb2RlYnVpbGQ7XG4gIH1cblxuICBjb25zdCBkZXJpdmVkRGF0YVBhdGggPSBhd2FpdCB4Y29kZWJ1aWxkLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCk7XG4gIGNvbnN0IHdkYUJ1bmRsZVBhdGggPSBwYXRoLmpvaW4oZGVyaXZlZERhdGFQYXRoLCAnQnVpbGQnLCAnUHJvZHVjdHMnLCAnRGVidWctaXBob25lc2ltdWxhdG9yJywgV0RBX1JVTk5FUl9BUFApO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKHdkYUJ1bmRsZVBhdGgpKSB7XG4gICAgcmV0dXJuIHdkYUJ1bmRsZVBhdGg7XG4gIH1cbiAgYXdhaXQgY2hlY2tGb3JEZXBlbmRlbmNpZXMob3B0cyk7XG4gIGF3YWl0IGJ1aWxkV0RBU2ltKHhjb2RlYnVpbGQsIG9wdHMpO1xuICByZXR1cm4gd2RhQnVuZGxlUGF0aDtcbn1cblxuZXhwb3J0IHsgY2hlY2tGb3JEZXBlbmRlbmNpZXMsIGJ1bmRsZVdEQVNpbSB9O1xuIl0sImZpbGUiOiJsaWIvY2hlY2stZGVwZW5kZW5jaWVzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
