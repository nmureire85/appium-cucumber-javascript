"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _path = _interopRequireDefault(require("path"));

const CONTAINER_PATH_MARKER = '@';
const CONTAINER_PATH_PATTERN = new RegExp(`^${CONTAINER_PATH_MARKER}([^/]+)/(.+)`);
const ANDROID_MEDIA_RESCAN_INTENT = 'android.intent.action.MEDIA_SCANNER_SCAN_FILE';
const commands = {};
exports.commands = commands;

function parseContainerPath(remotePath) {
  const match = CONTAINER_PATH_PATTERN.exec(remotePath);

  if (!match) {
    _logger.default.errorAndThrow(`It is expected that package identifier is separated from the relative path with a single slash. ` + `'${remotePath}' is given instead`);
  }

  return [match[1], _path.default.posix.resolve(`/data/data/${match[1]}`, match[2])];
}

function escapePath(p) {
  return p.replace(/'/g, `\\'`);
}

commands.pullFile = async function pullFile(remotePath) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  let tmpDestination = null;

  if (remotePath.startsWith(CONTAINER_PATH_MARKER)) {
    const [packageId, pathInContainer] = parseContainerPath(remotePath);

    _logger.default.debug(`Parsed package identifier '${packageId}' from '${remotePath}'. Will get the data from '${pathInContainer}'`);

    tmpDestination = `/data/local/tmp/${_path.default.posix.basename(pathInContainer)}`;

    try {
      await this.adb.shell(['run-as', packageId, `chmod 777 '${escapePath(pathInContainer)}'`]);
      await this.adb.shell(['cp', '-f', pathInContainer, tmpDestination]);
    } catch (e) {
      _logger.default.errorAndThrow(`Cannot access the container of '${packageId}' application. ` + `Is the application installed and has 'debuggable' build option set to true? ` + `Original error: ${e.message}`);
    }
  }

  const localFile = await _appiumSupport.tempDir.path({
    prefix: 'appium',
    suffix: '.tmp'
  });

  try {
    await this.adb.pull(tmpDestination || remotePath, localFile);
    return (await _appiumSupport.util.toInMemoryBase64(localFile)).toString();
  } finally {
    if (await _appiumSupport.fs.exists(localFile)) {
      await _appiumSupport.fs.unlink(localFile);
    }

    if (tmpDestination) {
      await this.adb.shell(['rm', '-f', tmpDestination]);
    }
  }
};

commands.pushFile = async function pushFile(remotePath, base64Data) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  const localFile = await _appiumSupport.tempDir.path({
    prefix: 'appium',
    suffix: '.tmp'
  });

  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }

  const content = Buffer.from(base64Data, 'base64');
  let tmpDestination = null;

  try {
    await _appiumSupport.fs.writeFile(localFile, content.toString('binary'), 'binary');

    if (remotePath.startsWith(CONTAINER_PATH_MARKER)) {
      const [packageId, pathInContainer] = parseContainerPath(remotePath);

      _logger.default.debug(`Parsed package identifier '${packageId}' from '${remotePath}'. Will put the data into '${pathInContainer}'`);

      tmpDestination = `/data/local/tmp/${_path.default.posix.basename(pathInContainer)}`;

      try {
        await this.adb.shell(['run-as', packageId, `mkdir -p '${escapePath(_path.default.posix.dirname(pathInContainer))}'`]);
        await this.adb.shell(['run-as', packageId, `touch '${escapePath(pathInContainer)}'`]);
        await this.adb.shell(['run-as', packageId, `chmod 777 '${escapePath(pathInContainer)}'`]);
        await this.adb.push(localFile, tmpDestination);
        await this.adb.shell(['cp', '-f', tmpDestination, pathInContainer]);
      } catch (e) {
        _logger.default.errorAndThrow(`Cannot access the container of '${packageId}' application. ` + `Is the application installed and has 'debuggable' build option set to true? ` + `Original error: ${e.message}`);
      }
    } else {
      await this.adb.push(localFile, remotePath);

      _logger.default.info('After pushing media file, broadcasting media scan intent');

      try {
        await this.adb.shell(['am', 'broadcast', '-a', ANDROID_MEDIA_RESCAN_INTENT, '-d', `file://${remotePath}`]);
      } catch (e) {
        _logger.default.warn(`Got error broadcasting media scan intent: ${e.message}; ignoring`);
      }
    }
  } finally {
    if (await _appiumSupport.fs.exists(localFile)) {
      await _appiumSupport.fs.unlink(localFile);
    }

    if (tmpDestination) {
      await this.adb.shell(['rm', '-f', tmpDestination]);
    }
  }
};

commands.pullFolder = async function pullFolder(remotePath) {
  let localFolder = await _appiumSupport.tempDir.path({
    prefix: 'appium'
  });
  await this.adb.pull(remotePath, localFolder);
  return (await _appiumSupport.zip.toInMemoryZip(localFolder, {
    encodeToBase64: true
  })).toString();
};

async function deleteFileOrFolder(adb, remotePath) {
  const performRemoteFsCheck = async (p, op, runAs = null) => {
    const passFlag = '__PASS__';
    const checkCmd = `[ -${op} '${escapePath(p)}' ] && echo ${passFlag}`;
    const fullCmd = runAs ? `run-as ${runAs} ${checkCmd}` : checkCmd;

    try {
      return _lodash.default.includes(await adb.shell([fullCmd]), passFlag);
    } catch (ign) {
      return false;
    }
  };

  const isFile = async (p, runAs = null) => await performRemoteFsCheck(p, 'f', runAs);

  const isDir = async (p, runAs = null) => await performRemoteFsCheck(p, 'd', runAs);

  const isPresent = async (p, runAs = null) => await performRemoteFsCheck(p, 'e', runAs);

  let dstPath = remotePath;
  let pkgId = null;

  if (remotePath.startsWith(CONTAINER_PATH_MARKER)) {
    const [packageId, pathInContainer] = parseContainerPath(remotePath);

    _logger.default.debug(`Parsed package identifier '${packageId}' from '${remotePath}'`);

    dstPath = pathInContainer;
    pkgId = packageId;
  }

  if (pkgId) {
    try {
      await adb.shell(['run-as', pkgId, 'ls']);
    } catch (e) {
      _logger.default.errorAndThrow(`Cannot access the container of '${pkgId}' application. ` + `Is the application installed and has 'debuggable' build option set to true? ` + `Original error: ${e.message}`);
    }
  }

  if (!(await isPresent(dstPath, pkgId))) {
    _logger.default.info(`The item at '${dstPath}' does not exist. Perhaps, already deleted?`);

    return false;
  }

  const expectsFile = !remotePath.endsWith('/');

  if (expectsFile && !(await isFile(dstPath, pkgId))) {
    _logger.default.errorAndThrow(`The item at '${dstPath}' is not a file`);
  } else if (!expectsFile && !(await isDir(dstPath, pkgId))) {
    _logger.default.errorAndThrow(`The item at '${dstPath}' is not a folder`);
  }

  if (pkgId) {
    await adb.shell(['run-as', pkgId, `rm -f${expectsFile ? '' : 'r'} '${escapePath(dstPath)}'`]);
  } else {
    await adb.shell(['rm', `-f${expectsFile ? '' : 'r'}`, dstPath]);
  }

  if (await isPresent(dstPath, pkgId)) {
    _logger.default.errorAndThrow(`The item at '${dstPath}' still exists after being deleted. ` + `Is it writable?`);
  }

  return true;
}

commands.mobileDeleteFile = async function mobileDeleteFile(opts = {}) {
  const {
    remotePath
  } = opts;

  if (!remotePath) {
    _logger.default.errorAndThrow(`The 'remotePath' argument is mandatory`);
  }

  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a folder and not to a file. ` + `'${remotePath}' is given instead`);
  }

  return await deleteFileOrFolder(this.adb, remotePath);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLWFjdGlvbnMuanMiXSwibmFtZXMiOlsiQ09OVEFJTkVSX1BBVEhfTUFSS0VSIiwiQ09OVEFJTkVSX1BBVEhfUEFUVEVSTiIsIlJlZ0V4cCIsIkFORFJPSURfTUVESUFfUkVTQ0FOX0lOVEVOVCIsImNvbW1hbmRzIiwicGFyc2VDb250YWluZXJQYXRoIiwicmVtb3RlUGF0aCIsIm1hdGNoIiwiZXhlYyIsImxvZyIsImVycm9yQW5kVGhyb3ciLCJwYXRoIiwicG9zaXgiLCJyZXNvbHZlIiwiZXNjYXBlUGF0aCIsInAiLCJyZXBsYWNlIiwicHVsbEZpbGUiLCJlbmRzV2l0aCIsInRtcERlc3RpbmF0aW9uIiwic3RhcnRzV2l0aCIsInBhY2thZ2VJZCIsInBhdGhJbkNvbnRhaW5lciIsImRlYnVnIiwiYmFzZW5hbWUiLCJhZGIiLCJzaGVsbCIsImUiLCJtZXNzYWdlIiwibG9jYWxGaWxlIiwidGVtcERpciIsInByZWZpeCIsInN1ZmZpeCIsInB1bGwiLCJ1dGlsIiwidG9Jbk1lbW9yeUJhc2U2NCIsInRvU3RyaW5nIiwiZnMiLCJleGlzdHMiLCJ1bmxpbmsiLCJwdXNoRmlsZSIsImJhc2U2NERhdGEiLCJfIiwiaXNBcnJheSIsIkJ1ZmZlciIsImZyb20iLCJjb250ZW50Iiwid3JpdGVGaWxlIiwiZGlybmFtZSIsInB1c2giLCJpbmZvIiwid2FybiIsInB1bGxGb2xkZXIiLCJsb2NhbEZvbGRlciIsInppcCIsInRvSW5NZW1vcnlaaXAiLCJlbmNvZGVUb0Jhc2U2NCIsImRlbGV0ZUZpbGVPckZvbGRlciIsInBlcmZvcm1SZW1vdGVGc0NoZWNrIiwib3AiLCJydW5BcyIsInBhc3NGbGFnIiwiY2hlY2tDbWQiLCJmdWxsQ21kIiwiaW5jbHVkZXMiLCJpZ24iLCJpc0ZpbGUiLCJpc0RpciIsImlzUHJlc2VudCIsImRzdFBhdGgiLCJwa2dJZCIsImV4cGVjdHNGaWxlIiwibW9iaWxlRGVsZXRlRmlsZSIsIm9wdHMiXSwibWFwcGluZ3Mi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QUFYLEVBQW1CLFFBQU9DLFdBQVcsR0FBRyxFQUFILEdBQVEsR0FBSSxLQUFJekQsVUFBVSxDQUFDdUQsT0FBRCxDQUFVLEdBQXpFLENBREksQ0FBTjtBQUVELEdBSEQsTUFHTztBQUNMLFVBQU01QyxHQUFHLENBQUNDLEtBQUosQ0FBVSxDQUFDLElBQUQsRUFBUSxLQUFJNkMsV0FBVyxHQUFHLEVBQUgsR0FBUSxHQUFJLEVBQW5DLEVBQXNDRixPQUF0QyxDQUFWLENBQU47QUFDRDs7QUFDRCxNQUFJLE1BQU1ELFNBQVMsQ0FBQ0MsT0FBRCxFQUFVQyxLQUFWLENBQW5CLEVBQXFDO0FBQ25DN0Qsb0JBQUlDLGFBQUosQ0FBbUIsZ0JBQWUyRCxPQUFRLHNDQUF4QixHQUNmLGlCQURIO0FBRUQ7O0FBQ0QsU0FBTyxJQUFQO0FBQ0Q7O0FBa0JEakUsUUFBUSxDQUFDb0UsZ0JBQVQsR0FBNEIsZUFBZUEsZ0JBQWYsQ0FBaUNDLElBQUksR0FBRyxFQUF4QyxFQUE0QztBQUN0RSxRQUFNO0FBQUNuRSxJQUFBQTtBQUFELE1BQWVtRSxJQUFyQjs7QUFDQSxNQUFJLENBQUNuRSxVQUFMLEVBQWlCO0FBQ2ZHLG9CQUFJQyxhQUFKLENBQW1CLHdDQUFuQjtBQUNEOztBQUNELE1BQUlKLFVBQVUsQ0FBQ1ksUUFBWCxDQUFvQixHQUFwQixDQUFKLEVBQThCO0FBQzVCVCxvQkFBSUMsYUFBSixDQUFtQix3RUFBRCxHQUNDLElBQUdKLFVBQVcsb0JBRGpDO0FBRUQ7O0FBQ0QsU0FBTyxNQUFNbUQsa0JBQWtCLENBQUMsS0FBS2hDLEdBQU4sRUFBV25CLFVBQVgsQ0FBL0I7QUFDRCxDQVZEOztlQWFlRixRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCB1dGlsLCB6aXAsIHRlbXBEaXJ9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5cbmNvbnN0IENPTlRBSU5FUl9QQVRIX01BUktFUiA9ICdAJztcbi8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvUExkQjBHLzJcbmNvbnN0IENPTlRBSU5FUl9QQVRIX1BBVFRFUk4gPSBuZXcgUmVnRXhwKGBeJHtDT05UQUlORVJfUEFUSF9NQVJLRVJ9KFteL10rKS8oLispYCk7XG5jb25zdCBBTkRST0lEX01FRElBX1JFU0NBTl9JTlRFTlQgPSAnYW5kcm9pZC5pbnRlbnQuYWN0aW9uLk1FRElBX1NDQU5ORVJfU0NBTl9GSUxFJztcblxuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG4vKipcbiAqIFBhcnNlcyB0aGUgYWN0dWFsIGRlc3RpbmF0aW9uIHBhdGggZnJvbSB0aGUgZ2l2ZW4gdmFsdWVcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCBUaGUgcHJlZm9ybWF0dGVkIHJlbW90ZSBwYXRoLCB3aGljaCBsb29rcyBsaWtlXG4gKiBgQG15LmFwcC5pZC9teS9wYXRoYFxuICogQHJldHVybnMge0FycmF5PHN0cmluZz59IEFuIGFycmF5LCB3aGVyZSB0aGUgZmlyc3QgaXRlbSBpcyB0aGUgcGFyc2VkIHBhY2thZ2VcbiAqIGlkZW50aWZpZXIgYW5kIHRoZSBzZWNvbmQgb25lIGlzIHRoZSBhY3R1YWwgZGVzdGluYXRpb24gcGF0aCBpbnNpZGUgdGhlIHBhY2thZ2UuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGdpdmVuIHN0cmluZyBjYW5ub3QgYmUgcGFyc2VkXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQ29udGFpbmVyUGF0aCAocmVtb3RlUGF0aCkge1xuICBjb25zdCBtYXRjaCA9IENPTlRBSU5FUl9QQVRIX1BBVFRFUk4uZXhlYyhyZW1vdGVQYXRoKTtcbiAgaWYgKCFtYXRjaCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBJdCBpcyBleHBlY3RlZCB0aGF0IHBhY2thZ2UgaWRlbnRpZmllciBpcyBzZXBhcmF0ZWQgZnJvbSB0aGUgcmVsYXRpdmUgcGF0aCB3aXRoIGEgc2luZ2xlIHNsYXNoLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICByZXR1cm4gW21hdGNoWzFdLCBwYXRoLnBvc2l4LnJlc29sdmUoYC9kYXRhL2RhdGEvJHttYXRjaFsxXX1gLCBtYXRjaFsyXSldO1xufVxuXG4vKipcbiAqIEEgc21hbGwgaGVscGVyLCB3aGljaCBlc2NhcGVzIHNpbmdsZSBxdW90ZXMgaW4gcGF0aHMsXG4gKiBzbyB0aGV5IGFyZSBzYWZlIHRvIGJlIHBhc3NlZCBhcyBhcmd1bWVudHMgb2Ygc2hlbGwgY29tbWFuZHNcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcCBUaGUgaW5pdGlhbCByZW1vdGUgcGF0aFxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGVzY2FwZWQgcGF0aCB2YWx1ZVxuICovXG5mdW5jdGlvbiBlc2NhcGVQYXRoIChwKSB7XG4gIHJldHVybiBwLnJlcGxhY2UoLycvZywgYFxcXFwnYCk7XG59XG5cbi8qKlxuICogUHVsbHMgYSByZW1vdGUgZmlsZSBmcm9tIHRoZSBkZXZpY2UuXG4gKiBJdCBpcyByZXF1aXJlZCwgdGhhdCBhIHBhY2thZ2UgaGFzIGRlYnVnZ2luZyBmbGFnIGVuYWJsZWRcbiAqIGluIG9yZGVyIHRvIGFjY2VzcyBpdHMgZmlsZXMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggVGhlIGZ1bGwgcGF0aCB0byB0aGUgcmVtb3RlIGZpbGVcbiAqIG9yIGEgc3BlY2lhbGx5IGZvcm1hdHRlZCBwYXRoLCB3aGljaCBwb2ludHMgdG8gYW4gaXRlbSBpbnNpZGUgYXBwIGJ1bmRsZVxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgcHVsbGVkIGZpbGVcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcHVsbCBvcGVyYXRpb24gZmFpbGVkXG4gKi9cbmNvbW1hbmRzLnB1bGxGaWxlID0gYXN5bmMgZnVuY3Rpb24gcHVsbEZpbGUgKHJlbW90ZVBhdGgpIHtcbiAgaWYgKHJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBJdCBpcyBleHBlY3RlZCB0aGF0IHJlbW90ZSBwYXRoIHBvaW50cyB0byBhIGZpbGUgYW5kIG5vdCB0byBhIGZvbGRlci4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYCcke3JlbW90ZVBhdGh9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgbGV0IHRtcERlc3RpbmF0aW9uID0gbnVsbDtcbiAgaWYgKHJlbW90ZVBhdGguc3RhcnRzV2l0aChDT05UQUlORVJfUEFUSF9NQVJLRVIpKSB7XG4gICAgY29uc3QgW3BhY2thZ2VJZCwgcGF0aEluQ29udGFpbmVyXSA9IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoKTtcbiAgICBsb2cuZGVidWcoYFBhcnNlZCBwYWNrYWdlIGlkZW50aWZpZXIgJyR7cGFja2FnZUlkfScgZnJvbSAnJHtyZW1vdGVQYXRofScuIFdpbGwgZ2V0IHRoZSBkYXRhIGZyb20gJyR7cGF0aEluQ29udGFpbmVyfSdgKTtcbiAgICB0bXBEZXN0aW5hdGlvbiA9IGAvZGF0YS9sb2NhbC90bXAvJHtwYXRoLnBvc2l4LmJhc2VuYW1lKHBhdGhJbkNvbnRhaW5lcil9YDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydydW4tYXMnLCBwYWNrYWdlSWQsIGBjaG1vZCA3NzcgJyR7ZXNjYXBlUGF0aChwYXRoSW5Db250YWluZXIpfSdgXSk7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2NwJywgJy1mJywgcGF0aEluQ29udGFpbmVyLCB0bXBEZXN0aW5hdGlvbl0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3QgYWNjZXNzIHRoZSBjb250YWluZXIgb2YgJyR7cGFja2FnZUlkfScgYXBwbGljYXRpb24uIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYElzIHRoZSBhcHBsaWNhdGlvbiBpbnN0YWxsZWQgYW5kIGhhcyAnZGVidWdnYWJsZScgYnVpbGQgb3B0aW9uIHNldCB0byB0cnVlPyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG4gIGNvbnN0IGxvY2FsRmlsZSA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBwaXVtJywgc3VmZml4OiAnLnRtcCd9KTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmFkYi5wdWxsKHRtcERlc3RpbmF0aW9uIHx8IHJlbW90ZVBhdGgsIGxvY2FsRmlsZSk7XG4gICAgcmV0dXJuIChhd2FpdCB1dGlsLnRvSW5NZW1vcnlCYXNlNjQobG9jYWxGaWxlKSkudG9TdHJpbmcoKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGxvY2FsRmlsZSkpIHtcbiAgICAgIGF3YWl0IGZzLnVubGluayhsb2NhbEZpbGUpO1xuICAgIH1cbiAgICBpZiAodG1wRGVzdGluYXRpb24pIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsncm0nLCAnLWYnLCB0bXBEZXN0aW5hdGlvbl0pO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiBQdXNoZWQgdGhlIGdpdmVuIGRhdGEgdG8gYSBmaWxlIG9uIHRoZSByZW1vdGUgZGV2aWNlXG4gKiBJdCBpcyByZXF1aXJlZCwgdGhhdCBhIHBhY2thZ2UgaGFzIGRlYnVnZ2luZyBmbGFnIGVuYWJsZWRcbiAqIGluIG9yZGVyIHRvIGFjY2VzcyBpdHMgZmlsZXMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggVGhlIGZ1bGwgcGF0aCB0byB0aGUgcmVtb3RlIGZpbGUgb3JcbiAqIGEgZmlsZSBpbnNpZGUgYSBwYWNrYWdlIGJ1bmRsZVxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2U2NERhdGEgQmFzZTY0IGVuY29kZWQgZGF0YSB0byBiZSB3cml0dGVuIHRvIHRoZVxuICogcmVtb3RlIGZpbGUuIFRoZSByZW1vdGUgZmlsZSB3aWxsIGJlIHNpbGVudGx5IG92ZXJyaWRkZW4gaWYgaXQgYWxyZWFkeSBleGlzdHMuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIHB1c2hpbmcgdGhlIGRhdGFcbiAqL1xuY29tbWFuZHMucHVzaEZpbGUgPSBhc3luYyBmdW5jdGlvbiBwdXNoRmlsZSAocmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICBjb25zdCBsb2NhbEZpbGUgPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe3ByZWZpeDogJ2FwcGl1bScsIHN1ZmZpeDogJy50bXAnfSk7XG4gIGlmIChfLmlzQXJyYXkoYmFzZTY0RGF0YSkpIHtcbiAgICAvLyBzb21lIGNsaWVudHMgKGFoZW0pIGphdmEsIHNlbmQgYSBieXRlIGFycmF5IGVuY29kaW5nIHV0ZjggY2hhcmFjdGVyc1xuICAgIC8vIGluc3RlYWQgb2YgYSBzdHJpbmcsIHdoaWNoIHdvdWxkIGJlIGluZmluaXRlbHkgYmV0dGVyIVxuICAgIGJhc2U2NERhdGEgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhKS50b1N0cmluZygndXRmOCcpO1xuICB9XG4gIGNvbnN0IGNvbnRlbnQgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhLCAnYmFzZTY0Jyk7XG4gIGxldCB0bXBEZXN0aW5hdGlvbiA9IG51bGw7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGxvY2FsRmlsZSwgY29udGVudC50b1N0cmluZygnYmluYXJ5JyksICdiaW5hcnknKTtcbiAgICBpZiAocmVtb3RlUGF0aC5zdGFydHNXaXRoKENPTlRBSU5FUl9QQVRIX01BUktFUikpIHtcbiAgICAgIGNvbnN0IFtwYWNrYWdlSWQsIHBhdGhJbkNvbnRhaW5lcl0gPSBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCk7XG4gICAgICBsb2cuZGVidWcoYFBhcnNlZCBwYWNrYWdlIGlkZW50aWZpZXIgJyR7cGFja2FnZUlkfScgZnJvbSAnJHtyZW1vdGVQYXRofScuIFdpbGwgcHV0IHRoZSBkYXRhIGludG8gJyR7cGF0aEluQ29udGFpbmVyfSdgKTtcbiAgICAgIHRtcERlc3RpbmF0aW9uID0gYC9kYXRhL2xvY2FsL3RtcC8ke3BhdGgucG9zaXguYmFzZW5hbWUocGF0aEluQ29udGFpbmVyKX1gO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuc2hlbGwoXG4gICAgICAgICAgWydydW4tYXMnLCBwYWNrYWdlSWQsIGBta2RpciAtcCAnJHtlc2NhcGVQYXRoKHBhdGgucG9zaXguZGlybmFtZShwYXRoSW5Db250YWluZXIpKX0nYF1cbiAgICAgICAgKTtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydydW4tYXMnLCBwYWNrYWdlSWQsIGB0b3VjaCAnJHtlc2NhcGVQYXRoKHBhdGhJbkNvbnRhaW5lcil9J2BdKTtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydydW4tYXMnLCBwYWNrYWdlSWQsIGBjaG1vZCA3NzcgJyR7ZXNjYXBlUGF0aChwYXRoSW5Db250YWluZXIpfSdgXSk7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnB1c2gobG9jYWxGaWxlLCB0bXBEZXN0aW5hdGlvbik7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnY3AnLCAnLWYnLCB0bXBEZXN0aW5hdGlvbiwgcGF0aEluQ29udGFpbmVyXSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3QgYWNjZXNzIHRoZSBjb250YWluZXIgb2YgJyR7cGFja2FnZUlkfScgYXBwbGljYXRpb24uIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICBgSXMgdGhlIGFwcGxpY2F0aW9uIGluc3RhbGxlZCBhbmQgaGFzICdkZWJ1Z2dhYmxlJyBidWlsZCBvcHRpb24gc2V0IHRvIHRydWU/IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBhZGIgcHVzaCBjcmVhdGVzIGZvbGRlcnMgYW5kIG92ZXJ3cml0ZXMgZXhpc3RpbmcgZmlsZXMuXG4gICAgICBhd2FpdCB0aGlzLmFkYi5wdXNoKGxvY2FsRmlsZSwgcmVtb3RlUGF0aCk7XG5cbiAgICAgIC8vIGlmIHdlIGhhdmUgcHVzaGVkIGEgZmlsZSwgaXQgbWlnaHQgYmUgYSBtZWRpYSBmaWxlLCBzbyBlbnN1cmUgdGhhdFxuICAgICAgLy8gYXBwcyBrbm93IGFib3V0IGl0XG4gICAgICBsb2cuaW5mbygnQWZ0ZXIgcHVzaGluZyBtZWRpYSBmaWxlLCBicm9hZGNhc3RpbmcgbWVkaWEgc2NhbiBpbnRlbnQnKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnYW0nLCAnYnJvYWRjYXN0JywgJy1hJyxcbiAgICAgICAgICBBTkRST0lEX01FRElBX1JFU0NBTl9JTlRFTlQsICctZCcsIGBmaWxlOi8vJHtyZW1vdGVQYXRofWBdKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYEdvdCBlcnJvciBicm9hZGNhc3RpbmcgbWVkaWEgc2NhbiBpbnRlbnQ6ICR7ZS5tZXNzYWdlfTsgaWdub3JpbmdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2NhbEZpbGUpKSB7XG4gICAgICBhd2FpdCBmcy51bmxpbmsobG9jYWxGaWxlKTtcbiAgICB9XG4gICAgaWYgKHRtcERlc3RpbmF0aW9uKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ3JtJywgJy1mJywgdG1wRGVzdGluYXRpb25dKTtcbiAgICB9XG4gIH1cbn07XG5cbi8qKlxuICogUHVsbHMgdGhlIHdob2xlIGZvbGRlciBmcm9tIHRoZSByZW1vdGUgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggVGhlIGZ1bGwgcGF0aCB0byBhIGZvbGRlciBvbiB0aGVcbiAqIHJlbW90ZSBkZXZpY2Ugb3IgYSBmb2xkZXIgaW5zaWRlIGFuIGFwcGxpY2F0aW9uIGJ1bmRsZVxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgYW5kIHppcHBlZCBjb250ZW50IG9mIHRoZSBmb2xkZXJcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYSBmYWlsdXJlIHdoaWxlIGdldHRpbmcgdGhlIGZvbGRlciBjb250ZW50XG4gKi9cbmNvbW1hbmRzLnB1bGxGb2xkZXIgPSBhc3luYyBmdW5jdGlvbiBwdWxsRm9sZGVyIChyZW1vdGVQYXRoKSB7XG4gIGxldCBsb2NhbEZvbGRlciA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBwaXVtJ30pO1xuICBhd2FpdCB0aGlzLmFkYi5wdWxsKHJlbW90ZVBhdGgsIGxvY2FsRm9sZGVyKTtcbiAgcmV0dXJuIChhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChsb2NhbEZvbGRlciwge1xuICAgIGVuY29kZVRvQmFzZTY0OiB0cnVlLFxuICB9KSkudG9TdHJpbmcoKTtcbn07XG5cbi8qKlxuICogRGVsZXRlcyB0aGUgZ2l2ZW4gZm9sZGVyIG9yIGZpbGUgZnJvbSB0aGUgcmVtb3RlIGRldmljZVxuICpcbiAqIEBwYXJhbSB7QURCfSBhZGJcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIFRoZSBmdWxsIHBhdGggdG8gdGhlIHJlbW90ZSBmb2xkZXJcbiAqIG9yIGZpbGUgKGZvbGRlciBuYW1lcyBtdXN0IGVuZCB3aXRoIGEgc2luZ2xlIHNsYXNoKVxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwcm92aWRlZCByZW1vdGUgcGF0aCBpcyBpbnZhbGlkIG9yXG4gKiB0aGUgcGFja2FnZSBjb250ZW50IGNhbm5vdCBiZSBhY2Nlc3NlZFxuICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgcmVtb3RlIGl0ZW0gaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQuXG4gKiBJZiB0aGUgcmVtb3RlIHBhdGggaXMgdmFsaWQsIGJ1dCB0aGUgcmVtb3RlIHBhdGggZG9lcyBub3QgZXhpc3RcbiAqIHRoaXMgZnVuY3Rpb24gcmV0dXJuIGBmYWxzZWAuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUZpbGVPckZvbGRlciAoYWRiLCByZW1vdGVQYXRoKSB7XG4gIGNvbnN0IHBlcmZvcm1SZW1vdGVGc0NoZWNrID0gYXN5bmMgKHAsIG9wLCBydW5BcyA9IG51bGwpID0+IHtcbiAgICBjb25zdCBwYXNzRmxhZyA9ICdfX1BBU1NfXyc7XG4gICAgY29uc3QgY2hlY2tDbWQgPSBgWyAtJHtvcH0gJyR7ZXNjYXBlUGF0aChwKX0nIF0gJiYgZWNobyAke3Bhc3NGbGFnfWA7XG4gICAgY29uc3QgZnVsbENtZCA9IHJ1bkFzID8gYHJ1bi1hcyAke3J1bkFzfSAke2NoZWNrQ21kfWAgOiBjaGVja0NtZDtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIF8uaW5jbHVkZXMoYXdhaXQgYWRiLnNoZWxsKFtmdWxsQ21kXSksIHBhc3NGbGFnKTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IGlzRmlsZSA9IGFzeW5jIChwLCBydW5BcyA9IG51bGwpID0+IGF3YWl0IHBlcmZvcm1SZW1vdGVGc0NoZWNrKHAsICdmJywgcnVuQXMpO1xuICBjb25zdCBpc0RpciA9IGFzeW5jIChwLCBydW5BcyA9IG51bGwpID0+IGF3YWl0IHBlcmZvcm1SZW1vdGVGc0NoZWNrKHAsICdkJywgcnVuQXMpO1xuICBjb25zdCBpc1ByZXNlbnQgPSBhc3luYyAocCwgcnVuQXMgPSBudWxsKSA9PiBhd2FpdCBwZXJmb3JtUmVtb3RlRnNDaGVjayhwLCAnZScsIHJ1bkFzKTtcblxuICBsZXQgZHN0UGF0aCA9IHJlbW90ZVBhdGg7XG4gIGxldCBwa2dJZCA9IG51bGw7XG4gIGlmIChyZW1vdGVQYXRoLnN0YXJ0c1dpdGgoQ09OVEFJTkVSX1BBVEhfTUFSS0VSKSkge1xuICAgIGNvbnN0IFtwYWNrYWdlSWQsIHBhdGhJbkNvbnRhaW5lcl0gPSBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBQYXJzZWQgcGFja2FnZSBpZGVudGlmaWVyICcke3BhY2thZ2VJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nYCk7XG4gICAgZHN0UGF0aCA9IHBhdGhJbkNvbnRhaW5lcjtcbiAgICBwa2dJZCA9IHBhY2thZ2VJZDtcbiAgfVxuXG4gIGlmIChwa2dJZCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBhZGIuc2hlbGwoWydydW4tYXMnLCBwa2dJZCwgJ2xzJ10pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3QgYWNjZXNzIHRoZSBjb250YWluZXIgb2YgJyR7cGtnSWR9JyBhcHBsaWNhdGlvbi4gYCArXG4gICAgICAgIGBJcyB0aGUgYXBwbGljYXRpb24gaW5zdGFsbGVkIGFuZCBoYXMgJ2RlYnVnZ2FibGUnIGJ1aWxkIG9wdGlvbiBzZXQgdG8gdHJ1ZT8gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFhd2FpdCBpc1ByZXNlbnQoZHN0UGF0aCwgcGtnSWQpKSB7XG4gICAgbG9nLmluZm8oYFRoZSBpdGVtIGF0ICcke2RzdFBhdGh9JyBkb2VzIG5vdCBleGlzdC4gUGVyaGFwcywgYWxyZWFkeSBkZWxldGVkP2ApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IGV4cGVjdHNGaWxlID0gIXJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKTtcbiAgaWYgKGV4cGVjdHNGaWxlICYmICFhd2FpdCBpc0ZpbGUoZHN0UGF0aCwgcGtnSWQpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBpdGVtIGF0ICcke2RzdFBhdGh9JyBpcyBub3QgYSBmaWxlYCk7XG4gIH0gZWxzZSBpZiAoIWV4cGVjdHNGaWxlICYmICFhd2FpdCBpc0Rpcihkc3RQYXRoLCBwa2dJZCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIGl0ZW0gYXQgJyR7ZHN0UGF0aH0nIGlzIG5vdCBhIGZvbGRlcmApO1xuICB9XG5cbiAgaWYgKHBrZ0lkKSB7XG4gICAgYXdhaXQgYWRiLnNoZWxsKFxuICAgICAgWydydW4tYXMnLCBwa2dJZCwgYHJtIC1mJHtleHBlY3RzRmlsZSA/ICcnIDogJ3InfSAnJHtlc2NhcGVQYXRoKGRzdFBhdGgpfSdgXSk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgYWRiLnNoZWxsKFsncm0nLCBgLWYke2V4cGVjdHNGaWxlID8gJycgOiAncid9YCwgZHN0UGF0aF0pO1xuICB9XG4gIGlmIChhd2FpdCBpc1ByZXNlbnQoZHN0UGF0aCwgcGtnSWQpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBpdGVtIGF0ICcke2RzdFBhdGh9JyBzdGlsbCBleGlzdHMgYWZ0ZXIgYmVpbmcgZGVsZXRlZC4gYCArXG4gICAgICBgSXMgaXQgd3JpdGFibGU/YCk7XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGVsZXRlRmlsZU9wdHNcbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ30gcmVtb3RlUGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSByZW1vdGUgZmlsZVxuICogb3IgYSBmaWxlIGluc2lkZSBhbiBhcHBsaWNhdGlvbiBidW5kbGUgKGZvciBleGFtcGxlIGBAbXkuYXBwLmlkL3BhdGgvaW4vYnVuZGxlYClcbiAqL1xuXG4vKipcbiAqIERlbGV0ZXMgYSBmaWxlIG9uIHRoZSByZW1vdGUgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtEZWxldGVGaWxlT3B0c30gb3B0c1xuICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgcmVtb3RlIGZpbGUgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQuXG4gKiBJZiB0aGUgcGF0aCB0byBhIHJlbW90ZSBmaWxlIGlzIHZhbGlkLCBidXQgdGhlIGZpbGUgaXRzZWxmIGRvZXMgbm90IGV4aXN0XG4gKiB0aGVuIGBmYWxzZWAgaXMgcmV0dXJuZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGFyZ3VtZW50IGlzIGludmFsaWQgb3IgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlXG4gKiBkZWxldGluZyB0aGUgZmlsZVxuICovXG5jb21tYW5kcy5tb2JpbGVEZWxldGVGaWxlID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlRGVsZXRlRmlsZSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtyZW1vdGVQYXRofSA9IG9wdHM7XG4gIGlmICghcmVtb3RlUGF0aCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgJ3JlbW90ZVBhdGgnIGFyZ3VtZW50IGlzIG1hbmRhdG9yeWApO1xuICB9XG4gIGlmIChyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSXQgaXMgZXhwZWN0ZWQgdGhhdCByZW1vdGUgcGF0aCBwb2ludHMgdG8gYSBmb2xkZXIgYW5kIG5vdCB0byBhIGZpbGUuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIHJldHVybiBhd2FpdCBkZWxldGVGaWxlT3JGb2xkZXIodGhpcy5hZGIsIHJlbW90ZVBhdGgpO1xufTtcblxuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZmlsZS1hY3Rpb25zLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
