"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _androidHelpers = _interopRequireDefault(require("../android-helpers"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.doTouchAction = async function doTouchAction(action, opts = {}) {
  const {
    element,
    x,
    y,
    count,
    ms,
    duration
  } = opts;

  switch (action) {
    case 'tap':
      return await this.tap(null, x, y, count);

    case 'press':
      return await this.touchDown(null, x, y);

    case 'release':
      return await this.touchUp(element, x, y);

    case 'moveTo':
      return await this.touchMove(null, x, y);

    case 'wait':
      return await _bluebird.default.delay(ms);

    case 'longPress':
      return await this.touchLongClick(null, x, y, duration || 1000);

    case 'cancel':
      _logger.default.warn('Cancel action currently has no effect');

      break;

    default:
      _logger.default.errorAndThrow(`unknown action ${action}`);

  }
};

helpers.doTouchDrag = async function doTouchDrag(gestures) {
  let longPress = gestures[0];
  let moveTo = gestures[1];
  let startX = longPress.options.x || 0,
      startY = longPress.options.y || 0,
      endX = moveTo.options.x || 0,
      endY = moveTo.options.y || 0;

  if (longPress.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(longPress.options.element);
    startX += x || 0;
    startY += y || 0;
  }

  if (moveTo.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(moveTo.options.element);
    endX += x || 0;
    endY += y || 0;
  }

  let apiLevel = await this.adb.getApiLevel();
  let duration = apiLevel >= 5 ? 2 : 1;

  if (longPress.options && longPress.options.duration) {
    duration = Math.max(longPress.options.duration / 1000, duration);
  }

  return await this.drag(startX, startY, endX, endY, duration, 1, longPress.options.element, moveTo.options.element);
};

helpers.fixRelease = async function fixRelease(gestures) {
  let release = _lodash.default.last(gestures);

  release.options = release.options || {};

  if (release.options.element || release.options.x && release.options.y) {
    return;
  }

  gestures = _lodash.default.clone(gestures);
  let ref = null;

  for (let gesture of gestures.reverse()) {
    let opts = gesture.options;

    if (opts.element || opts.x && opts.y) {
      ref = gesture;
      break;
    }
  }

  if (ref) {
    let opts = ref.options;

    if (opts.element) {
      let loc = await this.getLocationInView(opts.element);

      if (opts.x && opts.y) {
        release.options = {
          x: loc.x + opts.x,
          y: loc.y + opts.y
        };
      } else {
        let size = await this.getSize(opts.element);
        release.options = {
          x: loc.x + size.width / 2,
          y: loc.y + size.height / 2
        };
      }
    } else {
      release.options = _lodash.default.pick(opts, 'x', 'y');
    }
  }

  return release;
};

helpers.performGesture = async function performGesture(gesture) {
  try {
    return await this.doTouchAction(gesture.action, gesture.options || {});
  } catch (e) {
    if ((0, _appiumBaseDriver.isErrorType)(e, _appiumBaseDriver.errors.NoSuchElementError) && gesture.action === 'release' && gesture.options.element) {
      delete gesture.options.element;

      _logger.default.debug(`retrying release without element opts: ${gesture.options}.`);

      return await this.doTouchAction(gesture.action, gesture.options || {});
    }

    throw e;
  }
};

commands.performTouch = async function performTouch(gestures) {
  if (gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release') {
    let swipeOpts = await this.getSwipeOptions(gestures);
    return await this.swipe(swipeOpts.startX, swipeOpts.startY, swipeOpts.endX, swipeOpts.endY, swipeOpts.duration, swipeOpts.touchCount, swipeOpts.element);
  }

  let actions = _lodash.default.map(gestures, 'action');

  if (actions[0] === 'longPress' && actions[1] === 'moveTo' && actions[2] === 'release') {
    return await this.doTouchDrag(gestures);
  } else {
    if (actions.length === 2) {
      if (_lodash.default.head(actions) === 'press' && _lodash.default.last(actions) === 'release') {
        actions[0] = 'tap';
        gestures[0].action = 'tap';
      }

      if ((_lodash.default.head(actions) === 'tap' || _lodash.default.head(actions) === 'longPress') && _lodash.default.last(actions) === 'release') {
        gestures.pop();
        actions.pop();
      }
    } else {
      if (actions[0] === 'longPress') {
        actions = ['press', 'wait', ...actions.slice(1)];
        let press = gestures.shift();
        press.action = 'press';
        let wait = {
          action: 'wait',
          options: {
            ms: press.options.duration || 1000
          }
        };
        delete press.options.duration;
        gestures = [press, wait, ...gestures];
      }
    }

    let fixedGestures = await this.parseTouch(gestures, false);

    if (actions[actions.length - 1] === 'release') {
      actions[actions.length - 1] = await this.fixRelease(gestures);
    }

    for (let g of fixedGestures) {
      await this.performGesture(g);
    }
  }
};

helpers.parseTouch = async function parseTouch(gestures, multi) {
  if (multi && _lodash.default.last(gestures).action === 'release') {
    gestures.pop();
  }

  let touchStateObjects = await (0, _asyncbox.asyncmap)(gestures, async gesture => {
    let options = gesture.options || {};

    if (_lodash.default.includes(['press', 'moveTo', 'tap', 'longPress'], gesture.action)) {
      options.offset = false;
      let elementId = gesture.options.element;

      if (elementId) {
        let pos = await this.getLocationInView(elementId);

        if (gesture.options.x || gesture.options.y) {
          options.x = pos.x + (gesture.options.x || 0);
          options.y = pos.y + (gesture.options.y || 0);
        } else {
          const {
            width,
            height
          } = await this.getSize(elementId);
          options.x = pos.x + width / 2;
          options.y = pos.y + height / 2;
        }

        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      } else {
        options.x = gesture.options.x || 0;
        options.y = gesture.options.y || 0;
        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      }
    } else {
      let offset = 0.005;

      if (gesture.action === 'wait') {
        options = gesture.options;
        offset = parseInt(gesture.options.ms, 10) / 1000;
      }

      let touchStateObject = {
        action: gesture.action,
        options,
        timeOffset: offset
      };
      return touchStateObject;
    }
  }, false);
  let prevPos = null,
      time = 0;

  for (let state of touchStateObjects) {
    if (_lodash.default.isUndefined(state.options.x) && _lodash.default.isUndefined(state.options.y) && prevPos !== null) {
      state.options.x = prevPos.x;
      state.options.y = prevPos.y;
    }

    if (state.options.offset && prevPos) {
      state.options.x += prevPos.x;
      state.options.y += prevPos.y;
    }

    delete state.options.offset;

    if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
      prevPos = state.options;
    }

    if (multi) {
      let timeOffset = state.timeOffset;
      time += timeOffset;
      state.time = _androidHelpers.default.truncateDecimals(time, 3);

      if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
        state.touch = {
          x: state.options.x,
          y: state.options.y
        };
      }

      delete state.options;
    }

    delete state.timeOffset;
  }

  return touchStateObjects;
};

commands.performMultiAction = async function performMultiAction(actions, elementId) {
  if (actions.length === 1) {
    throw new Error('Multi Pointer Gestures need at least two actions. ' + 'Use Touch Actions for a single action.');
  }

  const states = await (0, _asyncbox.asyncmap)(actions, async action => await this.parseTouch(action, true), false);
  return await this.doPerformMultiAction(elementId, states);
};

commands.doPerformMultiAction = async function doPerformMultiAction(elementId, states) {
  let opts;

  if (elementId) {
    opts = {
      elementId,
      actions: states
    };
    return await this.bootstrap.sendAction('element:performMultiPointerGesture', opts);
  } else {
    opts = {
      actions: states
    };
    return await this.bootstrap.sendAction('performMultiPointerGesture', opts);
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy90b3VjaC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZG9Ub3VjaEFjdGlvbiIsImFjdGlvbiIsIm9wdHMiLCJlbGVtZW50IiwieCIsInkiLCJjb3VudCIsIm1zIiwiZHVyYXRpb24iLCJ0YXAiLCJ0b3VjaERvd24iLCJ0b3VjaFVwIiwidG91Y2hNb3ZlIiwiQiIsImRlbGF5IiwidG91Y2hMb25nQ2xpY2siLCJsb2ciLCJ3YXJuIiwiZXJyb3JBbmRUaHJvdyIsImRvVG91Y2hEcmFnIiwiZ2VzdHVyZXMiLCJsb25nUHJlc3MiLCJtb3ZlVG8iLCJzdGFydFgiLCJvcHRpb25zIiwic3RhcnRZIiwiZW5kWCIsImVuZFkiLCJnZXRMb2NhdGlvbkluVmlldyIsImFwaUxldmVsIiwiYWRiIiwiZ2V0QXBpTGV2ZWwiLCJNYXRoIiwibWF4IiwiZHJhZyIsImZpeFJlbGVhc2UiLCJyZWxlYXNlIiwiXyIsImxhc3QiLCJjbG9uZSIsInJlZiIsImdlc3R1cmUiLCJyZXZlcnNlIiwibG9jIiwic2l6ZSIsImdldFNpemUiLCJ3aWR0aCIsImhlaWdodCIsInBpY2siLCJwZXJmb3JtR2VzdHVyZSIsImUiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJkZWJ1ZyIsInBlcmZvcm1Ub3VjaCIsImxlbmd0aCIsInN3aXBlT3B0cyIsImdldFN3aXBlT3B0aW9ucyIsInN3aXBlIiwidG91Y2hDb3VudCIsImFjdGlvbnMiLCJtYXAiLCJoZWFkIiwicG9wIiwic2xpY2UiLCJwcmVzcyIsInNoaWZ0Iiwid2FpdCIsImZpeGVkR2VzdHVyZXMiLCJwYXJzZVRvdWNoIiwiZyIsIm11bHRpIiwidG91Y2hTdGF0ZU9iamVjdHMiLCJpbmNsdWRlcyIsIm9mZnNldCIsImVsZW1lbnRJZCIsInBvcyIsInRvdWNoU3RhdGVPYmplY3QiLCJ0aW1lT2Zmc2V0IiwicGFyc2VJbnQiLCJwcmV2UG9zIiwidGltZSIsInN0YXRlIiwiaXNVbmRlZmluZWQiLCJhbmRyb2lkSGVscGVycyIsInRydW5jYXRlRGVjaW1hbHMiLCJ0b3VjaCIsInBlcmZvcm1NdWx0aUFjdGlvbiIsIkVycm9yIiwic3RhdGVzIiwiZG9QZXJmb3JtTXVsdGlBY3Rpb24iLCJib290c3RyYXAiLCJzZW5kQWN0aW9uIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFFQUYsUUFBUSxDQUFDRyxhQUFULEdBQXlCLGVBQWVBLGFBQWYsQ0FBOEJDLE1BQTlCLEVBQXNDQyxJQUFJLEdBQUcsRUFBN0MsRUFBaUQ7QUFDeEUsUUFBTTtBQUFFQyxJQUFBQSxPQUFGO0FBQVdDLElBQUFBLENBQVg7QUFBY0MsSUFBQUEsQ0FBZDtBQUFpQkMsSUFBQUEsS0FBakI7QUFBd0JDLElBQUFBLEVBQXhCO0FBQTRCQyxJQUFBQTtBQUE1QixNQUF5Q04sSUFBL0M7O0FBR0EsVUFBUUQsTUFBUjtBQUNFLFNBQUssS0FBTDtBQUNFLGFBQU8sTUFBTSxLQUFLUSxHQUFMLENBQVMsSUFBVCxFQUFlTCxDQUFmLEVBQWtCQyxDQUFsQixFQUFxQkMsS0FBckIsQ0FBYjs7QUFDRixTQUFLLE9BQUw7QUFDRSxhQUFPLE1BQU0sS0FBS0ksU0FBTCxDQUFlLElBQWYsRUFBcUJOLENBQXJCLEVBQXdCQyxDQUF4QixDQUFiOztBQUNGLFNBQUssU0FBTDtBQUNFLGFBQU8sTUFBTSxLQUFLTSxPQUFMLENBQWFSLE9BQWIsRUFBc0JDLENBQXRCLEVBQXlCQyxDQUF6QixDQUFiOztBQUNGLFNBQUssUUFBTDtBQUNFLGFBQU8sTUFBTSxLQUFLTyxTQUFMLENBQWUsSUFBZixFQUFxQlIsQ0FBckIsRUFBd0JDLENBQXhCLENBQWI7O0FBQ0YsU0FBSyxNQUFMO0FBQ0Us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RCxNQU1PO0FBQ0xBLElBQUFBLElBQUksR0FBRztBQUNMMEQsTUFBQUEsT0FBTyxFQUFFNkI7QUFESixLQUFQO0FBR0EsV0FBTyxNQUFNLEtBQUtFLFNBQUwsQ0FBZUMsVUFBZixDQUEwQiw0QkFBMUIsRUFBd0QxRixJQUF4RCxDQUFiO0FBQ0Q7QUFDRixDQWREOztBQWdCQTJGLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjL0YsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGFuZHJvaWRIZWxwZXJzIGZyb20gJy4uL2FuZHJvaWQtaGVscGVycyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBlcnJvcnMsIGlzRXJyb3JUeXBlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGFzeW5jbWFwIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmRvVG91Y2hBY3Rpb24gPSBhc3luYyBmdW5jdGlvbiBkb1RvdWNoQWN0aW9uIChhY3Rpb24sIG9wdHMgPSB7fSkge1xuICBjb25zdCB7IGVsZW1lbnQsIHgsIHksIGNvdW50LCBtcywgZHVyYXRpb24gfSA9IG9wdHM7XG4gIC8vIHBhcnNlVG91Y2ggcHJlY2FsY3VsYXRlcyBhYnNvbHV0ZSBlbGVtZW50IHBvc2l0aW9uc1xuICAvLyBzbyB0aGVyZSBpcyBubyBuZWVkIHRvIHBhc3MgYGVsZW1lbnRgIHRvIHRoZSBhZmZlY3RlZCBnZXN0dXJlc1xuICBzd2l0Y2ggKGFjdGlvbikge1xuICAgIGNhc2UgJ3RhcCc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXAobnVsbCwgeCwgeSwgY291bnQpO1xuICAgIGNhc2UgJ3ByZXNzJzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRvdWNoRG93bihudWxsLCB4LCB5KTtcbiAgICBjYXNlICdyZWxlYXNlJzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRvdWNoVXAoZWxlbWVudCwgeCwgeSk7XG4gICAgY2FzZSAnbW92ZVRvJzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRvdWNoTW92ZShudWxsLCB4LCB5KTtcbiAgICBjYXNlICd3YWl0JzpcbiAgICAgIHJldHVybiBhd2FpdCBCLmRlbGF5KG1zKTtcbiAgICBjYXNlICdsb25nUHJlc3MnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hMb25nQ2xpY2sobnVsbCwgeCwgeSwgZHVyYXRpb24gfHwgMTAwMCk7XG4gICAgY2FzZSAnY2FuY2VsJzpcbiAgICAgIC8vIFRPRE86IGNsYXJpZnkgYmVoYXZpb3Igb2YgJ2NhbmNlbCcgYWN0aW9uIGFuZCBmaXggdGhpc1xuICAgICAgbG9nLndhcm4oJ0NhbmNlbCBhY3Rpb24gY3VycmVudGx5IGhhcyBubyBlZmZlY3QnKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgdW5rbm93biBhY3Rpb24gJHthY3Rpb259YCk7XG4gIH1cbn07XG5cblxuLy8gZHJhZyBpcyAqbm90KiBwcmVzcy1tb3ZlLXJlbGVhc2UsIHNvIHdlIG5lZWQgdG8gdHJhbnNsYXRlXG4vLyBkcmFnIHdvcmtzIGZpbmUgZm9yIHNjcm9sbCwgYXMgd2VsbFxuaGVscGVycy5kb1RvdWNoRHJhZyA9IGFzeW5jIGZ1bmN0aW9uIGRvVG91Y2hEcmFnIChnZXN0dXJlcykge1xuICBsZXQgbG9uZ1ByZXNzID0gZ2VzdHVyZXNbMF07XG4gIGxldCBtb3ZlVG8gPSBnZXN0dXJlc1sxXTtcbiAgbGV0IHN0YXJ0WCA9IGxvbmdQcmVzcy5vcHRpb25zLnggfHwgMCxcbiAgICAgIHN0YXJ0WSA9IGxvbmdQcmVzcy5vcHRpb25zLnkgfHwgMCxcbiAgICAgIGVuZFggPSBtb3ZlVG8ub3B0aW9ucy54IHx8IDAsXG4gICAgICBlbmRZID0gbW92ZVRvLm9wdGlvbnMueSB8fCAwO1xuICBpZiAobG9uZ1ByZXNzLm9wdGlvbnMuZWxlbWVudCkge1xuICAgIGxldCB7eCwgeX0gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGxvbmdQcmVzcy5vcHRpb25zLmVsZW1lbnQpO1xuICAgIHN0YXJ0WCArPSB4IHx8IDA7XG4gICAgc3RhcnRZICs9IHkgfHwgMDtcbiAgfVxuICBpZiAobW92ZVRvLm9wdGlvbnMuZWxlbWVudCkge1xuICAgIGxldCB7eCwgeX0gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KG1vdmVUby5vcHRpb25zLmVsZW1lbnQpO1xuICAgIGVuZFggKz0geCB8fCAwO1xuICAgIGVuZFkgKz0geSB8fCAwO1xuICB9XG5cbiAgbGV0IGFwaUxldmVsID0gYXdhaXQgdGhpcy5hZGIuZ2V0QXBpTGV2ZWwoKTtcbiAgLy8gbG9sbGlwb3AgdGFrZXMgYSBsaXR0bGUgbG9uZ2VyIHRvIGdldCB0aGluZ3Mgcm9sbGluZ1xuICBsZXQgZHVyYXRpb24gPSBhcGlMZXZlbCA+PSA1ID8gMiA6IDE7XG4gIC8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBsb25nIHByZXNzIGhhcyBhIGR1cmF0aW9uLCB3ZSB1c2UgaXQuXG4gIGlmIChsb25nUHJlc3Mub3B0aW9ucyAmJiBsb25nUHJlc3Mub3B0aW9ucy5kdXJhdGlvbikge1xuICAgIGR1cmF0aW9uID0gTWF0aC5tYXgobG9uZ1ByZXNzLm9wdGlvbnMuZHVyYXRpb24gLyAxMDAwLCBkdXJhdGlvbik7XG4gIH1cblxuICAvLyBgZHJhZ2Agd2lsbCB0YWtlIGNhcmUgb2Ygd2hldGhlciB0aGVyZSBpcyBhbiBlbGVtZW50IG9yIG5vdCBhdCB0aGF0IGxldmVsXG4gIHJldHVybiBhd2FpdCB0aGlzLmRyYWcoc3RhcnRYLCBzdGFydFksIGVuZFgsIGVuZFksIGR1cmF0aW9uLCAxLCBsb25nUHJlc3Mub3B0aW9ucy5lbGVtZW50LCBtb3ZlVG8ub3B0aW9ucy5lbGVtZW50KTtcbn07XG5cbi8vIFJlbGVhc2UgZ2VzdHVyZSBuZWVkcyBlbGVtZW50IG9yIGNvLW9yZGluYXRlcyB0byByZWxlYXNlIGl0IGZyb20gdGhhdCBwb3NpdGlvblxuLy8gb3IgZWxzZSByZWxlYXNlIGdlc3R1cmUgaXMgcGVyZm9ybWVkIGZyb20gY2VudGVyIG9mIHRoZSBzY3JlZW4sIHNvIHRvIGZpeCBpdFxuLy8gVGhpcyBtZXRob2Qgc2V0cyBjby1vcmRpbmF0ZXMvZWxlbWVudCB0byByZWxlYXNlIGdlc3R1cmUgaWYgaXQgaGFzIG5vIG9wdGlvbnMgc2V0IGFscmVhZHkuXG5oZWxwZXJzLmZpeFJlbGVhc2UgPSBhc3luYyBmdW5jdGlvbiBmaXhSZWxlYXNlIChnZXN0dXJlcykge1xuICBsZXQgcmVsZWFzZSA9IF8ubGFzdChnZXN0dXJlcyk7XG4gIC8vIHNvbWV0aW1lcyB0aGVyZSBhcmUgbm8gb3B0aW9uc1xuICByZWxlYXNlLm9wdGlvbnMgPSByZWxlYXNlLm9wdGlvbnMgfHwge307XG4gIC8vIG5vdGhpbmcgdG8gZG8gaWYgcmVsZWFzZSBvcHRpb25zIGFyZSBhbHJlYWR5IHNldFxuICBpZiAocmVsZWFzZS5vcHRpb25zLmVsZW1lbnQgfHwgKHJlbGVhc2Uub3B0aW9ucy54ICYmIHJlbGVhc2Uub3B0aW9ucy55KSkge1xuICAgIHJldHVybjtcbiAgfVxuICAvLyB3aXRob3V0IGNvb3JkaW5hdGVzLCBgcmVsZWFzZWAgdXNlcyB0aGUgY2VudGVyIG9mIHRoZSBzY3JlZW4sIHdoaWNoLFxuICAvLyBnZW5lcmFsbHkgc3BlYWtpbmcsIGlzIG5vdCB3aGF0IHdlIHdhbnRcbiAgLy8gdGhlcmVmb3JlOiBsb29wIGJhY2t3YXJkcyBhbmQgdXNlIHRoZSBsYXN0IGNvbW1hbmQgd2l0aCBhbiBlbGVtZW50IGFuZC9vclxuICAvLyBvZmZzZXQgY29vcmRpbmF0ZXNcbiAgZ2VzdHVyZXMgPSBfLmNsb25lKGdlc3R1cmVzKTtcbiAgbGV0IHJlZiA9IG51bGw7XG4gIGZvciAobGV0IGdlc3R1cmUgb2YgZ2VzdHVyZXMucmV2ZXJzZSgpKSB7XG4gICAgbGV0IG9wdHMgPSBnZXN0dXJlLm9wdGlvbnM7XG4gICAgaWYgKG9wdHMuZWxlbWVudCB8fCAob3B0cy54ICYmIG9wdHMueSkpIHtcbiAgICAgIHJlZiA9IGdlc3R1cmU7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgaWYgKHJlZikge1xuICAgIGxldCBvcHRzID0gcmVmLm9wdGlvbnM7XG4gICAgaWYgKG9wdHMuZWxlbWVudCkge1xuICAgICAgbGV0IGxvYyA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcob3B0cy5lbGVtZW50KTtcbiAgICAgIGlmIChvcHRzLnggJiYgb3B0cy55KSB7XG4gICAgICAgIC8vIHRoaXMgaXMgYW4gb2Zmc2V0IGZyb20gdGhlIGVsZW1lbnRcbiAgICAgICAgcmVsZWFzZS5vcHRpb25zID0ge1xuICAgICAgICAgIHg6IGxvYy54ICsgb3B0cy54LFxuICAgICAgICAgIHk6IGxvYy55ICsgb3B0cy55XG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0aGlzIGlzIHRoZSBjZW50ZXIgb2YgdGhlIGVsZW1lbnRcbiAgICAgICAgbGV0IHNpemUgPSBhd2FpdCB0aGlzLmdldFNpemUob3B0cy5lbGVtZW50KTtcbiAgICAgICAgcmVsZWFzZS5vcHRpb25zID0ge1xuICAgICAgICAgIHg6IGxvYy54ICsgc2l6ZS53aWR0aCAvIDIsXG4gICAgICAgICAgeTogbG9jLnkgKyBzaXplLmhlaWdodCAvIDJcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVsZWFzZS5vcHRpb25zID0gXy5waWNrKG9wdHMsICd4JywgJ3knKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlbGVhc2U7XG59O1xuXG4vLyBQZXJmb3JtIG9uZSBnZXN0dXJlXG5oZWxwZXJzLnBlcmZvcm1HZXN0dXJlID0gYXN5bmMgZnVuY3Rpb24gcGVyZm9ybUdlc3R1cmUgKGdlc3R1cmUpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kb1RvdWNoQWN0aW9uKGdlc3R1cmUuYWN0aW9uLCBnZXN0dXJlLm9wdGlvbnMgfHwge30pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gc29tZXRpbWUgdGhlIGVsZW1lbnQgaXMgbm90IGF2YWlsYWJsZSB3aGVuIHJlbGVhc2luZywgcmV0cnkgd2l0aG91dCBpdFxuICAgIGlmIChpc0Vycm9yVHlwZShlLCBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKSAmJiBnZXN0dXJlLmFjdGlvbiA9PT0gJ3JlbGVhc2UnICYmXG4gICAgICAgIGdlc3R1cmUub3B0aW9ucy5lbGVtZW50KSB7XG4gICAgICBkZWxldGUgZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG4gICAgICBsb2cuZGVidWcoYHJldHJ5aW5nIHJlbGVhc2Ugd2l0aG91dCBlbGVtZW50IG9wdHM6ICR7Z2VzdHVyZS5vcHRpb25zfS5gKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmRvVG91Y2hBY3Rpb24oZ2VzdHVyZS5hY3Rpb24sIGdlc3R1cmUub3B0aW9ucyB8fCB7fSk7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnBlcmZvcm1Ub3VjaCA9IGFzeW5jIGZ1bmN0aW9uIHBlcmZvcm1Ub3VjaCAoZ2VzdHVyZXMpIHtcbiAgLy8gcHJlc3Mtd2FpdC1tb3ZlVG8tcmVsZWFzZSBpcyBgc3dpcGVgLCBzbyB1c2UgbmF0aXZlIG1ldGhvZFxuICBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSA0ICYmXG4gICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPT09ICdwcmVzcycgJiZcbiAgICAgIGdlc3R1cmVzWzFdLmFjdGlvbiA9PT0gJ3dhaXQnICYmXG4gICAgICBnZXN0dXJlc1syXS5hY3Rpb24gPT09ICdtb3ZlVG8nICYmXG4gICAgICBnZXN0dXJlc1szXS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuXG4gICAgbGV0IHN3aXBlT3B0cyA9IGF3YWl0IHRoaXMuZ2V0U3dpcGVPcHRpb25zKGdlc3R1cmVzKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zd2lwZShzd2lwZU9wdHMuc3RhcnRYLCBzd2lwZU9wdHMuc3RhcnRZLCBzd2lwZU9wdHMuZW5kWCxcbiAgICAgICAgc3dpcGVPcHRzLmVuZFksIHN3aXBlT3B0cy5kdXJhdGlvbiwgc3dpcGVPcHRzLnRvdWNoQ291bnQsXG4gICAgICAgIHN3aXBlT3B0cy5lbGVtZW50KTtcbiAgfVxuICBsZXQgYWN0aW9ucyA9IF8ubWFwKGdlc3R1cmVzLCAnYWN0aW9uJyk7XG5cbiAgaWYgKGFjdGlvbnNbMF0gPT09ICdsb25nUHJlc3MnICYmIGFjdGlvbnNbMV0gPT09ICdtb3ZlVG8nICYmIGFjdGlvbnNbMl0gPT09ICdyZWxlYXNlJykge1xuICAgIC8vIHNvbWUgdGhpbmdzIGFyZSBzcGVjaWFsXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZG9Ub3VjaERyYWcoZ2VzdHVyZXMpO1xuICB9IGVsc2Uge1xuICAgIGlmIChhY3Rpb25zLmxlbmd0aCA9PT0gMikge1xuICAgICAgLy8gYHByZXNzYCB3aXRob3V0IGEgd2FpdCBpcyB0b28gc2xvdyBhbmQgZ2V0cyBpbnRlcnByZXR0ZWQgYXMgYSBgbG9uZ1ByZXNzYFxuICAgICAgaWYgKF8uaGVhZChhY3Rpb25zKSA9PT0gJ3ByZXNzJyAmJiBfLmxhc3QoYWN0aW9ucykgPT09ICdyZWxlYXNlJykge1xuICAgICAgICBhY3Rpb25zWzBdID0gJ3RhcCc7XG4gICAgICAgIGdlc3R1cmVzWzBdLmFjdGlvbiA9ICd0YXAnO1xuICAgICAgfVxuXG4gICAgICAvLyB0aGUgYGxvbmdQcmVzc2AgYW5kIGB0YXBgIG1ldGhvZHMgcmVsZWFzZSBvbiB0aGVpciBvd25cbiAgICAgIGlmICgoXy5oZWFkKGFjdGlvbnMpID09PSAndGFwJyB8fCBfLmhlYWQoYWN0aW9ucykgPT09ICdsb25nUHJlc3MnKSAmJiBfLmxhc3QoYWN0aW9ucykgPT09ICdyZWxlYXNlJykge1xuICAgICAgICBnZXN0dXJlcy5wb3AoKTtcbiAgICAgICAgYWN0aW9ucy5wb3AoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbG9uZ3ByZXNzIGZvbGxvd2VkIGJ5IGFueXRoaW5nIG90aGVyIHRoYW4gcmVsZWFzZSBzaG91bGQgYmVjb21lIGEgcHJlc3MgYW5kIHdhaXRcbiAgICAgIGlmIChhY3Rpb25zWzBdID09PSAnbG9uZ1ByZXNzJykge1xuICAgICAgICBhY3Rpb25zID0gWydwcmVzcycsICd3YWl0JywgLi4uYWN0aW9ucy5zbGljZSgxKV07XG5cbiAgICAgICAgbGV0IHByZXNzID0gZ2VzdHVyZXMuc2hpZnQoKTtcbiAgICAgICAgcHJlc3MuYWN0aW9uID0gJ3ByZXNzJztcbiAgICAgICAgbGV0IHdhaXQgPSB7XG4gICAgICAgICAgYWN0aW9uOiAnd2FpdCcsXG4gICAgICAgICAgb3B0aW9uczoge21zOiBwcmVzcy5vcHRpb25zLmR1cmF0aW9uIHx8IDEwMDB9XG4gICAgICAgIH07XG4gICAgICAgIGRlbGV0ZSBwcmVzcy5vcHRpb25zLmR1cmF0aW9uO1xuICAgICAgICBnZXN0dXJlcyA9IFtwcmVzcywgd2FpdCwgLi4uZ2VzdHVyZXNdO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBmaXhlZEdlc3R1cmVzID0gYXdhaXQgdGhpcy5wYXJzZVRvdWNoKGdlc3R1cmVzLCBmYWxzZSk7XG4gICAgLy8gZml4IHJlbGVhc2UgYWN0aW9uIHRoZW4gcGVyZm9ybSBhbGwgYWN0aW9uc1xuICAgIGlmIChhY3Rpb25zW2FjdGlvbnMubGVuZ3RoIC0gMV0gPT09ICdyZWxlYXNlJykge1xuICAgICAgYWN0aW9uc1thY3Rpb25zLmxlbmd0aCAtIDFdID0gYXdhaXQgdGhpcy5maXhSZWxlYXNlKGdlc3R1cmVzKTtcbiAgICB9XG4gICAgZm9yIChsZXQgZyBvZiBmaXhlZEdlc3R1cmVzKSB7XG4gICAgICBhd2FpdCB0aGlzLnBlcmZvcm1HZXN0dXJlKGcpO1xuICAgIH1cbiAgfVxufTtcblxuaGVscGVycy5wYXJzZVRvdWNoID0gYXN5bmMgZnVuY3Rpb24gcGFyc2VUb3VjaCAoZ2VzdHVyZXMsIG11bHRpKSB7XG4gIC8vIGJlY2F1c2UgbXVsdGktdG91Y2ggcmVsZWFzZXMgYXQgdGhlIGVuZCBieSBkZWZhdWx0XG4gIGlmIChtdWx0aSAmJiBfLmxhc3QoZ2VzdHVyZXMpLmFjdGlvbiA9PT0gJ3JlbGVhc2UnKSB7XG4gICAgZ2VzdHVyZXMucG9wKCk7XG4gIH1cblxuICBsZXQgdG91Y2hTdGF0ZU9iamVjdHMgPSBhd2FpdCBhc3luY21hcChnZXN0dXJlcywgYXN5bmMgKGdlc3R1cmUpID0+IHtcbiAgICBsZXQgb3B0aW9ucyA9IGdlc3R1cmUub3B0aW9ucyB8fCB7fTtcbiAgICBpZiAoXy5pbmNsdWRlcyhbJ3ByZXNzJywgJ21vdmVUbycsICd0YXAnLCAnbG9uZ1ByZXNzJ10sIGdlc3R1cmUuYWN0aW9uKSkge1xuICAgICAgb3B0aW9ucy5vZmZzZXQgPSBmYWxzZTtcbiAgICAgIGxldCBlbGVtZW50SWQgPSBnZXN0dXJlLm9wdGlvbnMuZWxlbWVudDtcbiAgICAgIGlmIChlbGVtZW50SWQpIHtcbiAgICAgICAgbGV0IHBvcyA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZWxlbWVudElkKTtcbiAgICAgICAgaWYgKGdlc3R1cmUub3B0aW9ucy54IHx8IGdlc3R1cmUub3B0aW9ucy55KSB7XG4gICAgICAgICAgb3B0aW9ucy54ID0gcG9zLnggKyAoZ2VzdHVyZS5vcHRpb25zLnggfHwgMCk7XG4gICAgICAgICAgb3B0aW9ucy55ID0gcG9zLnkgKyAoZ2VzdHVyZS5vcHRpb25zLnkgfHwgMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRTaXplKGVsZW1lbnRJZCk7XG4gICAgICAgICAgb3B0aW9ucy54ID0gcG9zLnggKyAod2lkdGggLyAyKTtcbiAgICAgICAgICBvcHRpb25zLnkgPSBwb3MueSArIChoZWlnaHQgLyAyKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgdG91Y2hTdGF0ZU9iamVjdCA9IHtcbiAgICAgICAgICBhY3Rpb246IGdlc3R1cmUuYWN0aW9uLFxuICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgdGltZU9mZnNldDogMC4wMDUsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB0b3VjaFN0YXRlT2JqZWN0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0aW9ucy54ID0gKGdlc3R1cmUub3B0aW9ucy54IHx8IDApO1xuICAgICAgICBvcHRpb25zLnkgPSAoZ2VzdHVyZS5vcHRpb25zLnkgfHwgMCk7XG5cbiAgICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgICAgYWN0aW9uOiBnZXN0dXJlLmFjdGlvbixcbiAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgIHRpbWVPZmZzZXQ6IDAuMDA1LFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IG9mZnNldCA9IDAuMDA1O1xuICAgICAgaWYgKGdlc3R1cmUuYWN0aW9uID09PSAnd2FpdCcpIHtcbiAgICAgICAgb3B0aW9ucyA9IGdlc3R1cmUub3B0aW9ucztcbiAgICAgICAgb2Zmc2V0ID0gKHBhcnNlSW50KGdlc3R1cmUub3B0aW9ucy5tcywgMTApIC8gMTAwMCk7XG4gICAgICB9XG4gICAgICBsZXQgdG91Y2hTdGF0ZU9iamVjdCA9IHtcbiAgICAgICAgYWN0aW9uOiBnZXN0dXJlLmFjdGlvbixcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgdGltZU9mZnNldDogb2Zmc2V0LFxuICAgICAgfTtcbiAgICAgIHJldHVybiB0b3VjaFN0YXRlT2JqZWN0O1xuICAgIH1cbiAgfSwgZmFsc2UpO1xuICAvLyB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgdGltZSAod2hpY2ggaXMgbm93IGFuIG9mZnNldClcbiAgLy8gYW5kIHRoZSBwb3NpdGlvbiAod2hpY2ggbWF5IGJlIGFuIG9mZnNldClcbiAgbGV0IHByZXZQb3MgPSBudWxsLFxuICAgICAgdGltZSA9IDA7XG4gIGZvciAobGV0IHN0YXRlIG9mIHRvdWNoU3RhdGVPYmplY3RzKSB7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiBfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueSkgJiYgcHJldlBvcyAhPT0gbnVsbCkge1xuICAgICAgLy8gdGhpcyBoYXBwZW5zIHdpdGggd2FpdFxuICAgICAgc3RhdGUub3B0aW9ucy54ID0gcHJldlBvcy54O1xuICAgICAgc3RhdGUub3B0aW9ucy55ID0gcHJldlBvcy55O1xuICAgIH1cbiAgICBpZiAoc3RhdGUub3B0aW9ucy5vZmZzZXQgJiYgcHJldlBvcykge1xuICAgICAgLy8gdGhlIGN1cnJlbnQgcG9zaXRpb24gaXMgYW4gb2Zmc2V0XG4gICAgICBzdGF0ZS5vcHRpb25zLnggKz0gcHJldlBvcy54O1xuICAgICAgc3RhdGUub3B0aW9ucy55ICs9IHByZXZQb3MueTtcbiAgICB9XG4gICAgZGVsZXRlIHN0YXRlLm9wdGlvbnMub2Zmc2V0O1xuICAgIGlmICghXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLngpICYmICFfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueSkpIHtcbiAgICAgIHByZXZQb3MgPSBzdGF0ZS5vcHRpb25zO1xuICAgIH1cblxuICAgIGlmIChtdWx0aSkge1xuICAgICAgbGV0IHRpbWVPZmZzZXQgPSBzdGF0ZS50aW1lT2Zmc2V0O1xuICAgICAgdGltZSArPSB0aW1lT2Zmc2V0O1xuICAgICAgc3RhdGUudGltZSA9IGFuZHJvaWRIZWxwZXJzLnRydW5jYXRlRGVjaW1hbHModGltZSwgMyk7XG5cbiAgICAgIC8vIG11bHRpIGdlc3R1cmVzIHJlcXVpcmUgJ3RvdWNoJyByYXRoZXIgdGhhbiAnb3B0aW9ucydcbiAgICAgIGlmICghXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLngpICYmICFfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueSkpIHtcbiAgICAgICAgc3RhdGUudG91Y2ggPSB7XG4gICAgICAgICAgeDogc3RhdGUub3B0aW9ucy54LFxuICAgICAgICAgIHk6IHN0YXRlLm9wdGlvbnMueVxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgZGVsZXRlIHN0YXRlLm9wdGlvbnM7XG4gICAgfVxuICAgIGRlbGV0ZSBzdGF0ZS50aW1lT2Zmc2V0O1xuICB9XG4gIHJldHVybiB0b3VjaFN0YXRlT2JqZWN0cztcbn07XG5cblxuY29tbWFuZHMucGVyZm9ybU11bHRpQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gcGVyZm9ybU11bHRpQWN0aW9uIChhY3Rpb25zLCBlbGVtZW50SWQpIHtcbiAgLy8gQW5kcm9pZCBuZWVkcyBhdCBsZWFzdCB0d28gYWN0aW9ucyB0byBiZSBhYmxlIHRvIHBlcmZvcm0gYSBtdWx0aSBwb2ludGVyIGdlc3R1cmVcbiAgaWYgKGFjdGlvbnMubGVuZ3RoID09PSAxKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNdWx0aSBQb2ludGVyIEdlc3R1cmVzIG5lZWQgYXQgbGVhc3QgdHdvIGFjdGlvbnMuICcgK1xuICAgICAgICAnVXNlIFRvdWNoIEFjdGlvbnMgZm9yIGEgc2luZ2xlIGFjdGlvbi4nKTtcbiAgfVxuXG4gIGNvbnN0IHN0YXRlcyA9IGF3YWl0IGFzeW5jbWFwKGFjdGlvbnMsIGFzeW5jIChhY3Rpb24pID0+IGF3YWl0IHRoaXMucGFyc2VUb3VjaChhY3Rpb24sIHRydWUpLCBmYWxzZSk7XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZG9QZXJmb3JtTXVsdGlBY3Rpb24oZWxlbWVudElkLCBzdGF0ZXMpO1xufTtcblxuLyoqXG4gKiBSZWFzb24gZm9yIGlzb2xhdGluZyBkb1BlcmZvcm1NdWx0aUFjdGlvbiBmcm9tIHBlcmZvcm1NdWx0aUFjdGlvbiBpcyBmb3IgcmV1c2luZyBwZXJmb3JtTXVsdGlBY3Rpb25cbiAqIGFjcm9zcyBhbmRyb2lkLWRyaXZlcnMgKGxpa2UgYXBwaXVtLXVpYXV0b21hdG9yMi1kcml2ZXIpIGFuZCB0byBhdm9pZCBjb2RlIGR1cGxpY2F0aW9uLlxuICogT3RoZXIgYW5kcm9pZC1kcml2ZXJzIChsaWtlIGFwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyKSBuZWVkIHRvIG92ZXJyaWRlIGRvUGVyZm9ybU11bHRpQWN0aW9uXG4gKiB0byBmYWNpbGl0YXRlIHBlcmZvcm1NdWx0aUFjdGlvbi5cbiAqL1xuY29tbWFuZHMuZG9QZXJmb3JtTXVsdGlBY3Rpb24gPSBhc3luYyBmdW5jdGlvbiBkb1BlcmZvcm1NdWx0aUFjdGlvbiAoZWxlbWVudElkLCBzdGF0ZXMpIHtcbiAgbGV0IG9wdHM7XG4gIGlmIChlbGVtZW50SWQpIHtcbiAgICBvcHRzID0ge1xuICAgICAgZWxlbWVudElkLFxuICAgICAgYWN0aW9uczogc3RhdGVzXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ib290c3RyYXAuc2VuZEFjdGlvbignZWxlbWVudDpwZXJmb3JtTXVsdGlQb2ludGVyR2VzdHVyZScsIG9wdHMpO1xuICB9IGVsc2Uge1xuICAgIG9wdHMgPSB7XG4gICAgICBhY3Rpb25zOiBzdGF0ZXNcbiAgICB9O1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zZW5kQWN0aW9uKCdwZXJmb3JtTXVsdGlQb2ludGVyR2VzdHVyZScsIG9wdHMpO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvdG91Y2guanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
