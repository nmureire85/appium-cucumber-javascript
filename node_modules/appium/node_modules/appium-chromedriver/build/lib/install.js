"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.install = install;
exports.installAll = installAll;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _utils = require("./utils");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _semver = _interopRequireDefault(require("semver"));

function log(line) {
  (0, _fancyLog.default)(`[Chromedriver Install] ${line}`);
}

const CD_PLATS = ['linux', 'win', 'mac'];
const CD_ARCHS = ['32', '64'];
const DOWNLOAD_TIMEOUT_MS = 15 * 1000;

async function getArchAndPlatform() {
  let arch = await _appiumSupport.system.arch();
  let platform = (0, _utils.getCurPlatform)();

  if (platform !== 'linux' && platform !== 'mac') {
    arch = '32';
  }

  const cdVer = _semver.default.coerce(_utils.CD_VER);

  if (platform === 'mac' && _semver.default.lt(cdVer, _utils.MAC_32_ONLY)) {
    arch = '32';
  }

  return {
    arch,
    platform
  };
}

function getDownloadUrl(version, platform, arch) {
  return `${_utils.CD_CDN}/${version}/chromedriver_${platform}${arch}.zip`;
}

function validatePlatform(platform, arch) {
  if (!_lodash.default.includes(CD_PLATS, platform)) {
    throw new Error(`Invalid platform: ${platform}`);
  }

  if (!_lodash.default.includes(CD_ARCHS, arch)) {
    throw new Error(`Invalid arch: ${arch}`);
  }

  if (arch === '64' && platform !== 'linux' && platform !== 'mac') {
    throw new Error('Only linux has a 64-bit version of Chromedriver');
  }
}

async function installForPlatform(version, platform, arch) {
  if (version === 'LATEST') {
    version = (await (0, _utils.retrieveData)(`${_utils.CD_CDN}/LATEST_RELEASE`, {
      'user-agent': 'appium',
      accept: '*/*'
    }, {
      timeout: DOWNLOAD_TIMEOUT_MS
    })).trim();
  }

  validatePlatform(platform, arch);
  const url = getDownloadUrl(version, platform, arch);
  log(`Installing Chromedriver version '${version}' for platform '${platform}' and architecture '${arch}'`);
  const binarySpec = `chromedriver_${platform}${arch}`;
  log(`Opening temp file to write '${binarySpec}' to...`);
  const tempFile = await _appiumSupport.tempDir.open({
    prefix: binarySpec,
    suffix: '.zip'
  });
  log(`Opened temp file '${tempFile.path}'`);
  log(`Downloading ${url} to '${tempFile.path}'`);
  await _appiumSupport.net.downloadFile(url, tempFile.path, {
    timeout: DOWNLOAD_TIMEOUT_MS
  });
  await _appiumSupport.fs.chmod(tempFile.path, 0o0644);

  const tempUnzipped = _path.default.resolve(_path.default.dirname(tempFile.path), binarySpec);

  log(`Extracting ${tempFile.path} to ${tempUnzipped}`);
  await (0, _appiumSupport.mkdirp)(tempUnzipped);
  await _appiumSupport.zip.extractAllTo(tempFile.path, tempUnzipped);

  let extractedBin = _path.default.resolve(tempUnzipped, 'chromedriver');

  if (platform === 'win') {
    extractedBin += '.exe';
  }

  log(`Creating ${_path.default.resolve(_utils.CD_BASE_DIR, platform)}...`);
  await (0, _appiumSupport.mkdirp)(_path.default.resolve(_utils.CD_BASE_DIR, platform));
  const newBin = await (0, _utils.getChromedriverBinaryPath)(platform, arch);
  log(`Copying unzipped binary, reading from ${extractedBin}...`);
  const binContents = await _appiumSupport.fs.readFile(extractedBin, {
    encoding: 'binary'
  });
  log(`Writing to ${newBin}...`);
  await _appiumSupport.fs.writeFile(newBin, binContents, {
    encoding: 'binary',
    mode: 0o755
  });
  log(`${newBin} successfully put in place`);
}

async function install() {
  const {
    arch,
    platform
  } = await getArchAndPlatform();
  await installForPlatform(_utils.CD_VER, platform, arch);
}

async function conditionalInstall() {
  const {
    arch,
    platform
  } = await getArchAndPlatform();
  const binPath = await (0, _utils.getChromedriverBinaryPath)(platform, arch);

  if (!(await _appiumSupport.fs.exists(binPath))) {
    await installForPlatform(_utils.CD_VER, platform, arch);
  } else {
    log(`No need to install chromedriver, ${binPath} exists`);
  }
}

async function installAll() {
  let downloads = [];

  for (let [platform, arch] of (0, _utils.getPlatforms)()) {
    downloads.push(installForPlatform(_utils.CD_VER, platform, arch));
  }

  await (0, _asyncbox.parallel)(downloads);
}

async function doInstall() {
  if (_lodash.default.includes(process.argv, '--all') || process.env.npm_config_chromedriver_install_all) {
    await installAll();
  } else if (_lodash.default.includes(process.argv, '--conditional')) {
    await conditionalInstall();
  } else {
    await install();
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsLmpzIl0sIm5hbWVzIjpbImxvZyIsImxpbmUiLCJDRF9QTEFUUyIsIkNEX0FSQ0hTIiwiRE9XTkxPQURfVElNRU9VVF9NUyIsImdldEFyY2hBbmRQbGF0Zm9ybSIsImFyY2giLCJzeXN0ZW0iLCJwbGF0Zm9ybSIsImNkVmVyIiwic2VtdmVyIiwiY29lcmNlIiwiQ0RfVkVSIiwibHQiLCJNQUNfMzJfT05MWSIsImdldERvd25sb2FkVXJsIiwidmVyc2lvbiIsIkNEX0NETiIsInZhbGlkYXRlUGxhdGZvcm0iLCJfIiwiaW5jbHVkZXMiLCJFcnJvciIsImluc3RhbGxGb3JQbGF0Zm9ybSIsImFjY2VwdCIsInRpbWVvdXQiLCJ0cmltIiwidXJsIiwiYmluYXJ5U3BlYyIsInRlbXBGaWxlIiwidGVtcERpciIsIm9wZW4iLCJwcmVmaXgiLCJzdWZmaXgiLCJwYXRoIiwibmV0IiwiZG93bmxvYWRGaWxlIiwiZnMiLCJjaG1vZCIsInRlbXBVbnppcHBlZCIsInJlc29sdmUiLCJkaXJuYW1lIiwiemlwIiwiZXh0cmFjdEFsbFRvIiwiZXh0cmFjdGVkQmluIiwiQ0RfQkFTRV9ESVIiLCJuZXdCaW4iLCJiaW5Db250ZW50cyIsInJlYWRGaWxlIiwiZW5jb2RpbmciLCJ3cml0ZUZpbGUiLCJtb2RlIiwiaW5zdGFsbCIsImNvbmRpdGlvbmFsSW5zdGFsbCIsImJpblBhdGgiLCJleGlzdHMiLCJpbnN0YWxsQWxsIiwiZG93bmxvYWRzIiwicHVzaCIsImRvSW5zdGFsbCIsInByb2Nlc3MiLCJhcmd2IiwiZW52IiwibnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfaW5zdGFsbF9hbGwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBR0EsU0FBU0EsR0FBVCxDQUFjQyxJQUFkLEVBQW9CO0FBQ2xCLHlCQUFRLDBCQUF5QkEsSUFBSyxFQUF0QztBQUNEOztBQUVELE1BQU1DLFFBQVEs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QUksQ0FBQ2hELFFBQUQsRUFBV0YsSUFBWCxDQUFULElBQTZCLDBCQUE3QixFQUE2QztBQUMzQ2tELElBQUFBLFNBQVMsQ0FBQ0MsSUFBVixDQUFlbkMsa0JBQWtCLENBQUNWLGFBQUQsRUFBU0osUUFBVCxFQUFtQkYsSUFBbkIsQ0FBakM7QUFDRDs7QUFDRCxRQUFNLHdCQUFHa0QsU0FBSCxDQUFOO0FBQ0Q7O0FBRUQsZUFBZUUsU0FBZixHQUE0QjtBQUMxQixNQUFJdkMsZ0JBQUVDLFFBQUYsQ0FBV3VDLE9BQU8sQ0FBQ0MsSUFBbkIsRUFBeUIsT0FBekIsS0FDQUQsT0FBTyxDQUFDRSxHQUFSLENBQVlDLG1DQURoQixFQUNxRDtBQUNuRCxVQUFNUCxVQUFVLEVBQWhCO0FBQ0QsR0FIRCxNQUdPLElBQUlwQyxnQkFBRUMsUUFBRixDQUFXdUMsT0FBTyxDQUFDQyxJQUFuQixFQUF5QixlQUF6QixDQUFKLEVBQStDO0FBQ3BELFVBQU1SLGtCQUFrQixFQUF4QjtBQUNELEdBRk0sTUFFQTtBQUNMLFVBQU1ELE9BQU8sRUFBYjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBwYXJhbGxlbCBhcyBsbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHN5c3RlbSwgdGVtcERpciwgZnMsIHppcCwgbWtkaXJwLCBuZXQgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQge1xuICBDRF9DRE4sIENEX1ZFUiwgQ0RfQkFTRV9ESVIsIGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgsXG4gIGdldEN1clBsYXRmb3JtLCBnZXRQbGF0Zm9ybXMsIE1BQ18zMl9PTkxZLCByZXRyaWV2ZURhdGEsXG59IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICdmYW5jeS1sb2cnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5cbmZ1bmN0aW9uIGxvZyAobGluZSkge1xuICBsb2dnZXIoYFtDaHJvbWVkcml2ZXIgSW5zdGFsbF0gJHtsaW5lfWApO1xufVxuXG5jb25zdCBDRF9QTEFUUyA9IFsnbGludXgnLCAnd2luJywgJ21hYyddO1xuY29uc3QgQ0RfQVJDSFMgPSBbJzMyJywgJzY0J107XG5jb25zdCBET1dOTE9BRF9USU1FT1VUX01TID0gMTUgKiAxMDAwO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRBcmNoQW5kUGxhdGZvcm0gKCkge1xuICBsZXQgYXJjaCA9IGF3YWl0IHN5c3RlbS5hcmNoKCk7XG4gIGxldCBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIGlmIChwbGF0Zm9ybSAhPT0gJ2xpbnV4JyAmJiBwbGF0Zm9ybSAhPT0gJ21hYycpIHtcbiAgICBhcmNoID0gJzMyJztcbiAgfVxuXG4gIGNvbnN0IGNkVmVyID0gc2VtdmVyLmNvZXJjZShDRF9WRVIpO1xuICBpZiAocGxhdGZvcm0gPT09ICdtYWMnICYmIHNlbXZlci5sdChjZFZlciwgTUFDXzMyX09OTFkpKSB7XG4gICAgYXJjaCA9ICczMic7XG4gIH1cbiAgcmV0dXJuIHthcmNoLCBwbGF0Zm9ybX07XG59XG5cbmZ1bmN0aW9uIGdldERvd25sb2FkVXJsICh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCkge1xuICByZXR1cm4gYCR7Q0RfQ0ROfS8ke3ZlcnNpb259L2Nocm9tZWRyaXZlcl8ke3BsYXRmb3JtfSR7YXJjaH0uemlwYDtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVQbGF0Zm9ybSAocGxhdGZvcm0sIGFyY2gpIHtcbiAgaWYgKCFfLmluY2x1ZGVzKENEX1BMQVRTLCBwbGF0Zm9ybSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGxhdGZvcm06ICR7cGxhdGZvcm19YCk7XG4gIH1cbiAgaWYgKCFfLmluY2x1ZGVzKENEX0FSQ0hTLCBhcmNoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBhcmNoOiAke2FyY2h9YCk7XG4gIH1cbiAgaWYgKGFyY2ggPT09ICc2NCcgJiYgcGxhdGZvcm0gIT09ICdsaW51eCcgJiYgcGxhdGZvcm0gIT09ICdtYWMnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IGxpbnV4IGhhcyBhIDY0LWJpdCB2ZXJzaW9uIG9mIENocm9tZWRyaXZlcicpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxGb3JQbGF0Zm9ybSAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgaWYgKHZlcnNpb24gPT09ICdMQVRFU1QnKSB7XG4gICAgdmVyc2lvbiA9IChhd2FpdCByZXRyaWV2ZURhdGEoYCR7Q0RfQ0ROfS9MQVRFU1RfUkVMRUFTRWAsIHtcbiAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICBhY2NlcHQ6ICcqLyonLFxuICAgIH0sIHsgdGltZW91dDogRE9XTkxPQURfVElNRU9VVF9NUyB9KSkudHJpbSgpO1xuICB9XG4gIHZhbGlkYXRlUGxhdGZvcm0ocGxhdGZvcm0sIGFyY2gpO1xuXG4gIGNvbnN0IHVybCA9IGdldERvd25sb2FkVXJsKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKTtcblxuICBsb2coYEluc3RhbGxpbmcgQ2hyb21lZHJpdmVyIHZlcnNpb24gJyR7dmVyc2lvbn0nIGZvciBwbGF0Zm9ybSAnJHtwbGF0Zm9ybX0nIGFuZCBhcmNoaXRlY3R1cmUgJyR7YXJjaH0nYCk7XG5cbiAgLy8gc2V0IHVwIGEgdGVtcCBmaWxlIHRvIGRvd25sb2FkIHRoZSBjaHJvbWVkcml2ZXIgemlwZmlsZSB0b1xuICBjb25zdCBiaW5hcnlTcGVjID0gYGNocm9tZWRyaXZlcl8ke3BsYXRmb3JtfSR7YXJjaH1gO1xuICBsb2coYE9wZW5pbmcgdGVtcCBmaWxlIHRvIHdyaXRlICcke2JpbmFyeVNwZWN9JyB0by4uLmApO1xuICBjb25zdCB0ZW1wRmlsZSA9IGF3YWl0IHRlbXBEaXIub3Blbih7XG4gICAgcHJlZml4OiBiaW5hcnlTcGVjLFxuICAgIHN1ZmZpeDogJy56aXAnXG4gIH0pO1xuICBsb2coYE9wZW5lZCB0ZW1wIGZpbGUgJyR7dGVtcEZpbGUucGF0aH0nYCk7XG5cbiAgLy8gYWN0dWFsbHkgZG93bmxvYWQgdGhlIHppcGZpbGUgYW5kIHdyaXRlIGl0IHdpdGggYXBwcm9wcmlhdGUgcGVybXNcbiAgbG9nKGBEb3dubG9hZGluZyAke3VybH0gdG8gJyR7dGVtcEZpbGUucGF0aH0nYCk7XG4gIGF3YWl0IG5ldC5kb3dubG9hZEZpbGUodXJsLCB0ZW1wRmlsZS5wYXRoLCB7dGltZW91dDogRE9XTkxPQURfVElNRU9VVF9NU30pO1xuICBhd2FpdCBmcy5jaG1vZCh0ZW1wRmlsZS5wYXRoLCAwbzA2NDQpO1xuXG4gIC8vIGV4dHJhY3QgZG93bmxvYWRlZCB6aXBmaWxlIHRvIHRlbXBkaXJcbiAgY29uc3QgdGVtcFVuemlwcGVkID0gcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZSh0ZW1wRmlsZS5wYXRoKSwgYmluYXJ5U3BlYyk7XG4gIGxvZyhgRXh0cmFjdGluZyAke3RlbXBGaWxlLnBhdGh9IHRvICR7dGVtcFVuemlwcGVkfWApO1xuICBhd2FpdCBta2RpcnAodGVtcFVuemlwcGVkKTtcbiAgYXdhaXQgemlwLmV4dHJhY3RBbGxUbyh0ZW1wRmlsZS5wYXRoLCB0ZW1wVW56aXBwZWQpO1xuICBsZXQgZXh0cmFjdGVkQmluID0gcGF0aC5yZXNvbHZlKHRlbXBVbnppcHBlZCwgJ2Nocm9tZWRyaXZlcicpO1xuICBpZiAocGxhdGZvcm0gPT09ICd3aW4nKSB7XG4gICAgZXh0cmFjdGVkQmluICs9ICcuZXhlJztcbiAgfVxuXG4gIC8vIG1ha2UgYnVpbGQgZGlycyB0aGF0IHdpbGwgaG9sZCB0aGUgY2hyb21lZHJpdmVyIGJpbmFyeVxuICBsb2coYENyZWF0aW5nICR7cGF0aC5yZXNvbHZlKENEX0JBU0VfRElSLCBwbGF0Zm9ybSl9Li4uYCk7XG4gIGF3YWl0IG1rZGlycChwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKSk7XG5cbiAgLy8gY29weSB0aGUgZXh0cmFjdGVkIGJpbmFyeSB0byB0aGUgY29ycmVjdCBidWlsZCBkaXJcbiAgY29uc3QgbmV3QmluID0gYXdhaXQgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aChwbGF0Zm9ybSwgYXJjaCk7XG4gIGxvZyhgQ29weWluZyB1bnppcHBlZCBiaW5hcnksIHJlYWRpbmcgZnJvbSAke2V4dHJhY3RlZEJpbn0uLi5gKTtcbiAgY29uc3QgYmluQ29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShleHRyYWN0ZWRCaW4sIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgbG9nKGBXcml0aW5nIHRvICR7bmV3QmlufS4uLmApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUobmV3QmluLCBiaW5Db250ZW50cywge2VuY29kaW5nOiAnYmluYXJ5JywgbW9kZTogMG83NTV9KTtcbiAgbG9nKGAke25ld0Jpbn0gc3VjY2Vzc2Z1bGx5IHB1dCBpbiBwbGFjZWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsICgpIHtcbiAgY29uc3Qge2FyY2gsIHBsYXRmb3JtfSA9IGF3YWl0IGdldEFyY2hBbmRQbGF0Zm9ybSgpO1xuICBhd2FpdCBpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmRpdGlvbmFsSW5zdGFsbCAoKSB7XG4gIGNvbnN0IHthcmNoLCBwbGF0Zm9ybX0gPSBhd2FpdCBnZXRBcmNoQW5kUGxhdGZvcm0oKTtcbiAgY29uc3QgYmluUGF0aCA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhiaW5QYXRoKSkge1xuICAgIGF3YWl0IGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2coYE5vIG5lZWQgdG8gaW5zdGFsbCBjaHJvbWVkcml2ZXIsICR7YmluUGF0aH0gZXhpc3RzYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEFsbCAoKSB7XG4gIGxldCBkb3dubG9hZHMgPSBbXTtcbiAgZm9yIChsZXQgW3BsYXRmb3JtLCBhcmNoXSBvZiBnZXRQbGF0Zm9ybXMoKSkge1xuICAgIGRvd25sb2Fkcy5wdXNoKGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKSk7XG4gIH1cbiAgYXdhaXQgbGwoZG93bmxvYWRzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG9JbnN0YWxsICgpIHtcbiAgaWYgKF8uaW5jbHVkZXMocHJvY2Vzcy5hcmd2LCAnLS1hbGwnKSB8fFxuICAgICAgcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfaW5zdGFsbF9hbGwpIHtcbiAgICBhd2FpdCBpbnN0YWxsQWxsKCk7XG4gIH0gZWxzZSBpZiAoXy5pbmNsdWRlcyhwcm9jZXNzLmFyZ3YsICctLWNvbmRpdGlvbmFsJykpIHtcbiAgICBhd2FpdCBjb25kaXRpb25hbEluc3RhbGwoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBpbnN0YWxsKCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgaW5zdGFsbCwgaW5zdGFsbEFsbCwgY29uZGl0aW9uYWxJbnN0YWxsLCBkb0luc3RhbGwgfTtcbiJdLCJmaWxlIjoibGliL2luc3RhbGwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
