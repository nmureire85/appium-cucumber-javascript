"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getChromeVersion = getChromeVersion;
exports.getChromedriverDir = getChromedriverDir;
exports.getChromedriverBinaryPath = getChromedriverBinaryPath;
exports.getCurPlatform = getCurPlatform;
exports.getPlatforms = getPlatforms;
exports.getMostRecentChromedriver = getMostRecentChromedriver;
exports.retrieveData = retrieveData;
exports.CHROMEDRIVER_CHROME_MAPPING = exports.CD_VER = exports.CD_CDN = exports.LINUX_32_ONLY = exports.MAC_32_ONLY = exports.CD_BASE_DIR = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _semver = _interopRequireDefault(require("semver"));

var _compareVersions = _interopRequireDefault(require("compare-versions"));

var _axios = _interopRequireDefault(require("axios"));

const rootDir = _path.default.basename(__dirname) === 'lib' ? _path.default.resolve(__dirname, process.env.NO_PRECOMPILE ? '..' : '../..') : __dirname;

const CHROMEDRIVER_CHROME_MAPPING = require(_path.default.resolve(rootDir, 'config', 'mapping.json'));

exports.CHROMEDRIVER_CHROME_MAPPING = CHROMEDRIVER_CHROME_MAPPING;
const CD_VER = process.env.npm_config_chromedriver_version || process.env.CHROMEDRIVER_VERSION || getMostRecentChromedriver();
exports.CD_VER = CD_VER;

const CD_BASE_DIR = _path.default.resolve(__dirname, '..', '..', 'chromedriver');

exports.CD_BASE_DIR = CD_BASE_DIR;
const CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';
exports.CD_CDN = CD_CDN;
const MAC_32_ONLY = '2.23.0';
exports.MAC_32_ONLY = MAC_32_ONLY;
const LINUX_32_ONLY = '2.34.0';
exports.LINUX_32_ONLY = LINUX_32_ONLY;

function getMostRecentChromedriver(mapping = CHROMEDRIVER_CHROME_MAPPING) {
  if (_lodash.default.isEmpty(mapping)) {
    throw new Error('Unable to get most recent Chromedriver version from empty mapping');
  }

  return _lodash.default.last(_lodash.default.keys(mapping).sort(_compareVersions.default));
}

async function getChromeVersion(adb, bundleId) {
  const {
    versionName
  } = await adb.getPackageInfo(bundleId);
  return versionName;
}

function getChromedriverDir(platform = getCurPlatform()) {
  return _path.default.resolve(CD_BASE_DIR, platform);
}

async function getChromedriverBinaryPath(platform = getCurPlatform(), arch = null) {
  const baseDir = getChromedriverDir(platform);
  let ext = '';

  if (platform === 'win') {
    ext = '.exe';
  } else if (platform === 'linux') {
    ext = `_${arch || (await _appiumSupport.system.arch())}`;
  }

  return _path.default.resolve(baseDir, `chromedriver${ext}`);
}

function getCurPlatform() {
  return _appiumSupport.system.isWindows() ? 'win' : _appiumSupport.system.isMac() ? 'mac' : 'linux';
}

function getPlatforms() {
  let plats = [['win', '32'], ['linux', '64']];

  const cdVer = _semver.default.coerce(CD_VER);

  plats.push(_semver.default.lt(cdVer, MAC_32_ONLY) ? ['mac', '32'] : ['mac', '64']);

  if (_semver.default.lt(cdVer, LINUX_32_ONLY)) {
    plats.push(['linux', '32']);
  }

  return plats;
}

async function retrieveData(url, headers, opts = {}) {
  const {
    timeout = 5000,
    responseType = 'text'
  } = opts;
  return (await (0, _axios.default)({
    url,
    headers,
    timeout,
    responseType
  })).data;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJyb290RGlyIiwicGF0aCIsImJhc2VuYW1lIiwiX19kaXJuYW1lIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJlbnYiLCJOT19QUkVDT01QSUxFIiwiQ0hST01FRFJJVkVSX0NIUk9NRV9NQVBQSU5HIiwicmVxdWlyZSIsIkNEX1ZFUiIsIm5wbV9jb25maWdfY2hyb21lZHJpdmVyX3ZlcnNpb24iLCJDSFJPTUVEUklWRVJfVkVSU0lPTiIsImdldE1vc3RSZWNlbnRDaHJvbWVkcml2ZXIiLCJDRF9CQVNFX0RJUiIsIkNEX0NETiIsIm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2NkbnVybCIsIkNIUk9NRURSSVZFUl9DRE5VUkwiLCJNQUNfMzJfT05MWSIsIkxJTlVYXzMyX09OTFkiLCJtYXBwaW5nIiwiXyIsImlzRW1wdHkiLCJFcnJvciIsImxhc3QiLCJrZXlzIiwic29ydCIsImNvbXBhcmVWZXJzaW9ucyIsImdldENocm9tZVZlcnNpb24iLCJhZGIiLCJidW5kbGVJZCIsInZlcnNpb25OYW1lIiwiZ2V0UGFja2FnZUluZm8iLCJnZXRDaHJvbWVkcml2ZXJEaXIiLCJwbGF0Zm9ybSIsImdldEN1clBsYXRmb3JtIiwiZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aCIsImFyY2giLCJiYXNlRGlyIiwiZXh0Iiwic3lzdGVtIiwiaXNXaW5kb3dzIiwiaXNNYWMiLCJnZXRQbGF0Zm9ybXMiLCJwbGF0cyIsImNkVmVyIiwic2VtdmVyIiwiY29lcmNlIiwicHVzaCIsImx0IiwicmV0cmlldmVEYXRhIiwidXJsIiwiaGVhZGVycyIsIm9wdHMiLCJ0aW1lb3V0IiwicmVzcG9uc2VUeXBlIiwiZGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsT0FBTyxHQUFHQyxjQUFLQyxRQUFMLENBQWNDLFNBQWQsTUFBNkIsS0FBN0IsR0FDWkYsY0FBS0csT0FBTCxDQUFhRCxTQUFiLEVBQXdCRSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsYUFBWixHQUE0QixJQUE1QixHQUFtQyxPQUEzRCxDQURZLEdBRVpKLFNBRko7O0FBSUEsTUFBTUssMkJBQTJCLEdBQUdDLE9BQU8sQ0FBQ1IsY0FBS0csT0FBTCxDQUFhSixPQUFiLEVBQXNCLFFBQXRCLEVBQWdDLGNBQWhDLENBQUQsQ0FBM0M7OztBQUVBLE1BQU1VLE1BQU0sR0FBR0wsT0FBTyxDQUFDQyxHQUFSLENBQVlLLCtCQUFaLElBQ1ZOLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTSxvQkFERixJQUVWQyx5QkFBeUIsRUFGOUI7OztBQUdBLE1BQU1DLFdBQVcsR0FBR2IsY0FBS0csT0FBTCxDQUFhRCxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLGNBQXBDLENBQXBCOzs7QUFDQSxNQUFNWSxNQUFNLEdBQUdWLE9BQU8sQ0FBQ0MsR0FBUixDQUFZVSw4QkFBWixJQUNWWCxPQUFPLENBQUNDLEdBQVIsQ0FBWVcsbUJBREYsSUFFViw2Q0FGTDs7QUFJQSxNQUFNQyxXQUFXLEdBQUcsUUFBcEI7O0FBQ0EsTUFBTUMsYUFBYSxHQUFHLFFBQXRCOzs7QUFHQSxTQUFTTix5QkFBVCxDQUFvQ08sT0FBTyxHQUFHWiwyQkFBOUMsRUFBMkU7QUFDekUsTUFBSWEsZ0JBQUVDLE9BQUYsQ0FBVUYsT0FBVixDQUFKLEVBQXdCO0FBQ3RCLFVBQU0sSUFBSUcsS0FBSixDQUFVLG1FQUFWLENBQU47QUFDRDs7QUFDRCxTQUFPRixnQkFBRUcsSUFBRixDQUFPSCxnQkFBRUksSUFBRixDQUFPTCxPQUFQLEVBQWdCTSxJQUFoQixDQUFxQkMsd0JBQXJCLENBQVAsQ0FBUDtBQUNEOztBQUVELGVBQWVDLGdCQUFmLENBQWlDQyxHQUFqQyxFQUFzQ0MsUUFBdEMsRUFBZ0Q7QUFDOUMsUUFBTTtBQUFDQyxJQUFBQTtBQUFELE1BQWdCLE1BQU1GLEdBQUcsQ0FBQ0csY0FBSixDQUFtQkYsUUFBbkIsQ0FBNUI7QUFDQSxTQUFPQyxXQUFQO0FBQ0Q7O0FBRUQsU0FBU0Usa0JBQVQsQ0FBNkJDLFFBQVEsR0FBR0MsY0FBYyxFQUF0RCxFQUEwRDtBQUN4RCxTQUFPbEMsY0FBS0csT0FBTCxDQUFhVSxXQUFiLEVBQTBCb0IsUUFBMUIsQ0FBUDtBQUNEOztBQUVELGVBQWVFLHlCQUFmLENBQTBDRixRQUFRLEdBQUdDLGNBQWMsRUFBbkUsRUFBdUVFLElBQUksR0FBRyxJQUE5RSxFQUFvRjtBQUNsRixRQUFNQyxPQUFPLEdBQUdMLGtCQUFrQixDQUFDQyxRQUFELENBQWxDO0FBQ0EsTUFBSUssR0FBRyxHQUFHLEVBQVY7O0FBQ0EsTUFBSUwsUUFBUSxLQUFLLEtBQWpCLEVBQXdCO0FBQ3RCSyxJQUFBQSxHQUFHLEdBQUcsTUFBTjtBQUNELEdBRkQsTUFFTyxJQUFJTCxRQUFRLEtBQUssT0FBakIsRUFBMEI7QUFDL0JLLElBQUFBLEdBQUcsR0FBSSxJQUFHRixJQUFJLEtBQUksTUFBTUcsc0JBQU9ILElBQVAsRUFBVixDQUF3QixFQUF0QztBQUNEOztBQUVELFNBQU9wQyxjQUFLRyxPQUFMLENBQWFrQyxPQUFiLEVBQXVCLGVBQWNDLEdBQUksRUFBekMsQ0FBUDtBQUNEOztBQUVELFNBQVNKLGNBQVQsR0FBMkI7QUFDekIsU0FBT0ssc0JBQU9DLFNBQVAsS0FBcUIsS0FBckIsR0FBOEJELHNCQUFPRSxLQUFQLEtBQWlCLEtBQWpCLEdBQXlCLE9BQTlEO0FBQ0Q7O0FBRUQsU0FBU0MsWUFBVCxHQUF5QjtBQUN2QixNQUFJQyxLQUFLLEdBQUcsQ0FDVixDQUFDLEtBQUQsRUFBUSxJQUFSLENBRFUsRUFFVixDQUFDLE9BQUQsRUFBVSxJQUFWLENBRlUsQ0FBWjs7QUFJQSxRQUFNQyxLQUFLLEdBQUdDLGdCQUFPQyxNQUFQLENBQWNyQyxNQUFkLENBQWQ7O0FBRUFrQyxFQUFBQSxLQUFLLENBQUNJLElBQU4sQ0FBV0YsZ0JBQU9HLEVBQVAsQ0FBVUosS0FBVixFQUFpQjNCLFdBQWpCLElBQWdDLENBQUMsS0FBRCxFQUFRLElBQVIsQ0FBaEMsR0FBZ0QsQ0FBQyxLQUFELEVBQVEsSUFBUixDQUEzRDs7QUFFQSxNQUFJNEIsZ0JBQU9HLEVBQVAsQ0FBVUosS0FBVixFQUFpQjFCLGFBQWpCLENBQUosRUFBcUM7QUFDbkN5QixJQUFBQSxLQUFLLENBQUNJLElBQU4sQ0FBVyxDQUFDLE9BQUQsRUFBVSxJQUFWLENBQVg7QUFDRDs7QUFDRCxTQUFPSixLQUFQO0FBQ0Q7O0FBRUQsZUFBZU0sWUFBZixDQUE2QkMsR0FBN0IsRUFBa0NDLE9BQWxDLEVBQTJDQyxJQUFJLEdBQUcsRUFBbEQsRUFBc0Q7QUFDcEQsUUFBTTtBQUNKQyxJQUFBQSxPQUFPLEdBQUcsSUFETjtBQUVKQyxJQUFBQSxZQUFZLEdBQUc7QUFGWCxNQUdGRixJQUhKO0FBSUEsU0FBTyxDQUFDLE1BQU0sb0JBQU07QUFDbEJGLElBQUFBLEdBRGtCO0FBRWxCQyxJQUFBQSxPQUZrQjtBQUdsQkUsSUFBQUEsT0FIa0I7QUFJbEJDLElBQUFBO0FBSmtCLEdBQU4sQ0FBUCxFQUtIQyxJQUxKO0FBTUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgc3lzdGVtIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgY29tcGFyZVZlcnNpb25zIGZyb20gJ2NvbXBhcmUtdmVyc2lvbnMnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcblxuXG5jb25zdCByb290RGlyID0gcGF0aC5iYXNlbmFtZShfX2Rpcm5hbWUpID09PSAnbGliJ1xuICA/IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIHByb2Nlc3MuZW52Lk5PX1BSRUNPTVBJTEUgPyAnLi4nIDogJy4uLy4uJylcbiAgOiBfX2Rpcm5hbWU7XG4vLyBDaHJvbWVkcml2ZXIgdmVyc2lvbjogbWluaW11bSBDaHJvbWUgdmVyc2lvblxuY29uc3QgQ0hST01FRFJJVkVSX0NIUk9NRV9NQVBQSU5HID0gcmVxdWlyZShwYXRoLnJlc29sdmUocm9vdERpciwgJ2NvbmZpZycsICdtYXBwaW5nLmpzb24nKSk7XG5cbmNvbnN0IENEX1ZFUiA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX3ZlcnNpb25cbiAgfHwgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX1ZFUlNJT05cbiAgfHwgZ2V0TW9zdFJlY2VudENocm9tZWRyaXZlcigpO1xuY29uc3QgQ0RfQkFTRV9ESVIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnY2hyb21lZHJpdmVyJyk7XG5jb25zdCBDRF9DRE4gPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX2Nocm9tZWRyaXZlcl9jZG51cmxcbiAgfHwgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX0NETlVSTFxuICB8fCAnaHR0cHM6Ly9jaHJvbWVkcml2ZXIuc3RvcmFnZS5nb29nbGVhcGlzLmNvbSc7XG5cbmNvbnN0IE1BQ18zMl9PTkxZID0gJzIuMjMuMCc7XG5jb25zdCBMSU5VWF8zMl9PTkxZID0gJzIuMzQuMCc7XG5cblxuZnVuY3Rpb24gZ2V0TW9zdFJlY2VudENocm9tZWRyaXZlciAobWFwcGluZyA9IENIUk9NRURSSVZFUl9DSFJPTUVfTUFQUElORykge1xuICBpZiAoXy5pc0VtcHR5KG1hcHBpbmcpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZ2V0IG1vc3QgcmVjZW50IENocm9tZWRyaXZlciB2ZXJzaW9uIGZyb20gZW1wdHkgbWFwcGluZycpO1xuICB9XG4gIHJldHVybiBfLmxhc3QoXy5rZXlzKG1hcHBpbmcpLnNvcnQoY29tcGFyZVZlcnNpb25zKSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldENocm9tZVZlcnNpb24gKGFkYiwgYnVuZGxlSWQpIHtcbiAgY29uc3Qge3ZlcnNpb25OYW1lfSA9IGF3YWl0IGFkYi5nZXRQYWNrYWdlSW5mbyhidW5kbGVJZCk7XG4gIHJldHVybiB2ZXJzaW9uTmFtZTtcbn1cblxuZnVuY3Rpb24gZ2V0Q2hyb21lZHJpdmVyRGlyIChwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCkpIHtcbiAgcmV0dXJuIHBhdGgucmVzb2x2ZShDRF9CQVNFX0RJUiwgcGxhdGZvcm0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoIChwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCksIGFyY2ggPSBudWxsKSB7XG4gIGNvbnN0IGJhc2VEaXIgPSBnZXRDaHJvbWVkcml2ZXJEaXIocGxhdGZvcm0pO1xuICBsZXQgZXh0ID0gJyc7XG4gIGlmIChwbGF0Zm9ybSA9PT0gJ3dpbicpIHtcbiAgICBleHQgPSAnLmV4ZSc7XG4gIH0gZWxzZSBpZiAocGxhdGZvcm0gPT09ICdsaW51eCcpIHtcbiAgICBleHQgPSBgXyR7YXJjaCB8fCBhd2FpdCBzeXN0ZW0uYXJjaCgpfWA7XG4gIH1cblxuICByZXR1cm4gcGF0aC5yZXNvbHZlKGJhc2VEaXIsIGBjaHJvbWVkcml2ZXIke2V4dH1gKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q3VyUGxhdGZvcm0gKCkge1xuICByZXR1cm4gc3lzdGVtLmlzV2luZG93cygpID8gJ3dpbicgOiAoc3lzdGVtLmlzTWFjKCkgPyAnbWFjJyA6ICdsaW51eCcpO1xufVxuXG5mdW5jdGlvbiBnZXRQbGF0Zm9ybXMgKCkge1xuICBsZXQgcGxhdHMgPSBbXG4gICAgWyd3aW4nLCAnMzInXSxcbiAgICBbJ2xpbnV4JywgJzY0J10sXG4gIF07XG4gIGNvbnN0IGNkVmVyID0gc2VtdmVyLmNvZXJjZShDRF9WRVIpO1xuICAvLyBiZWZvcmUgMi4yMyBNYWMgdmVyc2lvbiB3YXMgMzIgYml0LiBBZnRlciBpdCBpcyA2NC5cbiAgcGxhdHMucHVzaChzZW12ZXIubHQoY2RWZXIsIE1BQ18zMl9PTkxZKSA/IFsnbWFjJywgJzMyJ10gOiBbJ21hYycsICc2NCddKTtcbiAgLy8gMi4zNCBhbmQgYWJvdmUgbGludXggaXMgb25seSBzdXBwb3J0aW5nIDY0IGJpdFxuICBpZiAoc2VtdmVyLmx0KGNkVmVyLCBMSU5VWF8zMl9PTkxZKSkge1xuICAgIHBsYXRzLnB1c2goWydsaW51eCcsICczMiddKTtcbiAgfVxuICByZXR1cm4gcGxhdHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJldHJpZXZlRGF0YSAodXJsLCBoZWFkZXJzLCBvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHRpbWVvdXQgPSA1MDAwLFxuICAgIHJlc3BvbnNlVHlwZSA9ICd0ZXh0JyxcbiAgfSA9IG9wdHM7XG4gIHJldHVybiAoYXdhaXQgYXhpb3Moe1xuICAgIHVybCxcbiAgICBoZWFkZXJzLFxuICAgIHRpbWVvdXQsXG4gICAgcmVzcG9uc2VUeXBlLFxuICB9KSkuZGF0YTtcbn1cblxuXG5leHBvcnQge1xuICBnZXRDaHJvbWVWZXJzaW9uLCBnZXRDaHJvbWVkcml2ZXJEaXIsIGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgsXG4gIGdldEN1clBsYXRmb3JtLCBnZXRQbGF0Zm9ybXMsIENEX0JBU0VfRElSLCBNQUNfMzJfT05MWSwgTElOVVhfMzJfT05MWSxcbiAgQ0RfQ0ROLCBDRF9WRVIsIENIUk9NRURSSVZFUl9DSFJPTUVfTUFQUElORywgZ2V0TW9zdFJlY2VudENocm9tZWRyaXZlcixcbiAgcmV0cmlldmVEYXRhLFxufTtcbiJdLCJmaWxlIjoibGliL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
