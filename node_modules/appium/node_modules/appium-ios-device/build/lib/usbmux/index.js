"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getDefaultSocket = getDefaultSocket;
exports.default = exports.Usbmux = void 0;

require("source-map-support/register");

var _net = _interopRequireDefault(require("net"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _usbmuxDecoder = _interopRequireDefault(require("./transformer/usbmux-decoder.js"));

var _usbmuxEncoder = _interopRequireDefault(require("./transformer/usbmux-encoder.js"));

var _path = _interopRequireDefault(require("path"));

var _plistService = _interopRequireDefault(require("../plist-service"));

var _lockdown = require("../lockdown");

var _baseService = require("../base-service");

var _constants = require("../constants");

const MAX_FRAME_SIZE = 1 * _constants.MB;
const USBMUX_RESULT = {
  OK: 0,
  BADCOMMAND: 1,
  BADDEV: 2,
  CONNREFUSED: 3
};
let name, version;

try {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', '..', 'package.json')));
} catch (err) {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', 'package.json')));
}

const DEFAULT_USBMUXD_SOCKET = '/var/run/usbmuxd';
const PROG_NAME = name;
const CLIENT_VERSION_STRING = `${name}-${version}`;

function swap16(val) {
  return (val & 0xFF) << 8 | val >> 8 & 0xFF;
}

async function getDefaultSocket(socketPath = DEFAULT_USBMUXD_SOCKET, timeout = 5000) {
  if (!(await _appiumSupport.fs.exists(socketPath))) {
    throw new Error(`The usbmuxd socket at '${socketPath}' does not exist or is not accessible`);
  }

  return await new _bluebird.default((resolve, reject) => {
    const socket = _net.default.createConnection(socketPath);

    socket.once('error', reject);
    socket.once('connect', () => resolve(socket));
  }).timeout(timeout);
}

class Usbmux extends _baseService.BaseServiceSocket {
  constructor(socketClient) {
    super(socketClient);
    this._decoder = new _usbmuxDecoder.default();
    this._splitter = new _lengthBasedSplitter.default({
      readableStream: socketClient,
      littleEndian: true,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 0
    });

    this._socketClient.pipe(this._splitter).pipe(this._decoder);

    this._encoder = new _usbmuxEncoder.default();

    this._encoder.pipe(this._socketClient);

    this._assignClientFailureHandlers(this._encoder);

    this._tag = 0;
    this._responseCallbacks = {};

    this._decoder.on('data', this._handleData.bind(this));
  }

  _handleData(data) {
    const cb = this._responseCallbacks[data.header.tag] || _lodash.default.noop;
    cb(data);
  }

  async readBUID(timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.BUID) {
        return data.payload.BUID;
      }

      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    });

    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ReadBUID',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });

    return await receivePromise;
  }

  async readPairRecord(udid, timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (!data.payload.PairRecordData) {
        return null;
      }

      try {
        return _appiumSupport.plist.parsePlist(data.payload.PairRecordData);
      } catch (err) {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    });

    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ReadPairRecord',
        PairRecordID: udid,
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });

    return await receivePromise;
  }

  _sendPlist(json) {
    this._encoder.write(json);
  }

  _receivePlistPromise(timeout = 5000, responseCallback) {
    const tag = this._tag++;
    const receivePromise = new _bluebird.default((resolve, reject) => {
      this._responseCallbacks[tag] = data => {
        try {
          resolve(responseCallback(data));
        } catch (e) {
          reject(e);
        }
      };

      setTimeout(() => reject(new Error(`Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
    return {
      tag,
      receivePromise
    };
  }

  async listDevices(timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.DeviceList) {
        return data.payload.DeviceList;
      }

      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    });

    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ListDevices',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });

    return await receivePromise;
  }

  async findDevice(udid, timeout = 5000) {
    const devices = await this.listDevices(timeout);
    return _lodash.default.find(devices, device => device.Properties.SerialNumber === udid);
  }

  async connectLockdown(udid, timeout = 5000) {
    const device = await this.findDevice(udid, timeout);

    if (!device) {
      throw new Error(`Could not find the expected device '${udid}'`);
    }

    const socket = await this.connect(device.Properties.DeviceID, _lockdown.LOCKDOWN_PORT, timeout);
    return new _lockdown.Lockdown(new _plistService.default(socket));
  }

  async connect(deviceID, port, timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.MessageType !== 'Result') {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }

      if (data.payload.Number === USBMUX_RESULT.OK) {
        this._splitter.shutdown();

        this._socketClient.unpipe(this._splitter);

        this._splitter.unpipe(this._decoder);

        return this._socketClient;
      } else if (data.payload.Number === USBMUX_RESULT.CONNREFUSED) {
        throw new Error(`Connection was refused to port ${port}`);
      } else {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    });

    this._sendPlist({
      tag,
      payload: {
        MessageType: 'Connect',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING,
        DeviceID: deviceID,
        PortNumber: swap16(port)
      }
    });

    return await receivePromise;
  }

}

exports.Usbmux = Usbmux;
var _default = Usbmux;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91c2JtdXgvaW5kZXguanMiXSwibmFtZXMiOlsiTUFYX0ZSQU1FX1NJWkUiLCJNQiIsIlVTQk1VWF9SRVNVTFQiLCJPSyIsIkJBRENPTU1BTkQiLCJCQURERVYiLCJDT05OUkVGVVNFRCIsIm5hbWUiLCJ2ZXJzaW9uIiwicmVxdWlyZSIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZXJyIiwiREVGQVVMVF9VU0JNVVhEX1NPQ0tFVCIsIlBST0dfTkFNRSIsIkNMSUVOVF9WRVJTSU9OX1NUUklORyIsInN3YXAxNiIsInZhbCIsImdldERlZmF1bHRTb2NrZXQiLCJzb2NrZXRQYXRoIiwidGltZW91dCIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJCIiwicmVqZWN0Iiwic29ja2V0IiwibmV0IiwiY3JlYXRlQ29ubmVjdGlvbiIsIm9uY2UiLCJVc2JtdXgiLCJCYXNlU2VydmljZVNvY2tldCIsImNvbnN0cnVjdG9yIiwic29ja2V0Q2xpZW50IiwiX2RlY29kZXIiLCJVc2JtdXhEZWNvZGVyIiwiX3NwbGl0dGVyIiwiTGVuZ3RoQmFzZWRTcGxpdHRlciIsInJlYWRhYmxlU3RyZWFtIiwibGl0dGxlRW5kaWFuIiwibWF4RnJhbWVMZW5ndGgiLCJsZW5ndGhGaWVsZE9mZnNldCIsImxlbmd0aEZpZWxkTGVuZ3RoIiwibGVuZ3RoQWRqdXN0bWVudCIsIl9zb2NrZXRDbGllbnQiLCJwaXBlIiwiX2VuY29kZXIiLCJVc2JtdXhFbmNvZGVyIiwiX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyIsIl90YWciLCJfcmVzcG9uc2VDYWxsYmFja3MiLCJvbiIsIl9oYW5kbGVEYXRhIiwiYmluZCIsImRhdGEiLCJjYiIsImhlYWRlciIsInRhZyIsIl8iLCJub29wIiwicmVhZEJVSUQiLCJyZWNlaXZlUHJvbWlzZSIsIl9yZWNlaXZlUGxpc3RQcm9taXNlIiwicGF5bG9hZCIsIkJVSUQiLCJKU09OIiwic3RyaW5naWZ5IiwiX3NlbmRQbGlzdCIsIk1lc3NhZ2VUeXBlIiwiUHJvZ05hbWUiLCJDbGllbnRWZXJzaW9uU3RyaW5nIiwicmVhZFBhaXJSZWNvcmQiLCJ1ZGlkIiwiUGFpclJlY29yZERhdGEiLCJwbGlzdCIsInBhcnNlUGxpc3QiLCJQYWlyUmVjb3JkSUQiLCJqc29uIiwid3JpdGUiLCJyZXNwb25zZUNhbGxiYWNrIiwiZSIsInNldFRpbWVvdXQiLCJsaXN0RGV2aWNlcyIsIkRldmljZUxpc3QiLCJmaW5kRGV2aWNlIiwiZGV2aWNlcyIsImZpbmQiLCJkZXZpY2UiLCJQcm9wZXJ0aWVzIiwiU2VyaWFsTnVtYmVyIiwiY29ubmVjdExvY2tkb3duIiwiY29ubmVjdCIsIkRldmljZUlEIiwiTE9DS0RPV05fUE9SVCIsIkxvY2tkb3duIiwiUGxpc3RTZXJ2aWNlIiwiZGV2aWNlSUQiLCJwb3J0IiwiTnVtYmVyIiwic2h1dGRvd24iLCJ1bnBpcGUiLCJQb3J0TnVtYmVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxjQUFjLEdBQUcsSUFBSUMsYUFBM0I7QUFFQSxNQUFNQyxhQUFhLEdBQUc7QUFDcEJDLEVBQUFBLEVBQUUsRUFBRSxDQURnQjtBQUVwQkMsRUFBQUEsVUFBVSxFQUFFLENBRlE7QUFHcEJDLEVBQUFBLE1BQU0sRUFBRSxDQUhZO0FBSXBCQyxFQUFBQSxXQUFXLEVBQUU7QUFKTyxDQUF0QjtBQU9BLElBQUlDLElBQUosRUFBVUMsT0FBVjs7QUFDQSxJQUFJO0FBRUYsR0FBQztBQUFFRCxJQUFBQSxJQUFGO0FBQVFDLElBQUFBO0FBQVIsTUFBb0JDLE9BQU8sQ0FBQ0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLElBQXBDLEVBQTBDLGNBQTFDLENBQUQsQ0FBNUI7QUFDRCxDQUhELENBR0UsT0FBT0MsR0FBUCxFQUFZO0FBRVosR0FBQztBQUFFTixJ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LENBQU47QUFDRDtBQUNGLEtBZDZCLENBQTlCOztBQWdCQSxTQUFLYSxVQUFMLENBQWdCO0FBQ2RWLE1BQUFBLEdBRGM7QUFFZE0sTUFBQUEsT0FBTyxFQUFFO0FBQ1BLLFFBQUFBLFdBQVcsRUFBRSxTQUROO0FBRVBDLFFBQUFBLFFBQVEsRUFBRXZELFNBRkg7QUFHUHdELFFBQUFBLG1CQUFtQixFQUFFdkQscUJBSGQ7QUFJUDZFLFFBQUFBLFFBQVEsRUFBRUksUUFKSDtBQUtQSyxRQUFBQSxVQUFVLEVBQUVyRixNQUFNLENBQUNpRixJQUFEO0FBTFg7QUFGSyxLQUFoQjs7QUFXQSxXQUFPLE1BQU1wQyxjQUFiO0FBQ0Q7O0FBOUxvQzs7O2VBa014Qi9CLE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgcGxpc3QsIGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IExlbmd0aEJhc2VkU3BsaXR0ZXIgZnJvbSAnLi4vdXRpbC90cmFuc2Zvcm1lci9sZW5ndGgtYmFzZWQtc3BsaXR0ZXInO1xuaW1wb3J0IFVzYm11eERlY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci91c2JtdXgtZGVjb2Rlci5qcyc7XG5pbXBvcnQgVXNibXV4RW5jb2RlciBmcm9tICcuL3RyYW5zZm9ybWVyL3VzYm11eC1lbmNvZGVyLmpzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFBsaXN0U2VydmljZSBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlJztcbmltcG9ydCB7IExvY2tkb3duLCBMT0NLRE9XTl9QT1JUIH0gZnJvbSAnLi4vbG9ja2Rvd24nO1xuaW1wb3J0IHsgQmFzZVNlcnZpY2VTb2NrZXQgfSBmcm9tICcuLi9iYXNlLXNlcnZpY2UnO1xuaW1wb3J0IHsgTUIgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuXG5cbmNvbnN0IE1BWF9GUkFNRV9TSVpFID0gMSAqIE1CO1xuXG5jb25zdCBVU0JNVVhfUkVTVUxUID0ge1xuICBPSzogMCxcbiAgQkFEQ09NTUFORDogMSxcbiAgQkFEREVWOiAyLFxuICBDT05OUkVGVVNFRDogMyxcbn07XG5cbmxldCBuYW1lLCB2ZXJzaW9uO1xudHJ5IHtcbiAgLy8gZmlyc3QgdHJ5IGFzc3VtaW5nIHRoaXMgaXMgaW4gdGhlIGBidWlsZGAgZm9sZGVyXG4gICh7IG5hbWUsIHZlcnNpb24gfSA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3BhY2thZ2UuanNvbicpKSk7XG59IGNhdGNoIChlcnIpIHtcbiAgLy8gdGhlbiB0cnkgYXNzdW1pbmcgaXQgaXMgbm90XG4gICh7IG5hbWUsIHZlcnNpb24gfSA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3BhY2thZ2UuanNvbicpKSk7XG59XG5cbmNvbnN0IERFRkFVTFRfVVNCTVVYRF9TT0NLRVQgPSAnL3Zhci9ydW4vdXNibXV4ZCc7XG5jb25zdCBQUk9HX05BTUUgPSBuYW1lO1xuY29uc3QgQ0xJRU5UX1ZFUlNJT05fU1RSSU5HID0gYCR7bmFtZX0tJHt2ZXJzaW9ufWA7XG5cbmZ1bmN0aW9uIHN3YXAxNiAodmFsKSB7XG4gIHJldHVybiAoKHZhbCAmIDB4RkYpIDw8IDgpIHwgKCh2YWwgPj4gOCkgJiAweEZGKTtcbn1cblxuLyoqXG4gKiBDb25uZWN0cyBhIHNvY2tldCB0byB1c2JtdXhkIHNlcnZpY2VcbiAqXG4gKiBAcGFyYW0gez9zdHJpbmd9IHNvY2tldFBhdGggWy92YXIvcnVuL3VzYm11eGRdIFRoZSBmdWxsIHBhdGggdG8gdGhlIHVzYm11eGQgVW5peCBzb2NrZXRcbiAqIEBwYXJhbSB7P251bWJlcn0gdGltZW91dCBbNTAwMF0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbFxuICogdGhlIHNvY2tldCBpcyBjb25uZWN0ZWRcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgYWNjZXNzaW5nIHRoZSBzb2NrZXQgb3JcbiAqIGEgY29ubmVjdGlvbiBlcnJvciBoYXBwZW5lZFxuICogQHRocm93cyB7Qi5UaW1lb3V0RXJyb3J9IGlmIGNvbm5lY3Rpb24gdGltZW91dCBoYXBwZW5lZFxuICogQHJldHVybnMge25ldC5Tb2NrZXR9IENvbm5lY3RlZCBzb2NrZXQgaW5zdGFuY2VcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0RGVmYXVsdFNvY2tldCAoc29ja2V0UGF0aCA9IERFRkFVTFRfVVNCTVVYRF9TT0NLRVQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHNvY2tldFBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgdXNibXV4ZCBzb2NrZXQgYXQgJyR7c29ja2V0UGF0aH0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IHNvY2tldCA9IG5ldC5jcmVhdGVDb25uZWN0aW9uKHNvY2tldFBhdGgpO1xuICAgIHNvY2tldC5vbmNlKCdlcnJvcicsIHJlamVjdCk7XG4gICAgc29ja2V0Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiByZXNvbHZlKHNvY2tldCkpO1xuICB9KS50aW1lb3V0KHRpbWVvdXQpO1xufVxuXG5cbmNsYXNzIFVzYm11eCBleHRlbmRzIEJhc2VTZXJ2aWNlU29ja2V0IHtcbiAgY29uc3RydWN0b3IgKHNvY2tldENsaWVudCkge1xuICAgIHN1cGVyKHNvY2tldENsaWVudCk7XG5cbiAgICB0aGlzLl9kZWNvZGVyID0gbmV3IFVzYm11eERlY29kZXIoKTtcbiAgICB0aGlzLl9zcGxpdHRlciA9IG5ldyBMZW5ndGhCYXNlZFNwbGl0dGVyKHtcbiAgICAgIHJlYWRhYmxlU3RyZWFtOiBzb2NrZXRDbGllbnQsXG4gICAgICBsaXR0bGVFbmRpYW46IHRydWUsXG4gICAgICBtYXhGcmFtZUxlbmd0aDogTUFYX0ZSQU1FX1NJWkUsXG4gICAgICBsZW5ndGhGaWVsZE9mZnNldDogMCxcbiAgICAgIGxlbmd0aEZpZWxkTGVuZ3RoOiA0LFxuICAgICAgbGVuZ3RoQWRqdXN0bWVudDogMCxcbiAgICB9KTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnQucGlwZSh0aGlzLl9zcGxpdHRlcikucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgVXNibXV4RW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXIucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICAgIHRoaXMuX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyh0aGlzLl9lbmNvZGVyKTtcblxuICAgIHRoaXMuX3RhZyA9IDA7XG4gICAgdGhpcy5fcmVzcG9uc2VDYWxsYmFja3MgPSB7fTtcbiAgICB0aGlzLl9kZWNvZGVyLm9uKCdkYXRhJywgdGhpcy5faGFuZGxlRGF0YS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIF9oYW5kbGVEYXRhIChkYXRhKSB7XG4gICAgY29uc3QgY2IgPSB0aGlzLl9yZXNwb25zZUNhbGxiYWNrc1tkYXRhLmhlYWRlci50YWddIHx8IF8ubm9vcDtcbiAgICBjYihkYXRhKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBCVUlEIG9mIHRoZSBob3N0IGNvbXB1dGVyIGZyb20gdXNibXV4ZFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAqL1xuICBhc3luYyByZWFkQlVJRCAodGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCB7dGFnLCByZWNlaXZlUHJvbWlzZX0gPSB0aGlzLl9yZWNlaXZlUGxpc3RQcm9taXNlKHRpbWVvdXQsIChkYXRhKSA9PiB7XG4gICAgICBpZiAoZGF0YS5wYXlsb2FkLkJVSUQpIHtcbiAgICAgICAgcmV0dXJuIGRhdGEucGF5bG9hZC5CVUlEO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9zZW5kUGxpc3Qoe1xuICAgICAgdGFnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBNZXNzYWdlVHlwZTogJ1JlYWRCVUlEJyxcbiAgICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgICAgQ2xpZW50VmVyc2lvblN0cmluZzogQ0xJRU5UX1ZFUlNJT05fU1RSSU5HXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXdhaXQgcmVjZWl2ZVByb21pc2U7XG4gIH1cblxuICAvKipcbiAgICogUmVhZHMgdGhlIHBhaXIgcmVjb3JkIG9mIGEgZGV2aWNlLiBJdCB3aWxsIHJldHVybiBudWxsIGlmIGl0IGRvZXNuJ3QgZXhpc3RzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIHRoZSB1ZGlkIG9mIHRoZSBkZXZpY2VcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7P09iamVjdH1cbiAgICovXG4gIGFzeW5jIHJlYWRQYWlyUmVjb3JkICh1ZGlkLCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IHt0YWcsIHJlY2VpdmVQcm9taXNlfSA9IHRoaXMuX3JlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCwgKGRhdGEpID0+IHtcbiAgICAgIGlmICghZGF0YS5wYXlsb2FkLlBhaXJSZWNvcmREYXRhKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHBsaXN0LnBhcnNlUGxpc3QoZGF0YS5wYXlsb2FkLlBhaXJSZWNvcmREYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuX3NlbmRQbGlzdCh7XG4gICAgICB0YWcsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIE1lc3NhZ2VUeXBlOiAnUmVhZFBhaXJSZWNvcmQnLFxuICAgICAgICBQYWlyUmVjb3JkSUQ6IHVkaWQsXG4gICAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklOR1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgfVxuXG4gIF9zZW5kUGxpc3QgKGpzb24pIHtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGpzb24pO1xuICB9XG5cbiAgX3JlY2VpdmVQbGlzdFByb21pc2UgKHRpbWVvdXQgPSA1MDAwLCByZXNwb25zZUNhbGxiYWNrKSB7XG4gICAgY29uc3QgdGFnID0gdGhpcy5fdGFnKys7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLl9yZXNwb25zZUNhbGxiYWNrc1t0YWddID0gKGRhdGEpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlQ2FsbGJhY2soZGF0YSkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKGBGYWlsZWQgdG8gcmVjZWl2ZSBhbnkgZGF0YSB3aXRoaW4gdGhlIHRpbWVvdXQ6ICR7dGltZW91dH1gKSksIHRpbWVvdXQpO1xuICAgIH0pO1xuICAgIHJldHVybiB7dGFnLCByZWNlaXZlUHJvbWlzZX07XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgYWxsIGRldmljZXMgY29ubmVjdGVkIHRvIHRoZSBob3N0XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge0FycmF5fVxuICAgKi9cbiAgYXN5bmMgbGlzdERldmljZXMgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3Qge3RhZywgcmVjZWl2ZVByb21pc2V9ID0gdGhpcy5fcmVjZWl2ZVBsaXN0UHJvbWlzZSh0aW1lb3V0LCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEucGF5bG9hZC5EZXZpY2VMaXN0KSB7XG4gICAgICAgIHJldHVybiBkYXRhLnBheWxvYWQuRGV2aWNlTGlzdDtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5fc2VuZFBsaXN0KHtcbiAgICAgIHRhZyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgTWVzc2FnZVR5cGU6ICdMaXN0RGV2aWNlcycsXG4gICAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklOR1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICB9XG5cbiAgLyoqXG4gICAqIExvb2tzIGZvciBhIGRldmljZSB3aXRoIHRoZSBwYXNzZWQgdWRpZC4gSXQgd2lsbCByZXR1cm4gdW5kZWZpbmVkIGlmIHRoZSBkZXZpY2UgaXMgbm90IGZvdW5kXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIHRoZSB1ZGlkIG9mIHRoZSBkZXZpY2VcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7P09iamVjdH1cbiAgICovXG4gIGFzeW5jIGZpbmREZXZpY2UgKHVkaWQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGV2aWNlcyA9IGF3YWl0IHRoaXMubGlzdERldmljZXModGltZW91dCk7XG4gICAgcmV0dXJuIF8uZmluZChkZXZpY2VzLCAoZGV2aWNlKSA9PiBkZXZpY2UuUHJvcGVydGllcy5TZXJpYWxOdW1iZXIgPT09IHVkaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbm5lY3RzIHRvIHRoZSBsb2NrZG93bmQgb24gdGhlIGRldmljZSBhbmQgcmV0dXJucyBhIExvY2tkb3duIGNsaWVudFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdWRpZCB0aGUgdWRpZCBvZiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge0xvY2tkb3dufVxuICAgKi9cbiAgYXN5bmMgY29ubmVjdExvY2tkb3duICh1ZGlkLCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IGRldmljZSA9IGF3YWl0IHRoaXMuZmluZERldmljZSh1ZGlkLCB0aW1lb3V0KTtcbiAgICBpZiAoIWRldmljZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCB0aGUgZXhwZWN0ZWQgZGV2aWNlICcke3VkaWR9J2ApO1xuICAgIH1cbiAgICBjb25zdCBzb2NrZXQgPSBhd2FpdCB0aGlzLmNvbm5lY3QoZGV2aWNlLlByb3BlcnRpZXMuRGV2aWNlSUQsIExPQ0tET1dOX1BPUlQsIHRpbWVvdXQpO1xuICAgIHJldHVybiBuZXcgTG9ja2Rvd24obmV3IFBsaXN0U2VydmljZShzb2NrZXQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0cyB0byBhIGNlcnRhaW4gcG9ydCBvbiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkZXZpY2VJRCB0aGUgZGV2aWNlIGlkIHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcHJvcGVydGllcyBvZiBhIGRldmljZVxuICAgKiBAcGFyYW0ge251bWJlcn0gcG9ydCB0aGUgcG9ydCBudW1iZXIgdGhhdCB3YW50cyB0byBiZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7bmV0LlNvY2tldHxPYmplY3R9IFRoZSBzb2NrZXQgb3IgdGhlIG9iamVjdCByZXR1cm5lZCBpbiB0aGUgY2FsbGJhY2sgaWYgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGV4aXN0c1xuICAgKi9cbiAgYXN5bmMgY29ubmVjdCAoZGV2aWNlSUQsIHBvcnQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3Qge3RhZywgcmVjZWl2ZVByb21pc2V9ID0gdGhpcy5fcmVjZWl2ZVBsaXN0UHJvbWlzZSh0aW1lb3V0LCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEucGF5bG9hZC5NZXNzYWdlVHlwZSAhPT0gJ1Jlc3VsdCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS5wYXlsb2FkLk51bWJlciA9PT0gVVNCTVVYX1JFU1VMVC5PSykge1xuICAgICAgICB0aGlzLl9zcGxpdHRlci5zaHV0ZG93bigpO1xuICAgICAgICB0aGlzLl9zb2NrZXRDbGllbnQudW5waXBlKHRoaXMuX3NwbGl0dGVyKTtcbiAgICAgICAgdGhpcy5fc3BsaXR0ZXIudW5waXBlKHRoaXMuX2RlY29kZXIpO1xuICAgICAgICByZXR1cm4gdGhpcy5fc29ja2V0Q2xpZW50O1xuICAgICAgfSBlbHNlIGlmIChkYXRhLnBheWxvYWQuTnVtYmVyID09PSBVU0JNVVhfUkVTVUxULkNPTk5SRUZVU0VEKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiB3YXMgcmVmdXNlZCB0byBwb3J0ICR7cG9ydH1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5fc2VuZFBsaXN0KHtcbiAgICAgIHRhZyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgTWVzc2FnZVR5cGU6ICdDb25uZWN0JyxcbiAgICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgICAgQ2xpZW50VmVyc2lvblN0cmluZzogQ0xJRU5UX1ZFUlNJT05fU1RSSU5HLFxuICAgICAgICBEZXZpY2VJRDogZGV2aWNlSUQsXG4gICAgICAgIFBvcnROdW1iZXI6IHN3YXAxNihwb3J0KVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICB9XG59XG5cbmV4cG9ydCB7IFVzYm11eCwgZ2V0RGVmYXVsdFNvY2tldCB9O1xuZXhwb3J0IGRlZmF1bHQgVXNibXV4O1xuIl0sImZpbGUiOiJsaWIvdXNibXV4L2luZGV4LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
