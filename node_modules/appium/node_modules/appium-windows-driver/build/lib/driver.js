"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WindowsDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _winappdriver = require("./winappdriver");

var _logger = _interopRequireDefault(require("./logger"));

var _desiredCaps = require("./desired-caps");

var _index = _interopRequireDefault(require("./commands/index"));

const NO_PROXY = [['GET', new RegExp('^/session/[^/]+/appium')], ['POST', new RegExp('^/session/[^/]+/appium')], ['POST', new RegExp('^/session/[^/]+/element/[^/]+/elements?$')], ['POST', new RegExp('^/session/[^/]+/elements?$')]];

class WindowsDriver extends _appiumBaseDriver.BaseDriver {
  constructor(opts = {}, shouldValidateCaps = true) {
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.jwpProxyActive = false;
    this.jwpProxyAvoid = NO_PROXY;
    this.opts.address = opts.address || _winappdriver.DEFAULT_WAD_HOST;
    this.locatorStrategies = ['xpath', 'id', 'name', 'class name', 'accessibility id'];

    for (const [cmd, fn] of _lodash.default.toPairs(_index.default)) {
      WindowsDriver.prototype[cmd] = fn;
    }
  }

  async createSession(caps, reqCaps, curSessions) {
    if (!_appiumSupport.system.isWindows()) {
      throw new Error('WinAppDriver tests only run on Windows');
    }

    try {
      let sessionId;
      [sessionId] = await super.createSession(caps);
      await this.startWinAppDriverSession(curSessions);
      return [sessionId, caps];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  getNextAvailablePort(curSessions) {
    let newWADPort = _winappdriver.DEFAULT_WAD_PORT;

    while (_lodash.default.find(curSessions, o => o.WADPort === newWADPort)) {
      newWADPort++;
    }

    return newWADPort;
  }

  async startWinAppDriverSession(curSessions) {
    this.opts.port = this.getNextAvailablePort(curSessions);
    this.winAppDriver = new _winappdriver.WinAppDriver({
      app: this.opts.app,
      port: this.opts.port
    });
    await this.winAppDriver.start();
    await this.winAppDriver.startSession(this.caps);
    this.proxyReqRes = this.winAppDriver.proxyReqRes.bind(this.winAppDriver);
    this.jwpProxyActive = true;
  }

  async deleteSession() {
    _logger.default.debug('Deleting WinAppDriver session');

    if (this._screenRecorder) {
      await this._screenRecorder.stop(true);
      this._screenRecorder = null;
    }

    if (this.winAppDriver && this.jwpProxyActive) {
      await this.winAppDriver.deleteSession();
      await this.winAppDriver.stop();
      this.winAppDriver = null;
    }

    this.jwpProxyActive = false;
    await super.deleteSession();
  }

  proxyActive() {
    return true;
  }

  canProxy() {
    return true;
  }

  getProxyAvoidList() {
    return this.jwpProxyAvoid;
  }

  get driverData() {
    return {
      WADPort: this.opts.port
    };
  }

}

exports.WindowsDriver = WindowsDriver;
var _default = WindowsDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiTk9fUFJPWFkiLCJSZWdFeHAiLCJXaW5kb3dzRHJpdmVyIiwiQmFzZURyaXZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInNob3VsZFZhbGlkYXRlQ2FwcyIsImRlc2lyZWRDYXBDb25zdHJhaW50cyIsImp3cFByb3h5QWN0aXZlIiwiandwUHJveHlBdm9pZCIsImFkZHJlc3MiLCJERUZBVUxUX1dBRF9IT1NUIiwibG9jYXRvclN0cmF0ZWdpZXMiLCJjbWQiLCJmbiIsIl8iLCJ0b1BhaXJzIiwiY29tbWFuZHMiLCJwcm90b3R5cGUiLCJjcmVhdGVTZXNzaW9uIiwiY2FwcyIsInJlcUNhcHMiLCJjdXJTZXNzaW9ucyIsInN5c3RlbSIsImlzV2luZG93cyIsIkVycm9yIiwic2Vzc2lvbklkIiwic3RhcnRXaW5BcHBEcml2ZXJTZXNzaW9uIiwiZSIsImRlbGV0ZVNlc3Npb24iLCJnZXROZXh0QXZhaWxhYmxlUG9ydCIsIm5ld1dBRFBvcnQiLCJERUZBVUxUX1dBRF9QT1JUIiwiZmluZCIsIm8iLCJXQURQb3J0IiwicG9ydCIsIndpbkFwcERyaXZlciIsIldpbkFwcERyaXZlciIsImFwcCIsInN0YXJ0Iiwic3RhcnRTZXNzaW9uIiwicHJveHlSZXFSZXMiLCJiaW5kIiwibG9nZ2VyIiwiZGVidWciLCJfc2NyZWVuUmVjb3JkZXIiLCJzdG9wIiwicHJveHlBY3RpdmUiLCJjYW5Qcm94eSIsImdldFByb3h5QXZvaWRMaXN0IiwiZHJpdmVyRGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsQ0FDZixDQUFDLEtBQUQsRUFBUSxJQUFJQyxNQUFKLENBQVcsd0JBQVgsQ0FBUixDQURlLEVBRWYsQ0FBQyxNQUFELEVBQVMsSUFBSUEsTUFBSixDQUFXLHdCQUFYLENBQVQsQ0FGZSxFQUdmLENBQUMsTUFBRCxF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QUEwQixJQUExQixDQUFOO0FBQ0EsV0FBS0QsZUFBTCxHQUF1QixJQUF2QjtBQUNEOztBQUVELFFBQUksS0FBS1QsWUFBTCxJQUFxQixLQUFLN0IsY0FBOUIsRUFBOEM7QUFDNUMsWUFBTSxLQUFLNkIsWUFBTCxDQUFrQlIsYUFBbEIsRUFBTjtBQUNBLFlBQU0sS0FBS1EsWUFBTCxDQUFrQlUsSUFBbEIsRUFBTjtBQUNBLFdBQUtWLFlBQUwsR0FBb0IsSUFBcEI7QUFDRDs7QUFDRCxTQUFLN0IsY0FBTCxHQUFzQixLQUF0QjtBQUNBLFVBQU0sTUFBTXFCLGFBQU4sRUFBTjtBQUNEOztBQUVEbUIsRUFBQUEsV0FBVyxHQUFJO0FBRWIsV0FBTyxJQUFQO0FBQ0Q7O0FBRURDLEVBQUFBLFFBQVEsR0FBSTtBQUVWLFdBQU8sSUFBUDtBQUNEOztBQUVEQyxFQUFBQSxpQkFBaUIsR0FBaUI7QUFDaEMsV0FBTyxLQUFLekMsYUFBWjtBQUNEOztBQUVELE1BQUkwQyxVQUFKLEdBQWtCO0FBQ2hCLFdBQU87QUFBQ2hCLE1BQUFBLE9BQU8sRUFBRSxLQUFLOUIsSUFBTCxDQUFVK0I7QUFBcEIsS0FBUDtBQUNEOztBQWpHb0M7OztlQXFHeEJsQyxhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEJhc2VEcml2ZXIgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgc3lzdGVtIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgV2luQXBwRHJpdmVyLCBERUZBVUxUX1dBRF9IT1NULCBERUZBVUxUX1dBRF9QT1JUIH0gZnJvbSAnLi93aW5hcHBkcml2ZXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBkZXNpcmVkQ2FwQ29uc3RyYWludHMgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcy9pbmRleCc7XG5cbmNvbnN0IE5PX1BST1hZID0gW1xuICBbJ0dFVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9hcHBpdW0nKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9hcHBpdW0nKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9lbGVtZW50L1teL10rL2VsZW1lbnRzPyQnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9lbGVtZW50cz8kJyldLFxuXTtcblxuLy8gQXBwaXVtIGluc3RhbnRpYXRlcyB0aGlzIGNsYXNzXG5jbGFzcyBXaW5kb3dzRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgICBzdXBlcihvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpO1xuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMuandwUHJveHlBY3RpdmUgPSBmYWxzZTtcbiAgICB0aGlzLmp3cFByb3h5QXZvaWQgPSBOT19QUk9YWTtcbiAgICB0aGlzLm9wdHMuYWRkcmVzcyA9IG9wdHMuYWRkcmVzcyB8fCBERUZBVUxUX1dBRF9IT1NUO1xuXG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICd4cGF0aCcsXG4gICAgICAnaWQnLFxuICAgICAgJ25hbWUnLFxuICAgICAgJ2NsYXNzIG5hbWUnLFxuICAgICAgJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gICAgICBXaW5kb3dzRHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoY2FwcywgcmVxQ2FwcywgY3VyU2Vzc2lvbnMpIHtcblxuICAgIGlmICghc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dpbkFwcERyaXZlciB0ZXN0cyBvbmx5IHJ1biBvbiBXaW5kb3dzJyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBsZXQgc2Vzc2lvbklkO1xuICAgICAgW3Nlc3Npb25JZF0gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFdpbkFwcERyaXZlclNlc3Npb24oY3VyU2Vzc2lvbnMpO1xuICAgICAgcmV0dXJuIFtzZXNzaW9uSWQsIGNhcHNdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBnZXROZXh0QXZhaWxhYmxlUG9ydCAoY3VyU2Vzc2lvbnMpIHtcbiAgICBsZXQgbmV3V0FEUG9ydCA9IERFRkFVTFRfV0FEX1BPUlQ7XG5cbiAgICAvLyBzdGFydCBhdCA0NzI0IGFuZCBnbyB1cCB0aWxsIHdlIGZpbmQgYSBwb3J0IHRoYXQgaXNuJ3QgaW4gdXNlXG4gICAgd2hpbGUgKF8uZmluZChjdXJTZXNzaW9ucywgKG8pID0+IG8uV0FEUG9ydCA9PT0gbmV3V0FEUG9ydCkpIHtcbiAgICAgIG5ld1dBRFBvcnQrKztcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3V0FEUG9ydDtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0V2luQXBwRHJpdmVyU2Vzc2lvbiAoY3VyU2Vzc2lvbnMpIHtcblxuICAgIHRoaXMub3B0cy5wb3J0ID0gdGhpcy5nZXROZXh0QXZhaWxhYmxlUG9ydChjdXJTZXNzaW9ucyk7XG4gICAgdGhpcy53aW5BcHBEcml2ZXIgPSBuZXcgV2luQXBwRHJpdmVyKHtcbiAgICAgIGFwcDogdGhpcy5vcHRzLmFwcCxcbiAgICAgIHBvcnQ6IHRoaXMub3B0cy5wb3J0XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLndpbkFwcERyaXZlci5zdGFydCgpO1xuICAgIGF3YWl0IHRoaXMud2luQXBwRHJpdmVyLnN0YXJ0U2Vzc2lvbih0aGlzLmNhcHMpO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLndpbkFwcERyaXZlci5wcm94eVJlcVJlcy5iaW5kKHRoaXMud2luQXBwRHJpdmVyKTtcbiAgICAvLyBub3cgdGhhdCBldmVyeXRoaW5nIGhhcyBzdGFydGVkIHN1Y2Nlc3NmdWxseSwgdHVybiBvbiBwcm94eWluZyBzbyBhbGxcbiAgICAvLyBzdWJzZXF1ZW50IHNlc3Npb24gcmVxdWVzdHMgZ28gc3RyYWlnaHQgdG8vZnJvbSBXaW5BcHBEcml2ZXJcbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgV2luQXBwRHJpdmVyIHNlc3Npb24nKTtcblxuICAgIGlmICh0aGlzLl9zY3JlZW5SZWNvcmRlcikge1xuICAgICAgYXdhaXQgdGhpcy5fc2NyZWVuUmVjb3JkZXIuc3RvcCh0cnVlKTtcbiAgICAgIHRoaXMuX3NjcmVlblJlY29yZGVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy53aW5BcHBEcml2ZXIgJiYgdGhpcy5qd3BQcm94eUFjdGl2ZSkge1xuICAgICAgYXdhaXQgdGhpcy53aW5BcHBEcml2ZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgYXdhaXQgdGhpcy53aW5BcHBEcml2ZXIuc3RvcCgpO1xuICAgICAgdGhpcy53aW5BcHBEcml2ZXIgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgYXdhaXQgc3VwZXIuZGVsZXRlU2Vzc2lvbigpO1xuICB9XG5cbiAgcHJveHlBY3RpdmUgKCkge1xuICAgIC8vIHdlIGFsd2F5cyBoYXZlIGFuIGFjdGl2ZSBwcm94eSB0byB0aGUgV2luQXBwRHJpdmVyIHNlcnZlclxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY2FuUHJveHkgKCkge1xuICAgIC8vIHdlIGNhbiBhbHdheXMgcHJveHkgdG8gdGhlIFdpbkFwcERyaXZlciBzZXJ2ZXJcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGdldFByb3h5QXZvaWRMaXN0ICgvKnNlc3Npb25JZCovKSB7XG4gICAgcmV0dXJuIHRoaXMuandwUHJveHlBdm9pZDtcbiAgfVxuXG4gIGdldCBkcml2ZXJEYXRhICgpIHtcbiAgICByZXR1cm4ge1dBRFBvcnQ6IHRoaXMub3B0cy5wb3J0fTtcbiAgfVxufVxuXG5leHBvcnQgeyBXaW5kb3dzRHJpdmVyIH07XG5leHBvcnQgZGVmYXVsdCBXaW5kb3dzRHJpdmVyO1xuIl0sImZpbGUiOiJsaWIvZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
