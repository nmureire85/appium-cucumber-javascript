"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.REQ_A4M_APP_PATH = exports.A4M_APP_BUNDLE_ID = exports.DEFAULT_A4M_PORT = exports.DEFAULT_A4M_HOST = exports.AppiumForMac = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

const DEFAULT_A4M_HOST = '127.0.0.1';
exports.DEFAULT_A4M_HOST = DEFAULT_A4M_HOST;
const DEFAULT_A4M_PORT = 4622;
exports.DEFAULT_A4M_PORT = DEFAULT_A4M_PORT;
const REQ_A4M_APP_PATH = '/Applications/AppiumForMac.app';
exports.REQ_A4M_APP_PATH = REQ_A4M_APP_PATH;
const A4M_APP_BUNDLE_ID = 'com.appium.AppiumForMac';
exports.A4M_APP_BUNDLE_ID = A4M_APP_BUNDLE_ID;

const a4mLog = _appiumSupport.logger.getLogger('Appium4Mac');

class AppiumForMac {
  constructor(opts = {}) {
    this.proxyHost = opts.a4mHost;
    this.proxyPort = opts.a4mPort;
    this.a4mAppPath = opts.a4mAppPath;
    this.killAllA4MAppBeforeStart = opts.killAllA4MAppBeforeStart || true;
    this.proc = null;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  async start() {
    if (!(await _appiumSupport.fs.exists(this.a4mAppPath))) {
      throw new Error(`Could not verify AppiumForMacDriver install in '${this.a4mAppPath}'; please install it to '${this.a4mAppPath}'`);
    }

    const startDetector = (stdout, stderr) => {
      return stderr.indexOf('Started HTTP server') !== -1;
    };

    let processIsAlive = false;

    try {
      if (this.killAllA4MAppBeforeStart) {
        await this.killAll();
      }

      const a4mBinary = _path.default.resolve(this.a4mAppPath, 'Contents', 'MacOS', 'AppiumForMac');

      this.proc = new _teen_process.SubProcess(a4mBinary, []);
      processIsAlive = true;

      for (let stream of ['STDOUT', 'STDERR']) {
        this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
          for (let l of lines) {
            a4mLog.info(`[${stream}] ${l.trim()}`);
          }
        });
      }

      this.proc.on('exit', (code, signal) => {
        processIsAlive = false;
        let msg = `AppiumForMac exited unexpectedly with code ${code}, ` + `signal ${signal}`;

        _logger.default.error(msg);
      });

      _logger.default.info(`Spawning AppiumForMac with: ${this.a4mAppPath}`);

      await this.proc.start(startDetector);
      await this.waitForOnline();
    } catch (e) {
      this.emit(AppiumForMac.EVENT_ERROR, e);

      if (processIsAlive) {
        await this.proc.stop();
      }

      _logger.default.errorAndThrow(e);
    }
  }

  sessionId() {
    if (this.state !== AppiumForMac.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  async waitForOnline() {
    return true;
  }

  async getStatus() {
    return await this.sendCommand('/status', 'GET');
  }

  async startSession(caps) {
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    await this.sendCommand('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async stop() {
    try {
      if (this.proc) {
        await this.proc.stop();
      }
    } catch (e) {
      _logger.default.error(e);
    }
  }

  async sendCommand(url, method, body) {
    let res;

    try {
      res = await this.jwproxy.command(url, method, body);
    } catch (e) {
      if (e.message.indexOf('Did not get a valid response object') === -1 || e.message.indexOf('value') !== -1) {
        throw e;
      }
    }

    return res;
  }

  async proxyReq(req, res) {
    return await this.jwproxy.proxyReqRes(req, res);
  }

  async killAll() {
    const processName = 'AppiumForMac';

    _logger.default.info(`Killing any old AppiumForMac`);

    await _appiumSupport.process.killProcess(processName);

    _logger.default.info('Successfully cleaned up old Appium4Mac servers');
  }

  async deleteSession() {
    _logger.default.debug('Deleting AppiumForMac server session');

    try {
      await this.sendCommand('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation AppiumForMac deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

exports.AppiumForMac = AppiumForMac;
var _default = AppiumForMac;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hcHBpdW0tZm9yLW1hYy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX0E0TV9IT1NUIiwiREVGQVVMVF9BNE1fUE9SVCIsIlJFUV9BNE1fQVBQX1BBVEgiLCJBNE1fQVBQX0JVTkRMRV9JRCIsImE0bUxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkFwcGl1bUZvck1hYyIsImNvbnN0cnVjdG9yIiwib3B0cyIsInByb3h5SG9zdCIsImE0bUhvc3QiLCJwcm94eVBvcnQiLCJhNG1Qb3J0IiwiYTRtQXBwUGF0aCIsImtpbGxBbGxBNE1BcHBCZWZvcmVTdGFydCIsInByb2MiLCJqd3Byb3h5IiwiSldQcm94eSIsInNlcnZlciIsInBvcnQiLCJzdGFydCIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJzdGFydERldGVjdG9yIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5kZXhPZiIsInByb2Nlc3NJc0FsaXZlIiwia2lsbEFsbCIsImE0bUJpbmFyeSIsInBhdGgiLCJyZXNvbHZlIiwiU3ViUHJvY2VzcyIsInN0cmVhbSIsIm9uIiwidG9Mb3dlckNhc2UiLCJsaW5lcyIsImwiLCJpbmZvIiwidHJpbSIsImNvZGUiLCJzaWduYWwiLCJtc2ciLCJsb2ciLCJlcnJvciIsIndhaXRGb3JPbmxpbmUiLCJlIiwiZW1pdCIsIkVWRU5UX0VSUk9SIiwic3RvcCIsImVycm9yQW5kVGhyb3ciLCJzZXNzaW9uSWQiLCJzdGF0ZSIsIlNUQVRFX09OTElORSIsImdldFN0YXR1cyIsInNlbmRDb21tYW5kIiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsInByb3h5UmVxUmVzIiwiYmluZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwicmVzIiwiY29tbWFuZCIsIm1lc3NhZ2UiLCJwcm94eVJlcSIsInJlcSIsInByb2Nlc3NOYW1lIiwicHJvY2VzcyIsImtpbGxQcm9jZXNzIiwiZGVsZXRlU2Vzc2lvbiIsImRlYnVnIiwiZXJyIiwid2FybiJdLCJtYXBwaW5n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eyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcywgbG9nZ2VyLCBwcm9jZXNzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmNvbnN0IERFRkFVTFRfQTRNX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfQTRNX1BPUlQgPSA0NjIyO1xuXG5jb25zdCBSRVFfQTRNX0FQUF9QQVRIID0gJy9BcHBsaWNhdGlvbnMvQXBwaXVtRm9yTWFjLmFwcCc7XG5jb25zdCBBNE1fQVBQX0JVTkRMRV9JRCA9ICdjb20uYXBwaXVtLkFwcGl1bUZvck1hYyc7XG5cbmNvbnN0IGE0bUxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0FwcGl1bTRNYWMnKTtcblxuY2xhc3MgQXBwaXVtRm9yTWFjIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHRoaXMucHJveHlIb3N0ID0gb3B0cy5hNG1Ib3N0O1xuICAgIHRoaXMucHJveHlQb3J0ID0gb3B0cy5hNG1Qb3J0O1xuICAgIHRoaXMuYTRtQXBwUGF0aCA9IG9wdHMuYTRtQXBwUGF0aDtcbiAgICB0aGlzLmtpbGxBbGxBNE1BcHBCZWZvcmVTdGFydCA9IG9wdHMua2lsbEFsbEE0TUFwcEJlZm9yZVN0YXJ0IHx8IHRydWU7XG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLnByb3h5SG9zdCwgcG9ydDogdGhpcy5wcm94eVBvcnR9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh0aGlzLmE0bUFwcFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB2ZXJpZnkgQXBwaXVtRm9yTWFjRHJpdmVyIGluc3RhbGwgaW4gJyR7dGhpcy5hNG1BcHBQYXRofSc7IHBsZWFzZSBpbnN0YWxsIGl0IHRvICcke3RoaXMuYTRtQXBwUGF0aH0nYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnREZXRlY3RvciA9IChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgcmV0dXJuIHN0ZGVyci5pbmRleE9mKCdTdGFydGVkIEhUVFAgc2VydmVyJykgIT09IC0xO1xuICAgIH07XG5cbiAgICBsZXQgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMua2lsbEFsbEE0TUFwcEJlZm9yZVN0YXJ0KSB7XG4gICAgICAgIGF3YWl0IHRoaXMua2lsbEFsbCgpO1xuICAgICAgfVxuXG4gICAgICAvLyBzZXQgdXAgb3VyIHN1YnByb2Nlc3Mgb2JqZWN0XG4gICAgICBjb25zdCBhNG1CaW5hcnkgPSBwYXRoLnJlc29sdmUodGhpcy5hNG1BcHBQYXRoLCAnQ29udGVudHMnLCAnTWFjT1MnLCAnQXBwaXVtRm9yTWFjJyk7XG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhhNG1CaW5hcnksIFtdKTtcbiAgICAgIHByb2Nlc3NJc0FsaXZlID0gdHJ1ZTtcblxuICAgICAgLy8gaGFuZGxlIGxvZyBvdXRwdXRcbiAgICAgIGZvciAobGV0IHN0cmVhbSBvZiBbJ1NURE9VVCcsICdTVERFUlInXSkge1xuICAgICAgICB0aGlzLnByb2Mub24oYGxpbmVzLSR7c3RyZWFtLnRvTG93ZXJDYXNlKCl9YCwgKGxpbmVzKSA9PiB7XG4gICAgICAgICAgZm9yIChsZXQgbCBvZiBsaW5lcykge1xuICAgICAgICAgICAgYTRtTG9nLmluZm8oYFske3N0cmVhbX1dICR7bC50cmltKCl9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gaGFuZGxlIG91dC1vZi1ib3VuZCBleGl0IGJ5IHNpbXBseSBsb2dnaW5nXG4gICAgICAvLyBUT0RPIGFkZCBhYmlsaXR5IGZvciBkcml2ZXIgdG8gaGFuZGxlIHRoaXMgZ3JhY2VmdWxseSBhbmQgbWF5YmVcbiAgICAgIC8vIHJlc3RhcnRcbiAgICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICAgICAgbGV0IG1zZyA9IGBBcHBpdW1Gb3JNYWMgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXG4gICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgfSk7XG4gICAgICBsb2cuaW5mbyhgU3Bhd25pbmcgQXBwaXVtRm9yTWFjIHdpdGg6ICR7dGhpcy5hNG1BcHBQYXRofWApO1xuXG4gICAgICAvLyBzdGFydCBzdWJwcm9jIGFuZCB3YWl0IGZvciBzdGFydERldGVjdG9yXG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc3RhcnREZXRlY3Rvcik7XG5cbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvck9ubGluZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdChBcHBpdW1Gb3JNYWMuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIHdpbmFwcGRyaXZlciBwcm9jZXNzXG4gICAgICAvLyBmaW5pc2hlZDsgd2Ugc2hvdWxkIGNsZWFuIHVwIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKHByb2Nlc3NJc0FsaXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgICB9XG4gIH1cblxuICBzZXNzaW9uSWQgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBBcHBpdW1Gb3JNYWMuU1RBVEVfT05MSU5FKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5qd3Byb3h5LnNlc3Npb25JZDtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JPbmxpbmUgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICAvLyBUT0RPOiBBY3R1YWxseSBjaGVjayB2aWEgSFRUUFxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kQ29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICAgIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3IoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgbGV0IHJlcztcbiAgICAvLyBuZWVkIHRvIGNvdmVyIG92ZXIgQTRNJ3MgYmFkIGhhbmRsaW5nIG9mIHJlc3BvbnNlcywgd2hpY2ggc29tZXRpbWVzXG4gICAgLy8gZG9uJ3QgaGF2ZSAndmFsdWUnIHByb3BlcnRpZXNcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLm1lc3NhZ2UuaW5kZXhPZignRGlkIG5vdCBnZXQgYSB2YWxpZCByZXNwb25zZSBvYmplY3QnKSA9PT0gLTEgfHxcbiAgICAgICAgICBlLm1lc3NhZ2UuaW5kZXhPZigndmFsdWUnKSAhPT0gLTEpIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxIChyZXEsIHJlcykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMocmVxLCByZXMpO1xuICB9XG5cbiAgYXN5bmMga2lsbEFsbCAoKSB7XG4gICAgY29uc3QgcHJvY2Vzc05hbWUgPSAnQXBwaXVtRm9yTWFjJztcbiAgICAvLyBqcyBoaW50IGNhbm5vdCBoYW5kbGUgYmFja3RpY2tzLCBldmVuIGVzY2FwZWQsIHdpdGhpbiB0ZW1wbGF0ZSBsaXRlcmFsc1xuICAgIGxvZy5pbmZvKGBLaWxsaW5nIGFueSBvbGQgQXBwaXVtRm9yTWFjYCk7XG4gICAgYXdhaXQgcHJvY2Vzcy5raWxsUHJvY2Vzcyhwcm9jZXNzTmFtZSk7XG4gICAgbG9nLmluZm8oJ1N1Y2Nlc3NmdWxseSBjbGVhbmVkIHVwIG9sZCBBcHBpdW00TWFjIHNlcnZlcnMnKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgQXBwaXVtRm9yTWFjIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEFwcGl1bUZvck1hYyBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBBcHBpdW1Gb3JNYWMsIERFRkFVTFRfQTRNX0hPU1QsIERFRkFVTFRfQTRNX1BPUlQsXG4gIEE0TV9BUFBfQlVORExFX0lELCBSRVFfQTRNX0FQUF9QQVRIIH07XG5leHBvcnQgZGVmYXVsdCBBcHBpdW1Gb3JNYWM7XG4iXSwiZmlsZSI6ImxpYi9hcHBpdW0tZm9yLW1hYy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
