"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.MacDriver = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _appiumForMac = require("./appium-for-mac");

var _desiredCaps = _interopRequireDefault(require("./desired-caps"));

var _logger = _interopRequireDefault(require("./logger"));

var _index = _interopRequireDefault(require("./commands/index"));

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

const NO_PROXY_LIST = [['POST', new RegExp('^/session/[^/]+/execute')]];

class MacDriver extends _appiumBaseDriver.BaseDriver {
  constructor(opts = {}, shouldValidateCaps = true) {
    super(opts, shouldValidateCaps);
    this.jwpProxyActive = false;
    this.opts.address = opts.address || _appiumForMac.DEFAULT_A4M_HOST;
    this.desiredCapConstraints = _desiredCaps.default;

    for (const [cmd, fn] of _lodash.default.toPairs(_index.default)) {
      MacDriver.prototype[cmd] = fn;
    }
  }

  async createSession(...args) {
    if (!_appiumSupport.system.isMac()) {
      throw new Error('AppiumForMac tests only run on the Mac');
    }

    try {
      let [sessionId, caps] = await super.createSession(...args);
      await this.startAppiumForMacSession();

      if (caps.app) {
        _logger.default.info(`Automatically navigating to app '${caps.app}'`);

        await this.a4mDriver.sendCommand('/url', 'POST', {
          url: caps.app
        });
      }

      return [sessionId, caps];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  async startAppiumForMacSession() {
    let a4mAppPath = this.opts.a4mAppPath;

    if (!a4mAppPath) {
      _logger.default.debug(`The path to AppiumForMac server has not been provided explicitly. ` + `Trying to autodetect it`);

      a4mAppPath = await (0, _utils.findAppPath)(_appiumForMac.A4M_APP_BUNDLE_ID);

      if (a4mAppPath) {
        _logger.default.info(`Autodetected AppiumForMac server's location at '${a4mAppPath}'`);
      } else {
        a4mAppPath = _appiumForMac.REQ_A4M_APP_PATH;

        _logger.default.info(`Cannot autodetect AppiumForMac server's location. ` + `Using the default server path at '${a4mAppPath}'. Consider ` + `providing a custom path to 'a4mAppPath' capability if such behaviour ` + `is undesired`);
      }
    }

    this.opts.a4mAppPath = a4mAppPath;

    _lodash.default.defaults(this.opts, {
      a4mHost: _appiumForMac.DEFAULT_A4M_HOST,
      a4mPort: _appiumForMac.DEFAULT_A4M_PORT
    });

    this.a4mDriver = new _appiumForMac.AppiumForMac(this.opts);
    await this.a4mDriver.start();
    await this.a4mDriver.startSession(this.caps);
    this.proxyReqRes = this.a4mDriver.proxyReqRes.bind(this.a4mDriver);
    this.jwpProxyActive = true;
  }

  async deleteSession() {
    _logger.default.debug('Deleting AppiumForMac session');

    if (this.a4mDriver && this.jwpProxyActive) {
      await this.a4mDriver.deleteSession();
      await this.a4mDriver.stop();
      this.a4mDriver = null;
    }

    this.jwpProxyActive = false;
    await super.deleteSession();
  }

  proxyActive() {
    return true;
  }

  getProxyAvoidList() {
    return NO_PROXY_LIST;
  }

  canProxy() {
    return true;
  }

  get driverData() {
    return {
      A4MPort: this.opts.port
    };
  }

}

exports.MacDriver = MacDriver;
var _default = MacDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiTk9fUFJPWFlfTElTVCIsIlJlZ0V4cCIsIk1hY0RyaXZlciIsIkJhc2VEcml2ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJqd3BQcm94eUFjdGl2ZSIsImFkZHJlc3MiLCJERUZBVUxUX0E0TV9IT1NUIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwiY21kIiwiZm4iLCJfIiwidG9QYWlycyIsImNvbW1hbmRzIiwicHJvdG90eXBlIiwiY3JlYXRlU2Vzc2lvbiIsImFyZ3MiLCJzeXN0ZW0iLCJpc01hYyIsIkVycm9yIiwic2Vzc2lvbklkIiwiY2FwcyIsInN0YXJ0QXBwaXVtRm9yTWFjU2Vzc2lvbiIsImFwcCIsImxvZ2dlciIsImluZm8iLCJhNG1Ecml2ZXIiLCJzZW5kQ29tbWFuZCIsInVybCIsImUiLCJkZWxldGVTZXNzaW9uIiwiYTRtQXBwUGF0aCIsImRlYnVnIiwiQTRNX0FQUF9CVU5ETEVfSUQiLCJSRVFfQTRNX0FQUF9QQVRIIiwiZGVmYXVsdHMiLCJhNG1Ib3N0IiwiYTRtUG9ydCIsIkRFRkFVTFRfQTRNX1BPUlQiLCJBcHBpdW1Gb3JNYWMiLCJzdGFydCIsInN0YXJ0U2Vzc2lvbiIsInByb3h5UmVxUmVzIiwiYmluZCIsInN0b3AiLCJwcm94eUFjdGl2ZSIsImdldFByb3h5QXZvaWRMaXN0IiwiY2FuUHJveHkiLCJkcml2ZXJEYXRhIiwiQTRNUG9ydCIsInBvcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsYUFBYSxHQUFHLENBQ3BCLENBQUMsTUFBRCxFQUFTLElBQUlDLE1BQUosQ0FBVyx5QkFBWCxDQUFULENBRG9CLENBQXRCOztBQUtBLE1BQU1DLFNBQU4sU0FBd0JDLDRCQUF4QixDQUFtQztBQUNqQ0MsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhQyxrQkFBa0IsR0FBRyxJQUFsQyxFQUF3QztBQUNqRCxVQUFNRCxJQUFOLEVBQVlDLGtCQUFaO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQixLQUF0QjtBQUNBLFNBQUtGLElBQUwsQ0FBVUcsT0FBVixHQUFvQkgsSUFBSSxDQUFDRyxPQUFMLElBQWdCQyw4QkFBcEM7QUFFQSxTQUFLQyxxQkFBTCxHQUE2QkEsb0JBQTdCOztBQUVBLFNBQUssTUFBTSxDQUFDQyxHQUFELEVBQU1DLEVBQU4sQ0FBWCxJQUF3QkMsZ0JBQUVDLE9BQUYsQ0FBVUMsY0FBVixDQUF4QixFQUE2QztBQUMzQ2IsTUFBQUEsU0FBUyxDQUFDYyxTQUFWLENBQW9CTCxHQUFwQixJQUEyQkMsRUFBM0I7QUFDRDtBQUNGOztBQUVELFFBQU1LLGFBQU4sQ0FBcUIsR0FBR0MsSUFBeEIsRUFBOEI7QUFDNUIsUUFBSSxDQUFDQyxzQkFBT0MsS0FBUCxFQUFMLEVBQXFCO0FBQ25CLFlBQU0sSUFBSUMsS0FBSixDQUFVLHdDQUFWLENBQU47QUFDRDs7QUFDRCxRQUFJO0FBQ0YsVUFBSSxDQUFDQyxTQUFELEVBQVlDLElBQVosSUFBb0IsTUFBTSxNQUFNTixhQUFOLENBQW9CLEdBQUdDLElBQXZCLENBQTlCO0FBQ0EsWUFBTSxLQUFLTSx3QkFBTCxFQUFOOztBQUNBLFVBQUlELElBQUksQ0FBQ0UsR0FBVCxFQUFjO0FBQ1pDLHdCQUFPQyxJQUFQLENBQWEsb0NBQW1DSixJQUFJLENBQUNFLEdBQUksR0FBekQ7O0FBQ0EsY0FBTSxLQUFLRyxTQUFMLENBQWVDLFdBQWYsQ0FBMkIsTUFBM0IsRUFBbUMsTUFBbkMsRUFBMkM7QUFBQ0MsVUFBQUEsR0FBRyxFQUFFUCxJQUFJLENBQUNFO0FBQVgsU0FBM0MsQ0FBTjtBQUNEOztBQUNELGFBQU8sQ0FBQ0gsU0FBRCxFQUFZQyxJQUFaLENBQVA7QUFDRCxLQVJELENBUUUsT0FBT1EsQ0FBUCxFQUFVO0FBQ1YsWUFBTSxLQUFLQyxhQUFMLEVBQU47QUFDQSxZQUFNRCxDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNUCx3QkFBTixHQUFrQztBQUNoQyxRQUFJUyxVQUFVLEdBQUcsS0FBSzVCLElBQUwsQ0FBVTRCLFVBQTNCOztBQUNBLFFBQUksQ0FBQ0EsVUFBTCxFQUFpQjtBQUNmUCxzQkFBT1EsS0FBUCxDQUFjLG9FQUFELEdBQ1YseUJBREg7O0FBRUFELE1BQUFBLFVBQVUsR0FBRyxNQUFNLHdCQUFZRSwrQkFBWixDQUFuQjs7QUFDQSxVQUFJRixVQUFKLEVBQWdCO0FBQ2RQLHdCQUFPQyxJQUFQLENBQWEsbURBQWtETSxVQUFXLEdBQTFFO0FBQ0QsT0FGRCxNQUVPO0FBQ0xBLFFBQUFBLFVBQVUsR0FBR0csOEJBQWI7O0FBQ0FWLHdCQUFPQyxJQUFQLENBQWEsb0RBQUQsR0FDVCxxQ0FBb0NNLFVBQVcsY0FEdEMsR0FFVCx1RUFGUyxHQUdULGNBSEg7QUFJRDtBQUNGOztBQUNELFNBQUs1QixJQUFMLENBQVU0QixVQUFWLEdBQXVCQSxVQUF2Qjs7QUFDQXBCLG9CQUFFd0IsUUFBRixDQUFXLEtBQUtoQyxJQUFoQixFQUFzQjtBQUNwQmlDLE1BQUFBLE9BQU8sRUFBRTdCLDhCQURXO0FBRXBCOEIsTUFBQUEsT0FBTyxFQUFFQztBQUZXLEtBQXRCOztBQUlBLFNBQUtaLFNBQUwsR0FBaUIsSUFBSWEsMEJBQUosQ0FBaUIsS0FBS3BDLElBQXRCLENBQWpCO0FBRUEsVUFBTSxLQUFLdUIsU0FBTCxDQUFlYyxLQUFmLEVBQU47QUFDQSxVQUFNLEtBQUtkLFNBQUwsQ0FBZWUsWUFBZixDQUE0QixLQUFLcEIsSUFBakMsQ0FBTjtBQUNBLFNBQUtxQixXQUFMLEdBQW1CLEtBQUtoQixTQUFMLENBQWVnQixXQUFmLENBQTJCQyxJQUEzQixDQUFnQyxLQUFLakIsU0FBckMsQ0FBbkI7QUFHQSxTQUFLckIsY0FBTCxHQUFzQixJQUF0QjtBQUNEOztBQUVELFFBQU15QixhQUFOLEdBQXVCO0FBQ3JCTixvQkFBT1EsS0FBUCxDQUFhLCtCQUFiOztBQUVBLFFBQUksS0FBS04sU0FBTCxJQUFrQixLQUFLckIsY0FBM0IsRUFBMkM7QUFDekMsWUFBTSxLQUFLcUIsU0FBTCxDQUFlSSxhQUFmLEVBQU47QUFDQSxZQUFNLEtBQUtKLFNBQUwsQ0FBZWtCLElBQWYsRUFBTjtBQUNBLFdBQUtsQixTQUFMLEdBQWlCLElBQWpCO0FBQ0Q7O0FBQ0QsU0FBS3JCLGNBQUwsR0FBc0IsS0FBdEI7QUFDQSxVQUFNLE1BQU15QixhQUFOLEVBQU47QUFDRDs7QUFFRGUsRUFBQUEsV0FBVyxHQUFJO0FBRWIsV0FBTyxJQUFQO0FBQ0Q7O0FBRURDLEVBQUFBLGlCQUFpQixHQUFJO0FBQ25CLFdBQU9oRCxhQUFQO0FBQ0Q7O0FBRURpRCxFQUFBQSxRQUFRLEdBQUk7QUFFVixXQUFPLElBQVA7QUFDRDs7QUFFRCxNQUFJQyxVQUFKLEdBQWtCO0FBQ2hCLFdBQU87QUFBQ0MsTUFBQUEsT0FBTyxFQUFFLEtBQUs5QyxJQUFMLENBQVUrQztBQUFwQixLQUFQO0FBQ0Q7O0FBMUZnQzs7O2VBOEZwQmxELFMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlRHJpdmVyIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHN5c3RlbSB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7XG4gIEFwcGl1bUZvck1hYywgREVGQVVMVF9BNE1fSE9TVCwgQTRNX0FQUF9CVU5ETEVfSUQsXG4gIERFRkFVTFRfQTRNX1BPUlQsIFJFUV9BNE1fQVBQX1BBVEgsXG59IGZyb20gJy4vYXBwaXVtLWZvci1tYWMnO1xuaW1wb3J0IGRlc2lyZWRDYXBDb25zdHJhaW50cyBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBmaW5kQXBwUGF0aCB9IGZyb20gJy4vdXRpbHMnO1xuXG5cbmNvbnN0IE5PX1BST1hZX0xJU1QgPSBbXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9leGVjdXRlJyldLFxuXTtcblxuLy8gQXBwaXVtIGluc3RhbnRpYXRlcyB0aGlzIGNsYXNzXG5jbGFzcyBNYWNEcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICAgIHN1cGVyKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcyk7XG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IGZhbHNlO1xuICAgIHRoaXMub3B0cy5hZGRyZXNzID0gb3B0cy5hZGRyZXNzIHx8IERFRkFVTFRfQTRNX0hPU1Q7XG5cbiAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyA9IGRlc2lyZWRDYXBDb25zdHJhaW50cztcblxuICAgIGZvciAoY29uc3QgW2NtZCwgZm5dIG9mIF8udG9QYWlycyhjb21tYW5kcykpIHtcbiAgICAgIE1hY0RyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKC4uLmFyZ3MpIHtcbiAgICBpZiAoIXN5c3RlbS5pc01hYygpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FwcGl1bUZvck1hYyB0ZXN0cyBvbmx5IHJ1biBvbiB0aGUgTWFjJyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBsZXQgW3Nlc3Npb25JZCwgY2Fwc10gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKC4uLmFyZ3MpO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydEFwcGl1bUZvck1hY1Nlc3Npb24oKTtcbiAgICAgIGlmIChjYXBzLmFwcCkge1xuICAgICAgICBsb2dnZXIuaW5mbyhgQXV0b21hdGljYWxseSBuYXZpZ2F0aW5nIHRvIGFwcCAnJHtjYXBzLmFwcH0nYCk7XG4gICAgICAgIGF3YWl0IHRoaXMuYTRtRHJpdmVyLnNlbmRDb21tYW5kKCcvdXJsJywgJ1BPU1QnLCB7dXJsOiBjYXBzLmFwcH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtzZXNzaW9uSWQsIGNhcHNdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydEFwcGl1bUZvck1hY1Nlc3Npb24gKCkge1xuICAgIGxldCBhNG1BcHBQYXRoID0gdGhpcy5vcHRzLmE0bUFwcFBhdGg7XG4gICAgaWYgKCFhNG1BcHBQYXRoKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFRoZSBwYXRoIHRvIEFwcGl1bUZvck1hYyBzZXJ2ZXIgaGFzIG5vdCBiZWVuIHByb3ZpZGVkIGV4cGxpY2l0bHkuIGAgK1xuICAgICAgICBgVHJ5aW5nIHRvIGF1dG9kZXRlY3QgaXRgKTtcbiAgICAgIGE0bUFwcFBhdGggPSBhd2FpdCBmaW5kQXBwUGF0aChBNE1fQVBQX0JVTkRMRV9JRCk7XG4gICAgICBpZiAoYTRtQXBwUGF0aCkge1xuICAgICAgICBsb2dnZXIuaW5mbyhgQXV0b2RldGVjdGVkIEFwcGl1bUZvck1hYyBzZXJ2ZXIncyBsb2NhdGlvbiBhdCAnJHthNG1BcHBQYXRofSdgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGE0bUFwcFBhdGggPSBSRVFfQTRNX0FQUF9QQVRIO1xuICAgICAgICBsb2dnZXIuaW5mbyhgQ2Fubm90IGF1dG9kZXRlY3QgQXBwaXVtRm9yTWFjIHNlcnZlcidzIGxvY2F0aW9uLiBgICtcbiAgICAgICAgICBgVXNpbmcgdGhlIGRlZmF1bHQgc2VydmVyIHBhdGggYXQgJyR7YTRtQXBwUGF0aH0nLiBDb25zaWRlciBgICtcbiAgICAgICAgICBgcHJvdmlkaW5nIGEgY3VzdG9tIHBhdGggdG8gJ2E0bUFwcFBhdGgnIGNhcGFiaWxpdHkgaWYgc3VjaCBiZWhhdmlvdXIgYCArXG4gICAgICAgICAgYGlzIHVuZGVzaXJlZGApO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLm9wdHMuYTRtQXBwUGF0aCA9IGE0bUFwcFBhdGg7XG4gICAgXy5kZWZhdWx0cyh0aGlzLm9wdHMsIHtcbiAgICAgIGE0bUhvc3Q6IERFRkFVTFRfQTRNX0hPU1QsXG4gICAgICBhNG1Qb3J0OiBERUZBVUxUX0E0TV9QT1JULFxuICAgIH0pO1xuICAgIHRoaXMuYTRtRHJpdmVyID0gbmV3IEFwcGl1bUZvck1hYyh0aGlzLm9wdHMpO1xuXG4gICAgYXdhaXQgdGhpcy5hNG1Ecml2ZXIuc3RhcnQoKTtcbiAgICBhd2FpdCB0aGlzLmE0bURyaXZlci5zdGFydFNlc3Npb24odGhpcy5jYXBzKTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5hNG1Ecml2ZXIucHJveHlSZXFSZXMuYmluZCh0aGlzLmE0bURyaXZlcik7XG4gICAgLy8gbm93IHRoYXQgZXZlcnl0aGluZyBoYXMgc3RhcnRlZCBzdWNjZXNzZnVsbHksIHR1cm4gb24gcHJveHlpbmcgc28gYWxsXG4gICAgLy8gc3Vic2VxdWVudCBzZXNzaW9uIHJlcXVlc3RzIGdvIHN0cmFpZ2h0IHRvL2Zyb20gQXBwaXVtRm9yTWFjXG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IHRydWU7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIEFwcGl1bUZvck1hYyBzZXNzaW9uJyk7XG5cbiAgICBpZiAodGhpcy5hNG1Ecml2ZXIgJiYgdGhpcy5qd3BQcm94eUFjdGl2ZSkge1xuICAgICAgYXdhaXQgdGhpcy5hNG1Ecml2ZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgYXdhaXQgdGhpcy5hNG1Ecml2ZXIuc3RvcCgpO1xuICAgICAgdGhpcy5hNG1Ecml2ZXIgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgYXdhaXQgc3VwZXIuZGVsZXRlU2Vzc2lvbigpO1xuICB9XG5cbiAgcHJveHlBY3RpdmUgKCkge1xuICAgIC8vIHdlIGFsd2F5cyBoYXZlIGFuIGFjdGl2ZSBwcm94eSB0byB0aGUgQXBwaXVtRm9yTWFjIHNlcnZlclxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZ2V0UHJveHlBdm9pZExpc3QgKCkge1xuICAgIHJldHVybiBOT19QUk9YWV9MSVNUO1xuICB9XG5cbiAgY2FuUHJveHkgKCkge1xuICAgIC8vIHdlIGNhbiBhbHdheXMgcHJveHkgdG8gdGhlIEFwcGl1bUZvck1hYyBzZXJ2ZXJcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGdldCBkcml2ZXJEYXRhICgpIHtcbiAgICByZXR1cm4ge0E0TVBvcnQ6IHRoaXMub3B0cy5wb3J0fTtcbiAgfVxufVxuXG5leHBvcnQgeyBNYWNEcml2ZXIgfTtcbmV4cG9ydCBkZWZhdWx0IE1hY0RyaXZlcjtcbiJdLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
