"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.server = server;
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _constants = require("../constants");

var _events = require("events");

const KEEP_ALIVE_TIMEOUT_MS = 60 * 10 * 1000;

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _constants.DEFAULT_BASE_PATH
  } = opts;
  const app = (0, _express.default)();

  let httpServer = _http.default.createServer(app);

  const serverStateNotifier = new _events.EventEmitter();
  let isServerClosed = false;
  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => await new _bluebird.default((resolve, reject) => {
    isServerClosed = true;
    serverStateNotifier.emit('shutdown');
    httpServer.on('close', resolve);
    close(err => {
      if (err) reject(err);
    });
  });

  return await new _bluebird.default((resolve, reject) => {
    httpServer.on('error', err => {
      if (err.code === 'EADDRNOTAVAIL') {
        _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
      } else {
        _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
      }

      reject(err);
    });
    httpServer.on('connection', socket => {
      socket.setTimeout(KEEP_ALIVE_TIMEOUT_MS);
      socket.on('error', reject);

      function destroy() {
        if (socket._openReqCount === 0) {
          socket.destroy();
        }
      }

      socket._openReqCount = 0;
      socket.once('close', () => serverStateNotifier.removeListener('shutdown', destroy));
      serverStateNotifier.once('shutdown', destroy);
    });
    httpServer.on('request', function (req, res) {
      const socket = req.connection || req.socket;
      socket._openReqCount++;
      res.on('finish', function () {
        socket._openReqCount--;

        if (isServerClosed && socket._openReqCount === 0) {
          socket.destroy();
        }
      });
    });
    configureServer(app, routeConfiguringFunction, allowCors, basePath);
    let serverArgs = [port];

    if (hostname) {
      serverArgs.push(hostname);
    }

    httpServer.listen(...serverArgs, err => {
      if (err) {
        reject(err);
      }

      resolve(httpServer);
    });
    httpServer.keepAliveTimeout = KEEP_ALIVE_TIMEOUT_MS;
    httpServer.headersTimeout = KEEP_ALIVE_TIMEOUT_MS + 5 * 1000;
  });
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}

function configureServer(app, routeConfiguringFunction, allowCors = true, basePath = _constants.DEFAULT_BASE_PATH) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use(_middleware.handleIdempotency);
  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catch4XXHandler);
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  routeConfiguringFunction(app, basePath);
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
  app.use(_middleware.catch404Handler);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3NlcnZlci5qcyJdLCJuYW1lcyI6WyJLRUVQX0FMSVZFX1RJTUVPVVRfTVMiLCJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsImFwcCIsImh0dHBTZXJ2ZXIiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwic2VydmVyU3RhdGVOb3RpZmllciIsIkV2ZW50RW1pdHRlciIsImlzU2VydmVyQ2xvc2VkIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJyZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwiY2xvc2UiLCJiaW5kIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJlbWl0Iiwib24iLCJlcnIiLCJjb2RlIiwibG9nIiwiZXJyb3IiLCJzb2NrZXQiLCJzZXRUaW1lb3V0IiwiZGVzdHJveSIsIl9vcGVuUmVxQ291bnQiLCJvbmNlIiwicmVtb3ZlTGlzdGVuZXIiLCJyZXEiLCJyZXMiLCJjb25uZWN0aW9uIiwiY29uZmlndXJlU2VydmVyIiwic2VydmVyQXJncyIsInB1c2giLCJsaXN0ZW4iLCJrZWVwQWxpdmVUaW1lb3V0IiwiaGVhZGVyc1RpbWVvdXQiLCJub3JtYWxpemVCYXNlUGF0aCIsIl8iLCJpc1N0cmluZyIsIkVycm9yIiwicmVwbGFjZSIsInVzZSIsImVuZExvZ0Zvcm1hdHRlciIsInBhdGgiLCJTVEFUSUNfRElSIiwiZXhwcmVzcyIsInN0YXRpYyIsInByb2R1Y2VFcnJvciIsInByb2R1Y2VDcmFzaCIsImFsbG93Q3Jvc3NEb21haW4iLCJoYW5kbGVJZGVtcG90ZW5jeSIsImRlZmF1bHRUb0pTT05Db250ZW50VHlwZSIsImJvZHlQYXJzZXIiLCJ1cmxlbmNvZGVkIiwiZXh0ZW5kZWQiLCJjYXRjaDRYWEhhbmRsZXIiLCJjYXRjaEFsbEhhbmRsZXIiLCJqc29uIiwibGltaXQiLCJzdGFydExvZ0Zvcm1hdHRlciIsImFsbCIsIndlbGNvbWUiLCJndWluZWFQaWciLCJndWluZWFQaWdTY3JvbGxhYmxlIiwiZ3VpbmVhUGlnQXBwQmFubmVyIiwiY2F0Y2g0MDRIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEscUJBQXFCLEdBQUcsS0FBSyxFQUFMLEdBQVUsSUFBeEM7O0FBR0EsZUFBZUMsTUFBZixDQUF1QkMsSUFBSSxHQUFHLEVBQTlCLEVBQWtDO0FBQ2hDLFFBQU07QUFDSkMsSUFBQUEsd0JBREk7QUFFSkMsSUFBQUEsSUFGSTtBQUdKQyxJQUFBQSxRQUFRLEdBQUcsSUFIUDtBQUlKQyxJQUFBQSxTQUFTLEdBQUcsSUFKUjtBQUtKQyxJQUFBQSxRQUFRLEdBQUdDO0FBTFAsTUFNRk4sSUFOSjtBQVNBLFFBQU1PLEdBQUcsR0FBRyx1QkFBWjs7QUFDQSxNQUFJQyxVQUFVLEdBQUdDLGNBQUtDLFlBQUwsQ0FBa0JILEdBQWxCLENBQWpCOztBQUNBLFFBQU1JLG1CQUFtQixHQUFHLElBQUlDLG9CQUFKLEVBQTVCO0FBQ0EsTUFBSUMsY0FBYyxHQUFHLEtBQXJCO0FBQ0FMLEVBQUFBLFVBQVUsQ0FBQ00sbUJBQVgsR0FBaUNBLDhCQUFqQztBQUNBTixFQUFBQSxVQUFVLENBQUNPLHNCQUFYLEdBQW9DQSxpQ0FBcEM7QUFDQVAsRUFBQUEsVUFBVSxDQUFDUSwwQkFBWCxHQUF3Q0EscUNBQXhDO0FBQ0FSLEVBQUFBLFVBQVUsQ0FBQ1Msb0JBQVgsR0FBa0NBLCtCQUFsQztBQUlBLFFBQU1DLEtBQUssR0FBR1YsVUFBVSxDQUFDVSxLQUFYLENBQWlCQyxJQUFqQixDQUFzQlgsVUFBdEIsQ0FBZDs7QUFDQUEsRUFBQUEs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QUF2QztBQUNBaEUsRUFBQUEsR0FBRyxDQUFDNkQsR0FBSixDQUFRLDZCQUFSLEVBQXVDSSwwQkFBdkM7QUFHQWpFLEVBQUFBLEdBQUcsQ0FBQzBDLEdBQUosQ0FBUXdCLDJCQUFSO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IGZhdmljb24gZnJvbSAnc2VydmUtZmF2aWNvbic7XG5pbXBvcnQgYm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcic7XG5pbXBvcnQgbWV0aG9kT3ZlcnJpZGUgZnJvbSAnbWV0aG9kLW92ZXJyaWRlJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgc3RhcnRMb2dGb3JtYXR0ZXIsIGVuZExvZ0Zvcm1hdHRlciB9IGZyb20gJy4vZXhwcmVzcy1sb2dnaW5nJztcbmltcG9ydCB7XG4gIGFsbG93Q3Jvc3NEb21haW4sIGZpeFB5dGhvbkNvbnRlbnRUeXBlLCBkZWZhdWx0VG9KU09OQ29udGVudFR5cGUsXG4gIGNhdGNoQWxsSGFuZGxlciwgY2F0Y2g0MDRIYW5kbGVyLCBjYXRjaDRYWEhhbmRsZXIsXG4gIGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUsIGhhbmRsZUlkZW1wb3RlbmN5LFxufSBmcm9tICcuL21pZGRsZXdhcmUnO1xuaW1wb3J0IHsgZ3VpbmVhUGlnLCBndWluZWFQaWdTY3JvbGxhYmxlLCBndWluZWFQaWdBcHBCYW5uZXIsIHdlbGNvbWUsIFNUQVRJQ19ESVIgfSBmcm9tICcuL3N0YXRpYyc7XG5pbXBvcnQgeyBwcm9kdWNlRXJyb3IsIHByb2R1Y2VDcmFzaCB9IGZyb20gJy4vY3Jhc2gnO1xuaW1wb3J0IHtcbiAgYWRkV2ViU29ja2V0SGFuZGxlciwgcmVtb3ZlV2ViU29ja2V0SGFuZGxlciwgcmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnMsXG4gIGdldFdlYlNvY2tldEhhbmRsZXJzXG59IGZyb20gJy4vd2Vic29ja2V0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IERFRkFVTFRfQkFTRV9QQVRIIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5cblxuY29uc3QgS0VFUF9BTElWRV9USU1FT1VUX01TID0gNjAgKiAxMCAqIDEwMDA7IC8vIDEwIG1pbnV0ZXNcblxuXG5hc3luYyBmdW5jdGlvbiBzZXJ2ZXIgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uLFxuICAgIHBvcnQsXG4gICAgaG9zdG5hbWUgPSBudWxsLFxuICAgIGFsbG93Q29ycyA9IHRydWUsXG4gICAgYmFzZVBhdGggPSBERUZBVUxUX0JBU0VfUEFUSCxcbiAgfSA9IG9wdHM7XG5cbiAgLy8gY3JlYXRlIHRoZSBhY3R1YWwgaHR0cCBzZXJ2ZXJcbiAgY29uc3QgYXBwID0gZXhwcmVzcygpO1xuICBsZXQgaHR0cFNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XG4gIGNvbnN0IHNlcnZlclN0YXRlTm90aWZpZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIGxldCBpc1NlcnZlckNsb3NlZCA9IGZhbHNlO1xuICBodHRwU2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIgPSBhZGRXZWJTb2NrZXRIYW5kbGVyO1xuICBodHRwU2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIgPSByZW1vdmVXZWJTb2NrZXRIYW5kbGVyO1xuICBodHRwU2VydmVyLnJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzID0gcmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnM7XG4gIGh0dHBTZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMgPSBnZXRXZWJTb2NrZXRIYW5kbGVycztcblxuICAvLyBodHRwLlNlcnZlci5jbG9zZSgpIG9ubHkgc3RvcHMgbmV3IGNvbm5lY3Rpb25zLCBidXQgd2UgbmVlZCB0byB3YWl0IHVudGlsXG4gIC8vIGFsbCBjb25uZWN0aW9ucyBhcmUgY2xvc2VkIGFuZCB0aGUgYGNsb3NlYCBldmVudCBpcyBlbWl0dGVkXG4gIGNvbnN0IGNsb3NlID0gaHR0cFNlcnZlci5jbG9zZS5iaW5kKGh0dHBTZXJ2ZXIpO1xuICBodHRwU2VydmVyLmNsb3NlID0gYXN5bmMgKCkgPT4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS12MC54LWFyY2hpdmUvaXNzdWVzLzkwNjYjaXNzdWVjb21tZW50LTEyNDIxMDU3NlxuICAgIGlzU2VydmVyQ2xvc2VkID0gdHJ1ZTtcbiAgICBzZXJ2ZXJTdGF0ZU5vdGlmaWVyLmVtaXQoJ3NodXRkb3duJyk7XG4gICAgaHR0cFNlcnZlci5vbignY2xvc2UnLCByZXNvbHZlKTtcbiAgICBjbG9zZSgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGh0dHBTZXJ2ZXIub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgaWYgKGVyci5jb2RlID09PSAnRUFERFJOT1RBVkFJTCcpIHtcbiAgICAgICAgbG9nLmVycm9yKCdDb3VsZCBub3Qgc3RhcnQgUkVTVCBodHRwIGludGVyZmFjZSBsaXN0ZW5lci4gJyArXG4gICAgICAgICAgICAgICAgICAnUmVxdWVzdGVkIGFkZHJlc3MgaXMgbm90IGF2YWlsYWJsZS4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5lcnJvcignQ291bGQgbm90IHN0YXJ0IFJFU1QgaHR0cCBpbnRlcmZhY2UgbGlzdGVuZXIuIFRoZSByZXF1ZXN0ZWQgJyArXG4gICAgICAgICAgICAgICAgICAncG9ydCBtYXkgYWxyZWFkeSBiZSBpbiB1c2UuIFBsZWFzZSBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gJyArXG4gICAgICAgICAgICAgICAgICAnb3RoZXIgaW5zdGFuY2Ugb2YgdGhpcyBzZXJ2ZXIgcnVubmluZyBhbHJlYWR5LicpO1xuICAgICAgfVxuICAgICAgcmVqZWN0KGVycik7XG4gICAgfSk7XG4gICAgaHR0cFNlcnZlci5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICAgIHNvY2tldC5zZXRUaW1lb3V0KEtFRVBfQUxJVkVfVElNRU9VVF9NUyk7XG4gICAgICBzb2NrZXQub24oJ2Vycm9yJywgcmVqZWN0KTtcblxuICAgICAgZnVuY3Rpb24gZGVzdHJveSAoKSB7XG4gICAgICAgIGlmIChzb2NrZXQuX29wZW5SZXFDb3VudCA9PT0gMCkge1xuICAgICAgICAgIHNvY2tldC5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHNvY2tldC5fb3BlblJlcUNvdW50ID0gMDtcbiAgICAgIHNvY2tldC5vbmNlKCdjbG9zZScsICgpID0+IHNlcnZlclN0YXRlTm90aWZpZXIucmVtb3ZlTGlzdGVuZXIoJ3NodXRkb3duJywgZGVzdHJveSkpO1xuICAgICAgc2VydmVyU3RhdGVOb3RpZmllci5vbmNlKCdzaHV0ZG93bicsIGRlc3Ryb3kpO1xuICAgIH0pO1xuICAgIGh0dHBTZXJ2ZXIub24oJ3JlcXVlc3QnLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICAgIGNvbnN0IHNvY2tldCA9IHJlcS5jb25uZWN0aW9uIHx8IHJlcS5zb2NrZXQ7XG4gICAgICBzb2NrZXQuX29wZW5SZXFDb3VudCsrO1xuICAgICAgcmVzLm9uKCdmaW5pc2gnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNvY2tldC5fb3BlblJlcUNvdW50LS07XG4gICAgICAgIGlmIChpc1NlcnZlckNsb3NlZCAmJiBzb2NrZXQuX29wZW5SZXFDb3VudCA9PT0gMCkge1xuICAgICAgICAgIHNvY2tldC5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGNvbmZpZ3VyZVNlcnZlcihhcHAsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgYWxsb3dDb3JzLCBiYXNlUGF0aCk7XG5cbiAgICBsZXQgc2VydmVyQXJncyA9IFtwb3J0XTtcbiAgICBpZiAoaG9zdG5hbWUpIHtcbiAgICAgIC8vIElmIHRoZSBob3N0bmFtZSBpcyBvbWl0dGVkLCB0aGUgc2VydmVyIHdpbGwgYWNjZXB0XG4gICAgICAvLyBjb25uZWN0aW9ucyBvbiBhbnkgSVAgYWRkcmVzc1xuICAgICAgc2VydmVyQXJncy5wdXNoKGhvc3RuYW1lKTtcbiAgICB9XG4gICAgaHR0cFNlcnZlci5saXN0ZW4oLi4uc2VydmVyQXJncywgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIHJlc29sdmUoaHR0cFNlcnZlcik7XG4gICAgfSk7XG4gICAgaHR0cFNlcnZlci5rZWVwQWxpdmVUaW1lb3V0ID0gS0VFUF9BTElWRV9USU1FT1VUX01TO1xuICAgIC8vIGhlYWRlcnMgdGltZW91dCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBrZWVwQWxpdmVUaW1lb3V0XG4gICAgaHR0cFNlcnZlci5oZWFkZXJzVGltZW91dCA9IEtFRVBfQUxJVkVfVElNRU9VVF9NUyArIDUgKiAxMDAwO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQmFzZVBhdGggKGJhc2VQYXRoKSB7XG4gIGlmICghXy5pc1N0cmluZyhiYXNlUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBwcmVmaXggJHtiYXNlUGF0aH1gKTtcbiAgfVxuXG4gIC8vIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBub3QgZW5kIGluICcvJywgc2luY2Ugb3VyIG1ldGhvZCBtYXBcbiAgLy8gc3RhcnRzIGFsbCBwYXRocyB3aXRoICcvJ1xuICBiYXNlUGF0aCA9IGJhc2VQYXRoLnJlcGxhY2UoL1xcLyQvLCAnJyk7XG5cbiAgLy8gbGlrZXdpc2UsIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBhbHdheXMgU1RBUlQgd2l0aCAvLCB1bmxlc3MgdGhlIHBhdGhcbiAgLy8gaXMgZW1wdHkgbWVhbmluZyBubyBiYXNlIHBhdGggYXQgYWxsXG4gIGlmIChiYXNlUGF0aCAhPT0gJycgJiYgYmFzZVBhdGhbMF0gIT09ICcvJykge1xuICAgIGJhc2VQYXRoID0gYC8ke2Jhc2VQYXRofWA7XG4gIH1cblxuICByZXR1cm4gYmFzZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGNvbmZpZ3VyZVNlcnZlciAoYXBwLCByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIGFsbG93Q29ycyA9IHRydWUsIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgpIHtcbiAgYmFzZVBhdGggPSBub3JtYWxpemVCYXNlUGF0aChiYXNlUGF0aCk7XG5cbiAgYXBwLnVzZShlbmRMb2dGb3JtYXR0ZXIpO1xuXG4gIC8vIHNldCB1cCBzdGF0aWMgYXNzZXRzXG4gIGFwcC51c2UoZmF2aWNvbihwYXRoLnJlc29sdmUoU1RBVElDX0RJUiwgJ2Zhdmljb24uaWNvJykpKTtcbiAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhTVEFUSUNfRElSKSk7XG5cbiAgLy8gY3Jhc2ggcm91dGVzLCBmb3IgdGVzdGluZ1xuICBhcHAudXNlKGAke2Jhc2VQYXRofS9wcm9kdWNlX2Vycm9yYCwgcHJvZHVjZUVycm9yKTtcbiAgYXBwLnVzZShgJHtiYXNlUGF0aH0vY3Jhc2hgLCBwcm9kdWNlQ3Jhc2gpO1xuXG4gIC8vIGFkZCBtaWRkbGV3YXJlc1xuICBpZiAoYWxsb3dDb3JzKSB7XG4gICAgYXBwLnVzZShhbGxvd0Nyb3NzRG9tYWluKTtcbiAgfSBlbHNlIHtcbiAgICBhcHAudXNlKGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUoYmFzZVBhdGgpKTtcbiAgfVxuICBhcHAudXNlKGhhbmRsZUlkZW1wb3RlbmN5KTtcbiAgYXBwLnVzZShmaXhQeXRob25Db250ZW50VHlwZShiYXNlUGF0aCkpO1xuICBhcHAudXNlKGRlZmF1bHRUb0pTT05Db250ZW50VHlwZSk7XG4gIGFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZX0pKTtcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZSgpKTtcbiAgYXBwLnVzZShjYXRjaDRYWEhhbmRsZXIpO1xuICBhcHAudXNlKGNhdGNoQWxsSGFuZGxlcik7XG5cbiAgLy8gbWFrZSBzdXJlIGFwcGl1bSBuZXZlciBmYWlscyBiZWNhdXNlIG9mIGEgZmlsZSBzaXplIHVwbG9hZCBsaW1pdFxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7bGltaXQ6ICcxZ2InfSkpO1xuXG4gIC8vIHNldCB1cCBzdGFydCBsb2dnaW5nICh3aGljaCBkZXBlbmRzIG9uIGJvZHlQYXJzZXIgZG9pbmcgaXRzIHRoaW5nKVxuICBhcHAudXNlKHN0YXJ0TG9nRm9ybWF0dGVyKTtcblxuICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24oYXBwLCBiYXNlUGF0aCk7XG5cbiAgLy8gZHluYW1pYyByb3V0ZXMgZm9yIHRlc3RpbmcsIGV0Yy5cbiAgYXBwLmFsbCgnL3dlbGNvbWUnLCB3ZWxjb21lKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZycsIGd1aW5lYVBpZyk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWctc2Nyb2xsYWJsZScsIGd1aW5lYVBpZ1Njcm9sbGFibGUpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnLWFwcC1iYW5uZXInLCBndWluZWFQaWdBcHBCYW5uZXIpO1xuXG4gIC8vIGNhdGNoIHRoaXMgbGFzdCwgc28gYW55dGhpbmcgdGhhdCBmYWxscyB0aHJvdWdoIGlzIDQwNGVkXG4gIGFwcC51c2UoY2F0Y2g0MDRIYW5kbGVyKTtcbn1cblxuZXhwb3J0IHsgc2VydmVyLCBjb25maWd1cmVTZXJ2ZXIsIG5vcm1hbGl6ZUJhc2VQYXRoIH07XG4iXSwiZmlsZSI6ImxpYi9leHByZXNzL3NlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
