"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.RemoteMessages = void 0;

require("source-map-support/register");

var _remoteDebugger = require("./remote-debugger");

var _lodash = _interopRequireDefault(require("lodash"));

class RemoteMessages {
  constructor(isTargetBased = false) {
    this.isTargetBased = isTargetBased;
  }

  setCommunicationProtocol(isTargetBased) {
    this.isTargetBased = isTargetBased;
  }

  setConnectionKey(connId) {
    return {
      __argument: {
        WIRConnectionIdentifierKey: connId
      },
      __selector: '_rpc_reportIdentifier:'
    };
  }

  connectToApp(connId, appIdKey) {
    return {
      __argument: {
        WIRConnectionIdentifierKey: connId,
        WIRApplicationIdentifierKey: appIdKey
      },
      __selector: '_rpc_forwardGetListing:'
    };
  }

  setSenderKey(connId, senderId, appIdKey, pageIdKey) {
    return {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRPageIdentifierKey: pageIdKey,
        WIRAutomaticallyPause: false
      },
      __selector: '_rpc_forwardSocketSetup:'
    };
  }

  indicateWebView(connId, appIdKey, pageIdKey, opts) {
    const {
      enabled
    } = opts;
    return {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRIndicateEnabledKey: _lodash.default.isUndefined(enabled) ? true : enabled,
        WIRConnectionIdentifierKey: connId,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardIndicateWebView:'
    };
  }

  getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params) {
    const [realMethod, realParams] = this.isTargetBased ? ['Target.sendMessageToTarget', {
      message: {
        method,
        params
      }
    }] : [method, params];
    return this.command(realMethod, realParams, appIdKey, connId, senderId, pageIdKey, debuggerType);
  }

  sendJSCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, opts = {}) {
    const method = 'Runtime.evaluate';
    const params = {
      expression: opts.command,
      returnByValue: true
    };
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  callJSFunction(connId, senderId, appIdKey, pageIdKey, debuggerType, opts = {}) {
    const method = 'Runtime.callFunctionOn';
    const params = {
      objectId: opts.objId,
      functionDeclaration: opts.fn,
      arguments: opts.args,
      returnByValue: true
    };
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  setUrl(connId, senderId, appIdKey, pageIdKey, debuggerType, opts = {}) {
    const method = 'Page.navigate';
    const params = {
      url: opts.url
    };
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  enablePage(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Page.enable';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  startTimeline(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Timeline.start';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  stopTimeline(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Timeline.stop';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  startConsole(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Console.enable';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  stopConsole(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Console.disable';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  startNetwork(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Network.enable';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  stopNetwork(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Network.disable';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  getCookies(connId, senderId, appIdKey, pageIdKey, debuggerType, opts = {}) {
    const method = 'Page.getCookies';
    const params = {
      urls: opts.url
    };
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  deleteCookie(connId, senderId, appIdKey, pageIdKey, debuggerType, opts = {}) {
    const method = 'Page.deleteCookie';
    const params = {
      cookieName: opts.cookieName,
      url: opts.url
    };
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  garbageCollect(connId, senderId, appIdKey, pageIdKey, debuggerType) {
    const method = 'Heap.gc';
    const params = {};
    return this.getFullCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, method, params);
  }

  command(method, params, appIdKey, connId, senderId, pageIdKey, debuggerType) {
    if (debuggerType !== null && debuggerType === _remoteDebugger.DEBUGGER_TYPES.webkit) {
      return this.commandWebKit(method, params);
    } else {
      return this.commandWebInspector(method, params, appIdKey, connId, senderId, pageIdKey);
    }
  }

  commandWebInspector(method, params, appIdKey, connId, senderId, pageIdKey) {
    let plist = {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRSocketDataKey: {
          method,
          params: {
            objectGroup: 'console',
            includeCommandLineAPI: true,
            doNotPauseOnExceptionsAndMuteConsole: true
          }
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRPageIdentifierKey: pageIdKey,
        WIRAutomaticallyPause: true
      },
      __selector: '_rpc_forwardSocketData:'
    };

    if (params) {
      plist.__argument.WIRSocketDataKey.params = _lodash.default.extend(plist.__argument.WIRSocketDataKey.params, params);
    }

    return plist;
  }

  commandWebKit(method, params) {
    let jsonRequest = {
      method,
      params: {
        objectGroup: 'console',
        includeCommandLineAPI: true,
        doNotPauseOnExceptionsAndMuteConsole: true
      }
    };

    if (params) {
      jsonRequest.params = _lodash.default.extend(jsonRequest.params, params);
    }

    return jsonRequest;
  }

  getRemoteCommand(command, opts) {
    let cmd;
    const {
      connId,
      appIdKey,
      senderId,
      pageIdKey,
      debuggerType
    } = opts;

    switch (command) {
      case 'setConnectionKey':
        cmd = this.setConnectionKey(connId);
        break;

      case 'connectToApp':
        cmd = this.connectToApp(connId, appIdKey);
        break;

      case 'setSenderKey':
        cmd = this.setSenderKey(connId, senderId, appIdKey, pageIdKey);
        break;

      case 'indicateWebView':
        cmd = this.indicateWebView(connId, appIdKey, pageIdKey, opts);
        break;

      case 'sendJSCommand':
        cmd = this.sendJSCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, opts);
        break;

      case 'callJSFunction':
        cmd = this.callJSFunction(connId, senderId, appIdKey, pageIdKey, debuggerType, opts);
        break;

      case 'setUrl':
        cmd = this.setUrl(connId, senderId, appIdKey, pageIdKey, debuggerType, opts);
        break;

      case 'enablePage':
        cmd = this.enablePage(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'startTimeline':
        cmd = this.startTimeline(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'stopTimeline':
        cmd = this.stopTimeline(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'startConsole':
        cmd = this.startConsole(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'stopConsole':
        cmd = this.stopConsole(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'startNetwork':
        cmd = this.startNetwork(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'stopNetwork':
        cmd = this.stopNetwork(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      case 'getCookies':
        cmd = this.getCookies(connId, senderId, appIdKey, pageIdKey, debuggerType, opts);
        break;

      case 'deleteCookie':
        cmd = this.deleteCookie(connId, senderId, appIdKey, pageIdKey, debuggerType, opts);
        break;

      case 'garbageCollect':
        cmd = this.garbageCollect(connId, senderId, appIdKey, pageIdKey, debuggerType);
        break;

      default:
        throw new Error(`Unknown command: ${command}`);
    }

    return cmd;
  }

}

exports.RemoteMessages = RemoteMessages;
var _default = RemoteMessages;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtbWVzc2FnZXMuanMiXSwibmFtZXMiOlsiUmVtb3RlTWVzc2FnZXMiLCJjb25zdHJ1Y3RvciIsImlzVGFyZ2V0QmFzZWQiLCJzZXRDb21tdW5pY2F0aW9uUHJvdG9jb2wiLCJzZXRDb25uZWN0aW9uS2V5IiwiY29ubklkIiwiX19hcmd1bWVudCIsIldJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5IiwiX19zZWxlY3RvciIsImNvbm5lY3RUb0FwcCIsImFwcElkS2V5IiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5Iiwic2V0U2VuZGVyS2V5Iiwic2VuZGVySWQiLCJwYWdlSWRLZXkiLCJXSVJTZW5kZXJLZXkiLCJXSVJQYWdlSWRlbnRpZmllcktleSIsIldJUkF1dG9tYXRpY2FsbHlQYXVzZSIsImluZGljYXRlV2ViVmlldyIsIm9wdHMiLCJlbmFibGVkIiwiV0lSSW5kaWNhdGVFbmFibGVkS2V5IiwiXyIsImlzVW5kZWZpbmVkIiwiZ2V0RnVsbENvbW1hbmQiLCJkZWJ1Z2dlclR5cGUiLCJtZXRob2QiLCJwYXJhbXMiLCJyZWFsTWV0aG9kIiwicmVhbFBhcmFtcyIsIm1lc3NhZ2UiLCJjb21tYW5kIiwic2VuZEpTQ29tbWFuZCIsImV4cHJlc3Npb24iLCJyZXR1cm5CeVZhbHVlIiwiY2FsbEpTRnVuY3Rpb24iLCJvYmplY3RJZCIsIm9iaklkIiwiZnVuY3Rpb25EZWNsYXJhdGlvbiIsImZuIiwiYXJndW1lbnRzIiwiYXJncyIsInNldFVybCIsInVybCIsImVuYWJsZVBhZ2UiLCJzdGFydFRpbWVsaW5lIiwic3RvcFRpbWVsaW5lIiwic3RhcnRDb25zb2xlIiwic3RvcENvbnNvbGUiLCJzdGFydE5ldHdvcmsiLCJzdG9wTmV0d29yayIsImdldENvb2tpZXMiLCJ1cmxzIiwiZGVsZXRlQ29va2llIiwiY29va2llTmFtZSIsImdhcmJhZ2VDb2xsZWN0IiwiREVCVUdHRVJfVFlQRVMiLCJ3ZWJraXQiLCJjb21tYW5kV2ViS2l0IiwiY29tbWFuZFdlYkluc3BlY3RvciIsInBsaXN0IiwiV0lSU29ja2V0RGF0YUtleSIsIm9iamVjdEdyb3VwIiwiaW5jbHVkZUNvbW1hbmRMaW5lQVBJIiwiZG9Ob3RQYXVzZU9uRXhjZXB0aW9uc0FuZE11dGVDb25zb2xlIiwiZXh0ZW5kIiwianNvblJlcXVlc3QiLCJnZXRSZW1vdGVDb21tYW5kIiwiY21kIiwiRXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBR0EsTUFBTUEsY0FBTixDQUFxQjtBQUNuQkMsRUFBQUEsV0FBVyxDQUFFQyxhQUFhLEdBQUcsS0FBbEIsRUFBeUI7QUFDbEMsU0FBS0EsYUFBTCxHQUFxQkEsYUFBckI7QUFDRDs7QUFFREMsRUFBQUEsd0JBQXdCLENBQUVELGFBQUYsRUFBaUI7QUFDdkMsU0FBS0EsYUFBTCxHQUFxQkEsYUFBckI7QUFDRDs7QUFNREUsRUFBQUEsZ0JBQWdCLENBQUVDLE1BQUYsRUFBVTtBQUN4QixXQUFPO0FBQ0xDLE1BQUFBLFVBQVUsRUFBRTtBQUNWQyxRQUFBQSwwQkFBMEIsRUFBRUY7QUFEbEIsT0FEUDtBQUlMRyxNQUFBQSxVQUFVLEVBQUU7QUFKUCxLQUFQO0FBTUQ7O0FBRURDLEVBQUFBLFlBQVksQ0FBRUosTUFBRixFQUFVSyxRQUFWLEVBQW9CO0FBQzlCLFdBQU87QUFDTEosTUFBQUEsVUFBVSxFQUFFO0FBQ1ZDLFFBQUFBLDBCQUEwQixFQUFFRixNQURsQjtBQUVWTSxRQUFBQSwyQkFBMkIsRUFBRUQ7QUFGbkIsT0FEUDtBQUtMRixNQUFBQSxVQUFVLEVBQUU7QUFMUCxLQUFQO0FBT0Q7O0FBRURJLEVBQUFBLFlBQVksQ0FBRVAsTUFBRixFQUFVUSxRQUFWLEVBQW9CSCxRQUFwQixFQUE4QkksU0FBOUIsRUFBeUM7QUFDbkQsV0FBTztBQUNMUixNQUFBQSxVQUFVLEVBQUU7QUFDVkssUUFBQUEsMkJBQTJCLEVBQUVELFFBRG5CO0FBRVZILFFBQUFBLDBCQUEwQixFQUFFRixNQUZsQjtBQUdWVSxRQUFBQSxZQUFZLEVB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LFlBQXhELENBQU47QUFDQTs7QUFDRixXQUFLLFlBQUw7QUFDRTJDLFFBQUFBLEdBQUcsR0FBRyxLQUFLakIsVUFBTCxDQUFnQjlDLE1BQWhCLEVBQXdCUSxRQUF4QixFQUFrQ0gsUUFBbEMsRUFBNENJLFNBQTVDLEVBQXVEVyxZQUF2RCxFQUFxRU4sSUFBckUsQ0FBTjtBQUNBOztBQUNGLFdBQUssY0FBTDtBQUNFaUQsUUFBQUEsR0FBRyxHQUFHLEtBQUtmLFlBQUwsQ0FBa0JoRCxNQUFsQixFQUEwQlEsUUFBMUIsRUFBb0NILFFBQXBDLEVBQThDSSxTQUE5QyxFQUF5RFcsWUFBekQsRUFBdUVOLElBQXZFLENBQU47QUFDQTs7QUFDRixXQUFLLGdCQUFMO0FBQ0VpRCxRQUFBQSxHQUFHLEdBQUcsS0FBS2IsY0FBTCxDQUFvQmxELE1BQXBCLEVBQTRCUSxRQUE1QixFQUFzQ0gsUUFBdEMsRUFBZ0RJLFNBQWhELEVBQTJEVyxZQUEzRCxDQUFOO0FBQ0E7O0FBQ0Y7QUFDRSxjQUFNLElBQUk0QyxLQUFKLENBQVcsb0JBQW1CdEMsT0FBUSxFQUF0QyxDQUFOO0FBckRKOztBQXdEQSxXQUFPcUMsR0FBUDtBQUNEOztBQWpTa0I7OztlQXFTTnBFLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBERUJVR0dFUl9UWVBFUyB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuY2xhc3MgUmVtb3RlTWVzc2FnZXMge1xuICBjb25zdHJ1Y3RvciAoaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5pc1RhcmdldEJhc2VkID0gaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIHNldENvbW11bmljYXRpb25Qcm90b2NvbCAoaXNUYXJnZXRCYXNlZCkge1xuICAgIHRoaXMuaXNUYXJnZXRCYXNlZCA9IGlzVGFyZ2V0QmFzZWQ7XG4gIH1cblxuICAvKlxuICAgKiBDb25uZWN0aW9uIGZ1bmN0aW9uc1xuICAgKi9cblxuICBzZXRDb25uZWN0aW9uS2V5IChjb25uSWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleTogY29ubklkXG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfcmVwb3J0SWRlbnRpZmllcjonXG4gICAgfTtcbiAgfVxuXG4gIGNvbm5lY3RUb0FwcCAoY29ubklkLCBhcHBJZEtleSkge1xuICAgIHJldHVybiB7XG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXlcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonXG4gICAgfTtcbiAgfVxuXG4gIHNldFNlbmRlcktleSAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSkge1xuICAgIHJldHVybiB7XG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXksXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlNlbmRlcktleTogc2VuZGVySWQsXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXksXG4gICAgICAgIFdJUkF1dG9tYXRpY2FsbHlQYXVzZTogZmFsc2VcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkU29ja2V0U2V0dXA6J1xuICAgIH07XG4gIH1cblxuICBpbmRpY2F0ZVdlYlZpZXcgKGNvbm5JZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgb3B0cykge1xuICAgIGNvbnN0IHtlbmFibGVkfSA9IG9wdHM7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSSW5kaWNhdGVFbmFibGVkS2V5OiBfLmlzVW5kZWZpbmVkKGVuYWJsZWQpID8gdHJ1ZSA6IGVuYWJsZWQsXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXlcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkSW5kaWNhdGVXZWJWaWV3OidcbiAgICB9O1xuICB9XG5cblxuXG4gIC8qXG4gICAqIEFjdGlvbiBmdW5jdGlvbnNcbiAgICovXG5cbiAgZ2V0RnVsbENvbW1hbmQgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSwgbWV0aG9kLCBwYXJhbXMpIHtcbiAgICBjb25zdCBbcmVhbE1ldGhvZCwgcmVhbFBhcmFtc10gPSB0aGlzLmlzVGFyZ2V0QmFzZWRcbiAgICAgID8gWydUYXJnZXQuc2VuZE1lc3NhZ2VUb1RhcmdldCcsIHttZXNzYWdlOiB7bWV0aG9kLCBwYXJhbXN9fV1cbiAgICAgIDogW21ldGhvZCwgcGFyYW1zXTtcbiAgICByZXR1cm4gdGhpcy5jb21tYW5kKHJlYWxNZXRob2QsIHJlYWxQYXJhbXMsIGFwcElkS2V5LCBjb25uSWQsIHNlbmRlcklkLCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG4gIH1cblxuICBzZW5kSlNDb21tYW5kIChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IG1ldGhvZCA9ICdSdW50aW1lLmV2YWx1YXRlJztcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBleHByZXNzaW9uOiBvcHRzLmNvbW1hbmQsXG4gICAgICByZXR1cm5CeVZhbHVlOiB0cnVlLFxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0RnVsbENvbW1hbmQoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBtZXRob2QsIHBhcmFtcyk7XG4gIH1cblxuICBjYWxsSlNGdW5jdGlvbiAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBvcHRzID0ge30pIHtcbiAgICBjb25zdCBtZXRob2QgPSAnUnVudGltZS5jYWxsRnVuY3Rpb25Pbic7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgb2JqZWN0SWQ6IG9wdHMub2JqSWQsXG4gICAgICBmdW5jdGlvbkRlY2xhcmF0aW9uOiBvcHRzLmZuLFxuICAgICAgYXJndW1lbnRzOiBvcHRzLmFyZ3MsXG4gICAgICByZXR1cm5CeVZhbHVlOiB0cnVlLFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIHNldFVybCAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBvcHRzID0ge30pIHtcbiAgICBjb25zdCBtZXRob2QgPSAnUGFnZS5uYXZpZ2F0ZSc7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgdXJsOiBvcHRzLnVybCxcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmdldEZ1bGxDb21tYW5kKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSwgbWV0aG9kLCBwYXJhbXMpO1xuICB9XG5cbiAgZW5hYmxlUGFnZSAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKSB7XG4gICAgY29uc3QgbWV0aG9kID0gJ1BhZ2UuZW5hYmxlJztcbiAgICBjb25zdCBwYXJhbXMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIHN0YXJ0VGltZWxpbmUgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSkge1xuICAgIGNvbnN0IG1ldGhvZCA9ICdUaW1lbGluZS5zdGFydCc7XG4gICAgY29uc3QgcGFyYW1zID0ge307XG4gICAgcmV0dXJuIHRoaXMuZ2V0RnVsbENvbW1hbmQoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBtZXRob2QsIHBhcmFtcyk7XG4gIH1cblxuICBzdG9wVGltZWxpbmUgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSkge1xuICAgIGNvbnN0IG1ldGhvZCA9ICdUaW1lbGluZS5zdG9wJztcbiAgICBjb25zdCBwYXJhbXMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIHN0YXJ0Q29uc29sZSAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKSB7XG4gICAgY29uc3QgbWV0aG9kID0gJ0NvbnNvbGUuZW5hYmxlJztcbiAgICBjb25zdCBwYXJhbXMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIHN0b3BDb25zb2xlIChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpIHtcbiAgICBjb25zdCBtZXRob2QgPSAnQ29uc29sZS5kaXNhYmxlJztcbiAgICBjb25zdCBwYXJhbXMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIHN0YXJ0TmV0d29yayAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKSB7XG4gICAgY29uc3QgbWV0aG9kID0gJ05ldHdvcmsuZW5hYmxlJztcbiAgICBjb25zdCBwYXJhbXMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIHN0b3BOZXR3b3JrIChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpIHtcbiAgICBjb25zdCBtZXRob2QgPSAnTmV0d29yay5kaXNhYmxlJztcbiAgICBjb25zdCBwYXJhbXMgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIGdldENvb2tpZXMgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSwgb3B0cyA9IHt9KSB7XG4gICAgY29uc3QgbWV0aG9kID0gJ1BhZ2UuZ2V0Q29va2llcyc7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgdXJsczogb3B0cy51cmwsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIGRlbGV0ZUNvb2tpZSAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBvcHRzID0ge30pIHtcbiAgICBjb25zdCBtZXRob2QgPSAnUGFnZS5kZWxldGVDb29raWUnO1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIGNvb2tpZU5hbWU6IG9wdHMuY29va2llTmFtZSxcbiAgICAgIHVybDogb3B0cy51cmwsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRGdWxsQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIGdhcmJhZ2VDb2xsZWN0IChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpIHtcbiAgICBjb25zdCBtZXRob2QgPSAnSGVhcC5nYyc7XG4gICAgY29uc3QgcGFyYW1zID0ge307XG4gICAgcmV0dXJuIHRoaXMuZ2V0RnVsbENvbW1hbmQoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBtZXRob2QsIHBhcmFtcyk7XG4gIH1cblxuXG4gIC8qXG4gICAqIEludGVybmFsIGZ1bmN0aW9uc1xuICAgKi9cblxuICBjb21tYW5kIChtZXRob2QsIHBhcmFtcywgYXBwSWRLZXksIGNvbm5JZCwgc2VuZGVySWQsIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKSB7XG4gICAgaWYgKGRlYnVnZ2VyVHlwZSAhPT0gbnVsbCAmJiBkZWJ1Z2dlclR5cGUgPT09IERFQlVHR0VSX1RZUEVTLndlYmtpdCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29tbWFuZFdlYktpdChtZXRob2QsIHBhcmFtcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRXZWJJbnNwZWN0b3IobWV0aG9kLCBwYXJhbXMsIGFwcElkS2V5LCBjb25uSWQsIHNlbmRlcklkLCBwYWdlSWRLZXkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbW1hbmRXZWJJbnNwZWN0b3IgKG1ldGhvZCwgcGFyYW1zLCBhcHBJZEtleSwgY29ubklkLCBzZW5kZXJJZCwgcGFnZUlkS2V5KSB7XG4gICAgbGV0IHBsaXN0ID0ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IGFwcElkS2V5LFxuICAgICAgICBXSVJTb2NrZXREYXRhS2V5OiB7XG4gICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgIHBhcmFtczoge1xuICAgICAgICAgICAgb2JqZWN0R3JvdXA6ICdjb25zb2xlJyxcbiAgICAgICAgICAgIGluY2x1ZGVDb21tYW5kTGluZUFQSTogdHJ1ZSxcbiAgICAgICAgICAgIGRvTm90UGF1c2VPbkV4Y2VwdGlvbnNBbmRNdXRlQ29uc29sZTogdHJ1ZSxcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlNlbmRlcktleTogc2VuZGVySWQsXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXksXG4gICAgICAgIFdJUkF1dG9tYXRpY2FsbHlQYXVzZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkU29ja2V0RGF0YTonXG4gICAgfTtcbiAgICBpZiAocGFyYW1zKSB7XG4gICAgICBwbGlzdC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zID1cbiAgICAgICAgXy5leHRlbmQocGxpc3QuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcywgcGFyYW1zKTtcbiAgICB9XG4gICAgcmV0dXJuIHBsaXN0O1xuICB9XG5cbiAgLy9nZW5lcmF0ZSBhIGpzb24gcmVxdWVzdCB1c2luZyB0aGUgd2Via2l0IHByb3RvY29sXG4gIGNvbW1hbmRXZWJLaXQgKG1ldGhvZCwgcGFyYW1zKSB7XG4gICAgbGV0IGpzb25SZXF1ZXN0ID0ge1xuICAgICAgbWV0aG9kLFxuICAgICAgcGFyYW1zOiB7XG4gICAgICAgIG9iamVjdEdyb3VwOiAnY29uc29sZScsXG4gICAgICAgIGluY2x1ZGVDb21tYW5kTGluZUFQSTogdHJ1ZSxcbiAgICAgICAgZG9Ob3RQYXVzZU9uRXhjZXB0aW9uc0FuZE11dGVDb25zb2xlOiB0cnVlXG4gICAgICB9XG4gICAgfTtcbiAgICBpZiAocGFyYW1zKSB7XG4gICAgICAvL2lmIHRoZXJlIGFueSBwYXJhbWV0ZXJzIGFkZCB0aGVtXG4gICAgICBqc29uUmVxdWVzdC5wYXJhbXMgPSBfLmV4dGVuZChqc29uUmVxdWVzdC5wYXJhbXMsIHBhcmFtcyk7XG4gICAgfVxuICAgIHJldHVybiBqc29uUmVxdWVzdDtcbiAgfVxuXG4gIGdldFJlbW90ZUNvbW1hbmQgKGNvbW1hbmQsIG9wdHMpIHtcbiAgICBsZXQgY21kO1xuXG4gICAgY29uc3Qge1xuICAgICAgY29ubklkLFxuICAgICAgYXBwSWRLZXksXG4gICAgICBzZW5kZXJJZCxcbiAgICAgIHBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZSxcbiAgICB9ID0gb3B0cztcblxuICAgIHN3aXRjaCAoY29tbWFuZCkge1xuICAgICAgY2FzZSAnc2V0Q29ubmVjdGlvbktleSc6XG4gICAgICAgIGNtZCA9IHRoaXMuc2V0Q29ubmVjdGlvbktleShjb25uSWQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2Nvbm5lY3RUb0FwcCc6XG4gICAgICAgIGNtZCA9IHRoaXMuY29ubmVjdFRvQXBwKGNvbm5JZCwgYXBwSWRLZXkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3NldFNlbmRlcktleSc6XG4gICAgICAgIGNtZCA9IHRoaXMuc2V0U2VuZGVyS2V5KGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2luZGljYXRlV2ViVmlldyc6XG4gICAgICAgIGNtZCA9IHRoaXMuaW5kaWNhdGVXZWJWaWV3KGNvbm5JZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgb3B0cyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc2VuZEpTQ29tbWFuZCc6XG4gICAgICAgIGNtZCA9IHRoaXMuc2VuZEpTQ29tbWFuZChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG9wdHMpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2NhbGxKU0Z1bmN0aW9uJzpcbiAgICAgICAgY21kID0gdGhpcy5jYWxsSlNGdW5jdGlvbihjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG9wdHMpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3NldFVybCc6XG4gICAgICAgIGNtZCA9IHRoaXMuc2V0VXJsKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSwgb3B0cyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZW5hYmxlUGFnZSc6XG4gICAgICAgIGNtZCA9IHRoaXMuZW5hYmxlUGFnZShjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3N0YXJ0VGltZWxpbmUnOlxuICAgICAgICBjbWQgPSB0aGlzLnN0YXJ0VGltZWxpbmUoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzdG9wVGltZWxpbmUnOlxuICAgICAgICBjbWQgPSB0aGlzLnN0b3BUaW1lbGluZShjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3N0YXJ0Q29uc29sZSc6XG4gICAgICAgIGNtZCA9IHRoaXMuc3RhcnRDb25zb2xlKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc3RvcENvbnNvbGUnOlxuICAgICAgICBjbWQgPSB0aGlzLnN0b3BDb25zb2xlKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc3RhcnROZXR3b3JrJzpcbiAgICAgICAgY21kID0gdGhpcy5zdGFydE5ldHdvcmsoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzdG9wTmV0d29yayc6XG4gICAgICAgIGNtZCA9IHRoaXMuc3RvcE5ldHdvcmsoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdnZXRDb29raWVzJzpcbiAgICAgICAgY21kID0gdGhpcy5nZXRDb29raWVzKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSwgb3B0cyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZGVsZXRlQ29va2llJzpcbiAgICAgICAgY21kID0gdGhpcy5kZWxldGVDb29raWUoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCBvcHRzKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdnYXJiYWdlQ29sbGVjdCc6XG4gICAgICAgIGNtZCA9IHRoaXMuZ2FyYmFnZUNvbGxlY3QoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gY29tbWFuZDogJHtjb21tYW5kfWApO1xuICAgIH1cblxuICAgIHJldHVybiBjbWQ7XG4gIH1cbn1cblxuZXhwb3J0IHsgUmVtb3RlTWVzc2FnZXMgfTtcbmV4cG9ydCBkZWZhdWx0IFJlbW90ZU1lc3NhZ2VzO1xuIl0sImZpbGUiOiJsaWIvcmVtb3RlLW1lc3NhZ2VzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
