"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllSimulators = killAllSimulators;
exports.endAllSimulatorDaemons = endAllSimulatorDaemons;
exports.safeRimRaf = safeRimRaf;
exports.simExists = simExists;
exports.getSimulatorInfo = getSimulatorInfo;
exports.installSSLCert = installSSLCert;
exports.uninstallSSLCert = uninstallSSLCert;
exports.hasSSLCert = hasSSLCert;
exports.execSQLiteQuery = execSQLiteQuery;
exports.toBiometricDomainComponent = toBiometricDomainComponent;
exports.getDeveloperRoot = getDeveloperRoot;
exports.activateApp = activateApp;
exports.MOBILE_SAFARI_BUNDLE_ID = exports.SAFARI_STARTUP_TIMEOUT = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _asyncbox = require("asyncbox");

var _appiumXcode = require("appium-xcode");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumSupport = require("appium-support");

var _certificate = require("./certificate");

var _path = _interopRequireDefault(require("path"));

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-6"));

var _fkill = _interopRequireDefault(require("fkill"));

const DEFAULT_SIM_SHUTDOWN_TIMEOUT = 30000;
const SAFARI_STARTUP_TIMEOUT = 25 * 1000;
exports.SAFARI_STARTUP_TIMEOUT = SAFARI_STARTUP_TIMEOUT;
const MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
exports.MOBILE_SAFARI_BUNDLE_ID = MOBILE_SAFARI_BUNDLE_ID;

const APP_ACTIVATION_SCRIPT = pid => `#!/usr/bin/python

from AppKit import NSApplicationActivateIgnoringOtherApps, NSApplicationActivateAllWindows
from Cocoa import NSRunningApplication

app = NSRunningApplication.runningApplicationWithProcessIdentifier_(${pid})
if not app:
    raise ValueError('App with PID ${pid} is not running')
if not app.activateWithOptions_(NSApplicationActivateAllWindows | NSApplicationActivateIgnoringOtherApps):
    raise ValueError('App with PID ${pid} cannot be activated')
`;

const BIOMETRICS = {
  touchId: 'fingerTouch',
  faceId: 'pearl'
};

function toBiometricDomainComponent(name) {
  if (!BIOMETRICS[name]) {
    throw new Error(`'${name}' is not a valid biometric. Use one of: ${JSON.stringify(_lodash.default.keys(BIOMETRICS))}`);
  }

  return BIOMETRICS[name];
}

async function pkill(appName, forceKill = false) {
  let args = forceKill ? ['-9'] : [];
  args.push('-x', appName);

  try {
    await (0, _teen_process.exec)('pkill', args);
    return 0;
  } catch (err) {
    if (!_lodash.default.isUndefined(err.code)) {
      throw new Error(`Cannot forcefully terminate ${appName}. pkill error code: ${err.code}`);
    }

    _logger.default.error(`Received unexpected error while trying to kill ${appName}: ${err.message}`);

    throw err;
  }
}

async function killAllSimulators(timeout = DEFAULT_SIM_SHUTDOWN_TIMEOUT) {
  _logger.default.debug('Killing all iOS Simulators');

  const xcodeVersion = await (0, _appiumXcode.getVersion)(true);
  const appName = xcodeVersion.major >= 7 ? 'Simulator' : 'iOS Simulator';
  timeout = timeout * (xcodeVersion.major >= 8 ? 2 : 1);

  try {
    await (0, _teen_process.exec)('xcrun', ['simctl', 'shutdown', xcodeVersion.major > 8 ? 'all' : 'booted'], {
      timeout
    });
  } catch (ign) {}

  const pids = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('pgrep', ['-f', `${appName}.app/Contents/MacOS/`]);

    if (stdout.trim()) {
      pids.push(...stdout.trim().split(/\s+/));
    }
  } catch (e) {
    if (e.code === 1) {
      _logger.default.debug(`${appName} is not running. Continuing...`);

      return;
    }

    if (_lodash.default.isEmpty(pids)) {
      _logger.default.warn(`pgrep error ${e.code} while detecting whether ${appName} is running. Trying to kill anyway.`);
    }
  }

  if (!_lodash.default.isEmpty(pids)) {
    _logger.default.debug(`Using fkill to kill processes: ${pids.join(', ')}`);

    try {
      await (0, _fkill.default)(pids, {
        force: true
      });
    } catch (ign) {}
  }

  _logger.default.debug(`Using pkill to kill application: ${appName}`);

  try {
    await pkill(appName, true);
  } catch (ign) {}

  let remainingDevices = [];

  async function allSimsAreDown() {
    remainingDevices = [];
    let devices = await new _nodeSimctl.default().getDevices();
    devices = _lodash.default.flatten(_lodash.default.values(devices));
    return _lodash.default.every(devices, sim => {
      let state = sim.state.toLowerCase();
      let done = state === 'shutdown' || state === 'unavailable' || state === 'disconnected';

      if (!done) {
        remainingDevices.push(`${sim.name} (${sim.sdk}, udid: ${sim.udid}) is still in state '${state}'`);
      }

      return done;
    });
  }

  try {
    await (0, _asyncbox.waitForCondition)(allSimsAreDown, {
      waitMs: timeout,
      intervalMs: 200
    });
  } catch (err) {
    if (remainingDevices.length > 0) {
      _logger.default.warn(`The following devices are still not in the correct state after ${timeout} ms:`);

      for (let device of remainingDevices) {
        _logger.default.warn(`    ${device}`);
      }
    }

    throw err;
  }
}

async function endAllSimulatorDaemons() {
  _logger.default.debug('Ending all simulator daemons');

  for (let servicePattern of ['com.apple.iphonesimulator', 'com.apple.CoreSimulator']) {
    _logger.default.debug(`Killing any other ${servicePattern} daemons`);

    let launchCtlCommand = `launchctl list | grep ${servicePattern} | cut -f 3 | xargs -n 1 launchctl`;

    try {
      let stopCmd = `${launchCtlCommand} stop`;
      await (0, _teen_process.exec)('bash', ['-c', stopCmd]);
    } catch (err) {
      _logger.default.warn(`Could not stop ${servicePattern} daemons, carrying on anyway!`);
    }

    try {
      let removeCmd = `${launchCtlCommand} remove`;
      await (0, _teen_process.exec)('bash', ['-c', removeCmd]);
    } catch (err) {
      _logger.default.warn(`Could not remove ${servicePattern} daemons, carrying on anyway!`);
    }
  }

  try {
    await (0, _asyncbox.waitForCondition)(async () => {
      let {
        stdout
      } = await (0, _teen_process.exec)('bash', ['-c', `ps -e  | grep launchd_sim | grep -v bash | grep -v grep | awk {'print$1'}`]);
      return stdout.trim().length === 0;
    }, {
      waitMs: 5000,
      intervalMs: 500
    });
  } catch (err) {
    _logger.default.warn(`Could not end all simulator daemons, carrying on!`);
  }

  _logger.default.debug('Finishing ending all simulator daemons');
}

async function getSimulatorInfo(udid) {
  let devices = await new _nodeSimctl.default().getDevices();
  devices = _lodash.default.toPairs(devices).map(pair => pair[1]).reduce((a, b) => a.concat(b), []);
  return _lodash.default.find(devices, sim => sim.udid === udid);
}

async function simExists(udid) {
  return !!(await getSimulatorInfo(udid));
}

async function safeRimRaf(delPath, tryNum = 0) {
  try {
    await _appiumSupport.fs.rimraf(delPath);
  } catch (err) {
    if (tryNum < 20) {
      if (err.message.indexOf('ENOTEMPTY') !== -1) {
        _logger.default.debug(`Path '${delPath}' was not empty during delete; retrying`);

        return await safeRimRaf(delPath, tryNum + 1);
      } else if (err.message.indexOf('ENOENT') !== -1) {
        _logger.default.debug(`Path '${delPath}' did not exist when we tried to delete, ignoring`);

        return await safeRimRaf(delPath, tryNum + 1);
      }
    }
  }
}

async function installSSLCert(pemText, udid) {
  try {
    await _appiumSupport.fs.which('openssl');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires openssl to be available on path`);

    _logger.default.errorAndThrow(`Command 'openssl' not found`);
  }

  try {
    await _appiumSupport.fs.which('sqlite3');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires sqlite3 to be available on path`);

    _logger.default.errorAndThrow(`Command 'sqlite3' not found`);
  }

  let tempFileName = _path.default.resolve(await _appiumSupport.tempDir.openDir(), 'temp-ssl-cert.pem');

  let pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);

  try {
    await _appiumSupport.fs.stat(pathToKeychain);
  } catch (e) {
    _logger.default.debug(`Could not install SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }

  let certificate = new _certificate.Certificate(tempFileName);

  _logger.default.debug(`Installing certificate to ${pathToKeychain}`);

  await certificate.add(pathToKeychain);
  await _appiumSupport.fs.unlink(tempFileName);
  return certificate;
}

async function uninstallSSLCert(pemText, udid) {
  try {
    let tempFileName = _path.default.resolve(__dirname, 'temp-ssl-cert.pem');

    let pathToKeychain = _path.default.resolve(new _simulatorXcode.default(udid).getDir());

    await _appiumSupport.fs.writeFile(tempFileName, pemText);
    let certificate = new _certificate.Certificate(tempFileName);
    await certificate.remove(pathToKeychain);
    await _appiumSupport.fs.unlink(tempFileName);
    return certificate;
  } catch (e) {
    _logger.default.debug(`Could not uninstall SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }
}

async function hasSSLCert(pemText, udid) {
  const tempFileName = _path.default.resolve(await _appiumSupport.tempDir.openDir(), 'temp-ssl-cert.pem');

  const pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);
  const certificate = new _certificate.Certificate(tempFileName);
  return certificate.has(pathToKeychain);
}

async function execSQLiteQuery(db, query, ...queryParams) {
  query = query.replace(/\n+/g, ' ');
  let queryTokens = query.split('?');
  let formattedQuery = [];
  queryParams.map(param => `${param}`).forEach((param, i) => {
    formattedQuery.push(queryTokens[i]);
    formattedQuery.push(param.replace(/'/g, "''"));
  });
  formattedQuery.push(queryTokens[queryTokens.length - 1]);

  _logger.default.debug(`Executing SQL query "${formattedQuery.join('')}" on '${db}'`);

  try {
    return (await (0, _teen_process.exec)('sqlite3', ['-line', db, formattedQuery.join('')])).stdout;
  } catch (err) {
    throw new Error(`Cannot execute SQLite query "${formattedQuery.join('')}" to '${db}'. ` + `Original error: ${err.stderr}`);
  }
}

async function getDeveloperRoot() {
  const {
    stdout
  } = await (0, _teen_process.exec)('xcode-select', ['-p']);
  return stdout.trim();
}

async function activateApp(pid) {
  const tmpScript = await _appiumSupport.tempDir.path({
    prefix: `activate_sim_${_appiumSupport.util.uuidV4().substring(0, 8)}`,
    suffix: '.py'
  });
  await _appiumSupport.fs.writeFile(tmpScript, APP_ACTIVATION_SCRIPT(pid), 'utf8');

  try {
    await (0, _teen_process.exec)('/usr/bin/python', [tmpScript]);
  } finally {
    await _appiumSupport.fs.rimraf(tmpScript);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUIiwiU0FGQVJJX1NUQVJUVVBfVElNRU9VVCIsIk1PQklMRV9TQUZBUklfQlVORExFX0lEIiwiQVBQX0FDVElWQVRJT05fU0NSSVBUIiwicGlkIiwiQklPTUVUUklDUyIsInRvdWNoSWQiLCJmYWNlSWQiLCJ0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCIsIm5hbWUiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJfIiwia2V5cyIsInBraWxsIiwiYXBwTmFtZSIsImZvcmNlS2lsbCIsImFyZ3MiLCJwdXNoIiwiZXJyIiwiaXNVbmRlZmluZWQiLCJjb2RlIiwibG9nIiwiZXJyb3IiLCJtZXNzYWdlIiwia2lsbEFsbFNpbXVsYXRvcnMiLCJ0aW1lb3V0IiwiZGVidWciLCJ4Y29kZVZlcnNpb24iLCJtYWpvciIsImlnbiIsInBpZHMiLCJzdGRvdXQiLCJ0cmltIiwic3BsaXQiLCJlIiwiaXNFbXB0eSIsIndhcm4iLCJqb2luIiwiZm9yY2UiLCJyZW1haW5pbmdEZXZpY2VzIiwiYWxsU2ltc0FyZURvd24iLCJkZXZpY2VzIiwiU2ltY3RsIiwiZ2V0RGV2aWNlcyIsImZsYXR0ZW4iLCJ2YWx1ZXMiLCJldmVyeSIsInNpbSIsInN0YXRlIiwidG9Mb3dlckNhc2UiLCJkb25lIiwic2RrIiwidWRpZCIsIndhaXRNcyIsImludGVydmFsTXMiLCJsZW5ndGgiLCJkZXZpY2UiLCJlbmRBbGxTaW11bGF0b3JEYWVtb25zIiwic2VydmljZVBhdHRlcm4iLCJsYXVuY2hDdGxDb21tYW5kIiwic3RvcENtZCIsInJlbW92ZUNtZCIsImdldFNpbXVsYXRvckluZm8iLCJ0b1BhaXJzIiwibWFwIiwicGFpciIsInJlZHVjZSIsImEiLCJiIiwiY29uY2F0IiwiZmluZCIsInNpbUV4aXN0cyIsInNhZmVSaW1SYWYiLCJkZWxQYXRoIiwidHJ5TnVtIiwiZnMiLCJyaW1yYWYiLCJpbmRleE9mIiwiaW5zdGFsbFNTTENlcnQiLCJwZW1UZXh0Iiwid2hpY2giLCJlcnJvckFuZFRocm93IiwidGVtcEZpbGVOYW1lIiwicGF0aCIsInJlc29sdmUiLCJ0ZW1wRGlyIiwib3BlbkRpciIsInBhdGhUb0tleWNoYWluIiwiU2ltdWxhdG9yIiwiZ2V0RGlyIiwid3JpdGVGaWxlIiwic3RhdCIsImNlcnRpZmljYXRlIiwiQ2VydGlmaWNhdGUiLCJhZGQiLCJ1bmxpbmsiLCJ1bmluc3RhbGxTU0xDZXJ0IiwiX19kaXJuYW1lIiwicmVtb3ZlIiwiaGFzU1NMQ2VydCIsImhhcyIsImV4ZWNTUUxpdGVRdWVyeSIsImRiIiwicXVlcnkiLCJxdWVyeVBhcmFtcyIsInJlcGxhY2UiLCJxdWVyeVRva2VucyIsImZvcm1hdHRlZFF1ZXJ5IiwicGFyYW0iLCJmb3JFYWNoIiwiaSIsInN0ZGVyciIsImdldERldmVsb3BlclJvb3QiLCJhY3RpdmF0ZUFwcCIsInRtcFNjcmlwdCIsInByZWZpeCIsInV0aWwiLCJ1dWlkVjQiLCJzdWJzdHJpbmciLCJzdWZmaXgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsNEJBQTRCLEdBQUcsS0FBckM7QUFDQSxNQUFNQyxzQkFBc0IsR0FBRyxLQUFLLElBQXBDOztBQUNBLE1BQU1DLHVCQUF1QixHQUFHLHdCQUFoQzs7O0FBQ0EsTUFBTUMscUJBQXFCLEdBQUlDLEdBQUQsSUFBVTs7Ozs7c0VBSzhCQSxHQUFJOztxQ0FFckNBLEdBQUk7O3FDQUVKQSxHQUFJO0NBVHpDOztBQWFBLE1BQU1DLFVBQVUsR0FBRztBQUNqQkMsRUFBQUEsT0FBTyxFQUFFLGFBRFE7QUFFakJDLEVBQUFBLE1BQU0sRUFBRTtBQUZTLENBQW5COztBQUtBLFNBQVNDLDBCQUFULENBQXFDQyxJQUFyQyxFQUEyQztBQUN6QyxNQUFJLENBQUNKLFVBQVUs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QUFGMkIsR0FBYixDQUF4QjtBQUlBLFFBQU01QyxrQkFBR2UsU0FBSCxDQUFhd0IsU0FBYixFQUF3QmpILHFCQUFxQixDQUFDQyxHQUFELENBQTdDLEVBQW9ELE1BQXBELENBQU47O0FBQ0EsTUFBSTtBQUNGLFVBQU0sd0JBQUssaUJBQUwsRUFBd0IsQ0FBQ2dILFNBQUQsQ0FBeEIsQ0FBTjtBQUNELEdBRkQsU0FFVTtBQUNSLFVBQU12QyxrQkFBR0MsTUFBSCxDQUFVc0MsU0FBVixDQUFOO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGdldFZlcnNpb24gfSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IFNpbWN0bCBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBmcywgdGVtcERpciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IENlcnRpZmljYXRlIH0gZnJvbSAnLi9jZXJ0aWZpY2F0ZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBTaW11bGF0b3IgZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgZmtpbGwgZnJvbSAnZmtpbGwnO1xuXG5cbmNvbnN0IERFRkFVTFRfU0lNX1NIVVRET1dOX1RJTUVPVVQgPSAzMDAwMDtcbmNvbnN0IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQgPSAyNSAqIDEwMDA7XG5jb25zdCBNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJztcbmNvbnN0IEFQUF9BQ1RJVkFUSU9OX1NDUklQVCA9IChwaWQpID0+IGAjIS91c3IvYmluL3B5dGhvblxuXG5mcm9tIEFwcEtpdCBpbXBvcnQgTlNBcHBsaWNhdGlvbkFjdGl2YXRlSWdub3JpbmdPdGhlckFwcHMsIE5TQXBwbGljYXRpb25BY3RpdmF0ZUFsbFdpbmRvd3NcbmZyb20gQ29jb2EgaW1wb3J0IE5TUnVubmluZ0FwcGxpY2F0aW9uXG5cbmFwcCA9IE5TUnVubmluZ0FwcGxpY2F0aW9uLnJ1bm5pbmdBcHBsaWNhdGlvbldpdGhQcm9jZXNzSWRlbnRpZmllcl8oJHtwaWR9KVxuaWYgbm90IGFwcDpcbiAgICByYWlzZSBWYWx1ZUVycm9yKCdBcHAgd2l0aCBQSUQgJHtwaWR9IGlzIG5vdCBydW5uaW5nJylcbmlmIG5vdCBhcHAuYWN0aXZhdGVXaXRoT3B0aW9uc18oTlNBcHBsaWNhdGlvbkFjdGl2YXRlQWxsV2luZG93cyB8IE5TQXBwbGljYXRpb25BY3RpdmF0ZUlnbm9yaW5nT3RoZXJBcHBzKTpcbiAgICByYWlzZSBWYWx1ZUVycm9yKCdBcHAgd2l0aCBQSUQgJHtwaWR9IGNhbm5vdCBiZSBhY3RpdmF0ZWQnKVxuYDtcblxuXG5jb25zdCBCSU9NRVRSSUNTID0ge1xuICB0b3VjaElkOiAnZmluZ2VyVG91Y2gnLFxuICBmYWNlSWQ6ICdwZWFybCcsXG59O1xuXG5mdW5jdGlvbiB0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCAobmFtZSkge1xuICBpZiAoIUJJT01FVFJJQ1NbbmFtZV0pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke25hbWV9JyBpcyBub3QgYSB2YWxpZCBiaW9tZXRyaWMuIFVzZSBvbmUgb2Y6ICR7SlNPTi5zdHJpbmdpZnkoXy5rZXlzKEJJT01FVFJJQ1MpKX1gKTtcbiAgfVxuICByZXR1cm4gQklPTUVUUklDU1tuYW1lXTtcbn1cblxuLy8gcGdyZXAvcGtpbGwgZXhpdCBjb2Rlczpcbi8vIDAgICAgICAgT25lIG9yIG1vcmUgcHJvY2Vzc2VzIHdlcmUgbWF0Y2hlZC5cbi8vIDEgICAgICAgTm8gcHJvY2Vzc2VzIHdlcmUgbWF0Y2hlZC5cbi8vIDIgICAgICAgSW52YWxpZCBvcHRpb25zIHdlcmUgc3BlY2lmaWVkIG9uIHRoZSBjb21tYW5kIGxpbmUuXG4vLyAzICAgICAgIEFuIGludGVybmFsIGVycm9yIG9jY3VycmVkLlxuXG5hc3luYyBmdW5jdGlvbiBwa2lsbCAoYXBwTmFtZSwgZm9yY2VLaWxsID0gZmFsc2UpIHtcbiAgbGV0IGFyZ3MgPSBmb3JjZUtpbGwgPyBbJy05J10gOiBbXTtcbiAgYXJncy5wdXNoKCcteCcsIGFwcE5hbWUpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ3BraWxsJywgYXJncyk7XG4gICAgcmV0dXJuIDA7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghXy5pc1VuZGVmaW5lZChlcnIuY29kZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZvcmNlZnVsbHkgdGVybWluYXRlICR7YXBwTmFtZX0uIHBraWxsIGVycm9yIGNvZGU6ICR7ZXJyLmNvZGV9YCk7XG4gICAgfVxuICAgIGxvZy5lcnJvcihgUmVjZWl2ZWQgdW5leHBlY3RlZCBlcnJvciB3aGlsZSB0cnlpbmcgdG8ga2lsbCAke2FwcE5hbWV9OiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHRocm93IGVycjtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsU2ltdWxhdG9ycyAodGltZW91dCA9IERFRkFVTFRfU0lNX1NIVVRET1dOX1RJTUVPVVQpIHtcbiAgbG9nLmRlYnVnKCdLaWxsaW5nIGFsbCBpT1MgU2ltdWxhdG9ycycpO1xuICBjb25zdCB4Y29kZVZlcnNpb24gPSBhd2FpdCBnZXRWZXJzaW9uKHRydWUpO1xuICBjb25zdCBhcHBOYW1lID0geGNvZGVWZXJzaW9uLm1ham9yID49IDcgPyAnU2ltdWxhdG9yJyA6ICdpT1MgU2ltdWxhdG9yJztcblxuICAvLyBsYXRlciB2ZXJzaW9ucyBhcmUgc2xvd2VyIHRvIGNsb3NlXG4gIHRpbWVvdXQgPSB0aW1lb3V0ICogKHhjb2RlVmVyc2lvbi5tYWpvciA+PSA4ID8gMiA6IDEpO1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygneGNydW4nLCBbJ3NpbWN0bCcsICdzaHV0ZG93bicsIHhjb2RlVmVyc2lvbi5tYWpvciA+IDggPyAnYWxsJyA6ICdib290ZWQnXSwge3RpbWVvdXR9KTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuXG4gIGNvbnN0IHBpZHMgPSBbXTtcbiAgdHJ5IHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3BncmVwJywgWyctZicsIGAke2FwcE5hbWV9LmFwcC9Db250ZW50cy9NYWNPUy9gXSk7XG4gICAgaWYgKHN0ZG91dC50cmltKCkpIHtcbiAgICAgIHBpZHMucHVzaCguLi4oc3Rkb3V0LnRyaW0oKS5zcGxpdCgvXFxzKy8pKSk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUuY29kZSA9PT0gMSkge1xuICAgICAgbG9nLmRlYnVnKGAke2FwcE5hbWV9IGlzIG5vdCBydW5uaW5nLiBDb250aW51aW5nLi4uYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChfLmlzRW1wdHkocGlkcykpIHtcbiAgICAgIGxvZy53YXJuKGBwZ3JlcCBlcnJvciAke2UuY29kZX0gd2hpbGUgZGV0ZWN0aW5nIHdoZXRoZXIgJHthcHBOYW1lfSBpcyBydW5uaW5nLiBUcnlpbmcgdG8ga2lsbCBhbnl3YXkuYCk7XG4gICAgfVxuICB9XG4gIGlmICghXy5pc0VtcHR5KHBpZHMpKSB7XG4gICAgbG9nLmRlYnVnKGBVc2luZyBma2lsbCB0byBraWxsIHByb2Nlc3NlczogJHtwaWRzLmpvaW4oJywgJyl9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZraWxsKHBpZHMsIHtmb3JjZTogdHJ1ZX0pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgVXNpbmcgcGtpbGwgdG8ga2lsbCBhcHBsaWNhdGlvbjogJHthcHBOYW1lfWApO1xuICB0cnkge1xuICAgIGF3YWl0IHBraWxsKGFwcE5hbWUsIHRydWUpO1xuICB9IGNhdGNoIChpZ24pIHt9XG5cbiAgLy8gd2FpdCBmb3IgYWxsIHRoZSBkZXZpY2VzIHRvIGJlIHNodXRkb3duIGJlZm9yZSBDb250aW51aW5nXG4gIC8vIGJ1dCBvbmx5IHByaW50IG91dCB0aGUgZmFpbGVkIG9uZXMgd2hlbiB0aGV5IGFyZSBhY3R1YWxseSBmdWxseSBmYWlsZWRcbiAgbGV0IHJlbWFpbmluZ0RldmljZXMgPSBbXTtcbiAgYXN5bmMgZnVuY3Rpb24gYWxsU2ltc0FyZURvd24gKCkge1xuICAgIHJlbWFpbmluZ0RldmljZXMgPSBbXTtcbiAgICBsZXQgZGV2aWNlcyA9IGF3YWl0IG5ldyBTaW1jdGwoKS5nZXREZXZpY2VzKCk7XG4gICAgZGV2aWNlcyA9IF8uZmxhdHRlbihfLnZhbHVlcyhkZXZpY2VzKSk7XG4gICAgcmV0dXJuIF8uZXZlcnkoZGV2aWNlcywgKHNpbSkgPT4ge1xuICAgICAgbGV0IHN0YXRlID0gc2ltLnN0YXRlLnRvTG93ZXJDYXNlKCk7XG4gICAgICBsZXQgZG9uZSA9IHN0YXRlID09PSAnc2h1dGRvd24nIHx8XG4gICAgICAgICAgICAgICAgIHN0YXRlID09PSAndW5hdmFpbGFibGUnIHx8XG4gICAgICAgICAgICAgICAgIHN0YXRlID09PSAnZGlzY29ubmVjdGVkJztcbiAgICAgIGlmICghZG9uZSkge1xuICAgICAgICByZW1haW5pbmdEZXZpY2VzLnB1c2goYCR7c2ltLm5hbWV9ICgke3NpbS5zZGt9LCB1ZGlkOiAke3NpbS51ZGlkfSkgaXMgc3RpbGwgaW4gc3RhdGUgJyR7c3RhdGV9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRvbmU7XG4gICAgfSk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFsbFNpbXNBcmVEb3duLCB7XG4gICAgICB3YWl0TXM6IHRpbWVvdXQsXG4gICAgICBpbnRlcnZhbE1zOiAyMDBcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHJlbWFpbmluZ0RldmljZXMubGVuZ3RoID4gMCkge1xuICAgICAgbG9nLndhcm4oYFRoZSBmb2xsb3dpbmcgZGV2aWNlcyBhcmUgc3RpbGwgbm90IGluIHRoZSBjb3JyZWN0IHN0YXRlIGFmdGVyICR7dGltZW91dH0gbXM6YCk7XG4gICAgICBmb3IgKGxldCBkZXZpY2Ugb2YgcmVtYWluaW5nRGV2aWNlcykge1xuICAgICAgICBsb2cud2FybihgICAgICR7ZGV2aWNlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZW5kQWxsU2ltdWxhdG9yRGFlbW9ucyAoKSB7XG4gIGxvZy5kZWJ1ZygnRW5kaW5nIGFsbCBzaW11bGF0b3IgZGFlbW9ucycpO1xuICBmb3IgKGxldCBzZXJ2aWNlUGF0dGVybiBvZiBbJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3InLCAnY29tLmFwcGxlLkNvcmVTaW11bGF0b3InXSkge1xuICAgIGxvZy5kZWJ1ZyhgS2lsbGluZyBhbnkgb3RoZXIgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9uc2ApO1xuICAgIGxldCBsYXVuY2hDdGxDb21tYW5kID0gYGxhdW5jaGN0bCBsaXN0IHwgZ3JlcCAke3NlcnZpY2VQYXR0ZXJufSB8IGN1dCAtZiAzIHwgeGFyZ3MgLW4gMSBsYXVuY2hjdGxgO1xuICAgIHRyeSB7XG4gICAgICBsZXQgc3RvcENtZCA9IGAke2xhdW5jaEN0bENvbW1hbmR9IHN0b3BgO1xuICAgICAgYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLCBzdG9wQ21kXSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IHN0b3AgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9ucywgY2Fycnlpbmcgb24gYW55d2F5IWApO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgbGV0IHJlbW92ZUNtZCA9IGAke2xhdW5jaEN0bENvbW1hbmR9IHJlbW92ZWA7XG4gICAgICBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsIHJlbW92ZUNtZF0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCByZW1vdmUgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9ucywgY2Fycnlpbmcgb24gYW55d2F5IWApO1xuICAgIH1cbiAgfVxuICAvLyB3YWl0aW5nIHVudGlsIHRoZSBzaW11bGF0b3Igc2VydmljZSBoYXMgZGllZC5cbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJyxcbiAgICAgICAgYHBzIC1lICB8IGdyZXAgbGF1bmNoZF9zaW0gfCBncmVwIC12IGJhc2ggfCBncmVwIC12IGdyZXAgfCBhd2sgeydwcmludCQxJ31gXSk7XG4gICAgICByZXR1cm4gc3Rkb3V0LnRyaW0oKS5sZW5ndGggPT09IDA7XG4gICAgfSwge3dhaXRNczogNTAwMCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDb3VsZCBub3QgZW5kIGFsbCBzaW11bGF0b3IgZGFlbW9ucywgY2Fycnlpbmcgb24hYCk7XG4gIH1cbiAgbG9nLmRlYnVnKCdGaW5pc2hpbmcgZW5kaW5nIGFsbCBzaW11bGF0b3IgZGFlbW9ucycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTaW11bGF0b3JJbmZvICh1ZGlkKSB7XG4gIC8vIHNlZSB0aGUgUkVBRE1FIGZvciBnaXRodWIuY29tL2FwcGl1bS9ub2RlLXNpbWN0bCBmb3IgZXhhbXBsZSBvdXRwdXQgb2YgZ2V0RGV2aWNlcygpXG4gIGxldCBkZXZpY2VzID0gYXdhaXQgbmV3IFNpbWN0bCgpLmdldERldmljZXMoKTtcblxuICBkZXZpY2VzID0gXy50b1BhaXJzKGRldmljZXMpXG4gICAgLm1hcCgocGFpcikgPT4gcGFpclsxXSlcbiAgICAucmVkdWNlKChhLCBiKSA9PiBhLmNvbmNhdChiKSwgW10pO1xuICByZXR1cm4gXy5maW5kKGRldmljZXMsIChzaW0pID0+IHNpbS51ZGlkID09PSB1ZGlkKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2ltRXhpc3RzICh1ZGlkKSB7XG4gIHJldHVybiAhIShhd2FpdCBnZXRTaW11bGF0b3JJbmZvKHVkaWQpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2FmZVJpbVJhZiAoZGVsUGF0aCwgdHJ5TnVtID0gMCkge1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihkZWxQYXRoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHRyeU51bSA8IDIwKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignRU5PVEVNUFRZJykgIT09IC0xKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUGF0aCAnJHtkZWxQYXRofScgd2FzIG5vdCBlbXB0eSBkdXJpbmcgZGVsZXRlOyByZXRyeWluZ2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgc2FmZVJpbVJhZihkZWxQYXRoLCB0cnlOdW0gKyAxKTtcbiAgICAgIH0gZWxzZSBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignRU5PRU5UJykgIT09IC0xKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUGF0aCAnJHtkZWxQYXRofScgZGlkIG5vdCBleGlzdCB3aGVuIHdlIHRyaWVkIHRvIGRlbGV0ZSwgaWdub3JpbmdgKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHNhZmVSaW1SYWYoZGVsUGF0aCwgdHJ5TnVtICsgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogSW5zdGFsbCBhbiBTU0wgY2VydGlmaWNhdGUgdG8gYSBkZXZpY2Ugd2l0aCBnaXZlbiB1ZGlkXG4gKiBAcGFyYW0ge3N0cmluZ30gcGVtVGV4dCBTU0wgcGVtIHRleHRcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIElkZW50aWZpZXIgb2YgdGhlIFNpbXVsYXRvclxuICovXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsU1NMQ2VydCAocGVtVGV4dCwgdWRpZCkge1xuICAvLyBDaGVjayB0aGF0IG9wZW5zc2wgaXMgaW5zdGFsbGVkIG9uIHRoZSBwYXRoXG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ29wZW5zc2wnKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZyhgY3VzdG9tU1NMQ2VydCByZXF1aXJlcyBvcGVuc3NsIHRvIGJlIGF2YWlsYWJsZSBvbiBwYXRoYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvbW1hbmQgJ29wZW5zc2wnIG5vdCBmb3VuZGApO1xuICB9XG5cbiAgLy8gQ2hlY2sgdGhhdCBzcWxpdGUzIGlzIGluc3RhbGxlZCBvbiB0aGUgcGF0aFxuICB0cnkge1xuICAgIGF3YWl0IGZzLndoaWNoKCdzcWxpdGUzJyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYGN1c3RvbVNTTENlcnQgcmVxdWlyZXMgc3FsaXRlMyB0byBiZSBhdmFpbGFibGUgb24gcGF0aGApO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb21tYW5kICdzcWxpdGUzJyBub3QgZm91bmRgKTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBhIHRlbXBvcmFyeSBmaWxlIHRvIHN0b3JlIFBFTSB0ZXh0XG4gIC8vIChhIHRlbXAgZmlsZSBpcyBuZWNlc3NhcnkgdG8gcnVuIGBvcGVuc3NsYCBzaGVsbCBjb21tYW5kcywgY2FuJ3QgYmUgZG9uZSBpbiBtZW1vcnkpXG4gIGxldCB0ZW1wRmlsZU5hbWUgPSBwYXRoLnJlc29sdmUoYXdhaXQgdGVtcERpci5vcGVuRGlyKCksICd0ZW1wLXNzbC1jZXJ0LnBlbScpO1xuICBsZXQgcGF0aFRvS2V5Y2hhaW4gPSBuZXcgU2ltdWxhdG9yKHVkaWQpLmdldERpcigpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUodGVtcEZpbGVOYW1lLCBwZW1UZXh0KTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5zdGF0KHBhdGhUb0tleWNoYWluKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZyhgQ291bGQgbm90IGluc3RhbGwgU1NMIGNlcnRpZmljYXRlLiBObyBzaW11bGF0b3Igd2l0aCB1ZGlkICcke3VkaWR9J2ApO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICB9XG5cbiAgLy8gRG8gdGhlIGNlcnRpZmljYXRlIGluc3RhbGxhdGlvblxuICBsZXQgY2VydGlmaWNhdGUgPSBuZXcgQ2VydGlmaWNhdGUodGVtcEZpbGVOYW1lKTtcbiAgbG9nLmRlYnVnKGBJbnN0YWxsaW5nIGNlcnRpZmljYXRlIHRvICR7cGF0aFRvS2V5Y2hhaW59YCk7XG4gIGF3YWl0IGNlcnRpZmljYXRlLmFkZChwYXRoVG9LZXljaGFpbik7XG5cbiAgLy8gUmVtb3ZlIHRoZSB0ZW1wb3JhcnkgZmlsZVxuICBhd2FpdCBmcy51bmxpbmsodGVtcEZpbGVOYW1lKTtcblxuICByZXR1cm4gY2VydGlmaWNhdGU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVuaW5zdGFsbFNTTENlcnQgKHBlbVRleHQsIHVkaWQpIHtcbiAgdHJ5IHtcbiAgICBsZXQgdGVtcEZpbGVOYW1lID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gICAgbGV0IHBhdGhUb0tleWNoYWluID0gcGF0aC5yZXNvbHZlKG5ldyBTaW11bGF0b3IodWRpZCkuZ2V0RGlyKCkpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZU5hbWUsIHBlbVRleHQpO1xuICAgIGxldCBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZSh0ZW1wRmlsZU5hbWUpO1xuICAgIGF3YWl0IGNlcnRpZmljYXRlLnJlbW92ZShwYXRoVG9LZXljaGFpbik7XG4gICAgYXdhaXQgZnMudW5saW5rKHRlbXBGaWxlTmFtZSk7XG4gICAgcmV0dXJuIGNlcnRpZmljYXRlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBDb3VsZCBub3QgdW5pbnN0YWxsIFNTTCBjZXJ0aWZpY2F0ZS4gTm8gc2ltdWxhdG9yIHdpdGggdWRpZCAnJHt1ZGlkfSdgKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBTaW11bGF0b3IgYWxyZWFkeSBoYXMgdGhpcyBTU0wgY2VydGlmaWNhdGVcbiAqIEBwYXJhbSB7c3RyaW5nfSBwZW1UZXh0IFBFTSB0ZXh0IG9mIFNTTCBjZXJ0XG4gKiBAcGFyYW0ge3N0cmluZ30gdWRpZCBJZGVudGlmaWVyIG9mIHRoZSBTaW11bGF0b3JcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaGFzU1NMQ2VydCAocGVtVGV4dCwgdWRpZCkge1xuICBjb25zdCB0ZW1wRmlsZU5hbWUgPSBwYXRoLnJlc29sdmUoYXdhaXQgdGVtcERpci5vcGVuRGlyKCksICd0ZW1wLXNzbC1jZXJ0LnBlbScpO1xuICBjb25zdCBwYXRoVG9LZXljaGFpbiA9IG5ldyBTaW11bGF0b3IodWRpZCkuZ2V0RGlyKCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZU5hbWUsIHBlbVRleHQpO1xuICBjb25zdCBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZSh0ZW1wRmlsZU5hbWUpO1xuICByZXR1cm4gY2VydGlmaWNhdGUuaGFzKHBhdGhUb0tleWNoYWluKTtcbn1cblxuLyoqXG4gKiBSdW5zIGEgY29tbWFuZCBsaW5lIHNxbGl0ZTMgcXVlcnlcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZGIgLSBGdWxsIHBhdGggdG8gc3FsaXRlIGRhdGFiYXNlXG4gKiBAcGFyYW0ge3N0cmluZ30gcXVlcnkgLSBUaGUgYWN0dWFsIHF1ZXJ5IHN0cmluZ1xuICogQHBhcmFtIHsuLi5zdHJpbmd9IHF1ZXJ5UGFyYW1zIC0gVGhlIGxpc3Qgb2YgcXVlcnkgcGFyYW1ldGVyc1xuICogQHJldHVybnMge3N0cmluZ30gc3FsaXRlIGNvbW1hbmQgc3Rkb3V0XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGV4ZWNTUUxpdGVRdWVyeSAoZGIsIHF1ZXJ5LCAuLi5xdWVyeVBhcmFtcykge1xuICBxdWVyeSA9IHF1ZXJ5LnJlcGxhY2UoL1xcbisvZywgJyAnKTtcbiAgbGV0IHF1ZXJ5VG9rZW5zID0gcXVlcnkuc3BsaXQoJz8nKTtcbiAgbGV0IGZvcm1hdHRlZFF1ZXJ5ID0gW107XG4gIHF1ZXJ5UGFyYW1zXG4gICAgLm1hcCgocGFyYW0pID0+IGAke3BhcmFtfWApXG4gICAgLmZvckVhY2goKHBhcmFtLCBpKSA9PiB7XG4gICAgICBmb3JtYXR0ZWRRdWVyeS5wdXNoKHF1ZXJ5VG9rZW5zW2ldKTtcbiAgICAgIGZvcm1hdHRlZFF1ZXJ5LnB1c2gocGFyYW0ucmVwbGFjZSgvJy9nLCBcIicnXCIpKTtcbiAgICB9KTtcbiAgZm9ybWF0dGVkUXVlcnkucHVzaChxdWVyeVRva2Vuc1txdWVyeVRva2Vucy5sZW5ndGggLSAxXSk7XG5cbiAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgU1FMIHF1ZXJ5IFwiJHtmb3JtYXR0ZWRRdWVyeS5qb2luKCcnKX1cIiBvbiAnJHtkYn0nYCk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIChhd2FpdCBleGVjKCdzcWxpdGUzJywgWyctbGluZScsIGRiLCBmb3JtYXR0ZWRRdWVyeS5qb2luKCcnKV0pKS5zdGRvdXQ7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGV4ZWN1dGUgU1FMaXRlIHF1ZXJ5IFwiJHtmb3JtYXR0ZWRRdWVyeS5qb2luKCcnKX1cIiB0byAnJHtkYn0nLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIuc3RkZXJyfWApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERldmVsb3BlclJvb3QgKCkge1xuICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjb2RlLXNlbGVjdCcsIFsnLXAnXSk7XG4gIHJldHVybiBzdGRvdXQudHJpbSgpO1xufVxuXG4vKipcbiAqIEFjdGl2YXRlcyB0aGUgYXBwIGhhdmluZyB0aGUgZ2l2ZW4gcHJvY2VzcyBpZGVudGlmaWVyLlxuICogU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9kb2N1bWVudGF0aW9uL2FwcGtpdC9uc3J1bm5pbmdhcHBsaWNhdGlvbi8xNTI4NzI1LWFjdGl2YXRld2l0aG9wdGlvbnM/bGFuZ3VhZ2U9b2JqY1xuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IHBpZCBBcHAgcHJvY2VzcyBpZGVudGlmaWVyXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGdpdmVuIFBJRCBpcyBub3QgcnVubmluZyBvciB0aGVyZSB3YXMgYSBmYWlsdXJlXG4gKiB3aGlsZSBhY3RpdmF0aW5nIHRoZSBhcHBcbiAqL1xuYXN5bmMgZnVuY3Rpb24gYWN0aXZhdGVBcHAgKHBpZCkge1xuICBjb25zdCB0bXBTY3JpcHQgPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe1xuICAgIHByZWZpeDogYGFjdGl2YXRlX3NpbV8ke3V0aWwudXVpZFY0KCkuc3Vic3RyaW5nKDAsIDgpfWAsXG4gICAgc3VmZml4OiAnLnB5JyxcbiAgfSk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0bXBTY3JpcHQsIEFQUF9BQ1RJVkFUSU9OX1NDUklQVChwaWQpLCAndXRmOCcpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJy91c3IvYmluL3B5dGhvbicsIFt0bXBTY3JpcHRdKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wU2NyaXB0KTtcbiAgfVxufVxuXG5leHBvcnQge1xuICBraWxsQWxsU2ltdWxhdG9ycyxcbiAgZW5kQWxsU2ltdWxhdG9yRGFlbW9ucyxcbiAgc2FmZVJpbVJhZixcbiAgc2ltRXhpc3RzLFxuICBnZXRTaW11bGF0b3JJbmZvLFxuICBpbnN0YWxsU1NMQ2VydCxcbiAgdW5pbnN0YWxsU1NMQ2VydCxcbiAgaGFzU1NMQ2VydCxcbiAgZXhlY1NRTGl0ZVF1ZXJ5LFxuICB0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCxcbiAgZ2V0RGV2ZWxvcGVyUm9vdCxcbiAgYWN0aXZhdGVBcHAsXG4gIFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQsXG4gIE1PQklMRV9TQUZBUklfQlVORExFX0lELFxufTtcbiJdLCJmaWxlIjoibGliL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
